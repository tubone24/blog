---
slug: 2024-11-29/貧乏企業名サジェスト機能開発
title: "企業名サジェスト機能貧乏開発"
date: 2024-11-29T14:24:04+0000
description: お金をかけず企業名サジェストUIを作ろう！
tags:
  - Elasticsearch
headerImage: https://i.imgur.com/1UvKYKu.gif
templateKey: blog-post
---

お金をかけない開発ほど美しいものはないだろう....。

## Table of Contents

```toc

```

## 企業検索窓のサジェスト機能が作りたいよー！

先に結論ですが、こんな感じの企業名を入力することでどんどんサジェストが出てくるようなUIを作ってほしいとあなたがクライアントやプロダクトマネージャーから依頼されたらどうしますか...?

![](https://i.imgur.com/1UvKYKu.gif)

企業名のサジェスト機能をAPIで提供しているサービスを探したり、（このブログの検索窓でも採用してますが）[Algolia](https://www.algolia.com/)などの全文検索APIサービスを活用するなどを検討することでしょう。

しかしながらそのようなサービスを使って開発を進めることでAWSなどのインフラコストとは別に月額の利用料がかかってしまいます。

個人開発ならまだしも実業務での開発だとこのような交渉は色々な要因で難航することも多いでしょう。

また、企業名など公開されている情報だけでなく、社内で抱えている非公開情報に対してもサジェストをしたい、という場面もあるかもしれません。

そうなってくると、事前に用意されているAPIを使うことはできなくなるわけです。

今回は、 AWSなどのクラウドサービスにスクラッチでサジェスト機能のDBとフロントエンドを作成し、しかもそのコストをできるだけ下げていく、というなんともマニアックな要件に対して挑んだ軌跡を記載していきたいと思います。

## サジェスト機能ってそもそもどうやって作るものなんですかね

まずはサジェスト機能の要件を叶えるためのアーキテクチャを考えていきます。

例えばAlgoliaだと独自に実装された検索エンジンを作成し、パフォーマンスを保っているようですが、要は全文検索エンジンに入力に対してフロントエンドから直接細かく全文検索APIを実行し結果をハイライトする形でサービスを構築することが一般的です。

Algoliaでも直接APIをフロントエンドから叩くことでバックエンドを経由しないことによるパフォーマンスの向上のほか専用のJSライブラリによるInstantSearch, Autocompleteの実装で開発速度の向上が図れることから推奨は直接検索APIを叩く構成とのことです。

[Frontend versus backend search](https://www.algolia.com/doc/guides/building-search-ui/going-further/backend-search/js/)

[What architecture does Algolia use to provide a high-performance search engine?](https://support.algolia.com/hc/en-us/articles/4406975268497-What-architecture-does-Algolia-use-to-provide-a-high-performance-search-engine)

ということで、これをスクラッチで作るとしたらざっくりこんな感じになるはずです。

- Elasticsearchのような全文検索エンジンを構築し、サジェストしたい単語を登録しておく
- フロントエンドから直接アクセスする

### フロントエンド実装

一からAutocompleteを作るのは大変なのでCSSフレームワークに用意されているAutocompleteを賢く使うことが重要です。

例えばMaterial UIでは[Autocomplete](https://mui.com/material-ui/react-autocomplete/)が用意されているので賢く使って開発速度を落とさないようにしましょう。

上記ではoptionsにサジェストの候補を突っ込むだけでよくあるサジェスト機能が作れます。

![](https://i.imgur.com/8ltqQNY.png)

### デバウンス処理

上記の例では、optionsが固定値ですが実際は入力された値から全文検索APIを実行し、結果をoptionsに入れ込む必要があります。

ユーザーの入力イベントはonChangeやonInputChangeが設定できるため、都度入力された文字列を取ることができますが、入力イベントが発生するたびにAPIが実行されてしまうと裏側のElasticsearchに大きな負荷がかかります。

そこで採用するのがデバウンス処理です。

デバウンス処理は、短時間に連続して発生する処理を間引くための重要な最適化テクニックです。

よってユーザーの入力がある程度落ち着いたタイミングで一発APIを叩くことで全文検索エンジンに過剰な負荷を防ぐことにつながります。

もちろん全文検索エンジンの性能がよければ、デバウンスでまとめ上げる時間を短くすればするほど、細かくサジェストが反映されて便利ですが、ここは貧乏開発なので、長めに300msくらいに設定しましょう。

### 全文検索API実装

さて、ここからがこの記事の真骨頂の「如何にして限られたコンピュートリソースで全文検索を実施できるElasticsearchを作るか」という話です。

先に答えを書きます。

「ワイルドカードを使わず、nグラムフィルターを作って乗り切って」です。

どういうことかというと、ワイルドカード検索という仕組みがElasticsearchにあるのですが、こちらがかなり負荷の高い検索方式なので、細かくnグラムを使って転置インデックスを作ってあげるのがよさそうです。


