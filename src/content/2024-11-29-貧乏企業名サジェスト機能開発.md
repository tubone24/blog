---
slug: 2024-11-29/貧乏企業名サジェスト機能開発
title: "企業名サジェスト機能貧乏開発"
date: 2024-11-29T14:24:04+0000
description: お金をかけず企業名サジェストUIを作ろう！
tags:
  - Elasticsearch
headerImage: https://i.imgur.com/1UvKYKu.gif
templateKey: blog-post
---

お金をかけない開発ほど美しいものはないだろう....。

## Table of Contents

```toc

```

## 企業検索窓のサジェスト機能が作りたいよー！

先に結論ですが、こんな感じの企業名を入力することでどんどんサジェストが出てくるようなUIを作ってほしいとあなたがクライアントやプロダクトマネージャーから依頼されたらどうしますか...?

![](https://i.imgur.com/1UvKYKu.gif)

企業名のサジェスト機能をAPIで提供しているサービスを探したり、（このブログの検索窓でも採用してますが）[Algolia](https://www.algolia.com/)などの全文検索APIサービスを活用するなどを検討することでしょう。

しかしながらそのようなサービスを使って開発を進めることでAWSなどのインフラコストとは別に月額の利用料がかかってしまいます。

個人開発ならまだしも実業務での開発だとこのような交渉は色々な要因で難航することも多いでしょう。

また、企業名など公開されている情報だけでなく、社内で抱えている非公開情報に対してもサジェストをしたい、という場面もあるかもしれません。

そうなってくると、事前に用意されているAPIを使うことはできなくなるわけです。

今回は、 AWSなどのクラウドサービスにスクラッチでサジェスト機能のDBとフロントエンドを作成し、しかもそのコストをできるだけ下げていく、というなんともマニアックな要件に対して挑んだ軌跡を記載していきたいと思います。

### ちなみに...

企業名に関しては、国税庁が提供する[法人番号システム Web-API](https://www.houjin-bangou.nta.go.jp/pc/webapi/riyokiyaku.html)というものが商用利用についても「このサービスは、国税庁法人番号システムWeb-API機能を利用して取得した情報をもとに作成しているが、サービスの内容は国税庁によって保証されたものではない」という旨を明記することで利用が可能になります。便利ですね。

ただし...。Web-APIは申請しアプリケーションIDが発行されるまでにいくつか手続きが必要なため、1ヶ月くらい開通までになんだかんだ時間がかかってしまうという問題があります。

今回[法人番号システム Web-API](https://www.houjin-bangou.nta.go.jp/pc/webapi/riyokiyaku.html)を使わず実装したのには上記の待ち時間を持つことが開発上できず、そのような制約下で開発を進める必要があったためです。

## サジェスト機能ってそもそもどうやって作るものなんですかね

まずはサジェスト機能の要件を叶えるためのアーキテクチャを考えていきます。

例えばAlgoliaだと独自に実装された検索エンジンを作成し、パフォーマンスを保っているようですが、要は全文検索エンジンに入力に対してフロントエンドから直接細かく全文検索APIを実行し結果をハイライトする形でサービスを構築することが一般的です。

Algoliaでも直接APIをフロントエンドから叩くことでバックエンドを経由しないことによるパフォーマンスの向上のほか専用のJSライブラリによるInstantSearch, Autocompleteの実装で開発速度の向上が図れることから推奨は直接検索APIを叩く構成とのことです。

[Frontend versus backend search](https://www.algolia.com/doc/guides/building-search-ui/going-further/backend-search/js/)

[What architecture does Algolia use to provide a high-performance search engine?](https://support.algolia.com/hc/en-us/articles/4406975268497-What-architecture-does-Algolia-use-to-provide-a-high-performance-search-engine)

ということで、これをスクラッチで作るとしたらざっくりこんな感じになるはずです。

- 企業名の一覧をどっかから仕入れる
- Elasticsearchのような全文検索エンジンを構築し、サジェストしたい単語（今回は企業名）を登録しておく
- フロントエンドから直接アクセスする

![](https://i.imgur.com/sXrN24x.jpg)

## データソースはどうする？

上記にもちらっと記載しましたが、世の中には[法人番号システム Web-API](https://www.houjin-bangou.nta.go.jp/pc/webapi/riyokiyaku.html)という便利なAPIがありますが、この元ネタになっている情報をCSVやXMLでダウンロードすることができます。[基本３情報ダウンロード](https://www.houjin-bangou.nta.go.jp/download/)

このあとインデックスを作る際にこちらのXMLが大活躍します。お楽しみに！

### フロントエンド実装

一からAutocompleteを作るのは大変なのでCSSフレームワークに用意されているAutocompleteを賢く使うことが重要です。

例えばMaterial UIでは[Autocomplete](https://mui.com/material-ui/react-autocomplete/)が用意されているので賢く使って開発速度を落とさないようにしましょう。

上記ではoptionsにサジェストの候補を突っ込むだけでよくあるサジェスト機能が作れます。

![](https://i.imgur.com/8ltqQNY.png)

### デバウンス処理

上記の例では、optionsが固定値ですが実際は入力された値から全文検索APIを実行し、結果をoptionsに入れ込む必要があります。

ユーザーの入力イベントはonChangeやonInputChangeが設定できるため、都度入力された文字列を取ることができますが、入力イベントが発生するたびにAPIが実行されてしまうと裏側のElasticsearchに大きな負荷がかかります。

そこで採用するのがデバウンス処理です。

デバウンス処理は、短時間に連続して発生する処理を間引くための重要な最適化テクニックです。

よってユーザーの入力がある程度落ち着いたタイミングで一発APIを叩くことで全文検索エンジンに過剰な負荷を防ぐことにつながります。

もちろん全文検索エンジンの性能がよければ、デバウンスでまとめ上げる時間を短くすればするほど、細かくサジェストが反映されて便利ですが、ここは貧乏開発なので、長めに300msくらいに設定しましょう。

## 全文検索API実装

さて、ここからがこの記事の真骨頂の「如何にして限られたコンピュートリソースで全文検索を実施できるElasticsearchを作るか」という話です。

先に答えを書きます。

「ワイルドカードを使わず、[N-gram tokenizer](https://www.elastic.co/guide/en/elasticsearch/reference/current/analysis-ngram-tokenizer.html)を作って乗り切って」です。

どういうことかというと、ワイルドカード検索という仕組みがElasticsearchにあるのですが、こちらがかなり負荷の高い検索方式なので、細かく[N-gram tokenizer](https://www.elastic.co/guide/en/elasticsearch/reference/current/analysis-ngram-tokenizer.html)を使って転置インデックスを作ってあげるのがよさそうです。

インデックスおよびクエリについては後ほど細かく見ていきます。

### ベースイメージを用意

今回Elasticsearchのベースイメージは docker.elastic.co/elasticsearch/elasticsearch:7.10.1 を使います。

企業検索APIは特定の（XMLをダウンロードしたタイミング）時点の企業名をサジェストできるようにするので、オンラインでインデックスが更新されることがない作りにしていくため、ローカル or CI/CDでElasticsearchのイメージを立ち上げ、インデックスを作成後、Docker Commitを使ってイメージを固めてECRなどにPushする構成を取ります。

### スロークエリ監視

まず、リソース面を削りに削っていくためできる限り小さなコンテナにElasticsearchを展開していくためスロークエリを監視できるようにしておきましょう。

```python
slowlog_template = {
    "settings": {
        "index.search.slowlog.threshold.query.warn": "10s",
        "index.search.slowlog.threshold.query.info": "5s",
        "index.search.slowlog.threshold.query.debug": "2s"
    }
}

es.indices.put_template(name="slowlog-template", body=slowlog_template)
```

インデックス作成Pythonコードはこんな感じにしております。

```python
import os
import xml.etree.ElementTree as ET

import boto3
import jaconv
from elasticsearch import Elasticsearch
from elasticsearch.helpers import streaming_bulk
from tqdm import tqdm


def clean_value(val):
    if not val or val.isspace():
        return None
    return str(val).strip()


def convert_kana(text):
    if not text:
        return None, None
    hiragana = jaconv.kata2hira(text)
    katakana = jaconv.hira2kata(text)
    return hiragana, katakana


def process_xml_file(xml_file, counters):
    """XMLファイルを少しずつ読み込んで処理する"""
    context = ET.iterparse(xml_file, events=("end",))

    try:
        for event, elem in context:
            # corporationタグの場合のみ処理
            if elem.tag != "corporation":
                continue

            company_name = elem.find("name").text if elem.find("name") is not None else None
            # 非表示企業の除外
            if elem.find("hihyoji") is not None and elem.find("hihyoji").text == "1":
                counters["hidden"] += 1
                elem.clear()
                continue

            # 閉鎖企業の除外
            if elem.find("closeDate") is not None and elem.find("closeDate").text:
                counters["closed"] += 1
                elem.clear()
                continue

            counters["processed"] += 1

            kana = clean_value(elem.find("furigana").text if elem.find("furigana") is not None else None)
            hiragana, katakana = convert_kana(kana)

            doc = {
                "_index": "companies",
                "_source": {
                    "company_name": clean_value(company_name),
                    "tax_id": clean_value(elem.find("corporateNumber").text if elem.find("corporateNumber") is not None else None),
                    "prefecture": clean_value(elem.find("prefectureName").text if elem.find("prefectureName") is not None else None),
                    "city": clean_value(elem.find("cityName").text if elem.find("cityName") is not None else None),
                    "address": clean_value(elem.find("streetNumber").text if elem.find("streetNumber") is not None else None),
                    "postal_code": clean_value(elem.find("postCode").text if elem.find("postCode") is not None else None),
                    "hiragana_name": hiragana,
                    "katakana_name": katakana,
                },
            }

            doc["_source"] = {k: v for k, v in doc["_source"].items() if v is not None}

            if doc["_source"]:
                yield doc

            # メモリ解放のために要素をクリア
            elem.clear()

            # ルート要素の子要素をクリア
            if context.root is not None:
                context.root.clear()

    except Exception as e:
        print(f"XMLファイル処理中にエラー: {e}")


def count_corporations(xml_file):
    """XMLファイル内の法人数をカウント"""
    count = 0
    context = ET.iterparse(xml_file, events=("end",))
    try:
        for event, elem in context:
            if elem.tag == "corporation":
                count += 1
            elem.clear()
    finally:
        if context.root is not None:
            context.root.clear()
    return count


def main():
    xml_files = [f for f in os.listdir(".") if f.endswith(".xml")]

    es = Elasticsearch(["http://localhost:9200"])

    # インデックスのリフレッシュ処理など
    refresh_template = {"index_patterns": ["*"], "template": {"settings": {"refresh_interval": "-1", "number_of_replicas": 0}}, "priority": 1}
    es.indices.put_index_template(name="default", body=refresh_template)

    slowlog_template = {
        "index_patterns": ["*"],
        "settings": {
            "index.search.slowlog.threshold.query.warn": "10s",
            "index.search.slowlog.threshold.query.info": "5s",
            "index.search.slowlog.threshold.query.debug": "2s",
            "index.search.slowlog.threshold.query.trace": "500ms",
            "index.search.slowlog.level": "debug",
        },
    }

    es.indices.put_template(name="slowlog-template", body=slowlog_template)

    index_settings = {
        "settings": {
            "analysis": {
                "analyzer": {
                    "kuromoji_analyzer": {
                        "type": "custom",
                        "tokenizer": "kuromoji_tokenizer",
                        "char_filter": ["icu_normalizer", "kana_converter", "remove_special_chars", "normalize_charset_filter"],
                        "filter": [
                            "lowercase",
                            "kuromoji_baseform",
                            "kuromoji_part_of_speech",
                            "ja_stop",
                            "kuromoji_number",
                            "kuromoji_stemmer",
                            "kana_readingform",
                        ],
                    },
                    "ngram_analyzer": {
                        "type": "custom",
                        "tokenizer": "ngram_tokenizer",
                        "filter": ["lowercase"],
                        "char_filter": ["kana_converter", "remove_special_chars"],
                    },
                    "edge_ngram_analyzer": {
                        "type": "custom",
                        "tokenizer": "edge_ngram_tokenizer",
                        "filter": ["lowercase"],
                        "char_filter": ["kana_converter", "remove_special_chars"],
                    },
                },
                "tokenizer": {
                    "ngram_tokenizer": {"type": "ngram", "min_gram": 2, "max_gram": 3, "token_chars": ["letter", "digit"]},
                    "edge_ngram_tokenizer": {"type": "edge_ngram", "min_gram": 1, "max_gram": 15, "token_chars": ["letter", "digit"]},
                },
                "char_filter": {
                    "kana_converter": {
                        "type": "mapping",
                        "mappings": [
                            # カタカナ→ひらがな（五十音順）
                            "ァ=>ぁ",
                            "ア=>あ",
                            "ィ=>ぃ",
                            "イ=>い",
                            "ゥ=>ぅ",
                            "ウ=>う",
                            "ェ=>ぇ",
                            "エ=>え",
                            "ォ=>ぉ",
                            "オ=>お",
                            "カ=>か",
                            "ガ=>が",
                            "キ=>き",
                            "ギ=>ぎ",
                            "ク=>く",
                            "グ=>ぐ",
                            "ケ=>け",
                            "ゲ=>げ",
                            "コ=>こ",
                            "ゴ=>ご",
                            "サ=>さ",
                            "ザ=>ざ",
                            "シ=>し",
                            "ジ=>じ",
                            "ス=>す",
                            "ズ=>ず",
                            "セ=>せ",
                            "ゼ=>ぜ",
                            "ソ=>そ",
                            "ゾ=>ぞ",
                            "タ=>た",
                            "ダ=>だ",
                            "チ=>ち",
                            "ヂ=>ぢ",
                            "ッ=>っ",
                            "ツ=>つ",
                            "ヅ=>づ",
                            "テ=>て",
                            "デ=>で",
                            "ト=>と",
                            "ド=>ど",
                            "ナ=>な",
                            "ニ=>に",
                            "ヌ=>ぬ",
                            "ネ=>ね",
                            "ノ=>の",
                            "ハ=>は",
                            "バ=>ば",
                            "パ=>ぱ",
                            "ヒ=>ひ",
                            "ビ=>び",
                            "ピ=>ぴ",
                            "フ=>ふ",
                            "ブ=>ぶ",
                            "プ=>ぷ",
                            "ヘ=>へ",
                            "ベ=>べ",
                            "ペ=>ぺ",
                            "ホ=>ほ",
                            "ボ=>ぼ",
                            "ポ=>ぽ",
                            "マ=>ま",
                            "ミ=>み",
                            "ム=>む",
                            "メ=>め",
                            "モ=>も",
                            "ャ=>ゃ",
                            "ヤ=>や",
                            "ュ=>ゅ",
                            "ユ=>ゆ",
                            "ョ=>ょ",
                            "ヨ=>よ",
                            "ラ=>ら",
                            "リ=>り",
                            "ル=>る",
                            "レ=>れ",
                            "ロ=>ろ",
                            "ワ=>わ",
                            "ヲ=>を",
                            "ン=>ん",
                            "ヮ=>ゎ",
                            # 半角カタカナ→ひらがな
                            "ｱ=>あ",
                            "ｲ=>い",
                            "ｳ=>う",
                            "ｴ=>え",
                            "ｵ=>お",
                            "ｶ=>か",
                            "ｷ=>き",
                            "ｸ=>く",
                            "ｹ=>け",
                            "ｺ=>こ",
                            "ｻ=>さ",
                            "ｼ=>し",
                            "ｽ=>す",
                            "ｾ=>せ",
                            "ｿ=>そ",
                            "ﾀ=>た",
                            "ﾁ=>ち",
                            "ﾂ=>つ",
                            "ﾃ=>て",
                            "ﾄ=>と",
                            "ﾅ=>な",
                            "ﾆ=>に",
                            "ﾇ=>ぬ",
                            "ﾈ=>ね",
                            "ﾉ=>の",
                            "ﾊ=>は",
                            "ﾋ=>ひ",
                            "ﾌ=>ふ",
                            "ﾍ=>へ",
                            "ﾎ=>ほ",
                            "ﾏ=>ま",
                            "ﾐ=>み",
                            "ﾑ=>む",
                            "ﾒ=>め",
                            "ﾓ=>も",
                            "ﾔ=>や",
                            "ﾕ=>ゆ",
                            "ﾖ=>よ",
                            "ﾗ=>ら",
                            "ﾘ=>り",
                            "ﾙ=>る",
                            "ﾚ=>れ",
                            "ﾛ=>ろ",
                            "ﾜ=>わ",
                            "ｦ=>を",
                            "ﾝ=>ん",
                            # 濁音、半濁音の処理
                            "ｶﾞ=>が",
                            "ｷﾞ=>ぎ",
                            "ｸﾞ=>ぐ",
                            "ｹﾞ=>げ",
                            "ｺﾞ=>ご",
                            "ｻﾞ=>ざ",
                            "ｼﾞ=>じ",
                            "ｽﾞ=>ず",
                            "ｾﾞ=>ぜ",
                            "ｿﾞ=>ぞ",
                            "ﾀﾞ=>だ",
                            "ﾁﾞ=>ぢ",
                            "ﾂﾞ=>づ",
                            "ﾃﾞ=>で",
                            "ﾄﾞ=>ど",
                            "ﾊﾞ=>ば",
                            "ﾋﾞ=>び",
                            "ﾌﾞ=>ぶ",
                            "ﾍﾞ=>べ",
                            "ﾎﾞ=>ぼ",
                            "ﾊﾟ=>ぱ",
                            "ﾋﾟ=>ぴ",
                            "ﾌﾟ=>ぷ",
                            "ﾍﾟ=>ぺ",
                            "ﾎﾟ=>ぽ",
                            # 記号の正規化（重複を削除）
                            "．=>",
                            "，=>",
                            "、=>",
                            "。=>",
                            "・=>",
                            "･=>",
                            "「=>",
                            "」=>",
                            "『=>",
                            "』=>",
                            "【=>",
                            "】=>",
                            "（=>",
                            "）=>",
                            "(=>",
                            ")=>",
                            "＜=>",
                            "＞=>",
                            # 長音符号の統一
                            "ー=>ー",
                            "―=>ー",
                            "-=>ー",
                            "‐=>ー",
                            "−=>ー",
                            "─=>ー",
                            "━=>ー",
                            "〜=>ー",
                            "～=>ー",
                            "ｰ=>ー",
                            # 空白文字の統一
                            "　=>",  # 全角スペース除去
                        ],
                    },
                    "remove_special_chars": {"type": "pattern_replace", "pattern": "[・．，、。：；！？＆（）｛｝［］【】《》〔〕＜＞「」『』〈〉" "''＝＊＋－∽～①②③④⑤⑥⑦⑧⑨⑩]", "replacement": " "},
                    "normalize_charset_filter": {
                        "type": "mapping",
                        "mappings": [
                            # 全角英字（大文字）を半角に変換
                            "Ａ=>A",
                            "Ｂ=>B",
                            "Ｃ=>C",
                            "Ｄ=>D",
                            "Ｅ=>E",
                            "Ｆ=>F",
                            "Ｇ=>G",
                            "Ｈ=>H",
                            "Ｉ=>I",
                            "Ｊ=>J",
                            "Ｋ=>K",
                            "Ｌ=>L",
                            "Ｍ=>M",
                            "Ｎ=>N",
                            "Ｏ=>O",
                            "Ｐ=>P",
                            "Ｑ=>Q",
                            "Ｒ=>R",
                            "Ｓ=>S",
                            "Ｔ=>T",
                            "Ｕ=>U",
                            "Ｖ=>V",
                            "Ｗ=>W",
                            "Ｘ=>X",
                            "Ｙ=>Y",
                            "Ｚ=>Z",
                            # 全角英字（小文字）を半角に変換
                            "ａ=>a",
                            "ｂ=>b",
                            "ｃ=>c",
                            "ｄ=>d",
                            "ｅ=>e",
                            "ｆ=>f",
                            "ｇ=>g",
                            "ｈ=>h",
                            "ｉ=>i",
                            "ｊ=>j",
                            "ｋ=>k",
                            "ｌ=>l",
                            "ｍ=>m",
                            "ｎ=>n",
                            "ｏ=>o",
                            "ｐ=>p",
                            "ｑ=>q",
                            "ｒ=>r",
                            "ｓ=>s",
                            "ｔ=>t",
                            "ｕ=>u",
                            "ｖ=>v",
                            "ｗ=>w",
                            "ｘ=>x",
                            "ｙ=>y",
                            "ｚ=>z",
                            # 全角数字を半角に変換
                            "０=>0",
                            "１=>1",
                            "２=>2",
                            "３=>3",
                            "４=>4",
                            "５=>5",
                            "６=>6",
                            "７=>7",
                            "８=>8",
                            "９=>9",
                            # 全角記号を半角に変換
                            "＆=>&",
                            "＠=>@",
                            "＃=>#",
                            "％=>%",
                            "＋=>+",
                            "－=>-",
                            "／=>/",
                            "＝=>=",
                        ],
                    },
                },
                "filter": {"kana_readingform": {"type": "kuromoji_readingform", "use_romaji": False}},
                "normalizer": {"lowercase_normalizer": {"type": "custom", "filter": ["lowercase"]}},
            }
        },
        "mappings": {
            "properties": {
                "company_name": {
                    "type": "text",
                    "analyzer": "kuromoji_analyzer",
                    "search_analyzer": "kuromoji_analyzer",
                    "fields": {
                        "keyword": {
                            "type": "keyword",
                            "normalizer": "lowercase_normalizer",
                        },
                        "ngram": {"type": "text", "analyzer": "ngram_analyzer", "search_analyzer": "kuromoji_analyzer"},
                        "edge_ngram": {"type": "text", "analyzer": "edge_ngram_analyzer", "search_analyzer": "kuromoji_analyzer"},
                    },
                },
                "company_name_reading": {
                    "type": "text",
                    "analyzer": "kuromoji_analyzer",
                    "search_analyzer": "kuromoji_analyzer",
                    "fields": {
                        "keyword": {"type": "keyword"},
                        "ngram": {"type": "text", "analyzer": "ngram_analyzer", "search_analyzer": "kuromoji_analyzer"},
                        "edge_ngram": {"type": "text", "analyzer": "edge_ngram_analyzer", "search_analyzer": "kuromoji_analyzer"},
                    },
                },
                "hiragana_name": {
                    "type": "text",
                    "analyzer": "kuromoji_analyzer",
                    "fields": {"keyword": {"type": "keyword", "normalizer": "lowercase_normalizer"}},
                },
                "katakana_name": {
                    "type": "text",
                    "analyzer": "kuromoji_analyzer",
                    "fields": {"keyword": {"type": "keyword", "normalizer": "lowercase_normalizer"}},
                },
                "tax_id": {"type": "text", "fields": {"keyword": {"type": "keyword", "ignore_above": 256}}},
            }
        },
    }

    # インデックスの作成
    if es.indices.exists(index="companies"):
        es.indices.delete(index="companies")
    es.indices.create(index="companies", settings=index_settings["settings"], mappings=index_settings["mappings"])

    es_bulk_chunk_size = 7000
    total_success = 0
    total_errors = []
    counters = {
        "processed": 0,
        "hidden": 0,
        "closed": 0,
    }

    # XMLファイル全体の進捗バー
    with tqdm(total=len(xml_files), desc="XMLファイル処理", unit="ファイル") as file_pbar:
        for xml_file in xml_files:
            try:
                # ESへのバルク登録の進捗バー
                with tqdm(desc=f"ESインデックス中 ({xml_file})", unit="件", leave=False) as bulk_pbar:
                    success = 0
                    for ok, result in streaming_bulk(es, process_xml_file(xml_file, counters), chunk_size=es_bulk_chunk_size, max_retries=3, yield_ok=True):
                        if ok:
                            success += 1
                            bulk_pbar.update(1)
                        else:
                            total_errors.append(result)

                    total_success += success

                file_pbar.update(1)
                file_pbar.set_postfix(
                    {"処理済": counters["processed"], "非表示": counters["hidden"], "閉鎖": counters["closed"], "成功": total_success, "エラー": len(total_errors)}
                )

            except Exception as e:
                print(f"\nファイル {xml_file} でエラーが発生: {e}")

        # インデックスをリフレッシュ
        es.indices.refresh()
        settings_body = {"index": {"blocks": {"write": True, "metadata": True, "read_only": True}, "auto_expand_replicas": "0-all"}}
        response = es.indices.put_settings(index="companies", body=settings_body)
        print("インデックスを読み取り専用に設定しました:", response)


if __name__ == "__main__":
    main()

```

### データクレンジングの工夫

```python
def clean_value(val):
    if not val or val.isspace():
        return None
    return str(val).strip()

def convert_kana(text):
    if not text:
        return None, None
    hiragana = jaconv.kata2hira(text)
    katakana = jaconv.hira2kata(text)
    return hiragana, katakana
```

- 空文字列やスペースのみの値を適切に処理
- ひらがな・カタカナの相互変換による検索精度の向上
- 全角・半角の統一による一貫性の確保

### 日本語検索のための高度な設定


```json
{
  "kuromoji_analyzer": {
    "type": "custom",
    "tokenizer": "kuromoji_tokenizer",
    "char_filter": [
      "icu_normalizer",
      "kana_converter",
      "remove_special_chars",
      "normalize_charset_filter"
    ],
    "filter": [
      "lowercase",
      "kuromoji_baseform",
      "kuromoji_part_of_speech",
      "ja_stop",
      "kuromoji_number",
      "kuromoji_stemmer",
      "kana_readingform"
    ]
  }
}
```

- ICU正規化による文字の標準化
- 特殊文字の除去による検索ノイズの低減
- 日本語ストップワードの除去
- 数字の正規化

### マルチフィールド検索の実装

```json
{
  "company_name": {
    "type": "text",
    "analyzer": "kuromoji_analyzer",
    "fields": {
      "keyword": {
        "type": "keyword",
        "normalizer": "lowercase_normalizer"
      },
      "ngram": {
        "type": "text",
        "analyzer": "ngram_analyzer"
      },
      "edge_ngram": {
        "type": "text",
        "analyzer": "edge_ngram_analyzer"
      }
    }
  }
}
```

- 完全一致検索のためのkeywordフィールド
- あいまい検索のためのN-gram解析
- 前方一致検索のためのEdge N-gram解析
- 各フィールドに適切なアナライザーを設定


