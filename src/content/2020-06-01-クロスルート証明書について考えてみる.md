---
slug: 2020/06/01/ssl-cert
title: クロスルート証明書について考えてみる
date: 2020-06-01T14:51:53.352Z
description: クロスルート証明書について考えてみようかなと思ってます。
tags:
  - Datadog
headerImage: https://i.imgur.com/QmIHfeR.jpg
templateKey: blog-post
---
2020/05/30に発生したDatadog Agentの[**CERTIFICATE_VERIFY_FAILED error**](https://docs.datadoghq.com/agent/faq/certificate_verify_failed-error/)について少し考察してみようかと思います。

## Table of Contents

```toc

```

## CERTIFICATE_VERIFY_FAILED は突然に

「ギャー！めっちゃEC2の監視が落ちているんですけど！」と連絡を受けた土曜日。

カンパリオレンジならぬカンパリ野菜生活をゴクゴク飲んでいた私は意識朦朧とする中、Slackを見る

ギャー！！

![img](https://i.imgur.com/MQtTdnk.png)

めっちゃ落ちてますね....。

一通りサービスの状態を見て問題なかったのでこの日は持ち前の「大丈夫ですよ(大嘘)」をかまして眠ることにしました。

## Datadogからのアナウンス

翌日、Datadogからアナウンスがありました。

[CERTIFICATE_VERIFY_FAILED error](https://docs.datadoghq.com/agent/faq/certificate_verify_failed-error/)

サイトを見ると何が起きていて、どんな対応がユーザーに必要かが書いてありました。

> On Saturday May 30th, 2020, at 10:48 UTC, an SSL root certificate used to cross-sign some of the Datadog certificates expired, and caused some of your Agents to lose connectivity with Datadog endpoints. Because this root certificate is embedded in certain Agent versions, you will need to take action to restore connectivity.

ふむふむ... SSLのルート証明書(cross-sign)が失効してしまいましたわよ、という案件なのですね。

よくあるSSL証明書失効と何が違うのでしょうか...よくわかりませんね...

とりあえずそこら辺の調査は後回しで直していきます。

いくつかサイトに直し方が書いてありましたが今回は

```
sudo rm /opt/datadog-agent/agent/datadog-cert.pem && sudo service datadog-agent restart
```

の直し方にフォーカスしてみようかと思います。どうやら **datadog-cert.pem** を消してからdatadogのサービス再起動すればいいみたい。

ということで、各EC2に入ってごにょごにょしたら**直りました**。よかった...ホッと...。

## そもそもSSLの仕組みをおさらい

直ったのはいいですが、何が起きていたかちゃんと把握したいですよね...。

ということで5年ぶりにSSLのお勉強をしました。

といっても私が知っているのは公開鍵暗号の話だけ...ですので実質初学習です。

公開鍵暗号について詳しく知りたい人は

[暗号技術入門 第3版　秘密の国のアリス](https://www.amazon.co.jp/dp/B015643CPE/ref=dp-kindle-redirect?_encoding=UTF8&btkr=1)がいいと思います。

私をこの業界に引き込んだ師が大学の頃に読め！と言われて買って読んだ記憶があります。

今でも家の本棚にありました。マジで良書です。わかりやすいです。

![img](https://i.imgur.com/E0GC9w0.jpg)

さて簡単にSSL通信のおさらいをします。

![img](https://ssl.sakura.ad.jp/column/images/ssl/img01.png)
引用: https://ssl.sakura.ad.jp/column/ssl/

わかりやすいイラストがさくらのSSLにありましたので拝借します。

重要なポイントとして、ブラウザ(クライアント)はSSL通信をするときにSSLの通信リクエスト(ClientHello)を送信すると、サーバから**サーバ証明書**と**公開鍵**が送られてきます。

暗号通信についてはこのうち**公開鍵**が利用され、クライアント側でランダムな値を共通鍵のシークレットとして利用することを決定しこの公開鍵を使って暗号化し、サーバに送信します。

するとサーバでは秘密鍵を使って共通鍵が取り出せるのでここから共通鍵暗号(例えばAESとか)での通信ができるわけです。これが鍵交換というやつです。

えっ！？普通に互いの公開鍵を交換して公開鍵暗号で通信すればいいだけじゃんアゼルバイジャンと思ったそこの君！！それは違いますね。

まず、その場合クライアントに公開鍵と対応する秘密鍵を用意する必要がありますね。あなたは田舎のおばあちゃんにOpenSSLコマンドを打たせるんですか...それはきついですよね。

もう一つの問題は一般的に公開鍵暗号は共通鍵暗号に比べて暗号コストが高いということです。それなりの桁数の乱数をぶつけていくので共通鍵の数十～数千倍遅いといわれてます。

ちなみにSSLの通信で、出てきた公開鍵暗号や共通鍵暗号のアルゴリズムパターンを定義するのが皆さん大好きおなじみのCipher suiteです。

サイト管理者ならひと昔前、[ATS対応](https://developers.google.com/admob/ios/app-transport-security?hl=ja)とかでツライ思いをした人もいるかもしれませんね。

**ECDHE-RSA-AES128-GCM-SHA256** こんなやつ...あぁ...SHA-1の悪夢がよみがえりますね。

脱線ついでにもう一つ。上記で述べた鍵交換一つとってもたとえばRSAという方式ではほぼ上記で説明している通りの流れを組むのですが、**前方秘匿性**に弱い欠点(一言でいえば全暗号通信を記憶していた状態で秘密鍵を手に入れたらすべてがばれてしまう)があったりで最近ではDHE（DiffieHellman, Ephemeral）という鍵交換方式を楕円曲線暗号上で行う**ECDHE**（RFC4492）が主流だったりします。

ここまでのお話はぜひ[暗号技術入門 第3版　秘密の国のアリス](https://www.amazon.co.jp/dp/B015643CPE/ref=dp-kindle-redirect?_encoding=UTF8&btkr=1)を読んでいただければ私なんかよりわかりやすく説明しているので興味がある人はぜひ読んでみましょう！！


## SSL通信におけるサーバ認証



datadog-cert.pem

```
(py37) tubone% openssl x509 -text -noout -in datadog-cert.pem                                                                                   
Certificate:
    Data:
        Version: 3 (0x2)
        Serial Number: 1 (0x1)
        Signature Algorithm: sha1WithRSAEncryption
        Issuer: C = SE, O = AddTrust AB, OU = AddTrust External TTP Network, CN = AddTrust External CA Root
        Validity
            Not Before: May 30 10:48:38 2000 GMT
            Not After : May 30 10:48:38 2020 GMT
        Subject: C = SE, O = AddTrust AB, OU = AddTrust External TTP Network, CN = AddTrust External CA Root
        Subject Public Key Info:
            Public Key Algorithm: rsaEncryption
                RSA Public-Key: (2048 bit)
                Modulus:
                    00:b7:f7:1a:33:e6:f2:00:04:2d:39:e0:4e:5b:ed:
                    1f:bc:6c:0f:cd:b5:fa:23:b6:ce:de:9b:11:33:97:
                    a4:29:4c:7d:93:9f:bd:4a:bc:93:ed:03:1a:e3:8f:
                    cf:e5:6d:50:5a:d6:97:29:94:5a:80:b0:49:7a:db:
                    2e:95:fd:b8:ca:bf:37:38:2d:1e:3e:91:41:ad:70:
                    56:c7:f0:4f:3f:e8:32:9e:74:ca:c8:90:54:e9:c6:
                    5f:0f:78:9d:9a:40:3c:0e:ac:61:aa:5e:14:8f:9e:
                    87:a1:6a:50:dc:d7:9a:4e:af:05:b3:a6:71:94:9c:
                    71:b3:50:60:0a:c7:13:9d:38:07:86:02:a8:e9:a8:
                    69:26:18:90:ab:4c:b0:4f:23:ab:3a:4f:84:d8:df:
                    ce:9f:e1:69:6f:bb:d7:42:d7:6b:44:e4:c7:ad:ee:
                    6d:41:5f:72:5a:71:08:37:b3:79:65:a4:59:a0:94:
                    37:f7:00:2f:0d:c2:92:72:da:d0:38:72:db:14:a8:
                    45:c4:5d:2a:7d:b7:b4:d6:c4:ee:ac:cd:13:44:b7:
                    c9:2b:dd:43:00:25:fa:61:b9:69:6a:58:23:11:b7:
                    a7:33:8f:56:75:59:f5:cd:29:d7:46:b7:0a:2b:65:
                    b6:d3:42:6f:15:b2:b8:7b:fb:ef:e9:5d:53:d5:34:
                    5a:27
                Exponent: 65537 (0x10001)
        X509v3 extensions:
            X509v3 Subject Key Identifier:
                AD:BD:98:7A:34:B4:26:F7:FA:C4:26:54:EF:03:BD:E0:24:CB:54:1A
            X509v3 Key Usage:
                Certificate Sign, CRL Sign
            X509v3 Basic Constraints: critical
                CA:TRUE
            X509v3 Authority Key Identifier:
                keyid:AD:BD:98:7A:34:B4:26:F7:FA:C4:26:54:EF:03:BD:E0:24:CB:54:1A
                DirName:/C=SE/O=AddTrust AB/OU=AddTrust External TTP Network/CN=AddTrust External CA Root
                serial:01
    Signature Algorithm: sha1WithRSAEncryption
         b0:9b:e0:85:25:c2:d6:23:e2:0f:96:06:92:9d:41:98:9c:d9:
         84:79:81:d9:1e:5b:14:07:23:36:65:8f:b0:d8:77:bb:ac:41:
         6c:47:60:83:51:b0:f9:32:3d:e7:fc:f6:26:13:c7:80:16:a5:
         bf:5a:fc:87:cf:78:79:89:21:9a:e2:4c:07:0a:86:35:bc:f2:
         de:51:c4:d2:96:b7:dc:7e:4e:ee:70:fd:1c:39:eb:0c:02:51:
         14:2d:8e:bd:16:e0:c1:df:46:75:e7:24:ad:ec:f4:42:b4:85:
         93:70:10:67:ba:9d:06:35:4a:18:d3:2b:7a:cc:51:42:a1:7a:
         63:d1:e6:bb:a1:c5:2b:c2:36:be:13:0d:e6:bd:63:7e:79:7b:
         a7:09:0d:40:ab:6a:dd:8f:8a:c3:f6:f6:8c:1a:42:05:51:d4:
         45:f5:9f:a7:62:21:68:15:20:43:3c:99:e7:7c:bd:24:d8:a9:
         91:17:73:88:3f:56:1b:31:38:18:b4:71:0f:9a:cd:c8:0e:9e:
         8e:2e:1b:e1:8c:98:83:cb:1f:31:f1:44:4c:c6:04:73:49:76:
         60:0f:c7:f8:bd:17:80:6b:2e:e9:cc:4c:0e:5a:9a:79:0f:20:
         0a:2e:d5:9e:63:26:1e:55:92:94:d8:82:17:5a:7b:d0:bc:c7:
         8f:4e:86:04
```
