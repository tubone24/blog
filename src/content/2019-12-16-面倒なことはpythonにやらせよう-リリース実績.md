---
slug: 2019/12/16/python-auto
title: 面倒なことはPythonにやらせよう@GitHub API v4を使ったリリース実績取得
date: 2019-12-15T23:30:57.397Z
description: 頼まれついでにPythonスクリプトを作ってGitHubでリリース実績を取ってみることにした話
tags:
  - Python
  - GitHub
  - GraphQL
  - GitHub API v4
  - リリース実績
headerImage: 'https://i.imgur.com/QmIHfeR.jpg'
templateKey: blog-post
---
システムのリリース実績を取る必要がでてきたものの、管理表にはしてなかったので**GitHub API v4**から取得し、まとめましたというお話

## Table of Contents

```toc

```

## 背景

どうしてこんなことしなきゃいけなくなったかというとちょっとした頼まれごときっかけです。

ふつうシステムをリリースするとリリース管理というリリース日やリリースの内容などをまとめておく管理表があって然るべきなんですが、それがまとまっていなくて困った！なんとかしてというものでした。

困りましたね…。

ただ、我々のソースはGitHubで管理していて、かならず**[Git-flow](https://nvie.com/posts/a-successful-git-branching-model/)**というブランチ戦略を取っているのでPRやコミットの履歴を集めればええやんけ！となったわけです。

![Git-flow](https://i.imgur.com/qj5McGT.png)

上記の通りProduction環境へのリリースはmasterブランチから行います。

## GitHub API v4を使う

このブログだと2回目の取り上げになりますが、GitHubのAPIには2種類あります。

[GitHub API v3 (RestAPI)](https://developer.github.com/v3/)と[v4(GraphQL)](https://developer.github.com/v4/)です。

もちろん使い慣れたRestAPIを使ってもいいのですが、GraphQLくらい使えないと会社でバカにされそうなので**GraphQL**を使うことにします。

## なぜGraphQLを使わないと会社でバカにされるのか

ちょっと閑話休題。

最近流行ってますね。GraphQL。

こういった新しい技術は会社の若い人たちがどんどん使っていくので追いつくのに必死です。

APIサービスを提供する人も使う人両者からみてRESTよりはいいところがあるから流行るわけですがどういった点でしょうか？

### リソースごとにAPIをコールしなくていい

利用側からするとこれが一番大きいのではないでしょうか？

ちょっと複雑なAPIになるとアルアルなのが、

**記事情報API**から**コメントID**を取得して、**コメントID**を使って**コメントAPI**を叩いて、結果から**ユーザID**をとって**ユーザーID**を使って**ユーザーAPI**から……

どんだけリクエストするんや…と。

GraphQLなら自分が必要な項目を必要なだけ取得できます。


### BFFとして使うことでたくさんのエンドポイントを作らなくてよい

[Backends For Frontends](https://samnewman.io/patterns/architectural/bff/)な世界では、フロントエンドが使いやすい形式で様々な業務ロジックをGatewayしてあげることが求められます。

GraphQLはまさに呼び手、つまりフロントエンドがデータの形式を決められるためにBFFとの親和性が高いと思います。

## PythonではRequestsが便利だよねっていう話

タイトルの通り面倒なことはPythonに任せようなのでPythonで実装していくわけですが、PythonにはRequestsという超便利ライブラリがあるのでこちらを使ってGraphQLコール部を作っていきます。

次のような形で作るとGraphQLのリクエストができ、PythonのDictで結果を受け取ることができます。

（ソース）

それでは早速、作っていきましょう。

## リリース実績に必要な項目は？

今回のリリース実績取得に当たって下記のものがリリース実績としてカウントするものとします。

- masterブランチへのPRで
  - マージされてるものが対象
  - マージされずにCloseしているものは対象外
  - マージ日がリリース日とする
  - どんな変更が当たっているか後追いしたいのでPRに含まれるCommitのメッセージも添付する
  - 結果は標準出力とCSVで出す



