---
slug: 2022/03/20/k6-with-typescript
title: 負荷テストツールK6をTypeScript+Dockerで動かすためのテンプレートを作る
date: 2022-03-20T08:33:17.597Z
description: 高機能なgo製負荷テストツールK6を使って負荷テストを実施する際に環境づくりがめんどくさいのでDocker
  compose化し、さらにシナリオファイルをTypeScriptで実装できるようにすることでテストシナリオを簡単に実装できるようにしたよ、というお話です。
tags:
  - k6
  - 負荷試験
  - Docker
  - TypeScript
headerImage: https://i.imgur.com/QmIHfeR.jpg
templateKey: blog-post
---
暖かくなったと思ったら寒くなりましたね。

## Table of Contents

```toc

```

## k6とは？

k6 はGo製のOSS負荷テストツールでHTTP/2, gRPC, WebSocketなどにも対応した高機能なテストシナリオ作成がJavaScriptで実施できる手軽さとGrafanaを使ったパフォーマンスレポートが魅力の製品です。

以前はloadimpactと呼ばれていました。こちらのほうが馴染みある人が多いのではないでしょうか？

私個人としては、この手の負荷試験ツールは長らく[Locust](https://locust.io/)を愛用してきてそれなりに複雑なテストシナリオを作ってきた経験もあるのですが、時代の流れ的にこっちのほうがいいのではないかと思い浮気することにしました。

## 使い心地

K6をMacやEC2などで作ったLinux上に構築する方法はググればたくさん出てくるのでここでは割愛しますが、まず非常に簡単に環境が構築できる。この点はしっかり強調しておきたいです。

MacならHomebrew入っていれば

```
brew install k6
```

で完了ですからね。環境構築は超簡単です。

シナリオファイルの作成もJavaScript ES6対応&[公式ドキュメント](https://k6.io/docs/)比較的している充実しているので、ある程度JavaScript触ったことのある人であればノーストレスで実装できそうです。

また、細かいニーズのシナリオ作成については[GitHubレポジトリのサンプルコード](https://github.com/grafana/k6/tree/master/samples)がかなり参考になります。

なので、正直普通に使う分にはこの記事で紹介することなんてあんまりないのです。ここまで読んでくれた皆さん、ごめんなさい。

## ロマン

### 完全Dockerコンテナ上で実行

とはいえ、これで終わりならわざわざブログを書くこともないので早速ちょっとした改良をしていきます。

まず、完全Dockerコンテナ上での実行です。

開発チームの皆さんがMacを使っている会社さんなら不要な気もしますが中にはWindowsやLinuxを使っている人が混在している開発現場もありそうで、そういった現場で「はい。K6入れておいてね」はちょっと不親切です。かといって、全OSのマニュアルを用意するのもつらいです。

また、負荷テストはしばしばネットワークの安定したサーバー上で実行することもしばしばでMacで動くのに負荷テスト用サーバーで動きません！みたいになるのも悲しいです。そもそも専用のサーバーを立てるのもめんどくさいのでDocker Image化してDockerコンテナ管理サービスでサクッと実行させるのが賢そうです。なんならCIに組み込んで、パイプライン上で実行させるとかも面白そうです。

もちろんK6公式もぬかりなく[Docker Image](https://github.com/grafana/k6#docker)を用意してます。ただ、こちらを使った場合次の問題が発生します。










