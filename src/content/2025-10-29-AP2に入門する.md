---
slug: 2025-10-29/AP2に入門する
title: "AP2に入門する"
date: 2025-10-29T04:00:20+0000
description: AP2(Agent Payments Protocol)に入門してみます。
tags:
  - fixme
headerImage: https://i.imgur.com/QmIHfeR.jpg
templateKey: blog-post
---

お久しぶりです。

## Table of Contents

```toc

```

## すごいせっかちな人向けに

デモアプリを作ってみました。

![demo](https://i.imgur.com/4umwhpw.gif)

## AP2に入門してみたくなった。

突然ですが、育休を取っているのですが、なにか新しい技術を学んでおかないと復帰後不安で押しつぶされそうなので、重い腰をあげてAP2([Agent Payments Protocol](https://ap2-protocol.org/))に入門しようと思います。

どうにも生成AIの世界は謎のプロトコルが次々とでてくる...。この前MCPに入門したと思ったら、A2A、そしてAP2...。困りましたね。

AP2とは、Googleによると

> 主要な決済企業やテクノロジー企業と共同で開発されたオープン プロトコルで、プラットフォームをまたいでエージェント主導の決済を安全に開始、実行するもの

とのことで、要はAIエージェントを絡めたお買い物、決済を考えたときに起こり得る様々な不都合や問題をうまい具合に解決する仕組みです。

そもそもAIエージェントを用いたお買い物で起こり得る問題ってなんでしょうか。

## まず人間の買い物を想像してみましょう

AP2を考える前に、まずは人間の買い物を想像してみましょう。

![a](https://i.imgur.com/hvUOvHi.png)

Aさんは「かわいい犬のグッズ」がほしいな〜と思っているとします。ちなみに「『かわいい犬のグッズ』がほしいな〜」という気持ち(意図)のことをAP2では、Intentといいます。

しばらく歩いていると、「むぎぼーショップ」というかわいい柴犬をモチーフにしたお店を発見しました。入ってみましょう。

「むぎぼーショップ」は店員さんがとても優秀で、お客様の気持ちによりそった最適な商品を提示してくれるお店でした。細かい要望を伝えると、在庫を確認した後予算内でいくつか商品をピックアップしてくれました。（おすすめセットのリストを作ってくれました）

![a](https://i.imgur.com/E2feFkd.png)

Aさんもおすすめセットに納得したようで支払い手続きに進みます。お店に設置されているxxPayの端末を使ってお会計を済ませます。商品と領収書をもらってお買い物完了です。

![a](https://i.imgur.com/dXUyJlg.png)

以上が人間のお買い物でした。ポイントとしてAP2で想定されるお買い物は、スーパーなどの[セルフサービス方式](https://md-next.jp/yougo/%e3%82%bb%e3%83%ab%e3%83%95%e3%82%b5%e3%83%bc%e3%83%93%e3%82%b9)ではなく、[対面販売](https://md-next.jp/yougo/%E5%AF%BE%E9%9D%A2%E8%B2%A9%E5%A3%B2)を想定しています。

なので、買い物カゴに商品を入れてくれるのは店員さんで、その買い物カゴを確認してOKを出す感じです。

![](https://i.imgur.com/f2gUFXs.png)

この流れをAIエージェントに登場させることを考えていきましょう。

## その買い物、誰が間違えた...?

では、この流れでお買い物の一部をAIエージェントに任せることを想定してみます。

例えば、ユーザーの代わりにお買い物をするお買い物エージェント(Shopping Agent、以降SA)とお店の店員さんの代わりに業務をするお店エージェント(Merchant Agent、以降MA)が追加された図を考えていきます。

### ハルシネーション

まず思い浮かぶのは、AIエージェントのハルシネーション問題です。あたかも知ったように誤った情報をべらべら話すあの現象です。

お買い物というシチュエーションでこれが起きると大変です。しかも、考えられるミスのパターンが多いのも特徴です。

一番想像しやすいのは、ユーザーの意図（Intent)をSAが間違って理解してMAに伝えてしまうパターンです。伝言ゲーム的に間違った意図のもと購入が進められてしまいます。安い買い物ならまだしも、数百万の決済を勝手にやられては困ります。

![ia](https://i.imgur.com/P3B8dhg.png)

他にもMAが意図を間違えて解釈するケースもありそうです。

![aa](https://i.imgur.com/5XVBhIa.png)

さらに複雑なケースを想定すると、ユーザーの意図は正しく伝えられても、お店側の都合、例えばお得意さんしか売ってはいけない商品を売ってしまう、というMA側のコンテキスト不足によるミスもありそうです。

![aaa](https://i.imgur.com/E5N4Gjl.png)

### もっと悩ましいパターン

もっと悩ましいパターンも考えられます。例えばAさんが、AIエージェントには「かわいい犬のグッズがほしい」とお願いしておきながら、その意思を途中で変えてしまう、というものです。

心変わりしたり、いたずらだったり、勘違いだったり色々理由はあると思いますが、ユーザーから「実はかわいい猫のグッズがほしかった」と言われたら誰が責任を取るべきかわからなくなってしまうのも問題です。

![aaa](https://i.imgur.com/aL1N9Yl.png)

また、ユーザーになりすましてAIエージェントに購入の指示をされたりした場合にも同様の問題が起きてしまう可能性もあります。（なりすまし問題）

## AIエージェントが情報を知りすぎる問題

また、少し話の毛色は変わりますが、AIエージェント（SA）がユーザーの代わりにお買い物をする場合、ユーザーのお財布を勝手に使えてしまったりすることも問題です。

クレジットカード決済する場合を想定すると、カードの番号の他、有効期限や、CVC(Card Validation Code、カード裏面にある3桁くらいのコード)を知ってしまうことになります。これでは、万が一のときにカード情報が漏洩したり、AIエージェントが暴走して闇雲に高級品を買いまくったりする危険もありそうです。

加えて、AIエージェント（MA）がお店の決済システムに密結合になってしまうこともシステム保守観点で危うさがあります。

![aa](https://i.imgur.com/W4SrXsP.png)

## AP2ではどんな仕組みでこれらを解決しているのか

AP2ではこれらの課題を高度な暗号技術を組み合わせたデジタル署名をA2A(Agent2Agent)の通信にうまく拡張することで解決します。

### シーケンス

まずは、難しい用語抜きでわかりやすい（？）紙芝居をお見せし、それらで出てくる具体的な概念から用語を抑えたほうがきっとわかりやすいと確信したので、しばし紙芝居にお付き合いください。

（説明の都合で各ステップの順番を入れ替えている箇所があります。また、現時点シーケンスが公開されている[Illustrative Transaction Flow](https://ap2-protocol.org/specification/#71-illustrative-transaction-flow)を参考に作成しています）

![a](https://i.imgur.com/lKKSQnI.png)

まず、Aさんは「かわいい犬のグッズがほしい」「5000円以内」など具体的な購入意図をお買い物エージェント（Shopping Agent、SA）に指示します。すると、SAはその購入意図を汲み取ってお買い物を始めます。

実際にお買い物に移る前に、ユーザーと購入意図を委任状にしたIntent　Mandate、つまり「これから私AはSAに『かわいい犬のグッズを5000円以内』で購入することを委任します。」と委任状を取り交わします。Intent Mandateについては後ほど詳しくお話します。

と同時に、「むぎぼーショップ」のお店エージェント（Merchant Agent、MA）がSAに対して自分のお店の紹介も兼ねて名刺交換します。

A2Aに詳しい方ならピンとくると思いますが、A2AにおけるAgent Cardで自身の取り扱い状況やAP2に対応した購入体験ができますよ、ということを伝えてます。

![c](https://i.imgur.com/0KxrKpp.png)

次に、SAはMAと名刺交換した結果をもとにむぎぼーショップと取引をスタートすることを決めました。A2AのMessageを用いて、SA-MAのエージェント間通信を実施します。

ここでユーザーと取り交わしたIntent Mandateを送ることで、SAがユーザーの意図を確かに汲んだ購入をしていることをMAに示しつつ、目的の商品カートを作ってもらうことをお願いするわけです。

MAはユーザーのIntentを受けて、どんな商品セットがよいか検討を始めます。お店側（Merchant）の在庫状況や各商品の金額、説明などを見極め、ユーザーにぴったりな商品が入った商品カートを作成しにいきます。

![d](https://i.imgur.com/QVFkhfa.png)

さて、MAはついにユーザーにぴったりな商品の入った商品カートを作成しました。この商品カートの作成は本来はお店側(Merchant)が作るべきものですが、MAがお店の代わりに作成しているものですので、委任状の形でお店側の販売行為を委任していることを示す必要があります。

そこで、MAは商品カートの委任状（Cart Mandate）を作成し、お店側に確認と確かに確認したという署名をお店がつけます。

![b](https://i.imgur.com/wPZgNbR.png)

お店とMAの間での委任状の取り交わしが無事完了したら、その委任状（Cart Mandate）をSAに送信します。この商品カートをSAがユーザーに提示しながら実際の購入まで進めていくわけです。

![h](https://i.imgur.com/qNfLrKJ.png)

AさんはSAから提示された商品カートの委任状（Cart Mandate）に基づき、自身が購入する商品カートを確定させます。（Cart MandateはA2A Artifactsの形で複数提示もできるため、複数の候補から選択するUIも想定されうる）

確定した商品カートの委任状について、「確かにAが確定しましたよ」という意味合いで、ユーザーが署名をつけます。（実際にはDevice Attestationの動作が入りますが、Payment Mandateのところで説明します）

![i](https://i.imgur.com/rXcmmUi.png)

同時に、SAはユーザーが商品を購入するにあたっての支払い方法についても確認する必要があります。AP2では、Credential Provider(CP)という謎の概念が出てきます。

公式ドキュメントによると

> 3 The User’s Credentials Provider (CP): A specialized entity responsible for the secure management and execution of payments credentials (e.g. a digital Wallet). It holds knowledge of the User's available payment methods, gets user consent (if deemed necessary) to share credentials with the SA, selects the optimal payment method based on user preferences and transaction context, and handles payment scenarios like errors, declines and transaction challenges gracefully.

とあり、CPはユーザーの支払いおよびID資格情報を安全に管理・実行する専門的なエンティティの意味ですが、ようはデジタルウォレットと思っていただいて良さそうです。イメージとしてはGoogle PayやApple Payのようなスマートフォンからクレジットカードが使えるサービスが近いです。

のちのちユーザーに支払い方法を確認するため、CPに紐づく支払い方法を確認します。現状の仕様ではクレジットカードやデビットカードが選択可能だそうですが、将来的にはSuicaのようなサービスにも対応可能とのことです。

ここでポイントなのは、SAは支払い情報をユーザーに選択させるための最低限の情報（たとえばクレジットカードの下4桁とか）のみ受け取ります。

![f](https://i.imgur.com/Gyc2QU9.png)

では支払いに移りましょう。SAは先程CPから受け取った支払い情報からユーザーが利用する支払い方法を確定させます。ユーザーが支払いに利用するカードを確定させたら、CPにそのカードのトークン(支払い方法トークン、payment method token)を発行依頼します。

このトークンは、一時的な支払い利用の可能なカード情報となります。ただし、トークンには一切支払いに必要な情報(PCIデータ、カード番号とか)は含まれません。CPにはトークンと実情報のマッピングが存在するため、CPを経由することで支払いが可能となるわけです。またトークンはしばしば期限付きの支払能力のある代替通貨となる場合が多いので発行は実際のクレジットカードの決済ネットワークと連携して行われる形です。

支払い方法トークンが取得できたらSAは支払い委任状（Payment Mandate）を作成します。これは商品の細かな明細を含まない合計金額や支払い方法を明記した簡素な委任状となります。まず、ユーザーに「私SAはAさんに変わってこの委任状の通り支払いしますよ」という委任状をSAは提示し、ユーザーから署名をもらうことでユーザー意思を確定させます。

このとき、device attestationの動きが入ります。これはトランザクションの信頼性と否認不可能性を高めるためとされ、TPM、Secure Enclaveなどを用いて、ハードウェアに裏打ちされたキーとインセッション認証（生体認証など）を通じて実行されます。こうすることで確実にAさんが承認しましたよ。という血判状になるんですね。

![e](https://i.imgur.com/ATRxVXv.png)

ユーザー署名付き支払い委任状（Payment Mandate）が出来上がったら、MAに送信し、いよいよ支払いに移ります。

ここで重要なのは、支払い処理そのものはMAは実施せず、お店に紐づく支払いエンティティ（Merchant Payment Processor、MPP）が実施します。これは明確な職務分離というAP2の基本概念に従った実装となります。

![g](https://i.imgur.com/2sJ5eqV.png)

支払いが完了したら領収書をMPPが発行し、CPとSAに送信します。SAは領収書を受け取ってユーザーに取引の完了を伝えます。これがAP2で実現される動きです。



### 委任状（Mandate）

あらためて、AP2を語るうえで欠かせないのが委任状(Mandate)と呼ばれるデジタル署名付きの正式な委任証明の仕組みを再確認しましょう。

詳細はこのあとのコードでの説明で語ることとして、ユーザー・AIエージェント・お店などがそれぞれ持っている秘密鍵を使って委任状のJSONにデジタル署名を行い、その検証を各工程で実施することで、その委任が各エンティティが確実に実施したことを保証してます。デジタル署名を使ってそれぞれのエンティティが内容に承認、署名する仕組みがAP2の一番面白いところと言えるでしょう。

委任状（Mandate）には3種類あり、各シーケンスで必要な情報を送受信します。

#### Intent Mandate

まずはIntent Mandateです。これは、ユーザーの購入意図(Intent)を示すものです。

SAが作成し、ユーザーへ「あなたの購入意図はこうだよね？これでMAに依頼するけどいいかな？」といった具合で確認をとり、確認がとれたらそれをMAに伝えます。

「ユーザーの確認」をとって、と述べましたが、ユーザーの関与の仕方（トランザクションの様式）によってユーザーの署名が必要か署名が不要か変わってきます。トランザクションの様式については後ほど説明します。

今回のデモアプリは、シーケンスの細かいところまで割れているHuman in presentというトランザクションの様式で作成しているため、より革新的な技術であるHuman not in presentはあまりわかっていません。もう少し仕様がわかってきたらこちらも試してみたいと思います。

#### Cart Mandate

次にCart Mandateです。これは、MAが作成してきた商品が入ったカートを指します。

この商品カートが「本当に売っていいものなのか」、「本当に買いたいものなのか」をお店側、ユーザー双方に承認を取ることで購入へと進みます。

こちらもHuman in presentとHuman not in presentの場合で動きが異なるのですが、Human in presentの場合、購入の確定という意味でユーザーの署名が必要になります。一方で、Human not in presentの場合は、Intent Mandateにてユーザーの意図に基づき、購入を自動で遂行する必要があるため、ユーザー署名がこのタイミングで不要な場合がおおいです。

ちなみに、お店側の署名はどのトランザクションでも必要になります。

#### Payment Mandate

最後にPayment Mandateです。これはSAがユーザーに代わって支払いをするうえで必要な委任状でユーザーの署名と支払いに関するトークンが含まれているのが特徴です。

