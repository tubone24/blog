---
slug: 2025-10-29/AP2に入門する
title: "AP2に入門する"
date: 2025-10-29T04:00:20+0000
description: AP2(Agent Payments Protocol)に入門してみます。
tags:
  - fixme
headerImage: https://i.imgur.com/QmIHfeR.jpg
templateKey: blog-post
---

お久しぶりです。

## Table of Contents

```toc

```

## すごいせっかちな人向けに

デモアプリを作ってみました。

## AP2に入門してみたくなった。

突然ですが、育休を取っているのですが、なにか新しい技術を学んでおかないと復帰後不安で押しつぶされそうなので、重い腰をあげてAP2([Agent Payments Protocol](https://ap2-protocol.org/))に入門しようと思います。

どうにも生成AIの世界は謎のプロトコルが次々とでてくる...。この前MCPに入門したと思ったら、A2A、そしてAP2...。困りましたね。

AP2とは、Googleによると

> 主要な決済企業やテクノロジー企業と共同で開発されたオープン プロトコルで、プラットフォームをまたいでエージェント主導の決済を安全に開始、実行するもの

とのことで、要はAIエージェントを絡めたお買い物、決済を考えたときに起こり得る様々な不都合や問題をうまい具合に解決する仕組みです。

そもそもAIエージェントを用いたお買い物で起こり得る問題ってなんでしょうか。

## まず人間の買い物を想像してみましょう

AP2を考える前に、まずは人間の買い物を想像してみましょう。

![a](https://i.imgur.com/hvUOvHi.png)

Aさんは「かわいい犬のグッズ」がほしいな〜と思っているとします。ちなみに「『かわいい犬のグッズ』がほしいな〜」という気持ち(意図)のことをAP2では、Intentといいます。

しばらく歩いていると、「むぎぼーショップ」というかわいい柴犬をモチーフにしたお店を発見しました。入ってみましょう。

「むぎぼーショップ」は店員さんがとても優秀で、お客様の気持ちによりそった最適な商品を提示してくれるお店でした。細かい要望を伝えると、在庫を確認した後予算内でいくつか商品をピックアップしてくれました。（おすすめセットのリストを作ってくれました）

![a](https://i.imgur.com/E2feFkd.png)

Aさんもおすすめセットに納得したようで支払い手続きに進みます。お店に設置されているxxPayの端末を使ってお会計を済ませます。商品と領収書をもらってお買い物完了です。

![a](https://i.imgur.com/dXUyJlg.png)

以上が人間のお買い物でした。ポイントとしてAP2で想定されるお買い物は、スーパーなどの[セルフサービス方式](https://md-next.jp/yougo/%e3%82%bb%e3%83%ab%e3%83%95%e3%82%b5%e3%83%bc%e3%83%93%e3%82%b9)ではなく、[対面販売](https://md-next.jp/yougo/%E5%AF%BE%E9%9D%A2%E8%B2%A9%E5%A3%B2)を想定しています。

なので、買い物カゴに商品を入れてくれるのは店員さんで、その買い物カゴを確認してOKを出す感じです。

![](https://i.imgur.com/f2gUFXs.png)

この流れをAIエージェントに登場させることを考えていきましょう。

## その買い物、誰が間違えた...?

では、この流れでお買い物の一部をAIエージェントに任せることを想定してみます。

例えば、ユーザーの代わりにお買い物をするお買い物エージェント(Shopping Agent、以降SA)とお店の店員さんの代わりに業務をするお店エージェント(Merchant Agent、以降MA)が追加された図を考えていきます。

### ハルシネーション

まず思い浮かぶのは、AIエージェントのハルシネーション問題です。あたかも知ったように誤った情報をべらべら話すあの現象です。

お買い物というシチュエーションでこれが起きると大変です。しかも、考えられるミスのパターンが多いのも特徴です。

一番想像しやすいのは、ユーザーの意図（Intent)をSAが間違って理解してMAに伝えてしまうパターンです。伝言ゲーム的に間違った意図のもと購入が進められてしまいます。安い買い物ならまだしも、数百万の決済を勝手にやられては困ります。

![ia](https://i.imgur.com/P3B8dhg.png)

他にもMAが意図を間違えて解釈するケースもありそうです。

![aa](https://i.imgur.com/5XVBhIa.png)

さらに複雑なケースを想定すると、ユーザーの意図は正しく伝えられても、お店側の都合、例えばお得意さんしか売ってはいけない商品を売ってしまう、というMA側のコンテキスト不足によるミスもありそうです。

![aaa](https://i.imgur.com/E5N4Gjl.png)

### もっと悲しいパターン

もっと邪悪なパターンも考えられます。例えばAさんが、AIエージェントには「かわいい犬のグッズがほしい」とお願いしておきながら、その意思を途中で変えてしまう、というものです。

心変わりしたり、いたずらだったり、勘違いだったり色々理由はあると思いますが、ユーザーから「実はかわいい猫のグッズがほしかった」と言われたら誰が責任を取るべきかわからなくなってしまうのも問題です。

![aaa](https://i.imgur.com/aL1N9Yl.png)

また、ユーザーになりすましてAIエージェントに購入の指示をされたりした場合にも同様の問題が起きてしまう可能性もあります。（なりすまし問題）

## AIエージェントが情報を知りすぎる問題

また、少し話の毛色は変わりますが、AIエージェント（SA）がユーザーの代わりにお買い物をする場合、ユーザーのお財布を勝手に使えてしまったりすることも問題です。

クレジットカード決済する場合を想定すると、カードの番号の他、有効期限や、CVC(Card Validation Code、カード裏面にある3桁くらいのコード)を知ってしまうことになります。これでは、万が一のときにカード情報が漏洩したり、AIエージェントが暴走して闇雲に高級品を買いまくったりする危険もありそうです。

加えて、AIエージェント（MA）がお店の決済システムに密結合になってしまうこともシステム保守観点で危うさがあります。

![aa](https://i.imgur.com/W4SrXsP.png)

## AP2ではどんな仕組みでこれらを解決しているのか

AP2ではこれらの課題を高度な暗号技術を組み合わせたデジタル署名をA2A(Agent2Agent)の通信にうまく拡張することで解決します。

### 委任状（Mandate）

AP2を語るうえで欠かせないのが委任状(Mandate)と呼ばれるデジタル署名付きの正式な委任証明の仕組みです。

詳細はこのあとのコードでの説明で語ることとして、ユーザー・AIエージェント・お店などがそれぞれ持っている秘密鍵を使って委任状のJSONにデジタル署名を行い、その検証を各工程で実施することで、その委任が各エンティティが確実に実施したことを保証してます。デジタル署名を使ってそれぞれのエンティティが内容に承認、署名する仕組みがAP2の一番面白いところと言えるでしょう。

委任状（Mandate）には3種類あり、各シーケンスで必要な情報を送受信します。

#### Intent Mandate

#### Cart Mandate

#### Payment Mandate

### シーケンス

