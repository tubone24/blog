---
slug: 2021/01/01/mqtt-nenga
title: MQTTと電子ペーパーを使って年賀状を作る
date: 2020-12-31T12:58:01.960Z
description: MQTTと電子ペーパーとFastAPIとReact HooksとTailwind CSSを使って年賀状を作る
tags:
  - MQTT
  - RaspberryPi
  - 年賀状
headerImage: https://i.imgur.com/QmIHfeR.jpg
templateKey: blog-post
---

年賀書きたくないマン

## Table of Contents

```toc

```

## 一年の計は元旦にあり

あけましておめでとうございます。昨年は大変お世話になりました。本年もどうぞよろしくお願いします。

さて、お世話になったみなさまに年賀状を送りたいのですが、私は年賀状を書くのが苦手です。

というより、まず手書き文字が苦手なのと、文面を考えるのが苦手なのと、郵便局に行くのがめんどくさいのと、滅多にポストをあけないのが原因なのですが、

ともあって今年も年賀状を締め切りまでに出すことができませんでした。

なんというダメ人間。

年賀状って以下の点が辛いんですね。

- はがきを書ってこなければ行けない
- 専用のソフト、プリンターがないと一枚一枚手書きで辛い
- 郵便局に出し行かないといけない
- 宛先違うだけでたくさん刷らないといけない
- 年賀ハガキクジが当たらない

ということで、せっかくなのでこれらのお困りごとを解決するツールをさっそく作ってみることにしました。

## 注意

今回の記事ですが、やたら～BOXというワードが出てきます。

大意はないのですが、筆者が年末にみたとあるネット記事がマイブームになってしまい、使わざるを得えませんでした。

読み苦しい限りですがおつきあいくださいませ。

## 年末年始はやってみようBOX

年末年始という長期休暇は普段忙しくて出来ないアレコレを入れてあるやってみようBOXをあける日です。

仕事のことは考えてもしょうがないBOXです。

ということでこちらのツールですが先に技術選定からしていきます。

### MQTT

MQTTとは

### React Hooks

こちらも今更？感ありますが、

### Tailwind CSS

TrySailのアルバムにTailwindというものがありましたが、こちらも使っていきます。

## やらないことにしようBOX

色々選定時迷いましたが、一度にたくさんのことをやり過ぎるとやれなくてもやもやBOXに入ってしまうので元旦までに実装完了させるためにも、泣く泣くやらないことにしました。

いつかやるBOXだ。

- RustのWAF
  - MQTTのクライアントでRUSTで使えそうなものがぱっと見つからなかったため断念
- AWS IoT
  - 本当は使いたかったが、金がない&MQTTブローカーを一から作ってみたかったため断念、いつかやる
- WASM
  - 少しやって挫けるので今回はスキップ。いつかやりたいですね。
- Recoil
  - 流行っているのか怪しかったからパス。ファーストペンギンはいつだって怖い。

## アーキテクチャー

こんな感じになりました。

図

フロントからAPIコールされるとバックエンドサーバーで画像生成し、ByteArrayに変換後、MQTTブローカーにパブリッシュをします。

MQTTブローカーでは受け取ったメッセージを同一トピックをサブスクライブしているサブスクライバーに投げます。

ここでMQTT over WebSocketなどでトピックに流れるメッセージを待ち受けていれば、MQTT同様にサブスクライブできます。

サブスクライバーではメッセージを受け取るとon_messageイベントが発生するため、受け取ったByteArrayから画像を再生し、電子ペーパーの制御モジュールに渡します。

## 辛かったこと

### Hooksわかんねぇ！型チェックとおらねぇ！！

これは考えてもしょうがないBOXなのかもしれませんが、React HooksでReaderを使うの、難しくありません？

### Tailwind結局つかいこなせない問題

デザインというか、そういった素養がなさすぎて、むしろ私にはMaterial UIの出来きったフレームワークが使いやすかったです。

ほぼすべて、結局Tailwind ComponentからコピってReact向けに直して、ちょっと修正して、で作ったので恩恵なしで時間ばかりかかってしまいました。

## 思い通り進んだところ

### FastAPI

FastAPIの実装はスムーズでした。簡単なAPIを短時間で作らなければならないようなハッカソンや1dスプリントなんかにはとてもいいのではないでしょうか？

癖があるとしたらstaticsファイルのホスティングに使う～というモジュールを使うときになぜか、～というライブラリーが必要なことです。

デフォルトでいれないんかい。

とはいえ、しっかりエラーでModuleNotFoundエラーが出るのでそこまで困ることもないです。

### MQTT

くっそ難しいのかな？と思いましたがpahoがいい感じにラップしていてくれるので、何のことはなかったです。

### mosquitto

こちらもあっさりでした。

Dockerを使ったからか、ほぼ公式通りのconfigで通りました。

## できあがったもの

できあがったものの、ソースコードはこちらにあります。

EKSにのっけて公開しようかと悩んだのですが、サービス使わないで年賀状が一通もこないのも悲しいので、検証が終わったら壊しました。

というかEKSに載っけるなら最初からAWS IoTにすればよかったですね。

考えてもしょうがないBOX


