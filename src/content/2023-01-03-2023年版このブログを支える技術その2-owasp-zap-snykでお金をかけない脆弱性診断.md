---
slug: 2022/01/03/owaspzap
title: 2023年版このブログを支える技術その2(Owasp ZAP / Snykでお金をかけない脆弱性診断)
date: 2023-01-03T05:24:38.716Z
description: 2023年版このブログを支える技術その2(Owasp ZAP / Snykでお金をかけない脆弱性診断)
headerImage: https://i.imgur.com/QmIHfeR.jpg
templateKey: blog-post
---
## Table of Contents

第二段です。

```toc

```

みなさま、お疲れさまでございます。

本年も始まってしまい、すっかり仕事モードかと思いますが、引き続きこのブログを支えてる技術をご紹介したいと思います。

今回はセキュリティ編、ということでSnykとOwasp ZAPを使ってお金をかけない脆弱性診断を個人開発でも実現できる方法を検討していきたいと思います。

## Snyk

Snykというサービスを皆さま御存知でしょうか？

長年、特に最近のDependabotがGitHubで使えるようになったりとか、そういう時代の前くらいからライブラリのセキュリティ対策に興味のあった人ならご存じかもしれません。

公式の[Webサイト]()では次のようにサービスが紹介されております。

> Snyk（スニーク）は、安全な開発を迅速に行うことを支援しています。コードやオープンソースとその依存関係、コンテナやIaC(Infrastructure as Code)における脆弱性を見つけるだけでなく、優先順位をつけて自動的に修正します。
> 
> Gitや統合開発環境(IDE)、CI/CDパイプラインに直接組み込むことができるので、デベロッパーが簡単に使うことができます。

ずっとライブラリの依存関係から更新検知および更新の適用をしてくれるサービスだと思ってましたが、コンテナ・IaCなんかにも使えるんですね。知らなかった。

ちなみに、私とSnykの最初の出会いはヘニャヘニャエンジニア時代に作った[ショボいサービス](https://github.com/tubone24/ebook_homebrew#snyk)で導入したのが最初です。当時は若かった...。

久しぶりにSnykを触っていくつか個人的にいいな〜と思った機能があったのでそちらのご紹介とGitHub Actionsへの載せ方を少し検討してみたいと思います。

### Snyk CLIを使った依存関係の脆弱性チェック

まず、Snyk CLIを使った脆弱性チェックを実施します。

Snyk CLIを使うにはSnyk CLIをインストールする必要があるのですが、こちらはnpm, yarn経由でかんたんにインストールできます。

```shell{promptUser: tubone}{promptHost: dev.localhost}
yarn global add snyk
```

ローカルでSnykを実行する場合、認証リンクによるログインが必要となります。

```shell{promptUser: tubone}{promptHost: dev.localhost}
Snyk auth
```

がしかし、今回はCI経由から実行するため認証リンクを踏んでいく手順は使えないため、あらかじめ **SNYK_TOKEN** をenvに設定しておきます。

SNYK_TOKENは[アカウント設定](https://app.snyk.io/account)から取得できます。GitHub ActionsのSecretsなどに仕込んでおきましょう。

依存関係の脆弱性チェックをする際はプロジェクトルートで下記のコマンドを実行するだけです。

```shell{promptUser: tubone}{promptHost: dev.localhost}
snyk test .
```

すると、次のような依存関係のパッケージの脆弱性がリストされました。(ちゃんと対応します...)

```
Testing ....

Tested 1657 dependencies for known issues, found 6 issues, 16 vulnerable paths.


Issues to fix by upgrading:

  Upgrade gatsby-transformer-remark@5.23.1 to gatsby-transformer-remark@6.0.0 to fix
  ✗ Regular Expression Denial of Service (ReDoS) [Medium Severity][https://security.snyk.io/vuln/SNYK-JS-SANITIZEHTML-2957526] in sanitize-html@2.3.2
    introduced by gatsby-transformer-remark@5.23.1 > sanitize-html@2.3.2


Issues with no direct upgrade or patch:
  ✗ Regular Expression Denial of Service (ReDoS) [High Severity][https://security.snyk.io/vuln/SNYK-JS-ANSIREGEX-1583908] in ansi-regex@2.1.1
    introduced by gatsby@4.25.1 > gatsby-cli@4.25.0 > pretty-error@2.1.2 > renderkid@2.0.7 > strip-ansi@3.0.1 > ansi-regex@2.1.1
  This issue was fixed in versions: 3.0.1, 4.1.1, 5.0.1, 6.0.1
  ✗ Denial of Service (DoS) [High Severity][https://security.snyk.io/vuln/SNYK-JS-DECODEURICOMPONENT-3149970] in decode-uri-component@0.2.1
    introduced by gatsby@4.25.1 > query-string@6.14.1 > decode-uri-component@0.2.1 and 1 other path(s)
  This issue was fixed in versions: 0.2.2
  ✗ Regular Expression Denial of Service (ReDoS) [Medium Severity][https://security.snyk.io/vuln/SNYK-JS-HTMLMINIFIER-3091181] in html-minifier@4.0.0
    introduced by html-minifier@4.0.0
  No upgrade or patch available
  ✗ Prototype Pollution [Medium Severity][https://security.snyk.io/vuln/SNYK-JS-JSON5-3182856] in json5@1.0.1
    introduced by babel-loader@8.3.0 > loader-utils@2.0.4 > json5@2.2.1 and 9 other path(s)
  This issue was fixed in versions: 1.0.2, 2.2.2
  ✗ Command Injection [High Severity][https://security.snyk.io/vuln/SNYK-JS-LODASHTEMPLATE-1088054] in lodash.template@4.5.0
    introduced by gatsby-plugin-offline@5.23.1 > workbox-build@4.3.1 > lodash.template@4.5.0
  No upgrade or patch available



Organization:      tubone24
Package manager:   yarn
Target file:       yarn.lock
Project name:      blog
Open source:       no
Project path:      .
Licenses:          enabled
```

ちなみに、指摘されている脆弱性ですが、別で回しているDependabotでも同様のアラートが出ております。

Dependabotとの検知力の差はわかってませんがおそらく情報提供元はCVEと思うのでほぼ大差はないかと思います。依存関係の脆弱性チェックであればどちらを使っても良さそうに思いました。

ただ、SnykのほうがDependabotに比べリファレンスがわかりやすい気がしました。

![ref snyk](https://i.imgur.com/g5fWDjA.png)

ちなみに、依存関係の脆弱性はCLIを使わずともGitHubレポジトリの連携だけでSnyk上で依存関係を使っているパッケージ管理システム(npmとか)を追いかけて調べてくれます。

なので、Snykとの連携を済ませていれば必ずしもCLIで実行する必要はないとは思いますが、今回はCIのトリガーと連携したいなと思い、CLI経由で依存関係の脆弱性をチェックすることにした、というわけです。

![snyk dashboard](https://i.imgur.com/he9u9kb.png)

### Snyk CLIを使ったコードチェック

Snyk CLIには静的コード解析で脆弱なコードをスキャンしてくれる機能もあります。

使い方は超カンタンで、

```shell{promptUser: tubone}{promptHost: dev.localhost}
snyk code test .
```

とすると、

```
Testing . ...

 ✗ [Medium] Open Redirect 
   Path: src/templates/index.tsx, line 133 
   Info: Unsanitized input from the document location flows into url, where it is used as an URL to redirect the user. This may result in an Open Redirect vulnerability.


✔ Test completed

Organization:      tubone24
Test type:         Static code analysis
Project path:      .

Summary:

  1 Code issues found
  1 [Medium] 

```

という感じで[Open redirect](https://learn.snyk.io/lessons/open-redirect/javascript/)のエラーが出てますね...。

ちょっと直していきましょう。エラーになったコードは次のTSXです。

```jsx
     <div>
        <main>
            なんらかのページ
        </main>
        <div className="col-xl-2 col-lg-1 order-3" />
      </div>
      <ShareBox
        url={String(location.href)}
        hasCommentBox={false}
      />
```

Shareboxコンポーネントですが、表示されているページのURLを渡すことでTwitterやFacebookのShare Linkを作成する、というものでえす。

特に不正なリダイレクトURLを埋め込まれるような使い方はあまり想定されてないコンポーネントですが、ブログ内で不正はURLへ遷移し、そこでたまたまShareboxを開かれてしまうと、

任意のShare Linkが作れてしまうかもしれません。(もちろん、不正なURL404 Not Foundページに遷移するのでShareboxは出ませんが)

こちら、ドメインを固定することで攻撃を回避できそうです。

```jsx
      <ShareBox
        url={config.siteUrl + String(location.pathname)}
        hasCommentBox={false}
      />
```

これで、エラーがパスしました！

```
Testing . ...


✔ Test completed

Organization:      tubone24
Test type:         Static code analysis
Project path:      .

Summary:

✔ Awesome! No issues were found.
```

### GitHub Actionsに組み込んでみる

さて、それではSynk CLIの実行結果を毎回PRごとに取得し、PRのコメントとして通知する仕組みを検討します。