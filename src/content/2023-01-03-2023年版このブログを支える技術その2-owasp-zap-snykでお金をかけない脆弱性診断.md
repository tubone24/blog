---
slug: 2022/01/03/owaspzap
title: 2023年版このブログを支える技術その2(Owasp ZAP / Snykでお金をかけない脆弱性診断)
date: 2023-01-03T05:24:38.716Z
description: 2023年版このブログを支える技術その2(Owasp ZAP / Snykでお金をかけない脆弱性診断)
headerImage: https://i.imgur.com/QmIHfeR.jpg
templateKey: blog-post
---
## Table of Contents

第二段です。

```toc

```

みなさま、お疲れさまでございます。

本年も始まってしまい、すっかり仕事モードかと思いますが、引き続きこのブログを支えてる技術をご紹介したいと思います。

今回はセキュリティ編、ということでSnykとOwasp ZAPを使ってお金をかけない脆弱性診断を個人開発でも実現できる方法を検討していきたいと思います。

## Snyk

Snykというサービスを皆さまご存じでしょうか？

長年、特に最近のDependabotがGitHubで使えるようになったりとか、そういう時代の前くらいからライブラリのセキュリティ対策に興味のあった人ならご存じかもしれません。

公式の[Webサイト]()では次のようにサービスが紹介されております。

> Snyk（スニーク）は、安全な開発を迅速に行うことを支援しています。コードやオープンソースとその依存関係、コンテナやIaC(Infrastructure as Code)における脆弱性を見つけるだけでなく、優先順位をつけて自動的に修正します。
> 
> Gitや統合開発環境(IDE)、CI/CDパイプラインに直接組み込むことができるので、デベロッパーが簡単に使うことができます。

ずっとライブラリの依存関係から更新検知および更新の適用をしてくれるサービスだと思ってましたが、コンテナ・IaCなんかにも使えるんですね。知らなかった。

ちなみに、私とSnykの最初の出会いはヘニャヘニャエンジニア時代に作った[ショボいサービス](https://github.com/tubone24/ebook_homebrew#snyk)で導入したのが最初です。当時は若かった...。

久しぶりにSnykを触っていくつか個人的にいいな〜と思った機能があったのでそちらのご紹介とGitHub Actionsへの載せ方を少し検討してみたいと思います。

### Snyk CLIを使った依存関係の脆弱性チェック

まず、Snyk CLIを使った脆弱性チェックを実施します。

Snyk CLIを使うにはSnyk CLIをインストールする必要があるのですが、こちらはnpm, yarn経由でかんたんにインストールできます。

```shell{promptUser: tubone}{promptHost: dev.localhost}
yarn global add snyk
```

ローカルでSnykを実行する場合、認証リンクによるログインが必要となります。

```shell{promptUser: tubone}{promptHost: dev.localhost}
Snyk auth
```

がしかし、今回はCI経由から実行するため認証リンクを踏んでいく手順は使えないため、あらかじめ **SNYK_TOKEN** をenvに設定しておきます。

SNYK_TOKENは[アカウント設定](https://app.snyk.io/account)から取得できます。GitHub ActionsのSecretsなどに仕込んでおきましょう。

依存関係の脆弱性チェックをする際はプロジェクトルートで下記のコマンドを実行するだけです。

```shell{promptUser: tubone}{promptHost: dev.localhost}
snyk test .
```

すると、次のような依存関係のパッケージの脆弱性がリストされました。(ちゃんと対応します...)

```
Testing ....

Tested 1657 dependencies for known issues, found 6 issues, 16 vulnerable paths.


Issues to fix by upgrading:

  Upgrade gatsby-transformer-remark@5.23.1 to gatsby-transformer-remark@6.0.0 to fix
  ✗ Regular Expression Denial of Service (ReDoS) [Medium Severity][https://security.snyk.io/vuln/SNYK-JS-SANITIZEHTML-2957526] in sanitize-html@2.3.2
    introduced by gatsby-transformer-remark@5.23.1 > sanitize-html@2.3.2


Issues with no direct upgrade or patch:
  ✗ Regular Expression Denial of Service (ReDoS) [High Severity][https://security.snyk.io/vuln/SNYK-JS-ANSIREGEX-1583908] in ansi-regex@2.1.1
    introduced by gatsby@4.25.1 > gatsby-cli@4.25.0 > pretty-error@2.1.2 > renderkid@2.0.7 > strip-ansi@3.0.1 > ansi-regex@2.1.1
  This issue was fixed in versions: 3.0.1, 4.1.1, 5.0.1, 6.0.1
  ✗ Denial of Service (DoS) [High Severity][https://security.snyk.io/vuln/SNYK-JS-DECODEURICOMPONENT-3149970] in decode-uri-component@0.2.1
    introduced by gatsby@4.25.1 > query-string@6.14.1 > decode-uri-component@0.2.1 and 1 other path(s)
  This issue was fixed in versions: 0.2.2
  ✗ Regular Expression Denial of Service (ReDoS) [Medium Severity][https://security.snyk.io/vuln/SNYK-JS-HTMLMINIFIER-3091181] in html-minifier@4.0.0
    introduced by html-minifier@4.0.0
  No upgrade or patch available
  ✗ Prototype Pollution [Medium Severity][https://security.snyk.io/vuln/SNYK-JS-JSON5-3182856] in json5@1.0.1
    introduced by babel-loader@8.3.0 > loader-utils@2.0.4 > json5@2.2.1 and 9 other path(s)
  This issue was fixed in versions: 1.0.2, 2.2.2
  ✗ Command Injection [High Severity][https://security.snyk.io/vuln/SNYK-JS-LODASHTEMPLATE-1088054] in lodash.template@4.5.0
    introduced by gatsby-plugin-offline@5.23.1 > workbox-build@4.3.1 > lodash.template@4.5.0
  No upgrade or patch available



Organization:      tubone24
Package manager:   yarn
Target file:       yarn.lock
Project name:      blog
Open source:       no
Project path:      .
Licenses:          enabled
```

ちなみに、指摘されている脆弱性ですが、別で回しているDependabotでも同様のアラートが出ております。

Dependabotとの検知力の差はわかってませんがおそらく情報提供元はCVEと思うのでほぼ大差はないかと思います。依存関係の脆弱性チェックであればどちらを使っても良さそうに思いました。

ただ、SnykのほうがDependabotに比べリファレンスがわかりやすい気がしました。

![ref snyk](https://i.imgur.com/g5fWDjA.png)

ちなみに、依存関係の脆弱性はCLIを使わずともGitHubレポジトリの連携だけでSnyk上で依存関係を使っているパッケージ管理システム(npmとか)を追いかけて調べてくれます。

なので、Snykとの連携を済ませていれば必ずしもCLIで実行する必要はないとは思いますが、今回はCIのトリガーと連携したいなと思い、CLI経由で依存関係の脆弱性をチェックすることにした、というわけです。

![snyk dashboard](https://i.imgur.com/he9u9kb.png)

### Snyk CLIを使ったコードチェック

Snyk CLIには静的コード解析で脆弱なコードをスキャンしてくれる機能もあります。

使い方は超カンタンで、

```shell{promptUser: tubone}{promptHost: dev.localhost}
snyk code test .
```

とすると、

```
Testing . ...

 ✗ [Medium] Open Redirect 
   Path: src/templates/index.tsx, line 133 
   Info: Unsanitized input from the document location flows into url, where it is used as an URL to redirect the user. This may result in an Open Redirect vulnerability.


✔ Test completed

Organization:      tubone24
Test type:         Static code analysis
Project path:      .

Summary:

  1 Code issues found
  1 [Medium] 

```

という感じで[Open redirect](https://learn.snyk.io/lessons/open-redirect/javascript/)のエラーが出てますね...。

ちょっと直していきましょう。エラーになったコードは次のTSXです。

```jsx
     <div>
        <main>
            なんらかのページ
        </main>
        <div className="col-xl-2 col-lg-1 order-3" />
      </div>
      <ShareBox
        url={String(location.href)}
        hasCommentBox={false}
      />
```

Shareboxコンポーネントですが、表示されているページのURLを渡すことでTwitterやFacebookのShare Linkを作成する、というものでえす。

特に不正なリダイレクトURLを埋め込まれるような使い方はあまり想定されてないコンポーネントですが、ブログ内で不正はURLへ遷移し、そこでたまたまShareboxを開かれてしまうと、

任意のShare Linkが作れてしまうかもしれません。(もちろん、不正なURL404 Not Foundページに遷移するのでShareboxは出ませんが)

こちら、ドメインを固定することで攻撃を回避できそうです。

```jsx
      <ShareBox
        url={config.siteUrl + String(location.pathname)}
        hasCommentBox={false}
      />
```

これで、エラーがパスしました！

```
Testing . ...


✔ Test completed

Organization:      tubone24
Test type:         Static code analysis
Project path:      .

Summary:

✔ Awesome! No issues were found.
```

### GitHub Actionsに組み込んでみる

さて、それではSynk CLIの実行結果を毎回PRごとに取得し、PRのコメントとして通知する仕組みを検討します。

Synk CLIには結果をJSONで吐き出してParseする方法もありますが、今回は標準出力をそのままGitHubのPRコメントにする方法で行きたいと思います。

[こんな感じ](https://github.com/tubone24/blog/blob/daa58646cb8f381dff69199e2f0e323b59d0e9c8/.github/workflows/previewDeploy.yml#L366-L456)で実装し、Snykのコマンド結果をcomments_urlに送信します。

(上記ではプラスしてIaCとContainerのtestもしてます。)

![preview](https://i.imgur.com/mUDXQfl.gif)

こんな感じで、GitHubのPRに結果が送信されるようになりました！

## OWASP ZAP

Snykを使って脆弱性になりえるコードやパッケージの排除はできましたが自分たちのアプリケーションそのものへの脆弱性診断もぜひ実施していきたいです。

ただ、本格的な脆弱性診断は実施コストが大きいこともありかんたんにできるものではないのもまた事実で、特に個人開発では実施ハードルは高いです。

また、この手の診断は定期的にやってこそ価値があるものですが、定期的に実施する仕組みを作っていくのも難しいものです。

そんなツラミを解決してくれる手段の一つが今回ご紹介するOWASP ZAPです。

[OWASP ZAP（オワスプザップ）](https://www.zaproxy.org/)とは、[OWASP](https://owasp.org/www-chapter-japan/)が提供するOSS版のWebアプリケーション脆弱性診断ツールです。

クライアントソフトの他、Docker Imageなんかも公開されています。

### 注意

ここで気をつけなければいけないのが、OWASP ZapのActive Scanはめちゃくちゃシステムへの攻撃を積極的に実施します。

ある意味クラッカーさんがやる攻撃手法をやってみて脆弱性につながる応答が返ってこないかをみるのが目的のため当たり前ですが、 **決して自分の管理しているシステム以外には実施しないでください。**

また、自分が管理しているシステムでも、利用しているクラウドサービスなどでは追加の申請が必要なケースもあります。十分に調べてから実施をおすすめします。

今回はそういった紛らわしい申請をすり抜けるべく、無料でOWASP ZAPを使ったActive ScanをGitHub Actions内に構築したクローズドなコンテナに対して実行することで、安全に脆弱性診断を実施し、診断レポートも出力することを目的にします。

### Owasp ZAPの起動方法

Owasp ZAP公式からDocker Imageが配布されているため、提供されているImageを使えばかんたんにツールの起動ができます。

ローカル環境にてOwasp ZAPWeb GUIを起動するなら下記のようなDocker Composeを作ってあげればかんたんに立ち上げ可能です。

```yaml
version: '3'

services:
  web:
    container_name: web-target
    build:
      context: ../
      dockerfile: owasp/Dockerfile
    command:
      - "npx"
      - "serve"
      - "-s"
      - "-l"
      - "9000"
      - "public"
    ports:
      - "9000:9000" # yarn serve
      - "8000:8000" # yarn dev
    networks:
      - myNW
    tty: true

  owasp:
    container_name: owasp-web-ui
    image: owasp/zap2docker-stable
    command: bash -c "zap.sh -cmd -addonuninstall hud && zap-webswing.sh"
    volumes:
      - ./zap:/zap/wrk/
    ports:
      - "18081:8080"
      - "18090:8090"
    depends_on:
      - web
    networks:
      - myNW
      - default
    tty: true

networks:
  myNW:
    internal: true
```

今回は簡易的に、下記2コンテナでじっしします。

- web-target: 攻撃対象、つまり自身のアプリケーションが動くコンテナ
  - 例では簡易的にserveを使ってホスティングしているだけの環境です。テスト対象のDocker Imageを起動させてあげます。
  - 実際のこのブログではNetlifyにホスティングしているだけなので、Docker container上で動くWebアプリケーションではありません。なので、インフラ周りの警告が出てくる箇所は実際のNetlify環境とは異なるかもしれないということをご了承ください。
  - ポイントはnetworkをInternalにしてOWASP ZAP以外アクセスできないようにしております。
- owasp-web-ui: OWASP ZAPが動くコンテナです
  - 別のアプリケーションの都合で便宜的に8080ポートを18081に設定してますが、<http://localhost:18080/zap> にアクセスすることでOWASP ZAPのWeb GUIが起動します。
  - [18090(8090)ポートは[Proxy設定](https://www.zaproxy.org/docs/desktop/start/proxies/)を行なうことで、OWASP ZAP経由でInternalに作ったweb-targetにアクセスできるよ、というものです。今回は割愛します。

docker compose upしたら早速、OWASP ZAPのWEB GUIにアクセスしてみましょう。<http://localhost:18080/zap>からアクセスできます。

![owasp splash](https://i.imgur.com/7rIrR1o.png)

上のような起動Splashのあと、操作画面に遷移します。

とりあえず一通りの脆弱性チェックを実施してみたいので、Automated Scanを選びweb-targetのコンテナ<http://web:9000>をターゲットに設定します。

また、モードをStandard Mode、つまりActive Scanにします。

![active scan](https://i.imgur.com/rs9HIta.png)

まずは対象のURLをかき集める動き(Spider)が実行されますが、このブログはSPAの動きも多いのでAjax Spiderを選択してます。(Firefox headless browserがクロールしてくれます)

![owaspzap](https://i.imgur.com/Moc4POV.png)

クロールが終わるとそのままActive Scanに入ります。

Active Scanが完了すると検知した脆弱性が表示されます。

結構誤検知（False positive）がありました。技術ブログなので、Internal Server Errorなどの文言がブログ中に散見され、誤検知が増えてしまったものと思われます。
　
といった具合に

### CIに組み込む

さて、
