{"componentChunkName":"component---src-templates-blog-post-tsx","path":"/2020/11/11/ssh-confiig-json","result":{"data":{"content":{"edges":[{"node":{"id":"5f5ac075-48b9-5a3b-8893-f7765f838760","excerpt":"PCの入れ替えのたびにSSH Configとその鍵の扱いに困るので作ってみました。 Table of Contents はじめに 課題 鍵とまとめて設定しなければならない SSH Configも立派な機微なファイル 課題への解 SSH Config JSON…","fields":{"slug":"2020/11/11/ssh-confiig-json"},"frontmatter":{"id":null,"title":"面倒なSSH Configと鍵管理はssh-config-jsonに任せよう","slug":"2020/11/11/ssh-confiig-json","date":"2020-11-11T14:42:50.126Z","headerImage":"https://i.imgur.com/qBFYNb6.png","tags":["サーバー","Python","SSH"]}}}]}},"pageContext":{"id":"5f5ac075-48b9-5a3b-8893-f7765f838760","index":27,"repHtml":"<p>PCの入れ替えのたびにSSH Configとその鍵の扱いに困るので作ってみました。</p>\n<h2 id=\"table-of-contents\" style=\"position:relative;\"><a href=\"#table-of-contents\" aria-label=\"table of contents permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Table of Contents</h2>\n<div class=\"toc\">\n<ul>\n<li>\n<p><a href=\"#%E3%81%AF%E3%81%98%E3%82%81%E3%81%AB\">はじめに</a></p>\n</li>\n<li>\n<p><a href=\"#%E8%AA%B2%E9%A1%8C\">課題</a></p>\n<ul>\n<li><a href=\"#%E9%8D%B5%E3%81%A8%E3%81%BE%E3%81%A8%E3%82%81%E3%81%A6%E8%A8%AD%E5%AE%9A%E3%81%97%E3%81%AA%E3%81%91%E3%82%8C%E3%81%B0%E3%81%AA%E3%82%89%E3%81%AA%E3%81%84\">鍵とまとめて設定しなければならない</a></li>\n<li><a href=\"#ssh-config%E3%82%82%E7%AB%8B%E6%B4%BE%E3%81%AA%E6%A9%9F%E5%BE%AE%E3%81%AA%E3%83%95%E3%82%A1%E3%82%A4%E3%83%AB\">SSH Configも立派な機微なファイル</a></li>\n</ul>\n</li>\n<li>\n<p><a href=\"#%E8%AA%B2%E9%A1%8C%E3%81%B8%E3%81%AE%E8%A7%A3\">課題への解</a></p>\n</li>\n<li>\n<p><a href=\"#ssh-config-json\">SSH Config JSON</a></p>\n</li>\n<li>\n<p><a href=\"#%E7%89%B9%E5%BE%B4\">特徴</a></p>\n</li>\n<li>\n<p><a href=\"#%E4%BD%BF%E3%81%84%E6%96%B9\">使い方</a></p>\n</li>\n<li>\n<p><a href=\"#%E6%8A%80%E8%A1%93%E8%A7%A3%E8%AA%AC\">技術解説</a></p>\n</li>\n<li>\n<p><a href=\"#%E3%82%B3%E3%83%9E%E3%83%B3%E3%83%89%E3%83%91%E3%83%BC%E3%82%B5%E3%83%BC\">コマンドパーサー</a></p>\n<ul>\n<li><a href=\"#%E3%82%B3%E3%83%9E%E3%83%B3%E3%83%89%E3%83%A9%E3%82%A4%E3%83%B3%E3%83%91%E3%83%BC%E3%82%B5%E3%83%BC%E3%81%AE%E3%83%86%E3%82%B9%E3%83%88%E3%82%B3%E3%83%BC%E3%83%89\">コマンドラインパーサーのテストコード</a></li>\n</ul>\n</li>\n<li>\n<p><a href=\"#pycryptodome\">Pycryptodome</a></p>\n<ul>\n<li><a href=\"#aes%E6%9A%97%E5%8F%B7%E5%8C%96-eax%E3%83%A2%E3%83%BC%E3%83%89\">AES暗号化 EAXモード</a></li>\n<li><a href=\"#%E9%8D%B5%E3%81%AE%E3%83%8F%E3%83%83%E3%82%B7%E3%83%A5%E5%8C%96\">鍵のハッシュ化</a></li>\n<li><a href=\"#md5%E5%95%8F%E9%A1%8C\">MD5問題</a></li>\n<li><a href=\"#%E5%88%9D%E6%9C%9F%E5%8C%96%E3%83%99%E3%82%AF%E3%83%88%E3%83%AB\">初期化ベクトル</a></li>\n<li><a href=\"#%E3%83%90%E3%82%A4%E3%83%88%E5%88%97%E3%81%AE%E6%9B%B8%E3%81%8D%E8%BE%BC%E3%81%BF\">バイト列の書き込み</a></li>\n</ul>\n</li>\n<li>\n<p><a href=\"#lint\">Lint</a></p>\n</li>\n<li>\n<p><a href=\"#cicd%E3%81%AB%E8%BC%89%E3%81%A3%E3%81%91%E3%82%8B\">CI/CDに載っける</a></p>\n</li>\n<li>\n<p><a href=\"#pypi%E3%81%AB%E8%87%AA%E5%8B%95%E3%83%87%E3%83%97%E3%83%AD%E3%82%A4%E3%81%99%E3%82%8B\">PyPIに自動デプロイする</a></p>\n<ul>\n<li><a href=\"#%E3%83%90%E3%83%BC%E3%82%B8%E3%83%A7%E3%83%B3%E7%AE%A1%E7%90%86\">バージョン管理</a></li>\n</ul>\n</li>\n<li>\n<p><a href=\"#%E7%B5%90%E8%AB%96\">結論</a></p>\n</li>\n</ul>\n</div>\n<h2 id=\"はじめに\" style=\"position:relative;\"><a href=\"#%E3%81%AF%E3%81%98%E3%82%81%E3%81%AB\" aria-label=\"はじめに permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>はじめに</h2>\n<p>皆さんはサーバーへの<strong>SSH</strong>、どうしてますか？</p>\n<p>仕事柄管理しているサーバーへのSSHログインが多いため、<strong>SSH Config</strong>を使ってログインの手間を少なくしてます。</p>\n<p>特にSSHログインに鍵ファイルを利用したり、DBアクセスのためのポートフォワードをしたり、多段SSHをしようとするとSSHコマンドの長さはおのずと長くなり、毎回打ち込むのはそれはそれは億劫になります。</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">ssh tubone24@10.0.0.1 -i ~./ssh/id_rsa -L 127.0.0.1:80:intra.example.com:80 ProxyCommand='ssh -p 22 -W %h:%p step.server.com'</code></pre></div>\n<p>めんどくさいですね。</p>\n<p>そこで例えば上記のようなコマンドをSSH Configに設定し、</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">Host serverA\n    HostName 10.0.0.1\n    User tubone24\n    Port 22\n    IdentityFile ~./ssh/id_rsa\n    LocalForward   127.0.0.1:80:intra.example.com:80\n    ProxyCommand ssh -p 22 -W %h:%p step.server.com</code></pre></div>\n<p>次のようにエイリアスでアクセスできるようにするわけです。</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">ssh serverA</code></pre></div>\n<p>ちなみに、ZSHでは<a href=\"https://github.com/zsh-users/zsh-completions\" target=\"_blank\" rel=\"noopener noreferrer\">zsh-completions</a>という補完プラグインを設定することで、</p>\n<p>SSH Configのtab補完をしてくれるので上記との合わせ技でかなり効率的になります。</p>\n<h2 id=\"課題\" style=\"position:relative;\"><a href=\"#%E8%AA%B2%E9%A1%8C\" aria-label=\"課題 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>課題</h2>\n<p>とっても便利なSSH Configですが、PC移行や環境構築時、いろいろやっかいです。</p>\n<h3 id=\"鍵とまとめて設定しなければならない\" style=\"position:relative;\"><a href=\"#%E9%8D%B5%E3%81%A8%E3%81%BE%E3%81%A8%E3%82%81%E3%81%A6%E8%A8%AD%E5%AE%9A%E3%81%97%E3%81%AA%E3%81%91%E3%82%8C%E3%81%B0%E3%81%AA%E3%82%89%E3%81%AA%E3%81%84\" aria-label=\"鍵とまとめて設定しなければならない permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>鍵とまとめて設定しなければならない</h3>\n<p>まぁ当たり前と言えば当たり前なのですが、SSH Config上で設定した鍵ファイルも併せて管理しないと当然サーバーにアクセスできません。</p>\n<p>私の働いている現場では、<strong>鍵ファイルをS3に配置し</strong>、アクセス権を持ってる鍵が必要な人が各々鍵をローカルにダウンロードする必要があります。</p>\n<p>せっかくSSH Configだけ別のPCに移行しても結局鍵のダウンロードが必要なわけです。</p>\n<h3 id=\"ssh-configも立派な機微なファイル\" style=\"position:relative;\"><a href=\"#ssh-config%E3%82%82%E7%AB%8B%E6%B4%BE%E3%81%AA%E6%A9%9F%E5%BE%AE%E3%81%AA%E3%83%95%E3%82%A1%E3%82%A4%E3%83%AB\" aria-label=\"ssh configも立派な機微なファイル permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>SSH Configも立派な機微なファイル</h3>\n<p>鍵ファイルは前述の通りですが、じゃあSSH Configの受け渡しはどうでしょう？</p>\n<p>SSH ConfigにはサーバーのIPアドレス、ログイン名などかなりセキュリティ上機微な情報が入っており、</p>\n<p>dotfileのように、GitHubのレポジトリー管理にするのもはばかられます。</p>\n<h2 id=\"課題への解\" style=\"position:relative;\"><a href=\"#%E8%AA%B2%E9%A1%8C%E3%81%B8%E3%81%AE%E8%A7%A3\" aria-label=\"課題への解 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>課題への解</h2>\n<p>さて、こちらの課題を整理すると、</p>\n<ol>\n<li>SSH鍵も一元的に管理したい</li>\n<li>SSH Config自体も安全に管理したい</li>\n</ol>\n<p>となります。</p>\n<p>良い方法はあるでしょうか？</p>\n<h2 id=\"ssh-config-json\" style=\"position:relative;\"><a href=\"#ssh-config-json\" aria-label=\"ssh config json permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>SSH Config JSON</h2>\n<p>そこでボクは<del>オリーブオイル</del> SSH Config JSON。</p>\n<p>SSH ConfigをJSON形式で鍵ファイルとともに1ファイルにラッピングし、AES暗号で暗号化する、というツールを作ってみました。</p>\n<h2 id=\"特徴\" style=\"position:relative;\"><a href=\"#%E7%89%B9%E5%BE%B4\" aria-label=\"特徴 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>特徴</h2>\n<ul>\n<li>SSH ConfigのJSON変換、複合ができます</li>\n<li>IdentityFile(SSH鍵)をJSONにラッピングし一元管理できます</li>\n<li>AES暗号に対応し、JSONを暗号化しSSH鍵とともに安全に管理できます</li>\n</ul>\n<h2 id=\"使い方\" style=\"position:relative;\"><a href=\"#%E4%BD%BF%E3%81%84%E6%96%B9\" aria-label=\"使い方 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>使い方</h2>\n<p>主な使い方はRead the docsにドキュメントサイトを作りましたのでそちらをご参照ください。</p>\n<p><a href=\"https://ssh-config-json.readthedocs.io/en/latest/\" target=\"_blank\" rel=\"noopener noreferrer\">https://ssh-config-json.readthedocs.io/en/latest/</a></p>\n<p>一例を書きますとまずインストールはpipで行います。</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">pip install ssh-config-json</code></pre></div>\n<p>するとGlobalコマンドに<strong>scj</strong>というものができます。</p>\n<p><strong>S</strong>sh <strong>C</strong>onfig <strong>J</strong>sonですね。</p>\n<p>自らの~/.ssh/configをSSH鍵もセットでJSONにしたければ、</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">scj dump dump_config.json -i</code></pre></div>\n<p>とするとdump.jsonとしてSSH ConfigをラッピングしたJSONができます。</p>\n<p>復元したければ、</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">scj restore dump_config.json -i</code></pre></div>\n<p>とやることで、SSH鍵とともに展開されます。</p>\n<p>さらに暗号化オプションをつければ、</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">scj dump dump_config.json -i -e</code></pre></div>\n<p>とJSONを暗号化したファイルが生成され、AESキーを使った複合もできます。</p>\n<h2 id=\"技術解説\" style=\"position:relative;\"><a href=\"#%E6%8A%80%E8%A1%93%E8%A7%A3%E8%AA%AC\" aria-label=\"技術解説 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>技術解説</h2>\n<p>特に難しい技術は使ってませんが、このブログの趣旨はそういったところにあると思うので解説します。</p>\n<h2 id=\"コマンドパーサー\" style=\"position:relative;\"><a href=\"#%E3%82%B3%E3%83%9E%E3%83%B3%E3%83%89%E3%83%91%E3%83%BC%E3%82%B5%E3%83%BC\" aria-label=\"コマンドパーサー permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>コマンドパーサー</h2>\n<p>コマンドパーサーはおなじみ<strong>docopt</strong>です。もう何回目でしょうか。お世話になっております。</p>\n<p>やはり便利なのはusageを書いているとロジックもできあがるところで、なんというかまぁ本当にべんりです。</p>\n<p>Nimのdocoptの解説になってしまいますが、詳しくは<a href=\"https://blog.tubone-project24.xyz/2019/11/20/docopt-nim\" target=\"_blank\" rel=\"noopener noreferrer\">docoptはNimでも使えたのお話</a>をご確認ください。</p>\n<h3 id=\"コマンドラインパーサーのテストコード\" style=\"position:relative;\"><a href=\"#%E3%82%B3%E3%83%9E%E3%83%B3%E3%83%89%E3%83%A9%E3%82%A4%E3%83%B3%E3%83%91%E3%83%BC%E3%82%B5%E3%83%BC%E3%81%AE%E3%83%86%E3%82%B9%E3%83%88%E3%82%B3%E3%83%BC%E3%83%89\" aria-label=\"コマンドラインパーサーのテストコード permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>コマンドラインパーサーのテストコード</h3>\n<p>docoptを絡めたテストコードを今回は書いてみました。とはいい、これはもはやdocopt本体のテストになってしまうのでアンチパターンになりますが。</p>\n<p>本来的には、docoptをmock化するのが正義なんですけど、自前でパーサー作った場合とかに使えそうなのでまぁいいでしょう。</p>\n<p>docoptの実装はどうやら<strong>sys.argv</strong>からコマンドライン引数を取り出しているようです。当たり前といえば当たり前か。</p>\n<p>Pytestなどのテストランナーに書けた際、sys.argvはテストランナーに渡したものが入っているので、</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">    def test_main_dump(self):\n        del sys.argv[1:]\n        sys.argv.append(\"dump\")\n        sys.argv.append(\"tests/assets/test_config_xxx\")\n        sys.argv.append(\"-c\")\n        sys.argv.append(\"tests/assets/test_config\")\n        with patch(\"builtins.open\") as mock_open:\n            main()\n            mock_open.assert_any_call(\"tests/assets/test_config_xxx\", \"w\")\n            mock_open.assert_any_call(\"tests/assets/test_config\")\n        del sys.argv[1:]</code></pre></div>\n<p>のように無理矢理sys.argvを任意の値に変更することで、テスト対象にコマンドライン引数が渡せます。</p>\n<p><strong>終わったらお片づけでdel文を忘れずに！</strong></p>\n<h2 id=\"pycryptodome\" style=\"position:relative;\"><a href=\"#pycryptodome\" aria-label=\"pycryptodome permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Pycryptodome</h2>\n<p>AESの暗号化には<strong>Pycryptodome</strong>を利用してます。</p>\n<p>Pythonの暗号化ライブラリといえばpycryptoが有名ですが、こちらはPyPIを見ると2013/10/13以降更新がありません。（涙）なので、今回はPycryptodomeを使うことにしました。</p>\n<p><a href=\"https://dev.classmethod.jp/articles/python-crypto-libraries/\" target=\"_blank\" rel=\"noopener noreferrer\">AES対応のPython暗号化ライブラリを比較検証してみた</a>を確認してみるに、Pycryptodomeは低レベルの暗号化ライブラリらしく、低レベルの暗号ライブラリーは難しいと聞いてましたが、使ってみて案外ドキュメントがしっかりしていたことと、英語であれば結構実装例が出てきたので予想よりは詰まらなかったです。</p>\n<h3 id=\"aes暗号化-eaxモード\" style=\"position:relative;\"><a href=\"#aes%E6%9A%97%E5%8F%B7%E5%8C%96-eax%E3%83%A2%E3%83%BC%E3%83%89\" aria-label=\"aes暗号化 eaxモード permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>AES暗号化 EAXモード</h3>\n<p>今回は暗号利用モードは<a href=\"https://pycryptodome.readthedocs.io/en/latest/src/examples.html#encrypt-data-with-aes\" target=\"_blank\" rel=\"noopener noreferrer\">公式ドキュメント</a>通り<strong>EAXモード</strong>を使いました。</p>\n<p>そもそも暗号利用モードってなに？という人は下の画像を見てみてください。</p>\n<p><img class=\"lozad\" src=\"data:image/gif;base64,R0lGODlhAQABAGAAACH5BAEKAP8ALAAAAAABAAEAAAgEAP8FBAA7\" data-src=\"https://i.imgur.com/OrwJJwp.jpg\" alt=\"img\"></p>\n<p>通常暗号化というものはとある文字列（バイト列）を別の文字列（バイト列）に変換するものなので、暗号化結果の出現度合いによってその全容がわかってしまってはいけません。</p>\n<p>そこで、AES(今回は話が分かりやすいようにブロック暗号に絞ります)ではいくつかの暗号利用モードを定義し、例えばCBCというモードでは前の暗号ブロック（最初の場合は初期化ベクトル）と次の平文のブロックのXORをとり、そこへ暗号をかけるようにします。</p>\n<p>そうすることにより、同じ平文、同じ鍵を用いた場合一つ前のブロックと次のブロックとの間で出現する文字列が異なってくるので暗号文から推測される可能性を少なくできます。</p>\n<p>ちょっと古い内容かつ厳密にはブロック暗号ではないですが、エニグマ暗号も出現する文字のパターンから平文への頻度分析から判断されないように単純な換字式暗号を用いず、入力ごとに換字表が入れ替わるローターを仕込んで対策してました。ちょっと仕組みはCBCと比べるとあっさりしてますが、まぁやりたいことは似たような感じですね。</p>\n<p><img class=\"lozad\" src=\"data:image/gif;base64,R0lGODlhAQABAGAAACH5BAEKAP8ALAAAAAABAAEAAAgEAP8FBAA7\" data-src=\"https://i.imgur.com/LNR7N4P.jpg\" alt=\"img\"></p>\n<p>さて、話を戻します。</p>\n<p>EAXモード<a href=\"https://en.wikipedia.org/wiki/EAX_mode\" target=\"_blank\" rel=\"noopener noreferrer\">EAXモード（encrypt-then-authenticat-then-translate）</a>は、暗号ブロック暗号の動作モードの一つで、メッセージの認証（完全性）と秘匿性を同時に提供するように設計されたモードで、いわゆる<strong>Authenticated Encryption with Associated Data (AEAD) アルゴリズム</strong>となっております。</p>\n<p><img class=\"lozad\" src=\"data:image/gif;base64,R0lGODlhAQABAGAAACH5BAEKAP8ALAAAAAABAAEAAAgEAP8FBAA7\" data-src=\"https://i.imgur.com/bbXnZFo.png\" alt=\"img\"></p>\n<p>上の図のように、ブロックを暗号化をする1パスとブロックごとの真正性を実現するための1パスの2パス方式を採用することが特徴です。</p>\n<p>えっ！じゃあ、暗号利用モードのCBCモードは何が担保できないんですか??って思ったあなた！するどいですね。どうやら、CBCモードなどの古いモードではHMAC SHAなどのハッシュをかけることでダイジェストを作り、完全性を担保しているらしいです。CBC-HAMCという方式ですね。ふーむ。</p>\n<p>EAXモードでは完全性と秘匿性の担保を1つの暗号化フローのなかで実現し、効率よく両方を担保しているとのこと。</p>\n<p><img class=\"lozad\" src=\"data:image/gif;base64,R0lGODlhAQABAGAAACH5BAEKAP8ALAAAAAABAAEAAAgEAP8FBAA7\" data-src=\"https://i.imgur.com/bbXnZFo.png\" alt=\"img\"></p>\n<p>とは言ってもPycryptodomeではmodeをEAXにするだけで簡単に使えるので細かく考える必要はなさそうです。</p>\n<h3 id=\"鍵のハッシュ化\" style=\"position:relative;\"><a href=\"#%E9%8D%B5%E3%81%AE%E3%83%8F%E3%83%83%E3%82%B7%E3%83%A5%E5%8C%96\" aria-label=\"鍵のハッシュ化 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>鍵のハッシュ化</h3>\n<p>ご存じの通りAESでは共通鍵の鍵長として、128bitから256bitまで選ぶことができます。</p>\n<p>特に迷うことないので256bitの鍵を利用することにしました。</p>\n<p>が、しばしば問題になるのが256bit、つまり32byteの鍵バイト列を人は簡単に作れない、ということです。</p>\n<p>パスワードポリシーが、32文字のASCII文字です！それ以上でもそれ以下でもいけません。だったら辛いでしょう。</p>\n<p>また、貧弱な鍵バイト列のせいで総当たり攻撃をされてもいけません。</p>\n<p>そこで一般に、ユーザーからの入力された鍵に対してハッシュ関数をかけたものを鍵バイト列として使うことが知られてます。</p>\n<p>こうすることで上記の問題は解決できます。（とは言ってもハッシュから鍵バイト列を推測されないようによくあるpasswordのような文字はやめましょう。）</p>\n<h3 id=\"md5問題\" style=\"position:relative;\"><a href=\"#md5%E5%95%8F%E9%A1%8C\" aria-label=\"md5問題 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>MD5問題</h3>\n<p>さて、前述の通りハッシュ関数を使って指定バイトのキーを生成すればいいですがここで問題が起きます。</p>\n<p><strong>32バイトのハッシュを作るにはどのハッシュ関数を使えばいいんだろう？</strong></p>\n<p>いくつか公開されているサンプルコードでは、<strong>md5</strong> を利用してました。</p>\n<p>md5を使うと次のようになります。</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">import hashlib\n\nkey = hashlib.md5(key.encode(\"utf-8\")).hexdigest()).encode(\"utf-8\")</code></pre></div>\n<p>ぶっちゃけあとで調べたら<a href=\"https://stackoverflow.com/questions/47002578/algorithm-to-generate-12-byte-hash-from-web-urls\" target=\"_blank\" rel=\"noopener noreferrer\">Stack Overflow</a>にもあるとおり、暗号化に使う鍵のハッシュ関数はもっとそこまで安全性を考慮する必要はないので、</p>\n<p>md5が正解だったようですが、何となく前時代的なハッシュ化アルゴリズムが嫌だったのでSHA-3世代のShake128を使うことにしました。</p>\n<p>ShakeはいわゆるSHA-3ファミリーのハッシュ関数ですが、可変長のダイジェストを作り出すことができます。128bitつまり、16バイトのダイジェストを作る場合には次のようなコードになります。</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">key = hashlib.shake_128(key.encode(\"utf-8\")).hexdigest(16)).encode(\"utf-8\")</code></pre></div>\n<h3 id=\"初期化ベクトル\" style=\"position:relative;\"><a href=\"#%E5%88%9D%E6%9C%9F%E5%8C%96%E3%83%99%E3%82%AF%E3%83%88%E3%83%AB\" aria-label=\"初期化ベクトル permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>初期化ベクトル</h3>\n<p>初期化ベクトルとは、ブロック暗号にて同じ平文を暗号文にした際、その形質が同じになってしまうことによりセキュリティ驚異を取り除くために、使われる概念です。</p>\n<p>ちょっと意味合いはことなりますが、エニグマ暗号の初期値乱数表みたいなものです。</p>\n<p>こちらはランダム性が高いほどセキュリティが向上するため、次のようにPycryptodomeのRandom.get_random_bytesから生成します。</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">initialization_vector = Random.get_random_bytes(AES.block_size)\ncipher = AES.new(self.key, AES.MODE_EAX, initialization_vector)</code></pre></div>\n<h3 id=\"バイト列の書き込み\" style=\"position:relative;\"><a href=\"#%E3%83%90%E3%82%A4%E3%83%88%E5%88%97%E3%81%AE%E6%9B%B8%E3%81%8D%E8%BE%BC%E3%81%BF\" aria-label=\"バイト列の書き込み permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>バイト列の書き込み</h3>\n<p>Python書いたことある人なら当たり前とは思いますが、バイト列の書き込みをする際はopenモードをバイナリーにしないといけません。</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">    def encrypt_file(self, path, delete_raw_file=False):\n        with open(path, \"r\") as f1, open(path + \".enc\", \"wb\") as f2:\n            f2.write(self.encrypt(f1.read()))\n        if delete_raw_file:\n            os.remove(path)\n        print(f\"Encrypted file: {path}.enc\")</code></pre></div>\n<h2 id=\"lint\" style=\"position:relative;\"><a href=\"#lint\" aria-label=\"lint permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Lint</h2>\n<p>Pythonのコード規約チェックはpep8からflake8など多岐にわたり、かつPytestなどのテストランナーと組み合わせることができますが、今回はBlackを使います。</p>\n<p>Blackはpep8と比べかなり制約の強い（柔軟性の低い）Pythonコードフォーマッタです。</p>\n<p>Blackの公式Docには、</p>\n<blockquote>\n<p>Blackを使用することで、あなたは手作業でのフォーマットの細かい部分のコントロールを譲ることに同意したことになります。その見返りとして、Blackはあなたにスピード、決定論、そしてフォーマットに関するpycodestyleの口煩いからの自由を与えてくれます。時間と精神的エネルギーを節約して、より重要なことに充てることができるようになります。</p>\n</blockquote>\n<p>と書いてあります。本当にその通りだと思います。</p>\n<p>Blackはフォーマットチェックのほか、自動フォーマットにも対応してるのでautopep8と同じ用な使い方ができるわけです。</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\"> black ssh_config_json</code></pre></div>\n<p>autopep8との違いはその規約の厳しさと柔軟性の欠如にあります。</p>\n<p>pep8では強制されないような、改行の仕方や、シングルクォートとダブルクォートの統一、末尾カンマの統一、余計な丸括弧の削除、数値リテラルの書き方までも細かく強制されます。</p>\n<p>まさに、公式も言っているとおりフォーマットでのコントロールを完全に譲ることになります。</p>\n<p>pep8では特定のルールの無効化を細かく設定できますが、Blackはフォーマット適用ソースと最大行文字数しか制御できません。</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">[tool.black]\nline-length = 88\ntarget-version = ['py37']\ninclude = '\\.pyi?$'\nexclude = '''\n\n(\n  /(\n      \\.eggs         # exclude a few common directories in the\n    | \\.git          # root of the project\n    | \\.hg\n    | \\.mypy_cache\n    | \\.tox\n    | \\.venv\n    | _build\n    | buck-out\n    | build\n    | dist\n  )/\n  | foo.py           # also separately exclude a file named foo.py in\n                     # the root of the project\n)\n'''</code></pre></div>\n<blockquote>\n<p>Black化されたコードは、あなたが読んでいるプロジェクトに関係なく同じように見えます。しばらくすると書式設定が透明になり、代わりにコンテンツに集中することができます。</p>\n</blockquote>\n<p>まさにその通りで、「ロジックは問題ないけど、なんでこの書き方なんですか？見にくいですよ？」みたいな不毛な議論は「だってBlackが」と言えるわけです。</p>\n<p>SSH Config JSONではBlackフォーマットを採用してます。</p>\n<p><a href=\"https://github.com/psf/black\" target=\"_blank\" rel=\"noopener noreferrer\"><img class=\"lozad\" src=\"data:image/gif;base64,R0lGODlhAQABAGAAACH5BAEKAP8ALAAAAAABAAEAAAgEAP8FBAA7\" data-src=\"https://img.shields.io/badge/code%20style-black-000000.svg\" alt=\"Code style: black\"></a></p>\n<h2 id=\"cicdに載っける\" style=\"position:relative;\"><a href=\"#cicd%E3%81%AB%E8%BC%89%E3%81%A3%E3%81%91%E3%82%8B\" aria-label=\"cicdに載っける permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>CI/CDに載っける</h2>\n<p>せっかくテストコードも書いたので、CI載っけましょう。</p>\n<p>毎度おなじみGitHub Actionsです。</p>\n<p>正直、最近はGitHub Actions一択になりつつあります。</p>\n<p>PRのタイミングでテストとBlackのフォーマットチェックを走らせます。</p>\n<p>--checkオプションをつければ、フォーマットがゴミだとエラーで落ちてCIがfailedするようになります。</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\"> black ssh_config_json  --check</code></pre></div>\n<h2 id=\"pypiに自動デプロイする\" style=\"position:relative;\"><a href=\"#pypi%E3%81%AB%E8%87%AA%E5%8B%95%E3%83%87%E3%83%97%E3%83%AD%E3%82%A4%E3%81%99%E3%82%8B\" aria-label=\"pypiに自動デプロイする permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>PyPIに自動デプロイする</h2>\n<p>さて、ここまできてらもう自動でPyPIにパッケージ登録できるようにしたいですね。</p>\n<p>PyPIへのパッケージ登録を行なうには当然パッケージを作らないと行けませんが、Pythonの場合setup.pyを記載することで作ることができます。</p>\n<p>さらに、setup.pyはただのPythonコードでしかないので、それをコンフィグに起こしたsetup.cfgという方法もあります。</p>\n<p>下記のようにパッケージの情報を記載し、</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">[metadata]\nname = ssh_config_json\nversion = attr: ssh_config_json.__version__\ndescription = Dump JSON for your ssh config include IdentityFiles and restore those.\nlong_description = file: README.rst, CHANGELOG.rst\nlong_description_content_type = text/x-rst\nurl = https://github.com/tubone24/ssh_config_json\nproject-urls =\n    Documentation = https://ssh-config-json.readthedocs.io/en/latest/\n    ProjectBlog = https://blog.tubone-project24.xyz\nauthor = tubone24\nauthor_email = tubo.yyyuuu@gmail.com\nkeywords = ssh-config, json, backup, AES\nlicense = MIT\nlicense-file = LICENSE\nplatform = any\nclassifiers =\n    Development Status :: 4 - Beta\n    Intended Audience :: Developers\n    License :: OSI Approved :: MIT License\n    Operating System :: OS Independent\n    Topic :: Documentation :: Sphinx\n    Topic :: System :: Archiving :: Backup\n    Programming Language :: Python\n    Programming Language :: Python :: 3.6\n    Programming Language :: Python :: 3.7\n    Programming Language :: Python :: 3.8\n</code></pre></div>\n<p>setup.pyでsetup.cfgを読み込むようにして、</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">from setuptools import setup\n\nsetup()</code></pre></div>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">python setup.py sdist bdist_wheel</code></pre></div>\n<p>でdist配下にパッケージ作成ができます。簡単ですね。</p>\n<h3 id=\"バージョン管理\" style=\"position:relative;\"><a href=\"#%E3%83%90%E3%83%BC%E3%82%B8%E3%83%A7%E3%83%B3%E7%AE%A1%E7%90%86\" aria-label=\"バージョン管理 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>バージョン管理</h3>\n<p>PyPIでは同一バージョンのパッケージ登録ができません。</p>\n<p>次のようにsetup.pyもしくはsetup.cfgのいずれかにバージョンを指定すれば\nいいのですが <em>attr</em> を使って次のようにすることでPythonコード上に設定した変数を読み込むことができるので、\nCLIのバージョン表示と平仄をとることができます。</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">IntelliJ IDEAPyCharm   \n[metadata]\nname = ssh_config_json\nversion = attr: ssh_config_json.__version__\ndescription = Dump JSON for your ssh config include IdentityFiles and restore those.</code></pre></div>\n<p>さらに、パッケージ登録についても<a href=\"https://github.com/marketplace/actions/pypi-publish\" target=\"_blank\" rel=\"noopener noreferrer\">pypa/gh-action-pypi-publish</a>を使えば簡単に実装できます。</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">      - name: Publish package\n        uses: pypa/gh-action-pypi-publish@master\n        with:\n          user: tubone24\n          password: ${{ secrets.pypi_password }}\n          skip_existing: true</code></pre></div>\n<h2 id=\"結論\" style=\"position:relative;\"><a href=\"#%E7%B5%90%E8%AB%96\" aria-label=\"結論 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>結論</h2>\n<p>いろいろなことを組み合わせて、便利ツールが実装できました。ありがとうございました。</p>","words":5995,"minutes":15}},"staticQueryHashes":["1319877725","2959249232"]}