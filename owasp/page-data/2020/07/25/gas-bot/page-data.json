{"componentChunkName":"component---src-templates-blog-post-tsx","path":"/2020/07/25/gas-bot","result":{"data":{"content":{"edges":[{"node":{"id":"0a117939-3603-5d3a-bb1b-8bf5f89d684f","excerpt":"4連休、StayHomeが叫ばれる中、ラーメンが食べたくなったので、LINEBOTを含めたラーメンソリューションを作ってみました。 img Table of Contents StayHomeとは？ 縛りプレイ 全体構成 ワイヤーフレーム 無料&サーバーレスといえばGAS GAS…","fields":{"slug":"2020/07/25/gas-bot"},"frontmatter":{"id":null,"title":"4連休を使ってGASとLINE BOTとFirebaseを使ってラーメン食べたいBOTを作ってみた","slug":"2020/07/25/gas-bot","date":"2020-07-24T15:49:47.993Z","headerImage":"https://i.imgur.com/aFfsvoe.gif","tags":["GAS","LINEBOT"]}}}]}},"pageContext":{"id":"0a117939-3603-5d3a-bb1b-8bf5f89d684f","index":30,"repHtml":"<p>4連休、StayHomeが叫ばれる中、ラーメンが食べたくなったので、LINEBOTを含めたラーメンソリューションを作ってみました。</p>\n<p><img class=\"lozad\" src=\"data:image/gif;base64,R0lGODlhAQABAGAAACH5BAEKAP8ALAAAAAABAAEAAAgEAP8FBAA7\" data-src=\"https://i.imgur.com/aFfsvoe.gif\" alt=\"img\"></p>\n<h2 id=\"table-of-contents\" style=\"position:relative;\"><a href=\"#table-of-contents\" aria-label=\"table of contents permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Table of Contents</h2>\n<div class=\"toc\">\n<ul>\n<li>\n<p><a href=\"#stayhome%E3%81%A8%E3%81%AF\">StayHomeとは？</a></p>\n</li>\n<li>\n<p><a href=\"#%E7%B8%9B%E3%82%8A%E3%83%97%E3%83%AC%E3%82%A4\">縛りプレイ</a></p>\n</li>\n<li>\n<p><a href=\"#%E5%85%A8%E4%BD%93%E6%A7%8B%E6%88%90\">全体構成</a></p>\n<ul>\n<li><a href=\"#%E3%83%AF%E3%82%A4%E3%83%A4%E3%83%BC%E3%83%95%E3%83%AC%E3%83%BC%E3%83%A0\">ワイヤーフレーム</a></li>\n</ul>\n</li>\n<li>\n<p><a href=\"#%E7%84%A1%E6%96%99%E3%82%B5%E3%83%BC%E3%83%90%E3%83%BC%E3%83%AC%E3%82%B9%E3%81%A8%E3%81%84%E3%81%88%E3%81%B0gas\">無料&#x26;サーバーレスといえばGAS</a></p>\n</li>\n<li>\n<p><a href=\"#gas%E3%81%A7%E8%A9%B0%E3%81%BE%E3%81%A3%E3%81%9F%E3%81%A8%E3%81%93%E3%82%8D\">GASで詰まったところ</a></p>\n<ul>\n<li><a href=\"#%E8%BF%91%E3%81%8F%E3%81%AE%E3%83%A9%E3%83%BC%E3%83%A1%E3%83%B3%E6%83%85%E5%A0%B1%E3%81%AE%E5%8F%96%E5%BE%97%E6%96%B9%E6%B3%95\">近くのラーメン情報の取得方法</a></li>\n<li><a href=\"#%E4%B8%80%E5%BA%A6%E3%81%AB%E9%80%81%E3%82%8C%E3%82%8B%E3%82%AB%E3%83%AB%E3%83%BC%E3%82%BB%E3%83%AB%E3%81%AF10%E5%80%8B5%E3%83%A1%E3%83%83%E3%82%BB%E3%83%BC%E3%82%B8%E3%81%BE%E3%81%A7\">一度に送れるカルーセルは10個×5メッセージまで</a></li>\n<li><a href=\"#firebase%E3%81%B8%E3%81%AE%E3%82%A2%E3%82%AF%E3%82%BB%E3%82%B9\">Firebaseへのアクセス</a></li>\n</ul>\n</li>\n<li>\n<p><a href=\"#%E7%B5%90%E8%AB%96\">結論</a></p>\n</li>\n</ul>\n</div>\n<h2 id=\"stayhomeとは\" style=\"position:relative;\"><a href=\"#stayhome%E3%81%A8%E3%81%AF\" aria-label=\"stayhomeとは permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>StayHomeとは？</h2>\n<p>StayHomeとは、<strong>COVID-19</strong>の感染拡大を防止するために、**「人に会うのを可能な限り避ける」**取り組みのなかで、**みんなお家にいようね！**という標語のようなものです。</p>\n<p>多くの芸能人が呼びかけていて、あの<strong>星野源</strong>さんが歌いながらさまざまなことにチャレンジする動画作成がミームになってましたね。</p>\n<p>個人的には、</p>\n<iframe loading=\"lazy\" width=\"200\" height=\"113\" src=\"https://www.youtube.com/embed/Lk3MZrxXswY?feature=oembed\" frameborder=\"0\" allow=\"accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture\" allowfullscreen title=\"麻雀を打つ黒川検事長\"></iframe>\n<p>がもはや星野源さん関係ないけど笑ってしまいました。天和上がったよって顔がまたなんとも...。</p>\n<p>さて、StayHomeですが残念ながら独身生活もこう長くなってくると、人と接しなくてもストレスなく生きられてしまうので、全然StayHome OKマンな私です。ただのんびりDアニメストアでアニメを見ながら、きのこの山を食べて、ゴロゴロしているのも4連休のお休みを作ってくださった神様(政府)に申し訳ないので、ためになることをしようと思いました。</p>\n<p><strong>「StayHomeでCOVではなくDEVしよう」</strong></p>\n<h2 id=\"縛りプレイ\" style=\"position:relative;\"><a href=\"#%E7%B8%9B%E3%82%8A%E3%83%97%E3%83%AC%E3%82%A4\" aria-label=\"縛りプレイ permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>縛りプレイ</h2>\n<p>ただ闇雲に開発するだけでは面白くないので今回も縛りプレイを実施していこうと思います。</p>\n<ul>\n<li>貧乏なのでオールフリー(無料)</li>\n<li>できる限りサーバーレス</li>\n<li>LINEを絡める</li>\n</ul>\n<p>特にLINEを絡めた開発をするのには理由がありまして、最近本業の開発で隣のチームがLINEのメッセージレイアウトがどうとか言っているのを聞いていて、ちょっとでも話題に入れるようにしたいという下心があるわけです。</p>\n<h2 id=\"全体構成\" style=\"position:relative;\"><a href=\"#%E5%85%A8%E4%BD%93%E6%A7%8B%E6%88%90\" aria-label=\"全体構成 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>全体構成</h2>\n<p>今回のアプリケーションは<strong>LINEの位置情報から近くのラーメン屋を探す</strong>サービスにしたいと思います。</p>\n<p>お友達にヒアリングしてみると、<strong>食べたラーメンを登録したい</strong>、 <strong>食べたラーメンを共有したい</strong>などのご意見があったので<strong>ライフログ</strong>機能もつけます。</p>\n<h3 id=\"ワイヤーフレーム\" style=\"position:relative;\"><a href=\"#%E3%83%AF%E3%82%A4%E3%83%A4%E3%83%BC%E3%83%95%E3%83%AC%E3%83%BC%E3%83%A0\" aria-label=\"ワイヤーフレーム permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>ワイヤーフレーム</h3>\n<p><img class=\"lozad\" src=\"data:image/gif;base64,R0lGODlhAQABAGAAACH5BAEKAP8ALAAAAAABAAEAAAgEAP8FBAA7\" data-src=\"https://i.imgur.com/KUqm5Qs.png\" alt=\"img\"></p>\n<p>雑ですが作ってみました。位置情報を送ると、近くのラーメン屋を検索してカルーセルで紹介します。</p>\n<p>また、ラーメン評価ボタンを付けて、クリックするとFirebaseで作ったフロントに飛んで星をつけることができます。</p>\n<p><img class=\"lozad\" src=\"data:image/gif;base64,R0lGODlhAQABAGAAACH5BAEKAP8ALAAAAAABAAEAAAgEAP8FBAA7\" data-src=\"https://i.imgur.com/ibZirgX.png\" alt=\"img\"></p>\n<p>なので、LINEBOTを基軸にサービスを組みますが、今回はバックエンド処理がLINEの<a href=\"https://developers.line.biz/ja/reference/messaging-api/\" target=\"_blank\" rel=\"noopener noreferrer\">MessagingAPI</a>のWebhookで起動し、返信を返す機能なのでBOT部分はGASのdoPostを使って作ります。</p>\n<p>ラーメン登録画面などはさすがにGASで作り切るのはしんどいので、Firebaseを使います。フロント自体はある程度実装経験があるNuxt.jsを使います。</p>\n<h2 id=\"無料サーバーレスといえばgas\" style=\"position:relative;\"><a href=\"#%E7%84%A1%E6%96%99%E3%82%B5%E3%83%BC%E3%83%90%E3%83%BC%E3%83%AC%E3%82%B9%E3%81%A8%E3%81%84%E3%81%88%E3%81%B0gas\" aria-label=\"無料サーバーレスといえばgas permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>無料&#x26;サーバーレスといえばGAS</h2>\n<p>さて、GASが今回も出てきました。GAS大好きすぎるマンですね。すみません。</p>\n<p>GASとはGoogle Apps Scriptsのことで詳しくは過去ブログ<a href=\"https://blog.tubone-project24.xyz/2019/10/24/gas-webscreenshot#google-apps-scriptgas%E3%81%A8%E3%81%AF%EF%BC%9F\" target=\"_blank\" rel=\"noopener noreferrer\">Google Apps Script(GAS)とAPI FLASHとSlackAPIをClaspとJestとGitHub Actionで調理して定期的にWebページのスクリーンショットを撮る\n</a>をご確認いただければと思います。</p>\n<p>今回もTypeScript + Claspで開発していき、GitHub Actionsでデプロイまで完了するCI/CDを構築していきたいと思います。</p>\n<h2 id=\"gasで詰まったところ\" style=\"position:relative;\"><a href=\"#gas%E3%81%A7%E8%A9%B0%E3%81%BE%E3%81%A3%E3%81%9F%E3%81%A8%E3%81%93%E3%82%8D\" aria-label=\"gasで詰まったところ permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>GASで詰まったところ</h2>\n<h3 id=\"近くのラーメン情報の取得方法\" style=\"position:relative;\"><a href=\"#%E8%BF%91%E3%81%8F%E3%81%AE%E3%83%A9%E3%83%BC%E3%83%A1%E3%83%B3%E6%83%85%E5%A0%B1%E3%81%AE%E5%8F%96%E5%BE%97%E6%96%B9%E6%B3%95\" aria-label=\"近くのラーメン情報の取得方法 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>近くのラーメン情報の取得方法</h3>\n<p>LINEのMessagingAPIではユーザーが位置情報を送ると、設定したWebhookに対して緯度経度が送られます。</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">{\n  \"replyToken\": \"nHuyWiB7yP5Zw52FIkcQobQuGDXCTA\",\n  \"type\": \"message\",\n  \"mode\": \"active\",\n  \"timestamp\": 1462629479859,\n  \"source\": {\n    \"type\": \"user\",\n    \"userId\": \"U4af4980629...\"\n  },\n  \"message\": {\n    \"id\": \"325708\",\n    \"type\": \"location\",\n    \"title\": \"my location\",\n    \"address\": \"〒150-0002 東京都渋谷区渋谷２丁目２１−１\",\n    \"latitude\": 35.65910807942215,\n    \"longitude\": 139.70372892916203\n  }\n}</code></pre></div>\n<p><a href=\"https://developers.line.biz/ja/reference/messaging-api/#wh-location\" target=\"_blank\" rel=\"noopener noreferrer\">https://developers.line.biz/ja/reference/messaging-api/#wh-location</a></p>\n<p>そこで、送られた緯度経度を使って、近くのラーメン屋情報を取得するのですが、取得に使ったAPIが、</p>\n<p><a href=\"https://api.gnavi.co.jp/api/manual/restsearch/\" target=\"_blank\" rel=\"noopener noreferrer\">ぐるなびレストラン検索API\n</a>でした。</p>\n<p>登録も簡単で、緯度経度をフィルターで使えるので、結構便利に使えそうだったので選びました。</p>\n<p>位置情報を緯度経度で指定し、ラーメン屋のカテゴリコード(RSFST08008,RSFST08009,RSFST08012,RSFST08013)を指定し、緯度経度を設定するだけでこんな結果が返ってきます。</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">{\n    \"@attributes\": {\n        \"api_version\": \"v3\"\n    },\n    \"total_hit_count\": 10,\n    \"hit_per_page\": 1,\n    \"page_offset\": 1,\n    \"rest\": [\n        {\n            \"@attributes\": {\n                \"order\": 0\n            },\n            \"id\": \"gf8f400\",\n            \"update_date\": \"2020-03-31T14:49:10+09:00\",\n            \"name\": \"創作麺工房 鳴龍\",\n            \"name_kana\": \"ソウサクメンコウボウナキリュウ\",\n            \"latitude\": \"35.728676\",\n            \"longitude\": \"139.730343\",\n            \"category\": \"ラーメン、つけ麺\",\n            \"url\": \"https://r.gnavi.co.jp/akadann10000/?ak=UKutMOVrMfs3qHtpT1euv06MXqPjNZyGW51PnE3qUOk%3D\",\n            \"url_mobile\": \"http://mobile.gnavi.co.jp/shop/gf8f400/?ak=UKutMOVrMfs3qHtpT1euv06MXqPjNZyGW51PnE3qUOk%3D\",\n            \"coupon_url\": {\n                \"pc\": \"\",\n                \"mobile\": \"\"\n            },\n            \"image_url\": {\n                \"shop_image1\": \"https://rimage.gnst.jp/rest/img/akadann10000/t_0n6v.jpg\",\n                \"shop_image2\": \"\",\n                \"qrcode\": \"https://c-r.gnst.jp/tool/qr/?id=gf8f400&amp;q=6\"\n            },\n            \"address\": \"〒170-0005 東京都豊島区南大塚2-34-4 SKY南大塚1F\",\n            \"tel\": \"050-3461-5239\",\n            \"tel_sub\": \"03-6304-1811\",\n            \"fax\": \"03-6304-1811\",\n            \"opentime\": \"月 ランチ：11:30～15:00\\n水～日 ランチ：11:30～15:00\\n水～日 ディナー：18:00～21:00\",\n            \"holiday\": \"毎週火曜日\\n※※スープがなくなり次第終了することがございます。詳細はお電話でお問い合わせ下さい。\",\n            \"access\": {\n                \"line\": \"ＪＲ\",\n                \"station\": \"大塚駅\",\n                \"station_exit\": \"南口\",\n                \"walk\": \"4\",\n                \"note\": \"\"\n            },\n            \"parking_lots\": \"\",\n            \"pr\": {\n                \"pr_short\": \"丸鶏、牛骨、生牡蠣の旨みあふれるスープと小麦の風味ただよう自家製麺。店主のこだわりを一杯に昇華。\",\n                \"pr_long\": \"国内外の名店で腕を磨いた店主が、満を持して2012年に開店。「自分の食べたいものしか出さない」という店主渾身のスープと自家製麺から成る、担担麺、拉麺、つけ麺は、いずれもうまみ豊かでコク深い逸品ぞろい。タレや調味料も手作りにこだわっている。ボリュームたっぷりの自家製チャーシューや海老ワンタンなどのアラカルトも人気で、多くのファンを惹きつけている。ミシュランガイド東京2018 一つ星\"\n            },\n            \"code\": {\n                \"areacode\": \"AREA110\",\n                \"areaname\": \"関東\",\n                \"prefcode\": \"PREF13\",\n                \"prefname\": \"東京都\",\n                \"areacode_s\": \"AREAS2160\",\n                \"areaname_s\": \"大塚\",\n                \"category_code_l\": [\n                    \"RSFST08000\",\n                    \"RSFST08000\"\n                ],\n                \"category_name_l\": [\n                    \"ラーメン・麺料理\",\n                    \"ラーメン・麺料理\"\n                ],\n                \"category_code_s\": [\n                    \"RSFST08008\",\n                    \"RSFST08012\"\n                ],\n                \"category_name_s\": [\n                    \"ラーメン\",\n                    \"担々麺\"\n                ]\n            },\n            \"budget\": 1000,\n            \"party\": \"\",\n            \"lunch\": 900,\n            \"credit_card\": \"\",\n            \"e_money\": \"\",\n            \"flags\": {\n                \"mobile_site\": 1,\n                \"mobile_coupon\": 0,\n                \"pc_coupon\": 0\n            }\n        }\n    ]\n}</code></pre></div>\n<p>色々返ってきますが、今回必要なのは<strong>店名</strong>、<strong>場所情報</strong>、<strong>写真</strong>、<strong>電話番号</strong>です。</p>\n<p>ただ、この例ではお店の写真が<strong>shop_image1</strong>に設定されているのですが、ほとんどの検索結果で画像がありませんでした。</p>\n<p>画像がないとカルーセルがしょぼくなってしまいます。</p>\n<p>一応画像がない場合はいらすとやさんにあった、</p>\n<p><img class=\"lozad\" src=\"data:image/gif;base64,R0lGODlhAQABAGAAACH5BAEKAP8ALAAAAAABAAEAAAgEAP8FBAA7\" data-src=\"https://i.imgur.com/DxiGaAr.jpg\" alt=\"img\"></p>\n<p>で置き換えるようにしましたがそれにしても悲しいので、少し工夫したいと思います。</p>\n<p><a href=\"https://webservice.recruit.co.jp/doc/hotpepper/reference.html\" target=\"_blank\" rel=\"noopener noreferrer\">ホットペッパーグルメサーチAPI</a>を併用して、同名のお店がヒットしたらホットペッパー側の画像(こっちのほうが画像は充実している)を採用するように変更しました。</p>\n<p>ホットペッパーグルメサーチAPIのレスポンスはこんなかんじです。</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">{\n    \"results\": {\n        \"api_version\": \"1.26\",\n        \"results_available\": 4,\n        \"results_returned\": \"4\",\n        \"results_start\": 1,\n        \"shop\": [\n            {\n                \"access\": \"山手線　大塚駅より徒歩5分\",\n                \"address\": \"東京都豊島区北大塚２－８－８　北大塚ビル１F\",\n                \"band\": \"不可\",\n                \"barrier_free\": \"なし\",\n                \"budget\": {\n                    \"average\": \"1000円\",\n                    \"code\": \"B001\",\n                    \"name\": \"1501～2000円\"\n                },\n                \"budget_memo\": \"お通し代なし\",\n                \"capacity\": 20,\n                \"card\": \"利用不可\",\n                \"catch\": \"太陽のラーメンとは？ ♪めがねの日♪\",\n                \"charter\": \"貸切不可\",\n                \"child\": \"お子様連れ歓迎\",\n                \"close\": \"月\",\n                \"coupon_urls\": {\n                    \"pc\": \"https://www.hotpepper.jp/strJ000732789/map/?vos=nhppalsa000016\",\n                    \"sp\": \"https://www.hotpepper.jp/strJ000732789/scoupon/?vos=nhppalsa000016\"\n                },\n                \"course\": \"なし\",\n                \"english\": \"なし\",\n                \"free_drink\": \"なし\",\n                \"free_food\": \"なし\",\n                \"genre\": {\n                    \"catch\": \"おいしくてヘルシー！フレッシュなラーメン\",\n                    \"code\": \"G013\",\n                    \"name\": \"ラーメン\"\n                },\n                \"horigotatsu\": \"なし\",\n                \"id\": \"J000732789\",\n                \"karaoke\": \"なし\",\n                \"ktai_coupon\": 1,\n                \"large_area\": {\n                    \"code\": \"Z011\",\n                    \"name\": \"東京\"\n                },\n                \"large_service_area\": {\n                    \"code\": \"SS10\",\n                    \"name\": \"関東\"\n                },\n                \"lat\": 35.733611638,\n                \"lng\": 139.726689431,\n                \"logo_image\": \"https://imgfp.hotp.jp/IMGH/30/84/P010113084/P010113084_69.jpg\",\n                \"lunch\": \"あり\",\n                \"middle_area\": {\n                    \"code\": \"Y057\",\n                    \"name\": \"巣鴨・大塚・駒込\"\n                },\n                \"midnight\": \"営業している\",\n                \"mobile_access\": \"山手線 大塚駅より徒歩5分\",\n                \"name\": \"太陽のトマト麺 大塚北口支店\",\n                \"name_kana\": \"たいようのとまとめん　おおつかきたぐちしてん\",\n                \"non_smoking\": \"全面禁煙\",\n                \"open\": \"火～土、祝前日: 11:00～翌1:00 （料理L.O. 翌0:30 ドリンクL.O. 翌0:30）日、祝日: 11:00～翌0:00 （料理L.O. 23:30 ドリンクL.O. 23:30）\",\n                \"other_memo\": \"\",\n                \"parking\": \"なし\",\n                \"party_capacity\": \"\",\n                \"pet\": \"不可\",\n                \"photo\": {\n                    \"mobile\": {\n                        \"l\": \"https://imgfp.hotp.jp/IMGH/67/80/P019506780/P019506780_168.jpg\",\n                        \"s\": \"https://imgfp.hotp.jp/IMGH/67/80/P019506780/P019506780_100.jpg\"\n                    },\n                    \"pc\": {\n                        \"l\": \"https://imgfp.hotp.jp/IMGH/67/80/P019506780/P019506780_238.jpg\",\n                        \"m\": \"https://imgfp.hotp.jp/IMGH/67/80/P019506780/P019506780_168.jpg\",\n                        \"s\": \"https://imgfp.hotp.jp/IMGH/67/80/P019506780/P019506780_58_s.jpg\"\n                    }\n                },\n                \"private_room\": \"なし\",\n                \"service_area\": {\n                    \"code\": \"SA11\",\n                    \"name\": \"東京\"\n                },\n                \"shop_detail_memo\": \"\",\n                \"show\": \"なし\",\n                \"small_area\": {\n                    \"code\": \"X142\",\n                    \"name\": \"大塚\"\n                },\n                \"station_name\": \"大塚\",\n                \"tatami\": \"なし\",\n                \"tv\": \"なし\",\n                \"urls\": {\n                    \"pc\": \"https://www.hotpepper.jp/strJ000732789/?vos=nhppalsa000016\"\n                },\n                \"wedding\": \"\",\n                \"wifi\": \"あり\"\n            }\n        ]\n    }\n}</code></pre></div>\n<p>↑<strong>photo</strong>が写真です。</p>\n<p>ちなみに検索結果のマージも行なうので、ホットペッパーのみ掲載店についても表示するようにしています。</p>\n<h3 id=\"一度に送れるカルーセルは10個5メッセージまで\" style=\"position:relative;\"><a href=\"#%E4%B8%80%E5%BA%A6%E3%81%AB%E9%80%81%E3%82%8C%E3%82%8B%E3%82%AB%E3%83%AB%E3%83%BC%E3%82%BB%E3%83%AB%E3%81%AF10%E5%80%8B5%E3%83%A1%E3%83%83%E3%82%BB%E3%83%BC%E3%82%B8%E3%81%BE%E3%81%A7\" aria-label=\"一度に送れるカルーセルは10個5メッセージまで permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>一度に送れるカルーセルは10個×5メッセージまで</h3>\n<p>という制約がLINE MessaingAPIにあります。</p>\n<p>正確には、ReplyTokenで返信できる上限が5メッセージ、1メッセージに設定できるカルーセルが10個となってます。</p>\n<p>「xx件ヒットしました」というテキストで1メッセージ消費するので4メッセージカルーセルに設定できます。</p>\n<p>なので、40件以上お店がヒットした場合、一度に送りきれないことがわかりました。</p>\n<p>なので切り詰めて送るようにしました。</p>\n<h3 id=\"firebaseへのアクセス\" style=\"position:relative;\"><a href=\"#firebase%E3%81%B8%E3%81%AE%E3%82%A2%E3%82%AF%E3%82%BB%E3%82%B9\" aria-label=\"firebaseへのアクセス permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Firebaseへのアクセス</h3>\n<p>GASでFirebaseにアクセスする、これが一番苦戦しました。</p>\n<p>そもそもGASでFirebaseにアクセスする必要があるんだっけ？という話ですが、</p>\n<p>GASでFirebaseにアクセスするには<a href=\"https://github.com/grahamearley/FirestoreGoogleAppsScript\" target=\"_blank\" rel=\"noopener noreferrer\">FirestoreApp</a>をライブラリから使ってアクセスするのがいいみたいですが、こちらをClaspに乗っけるのに苦労しました。</p>\n<p>結論からですが、ts-ignoreを使ってliberaryからimportされている<strong>FirestoreApp</strong>の参照エラーを取り除くことでclaspと共存が可能でした。</p>\n<div class=\"gatsby-highlight\" data-language=\"typescript\"><pre class=\"language-typescript\"><code class=\"language-typescript\"><span class=\"token keyword\">export</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">FirestoreService</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">private</span> firestore<span class=\"token operator\">:</span> <span class=\"token builtin\">any</span><span class=\"token punctuation\">;</span>\n  <span class=\"token function\">constructor</span><span class=\"token punctuation\">(</span>email<span class=\"token operator\">:</span> <span class=\"token builtin\">string</span><span class=\"token punctuation\">,</span> key<span class=\"token operator\">:</span> <span class=\"token builtin\">string</span><span class=\"token punctuation\">,</span> projectId<span class=\"token operator\">:</span> <span class=\"token builtin\">string</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token comment\">// @ts-ignore because of Add GoogleScripts Library</span>\n    <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>firestore <span class=\"token operator\">=</span> FirestoreApp<span class=\"token punctuation\">.</span><span class=\"token function\">getFirestore</span><span class=\"token punctuation\">(</span>email<span class=\"token punctuation\">,</span> key<span class=\"token punctuation\">,</span> projectId<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span>\n  <span class=\"token function\">updateData</span><span class=\"token punctuation\">(</span>collectionId<span class=\"token operator\">:</span> <span class=\"token builtin\">string</span><span class=\"token punctuation\">,</span> documentId<span class=\"token operator\">:</span> <span class=\"token builtin\">string</span><span class=\"token punctuation\">,</span> data<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>firestore<span class=\"token punctuation\">.</span><span class=\"token function\">updateDocument</span><span class=\"token punctuation\">(</span>collectionId <span class=\"token operator\">+</span> <span class=\"token string\">'/'</span> <span class=\"token operator\">+</span> documentId<span class=\"token punctuation\">,</span> data<span class=\"token punctuation\">,</span> <span class=\"token boolean\">true</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>また、GASからlibraryを使う方法は簡単でGAS画面で<strong>リソース=>ライブラリ</strong>から<strong>1VUSl4b1r1eoNcRWotZM3e87ygkxvXltOgyDZhixqncz9lQ3MjfT1iKFw</strong>をAdd a libraryします。</p>\n<p><img class=\"lozad\" src=\"data:image/gif;base64,R0lGODlhAQABAGAAACH5BAEKAP8ALAAAAAABAAEAAAgEAP8FBAA7\" data-src=\"https://i.imgur.com/pdgBiAu.png\" alt=\"img\"></p>\n<p>ここで注意として指定するバージョンは最新にしないことです。</p>\n<p>最新のバージョンはGASのV8エンジンに対応したため、旧版のGASでは動かなかったです。</p>\n<h2 id=\"結論\" style=\"position:relative;\"><a href=\"#%E7%B5%90%E8%AB%96\" aria-label=\"結論 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>結論</h2>\n<p>なんかめんどくさくなってきたので、フロント周りの記事は別機会に書きます...。</p>","words":1791,"minutes":5}},"staticQueryHashes":["1319877725","2959249232"]}