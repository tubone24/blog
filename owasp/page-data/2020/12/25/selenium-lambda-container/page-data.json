{"componentChunkName":"component---src-templates-blog-post-tsx","path":"/2020/12/25/selenium-lambda-container","result":{"data":{"content":{"edges":[{"node":{"id":"31936c3d-dc9a-5ecf-b10e-ad123253faf4","excerpt":"寂しいクリスマスです。 Table of Contents Lambda – Container Image Support Container Image Supportで何がうれしいの? LambdaでSeleniumと言えばserverless-chrome…","fields":{"slug":"2020/12/25/selenium-lambda-container"},"frontmatter":{"id":null,"title":"Lambda – Container Image Supportを使ってAlpineからSeleniumが動くコンテナを作ってTerraformで当てる","slug":"2020/12/25/selenium-lambda-container","date":"2020-12-25T14:58:26.302Z","headerImage":"https://i.imgur.com/dmGb7V6.png","tags":["AWS","Lambda","Selenium","Terraform"]}}}]}},"pageContext":{"id":"31936c3d-dc9a-5ecf-b10e-ad123253faf4","index":26,"repHtml":"<p>寂しいクリスマスです。</p>\n<h2 id=\"table-of-contents\" style=\"position:relative;\"><a href=\"#table-of-contents\" aria-label=\"table of contents permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Table of Contents</h2>\n<div class=\"toc\">\n<ul>\n<li>\n<p><a href=\"#lambda--container-image-support\">Lambda – Container Image Support</a></p>\n</li>\n<li>\n<p><a href=\"#container-image-support%E3%81%A7%E4%BD%95%E3%81%8C%E3%81%86%E3%82%8C%E3%81%97%E3%81%84%E3%81%AE\">Container Image Supportで何がうれしいの?</a></p>\n</li>\n<li>\n<p><a href=\"#lambda%E3%81%A7selenium%E3%81%A8%E8%A8%80%E3%81%88%E3%81%B0serverless-chrome%E3%81%A7%E3%81%99%E3%81%8C\">LambdaでSeleniumと言えばserverless-chromeですが</a></p>\n</li>\n<li>\n<p><a href=\"#%E4%BB%8A%E5%9B%9E%E3%82%84%E3%82%8A%E3%81%9F%E3%81%84%E3%81%93%E3%81%A8%E3%81%A8%E3%81%84%E3%81%86%E3%81%8B%E8%AA%B2%E9%A1%8C\">今回やりたいこと、というか課題</a></p>\n</li>\n<li>\n<p><a href=\"#alpine-python37\">Alpine Python:3.7</a></p>\n<ul>\n<li><a href=\"#container-image-support%E3%82%92%E4%BD%BF%E3%81%86%E3%81%AB%E3%81%AFric%E3%81%8C%E5%BF%85%E8%A6%81\">Container Image Supportを使うにはRICが必要</a></li>\n</ul>\n</li>\n<li>\n<p><a href=\"#docker-image%E3%82%92%E5%B0%91%E3%81%97%E3%81%A7%E3%82%82%E8%BB%BD%E3%81%8F%E3%81%99%E3%82%8B\">Docker Imageを少しでも軽くする</a></p>\n</li>\n<li>\n<p><a href=\"#%E3%81%A4%E3%81%84%E3%81%A7%E3%81%AB%E6%97%A5%E6%9C%AC%E8%AA%9E%E3%83%95%E3%82%A9%E3%83%B3%E3%83%88%E3%82%82%E3%82%A4%E3%83%B3%E3%82%B9%E3%83%88%E3%83%BC%E3%83%AB%E3%81%99%E3%82%8B\">ついでに日本語フォントもインストールする</a></p>\n</li>\n<li>\n<p><a href=\"#entrypoint%E4%BB%96%E8%A8%AD%E5%AE%9A\">Entrypoint他設定</a></p>\n</li>\n<li>\n<p><a href=\"#selenium%E3%81%8C%E5%8B%95%E3%81%8F%E3%82%88%E3%81%86%E3%81%AB%E3%81%99%E3%82%8B\">Seleniumが動くようにする</a></p>\n</li>\n<li>\n<p><a href=\"#--disable-dev-shm-usage\">--disable-dev-shm-usage</a></p>\n</li>\n<li>\n<p><a href=\"#%E3%82%B9%E3%83%94%E3%83%BC%E3%83%89%E3%82%A2%E3%83%83%E3%83%97%E3%81%AFchrome-driverservice\">スピードアップはChrome DriverService</a></p>\n</li>\n<li>\n<p><a href=\"#slack%E3%81%AB%E3%83%AD%E3%82%B0%E3%82%A4%E3%83%B3%E3%81%97%E3%81%A6%E5%8B%A4%E6%80%A0%E3%83%81%E3%83%A3%E3%83%B3%E3%83%8D%E3%83%AB%E3%81%AE%E3%82%B9%E3%82%AF%E3%83%AA%E3%83%BC%E3%83%B3%E3%82%B7%E3%83%A7%E3%83%83%E3%83%88%E3%82%92%E6%92%AE%E3%82%8B\">Slackにログインして勤怠チャンネルのスクリーンショットを撮る</a></p>\n</li>\n<li>\n<p><a href=\"#slack%E3%81%AB%E3%82%A2%E3%83%83%E3%83%97%E3%83%AD%E3%83%BC%E3%83%89%E3%81%99%E3%82%8B\">Slackにアップロードする</a></p>\n</li>\n<li>\n<p><a href=\"#%E4%B8%80%E9%83%A8%E3%83%95%E3%82%A9%E3%83%B3%E3%83%88%E3%81%8C%E8%B1%86%E8%85%90%E3%81%AE%E3%81%BE%E3%81%BE%E3%81%AB%E3%81%AA%E3%82%8B\">一部フォントが豆腐のままになる</a></p>\n</li>\n<li>\n<p><a href=\"#slack%E3%82%B5%E3%82%A4%E3%83%B3%E3%82%A4%E3%83%B3%E8%AD%A6%E5%91%8A%E3%81%8C%E3%81%A7%E3%82%8B\">Slackサインイン警告がでる</a></p>\n</li>\n<li>\n<p><a href=\"#terraform%E5%8C%96%E3%81%99%E3%82%8B\">Terraform化する</a></p>\n</li>\n<li>\n<p><a href=\"#%E5%AE%8C%E6%88%90\">完成</a></p>\n</li>\n</ul>\n</div>\n<h2 id=\"lambda--container-image-support\" style=\"position:relative;\"><a href=\"#lambda--container-image-support\" aria-label=\"lambda  container image support permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Lambda – Container Image Support</h2>\n<p>12/1 **<a href=\"https://aws.amazon.com/jp/blogs/aws/new-for-aws-lambda-container-image-support/\" target=\"_blank\" rel=\"noopener noreferrer\">Lambda – Container Image Support</a>**が発表されました。</p>\n<p><img class=\"lozad\" src=\"data:image/gif;base64,R0lGODlhAQABAGAAACH5BAEKAP8ALAAAAAABAAEAAAgEAP8FBAA7\" data-src=\"https://i.imgur.com/ZWIqgQZ.png\" alt=\"img\"></p>\n<p>Lambda作成画面にもContainer Imageが出てきております。</p>\n<p>発表当初はあまり注目してなかったのですがとある思いつきをしました。</p>\n<p>**Selenium載っける運用なら案外使い勝手いいかもしれない？**と。</p>\n<h2 id=\"container-image-supportで何がうれしいの\" style=\"position:relative;\"><a href=\"#container-image-support%E3%81%A7%E4%BD%95%E3%81%8C%E3%81%86%E3%82%8C%E3%81%97%E3%81%84%E3%81%AE\" aria-label=\"container image supportで何がうれしいの permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Container Image Supportで何がうれしいの?</h2>\n<p>Container Image SupportとはLambdaでDocker ImageからContainerが使えますよーということなのですが、使い所はあるのでしょうか？</p>\n<p>色々メリットあると思いますが、私が思うに、</p>\n<ul>\n<li>イメージは10GBまでデプロイできる</li>\n<li>Lambda Runtime Interface Emulatorを使ってローカルで実行できる</li>\n</ul>\n<p>の2点が嬉しい点だと思います。</p>\n<p>**Seleniumでそんなに容量使うのか？**問題はありますが、機会学習の推論をLambdaで実行させる、とかだと容量の壁や、Cライブラリビルドのアーキテクチャ差分に苦しめられる煩わしいパッケージ導入もなくなるのでもしかしたら使えるのかもですね。</p>\n<h2 id=\"lambdaでseleniumと言えばserverless-chromeですが\" style=\"position:relative;\"><a href=\"#lambda%E3%81%A7selenium%E3%81%A8%E8%A8%80%E3%81%88%E3%81%B0serverless-chrome%E3%81%A7%E3%81%99%E3%81%8C\" aria-label=\"lambdaでseleniumと言えばserverless chromeですが permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>LambdaでSeleniumと言えばserverless-chromeですが</h2>\n<p>LambdaでSeleniumを動かすと言えばつい最近まで<a href=\"https://github.com/adieuadieu/serverless-chrome\" target=\"_blank\" rel=\"noopener noreferrer\">serverless-chrome</a>が有名です。</p>\n<p>ようはLambdaのZIPパッケージ制限(一昔前はアップロード10MB, S3経由200MBだった)に引っかからないくらい小さくしたChromeをLambdaにパッケージ内包して、Seleniumのランナーから動かすわけです。</p>\n<p>とはいえ、環境構築で一癖も二癖もあるserverless-chromeなので、今回は普通のChromeをheadless起動させるDockerコンテナを作ってそれをLambdaで起動していくことで簡単構築ができるのではないか、というのがこの検証の趣旨です。</p>\n<h2 id=\"今回やりたいことというか課題\" style=\"position:relative;\"><a href=\"#%E4%BB%8A%E5%9B%9E%E3%82%84%E3%82%8A%E3%81%9F%E3%81%84%E3%81%93%E3%81%A8%E3%81%A8%E3%81%84%E3%81%86%E3%81%8B%E8%AA%B2%E9%A1%8C\" aria-label=\"今回やりたいことというか課題 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>今回やりたいこと、というか課題</h2>\n<p>話は変わりますが弊社にはSlackのWorkSpaceが乱立してます。</p>\n<p>さらに勤怠連絡もSlackに書き込むのですが乱立したWorkSpaceにすべて書き込むのはちょっとめんどくさいです。</p>\n<p>(以前はSlackのほかTeamsやらメールやら電話やらあらゆる媒体で一斉勤怠連絡しないといけなくてこれでも楽になりました。)</p>\n<p>じゃあ、Slack APIとか使って、相互投稿とかして解決すればいいじゃんとなりそうですが、一部のWorkSpaceはセキュリティの観点から外部連携が禁止とのこと。なんじゃそりゃ...。</p>\n<p><img class=\"lozad\" src=\"data:image/gif;base64,R0lGODlhAQABAGAAACH5BAEKAP8ALAAAAAABAAEAAAgEAP8FBAA7\" data-src=\"https://i.imgur.com/odKSxHU.png\" alt=\"img\"></p>\n<p>そこで、セキュア(笑)なSlackのスクリーンショットを取り、普段使っているSlackへ投稿する仕組みにすれば、少なくとも連絡はしたようなものなので、まぁ楽でしょう！ということで作っていきます。</p>\n<h2 id=\"alpine-python37\" style=\"position:relative;\"><a href=\"#alpine-python37\" aria-label=\"alpine python37 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Alpine Python:3.7</h2>\n<p>軽量イメージで有名な<a href=\"https://hub.docker.com/_/alpine\" target=\"_blank\" rel=\"noopener noreferrer\">Apline</a>をベースイメージにします。</p>\n<p>はい、この選択肢はとある理由で<strong>間違い</strong>でした、がそれはこの先わかることです。</p>\n<p>軽いから使う、という安直極まりない選定で言ってしまったのが後々後悔となりますので、皆さん、ちゃんと調べましょう。</p>\n<h3 id=\"container-image-supportを使うにはricが必要\" style=\"position:relative;\"><a href=\"#container-image-support%E3%82%92%E4%BD%BF%E3%81%86%E3%81%AB%E3%81%AFric%E3%81%8C%E5%BF%85%E8%A6%81\" aria-label=\"container image supportを使うにはricが必要 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Container Image Supportを使うにはRICが必要</h3>\n<p>Lambdaは起動する際にAWS基板側からAWS LambdaランタイムAPIでランタイムをキックすることで実現してます。</p>\n<p>そうです。Container Image SupportといいつつもLambdaで実現する以上、こいつを受け取らないといけないのです。</p>\n<p>なので単純にdocker runで起動するコンテナイメージを作るだけじゃLambdaには載っけられないので、AWS Lambda Runtime Interface Clients(RIC)というOSSがAWSから提供されてます。</p>\n<p>例えばPythonであれば<a href=\"https://github.com/aws/aws-lambda-python-runtime-interface-client\" target=\"_blank\" rel=\"noopener noreferrer\">AWS Lambda Python Runtime Interface Client\n</a>があります。</p>\n<p>こいつを介してLambda起動させるわけです。</p>\n<p>こいつがやっかいでした。<a href=\"https://github.com/aws/aws-lambda-python-runtime-interface-client/blob/main/README.md#creating-a-docker-image-for-lambda-with-the-runtime-interface-client\" target=\"_blank\" rel=\"noopener noreferrer\">README</a>にも書いてありましたが、インストールにLinuxのBuild tool類が必要で、結局Alpineの軽量さの恩恵を受けられませんでした。</p>\n<p>とはいえ、落ち込んでいても仕方ないので、まずはSelenium Pythonが動く環境を作っていきます。</p>\n<p>Dockerfileを使って、RIC関連とChrome, Chrome-driverを入れていきます。</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">FROM python:3.7-alpine\n\nENV PYTHONIOENCODING utf-8\nWORKDIR /app\n\nRUN apk add --update \\\n        build-base \\\n        libtool \\\n        autoconf \\\n        automake \\\n        libexecinfo-dev \\\n        make \\\n        cmake \\\n        libcurl \\\n        wget \\\n        bash \\\n        which \\\n        groff \\\n        udev \\\n        chromium \\\n        chromium-chromedriver  &amp;&amp; \\\n        pip install --target /app awslambdaric &amp;&amp; \\\n        pip install selenium</code></pre></div>\n<p>RICを入れるには<a href=\"https://github.com/aws/aws-lambda-python-runtime-interface-client/blob/main/README.md#creating-a-docker-image-for-lambda-with-the-runtime-interface-client\" target=\"_blank\" rel=\"noopener noreferrer\">README</a>では、g++、make、cmake、unzip、libcurl4-openssl-devがでしたが、それはUbuntuベースのイメージだったからで、Alpineでは、他に、<strong>autoconf</strong>や<strong>automake</strong>など結構色々必要でした。めんどくさい...。</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">Collecting awslambdaric\n  Downloading awslambdaric-1.0.0.tar.gz (3.2 MB)\n    ERROR: Command errored out with exit status 1:\n     command: /usr/local/bin/python -c 'import sys, setuptools, tokenize; sys.argv[0] = '\"'\"'/tmp/pip-install-_vlp4rwk/awslambdaric_c160f1900b624d1a85d1135d75e3b6ef/setup.py'\"'\"'; __file__='\"'\"'/tmp/pip-install-_vlp4rwk/awslambdaric_c160f1900b624d1a85d1135d75e3b6ef/setup.py'\"'\"';f=getattr(tokenize, '\"'\"'open'\"'\"', open)(__file__);code=f.read().replace('\"'\"'\\r\\n'\"'\"', '\"'\"'\\n'\"'\"');f.close();exec(compile(code, __file__, '\"'\"'exec'\"'\"'))' egg_info --egg-base /tmp/pip-pip-egg-info-xp6t7j5r\n         cwd: /tmp/pip-install-_vlp4rwk/awslambdaric_c160f1900b624d1a85d1135d75e3b6ef/\n    Complete output (16 lines):\n    buildconf: autoconf version 2.69 (ok)\n    buildconf: autom4te version 2.69 (ok)\n    buildconf: autoheader version 2.69 (ok)\n    buildconf: automake not found.\n                You need automake version 1.7 or newer installed.\n    Traceback (most recent call last):\n      File \"&lt;string>\", line 1, in &lt;module>\n      File \"/tmp/pip-install-_vlp4rwk/awslambdaric_c160f1900b624d1a85d1135d75e3b6ef/setup.py\", line 94, in &lt;module>\n        ext_modules=get_runtime_client_extension(),\n      File \"/tmp/pip-install-_vlp4rwk/awslambdaric_c160f1900b624d1a85d1135d75e3b6ef/setup.py\", line 45, in get_runtime_client_extension\n        extra_link_args=get_curl_extra_linker_flags(),\n      File \"/tmp/pip-install-_vlp4rwk/awslambdaric_c160f1900b624d1a85d1135d75e3b6ef/setup.py\", line 18, in get_curl_extra_linker_flags\n        check_call([\"./scripts/preinstall.sh\"])\n      File \"/usr/local/lib/python3.7/subprocess.py\", line 363, in check_call\n        raise CalledProcessError(retcode, cmd)\n    subprocess.CalledProcessError: Command '['./scripts/preinstall.sh']' returned non-zero exit status 1.\n    ----------------------------------------\nERROR: Command errored out with exit status 1: python setup.py egg_info Check the logs for full command output.</code></pre></div>\n<p>必要なパッケージが入ってないと**You need automake version 1.7 or newer installed.**のようにRICのインストールで怒られてしまいます。こんな罠があるとは..。</p>\n<p>あれこれあれこれ試行錯誤し、うまくいけば次のようにRICのBuildが終わってめでたしめでたしです。</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">Building wheels for collected packages: awslambdaric, simplejson\n  Building wheel for awslambdaric (setup.py): started\n  Building wheel for awslambdaric (setup.py): still running...\n  Building wheel for awslambdaric (setup.py): finished with status 'done'\n  Created wheel for awslambdaric: filename=awslambdaric-1.0.0-cp37-cp37m-linux_x86_64.whl size=246020 sha256=4d2550bf826e2ad294aa0335eb87987b63d61d13aad8c06c189c080ff4479ac5\n  Stored in directory: /root/.cache/pip/wheels/f2/d6/df/40b746a2bdaca7ceec3244383e8e252c5a9f3870621fd68a37\n  Building wheel for simplejson (setup.py): started\n  Building wheel for simplejson (setup.py): finished with status 'done'\n  Created wheel for simplejson: filename=simplejson-3.17.2-cp37-cp37m-linux_x86_64.whl size=74647 sha256=ffca4c04bc4b3e577dcd91c83e01b3670d6274e1a7dde0177a699c7174a3c8f9\n  Stored in directory: /root/.cache/pip/wheels/e5/69/2c/bdcb34114373fc0dbb53242f5df4bf41bce149acac4f8160d0\nSuccessfully built awslambdaric simplejson</code></pre></div>\n<p>また、肝心のChromeとChrome-driverはapkでそのまま入れればいいので実にこちらは簡単です。</p>\n<p>apkからインストールすることで常に、stableでインストールするので、chromedriverとのバージョンを意識することもありません！れはありがたい。</p>\n<h2 id=\"docker-imageを少しでも軽くする\" style=\"position:relative;\"><a href=\"#docker-image%E3%82%92%E5%B0%91%E3%81%97%E3%81%A7%E3%82%82%E8%BB%BD%E3%81%8F%E3%81%99%E3%82%8B\" aria-label=\"docker imageを少しでも軽くする permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Docker Imageを少しでも軽くする</h2>\n<p>こちらImage Buildし終わるとあら大変。せっかくのAlpineの<strong>41.1MB</strong>の軽量イメージが<strong>1.14GB</strong>と台無しになってしまいました。</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\"># Alpine\npython         3.7-alpine       f82a49b6a141   10 days ago      41.1MB\n\n# Selenium\nselenium       latest           acc90965ec5b   30 hours ago     1.14GB\n</code></pre></div>\n<p>こちらなんとかするためにRICがインストールが完了したタイミングで、build関係のパッケージを同一レイヤーで消してしまいましょう。(別レイヤーにするとファイルの増減が記録されてしまうので注意)</p>\n<div class=\"gatsby-highlight\" data-language=\"docker\"><pre class=\"language-docker\"><code class=\"language-docker\"><span class=\"token instruction\"><span class=\"token keyword\">RUN</span> apk add --update <span class=\"token operator\">\\</span>\n    <span class=\"token comment\"># Add Dependencies for compile AWS Lambda ric</span>\n        build-base <span class=\"token operator\">\\</span>\n        libtool <span class=\"token operator\">\\</span>\n        autoconf <span class=\"token operator\">\\</span>\n        automake <span class=\"token operator\">\\</span>\n        libexecinfo-dev <span class=\"token operator\">\\</span>\n        make <span class=\"token operator\">\\</span>\n        cmake <span class=\"token operator\">\\</span>\n        libcurl <span class=\"token operator\">\\</span>\n        wget <span class=\"token operator\">\\</span>\n        bash <span class=\"token operator\">\\</span>\n        which <span class=\"token operator\">\\</span>\n        groff <span class=\"token operator\">\\</span>\n        udev <span class=\"token operator\">\\</span>\n        chromium <span class=\"token operator\">\\</span>\n        chromium-chromedriver  &amp;&amp; <span class=\"token operator\">\\</span>\n      pip install -r requirements.txt &amp;&amp; <span class=\"token operator\">\\</span>\n        pip install --target /app awslambdaric &amp;&amp; <span class=\"token operator\">\\</span>\n        rm /app/requirements.txt &amp;&amp; <span class=\"token operator\">\\</span>\n      apk del <span class=\"token operator\">\\</span>\n        build-base <span class=\"token operator\">\\</span>\n        libtool <span class=\"token operator\">\\</span>\n        autoconf <span class=\"token operator\">\\</span>\n        automake <span class=\"token operator\">\\</span>\n        libexecinfo-dev <span class=\"token operator\">\\</span>\n        make <span class=\"token operator\">\\</span>\n        cmake <span class=\"token operator\">\\</span>\n        libcurl <span class=\"token operator\">\\</span>\n        wget <span class=\"token operator\">\\</span>\n        bash <span class=\"token operator\">\\</span>\n        which <span class=\"token operator\">\\</span>\n        groff</span>\n</code></pre></div>\n<p>ややこしいですが、こうすることで（後述する日本語フォントも入れながら）846MBまで削減できました。同一レイヤーでいらないものは消す。これ、偉い人とのお約束。</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">selenium   latest           04304fcd4549   18 minutes ago   846MB</code></pre></div>\n<h2 id=\"ついでに日本語フォントもインストールする\" style=\"position:relative;\"><a href=\"#%E3%81%A4%E3%81%84%E3%81%A7%E3%81%AB%E6%97%A5%E6%9C%AC%E8%AA%9E%E3%83%95%E3%82%A9%E3%83%B3%E3%83%88%E3%82%82%E3%82%A4%E3%83%B3%E3%82%B9%E3%83%88%E3%83%BC%E3%83%AB%E3%81%99%E3%82%8B\" aria-label=\"ついでに日本語フォントもインストールする permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>ついでに日本語フォントもインストールする</h2>\n<p>さて、Seleniumを使うときつきまとうのはフォント<strong>豆腐</strong>問題です。</p>\n<p><img class=\"lozad\" src=\"data:image/gif;base64,R0lGODlhAQABAGAAACH5BAEKAP8ALAAAAAABAAEAAAgEAP8FBAA7\" data-src=\"https://i.imgur.com/tjIJUBn.jpg\" alt=\"img\"></p>\n<p>日本語のようにASCII文字では表現できない文字は、対応するフォントがインストールされていないと文字の代わりに小さい四角(□)、通称<strong>豆腐</strong>が表示されることがあります。麻雀の白ではないですよ。というより豆腐という日本語が世界語になっているのはすごいですね。</p>\n<p>で、話を戻しますが当然Alpineのような軽量Imageには日本語フォントなんて入ってません。</p>\n<p>さて、フォント豆腐問題の解消によく使うのが<a href=\"https://www.google.com/get/noto/\" target=\"_blank\" rel=\"noopener noreferrer\">Google Noto Fonts</a>です。</p>\n<p><strong>No</strong> <strong>to</strong>fuでNotoらしいです。</p>\n<p>ただし、配布されているNoto FontsのAll one packageをすべてを使うと例えばアラビア語(اللغة العربية)やサンスクリット語(संस्कृत)なんかも入ってしまい、計<strong>1.1GB</strong>になってしまいます。これは重い。</p>\n<p>そこで、日本語フォントだけ利用したい場合、<a href=\"https://www.google.com/get/noto/#sans-jpan\" target=\"_blank\" rel=\"noopener noreferrer\">Noto Sans CJK JP</a>と<a href=\"https://www.google.com/get/noto/#serif-jpan\" target=\"_blank\" rel=\"noopener noreferrer\">Noto Serif CJK JP</a>を個別にダウンロードして/usr/share/fonts配下に展開することで容量を抑えることができます。どちらも130MBくらいです。</p>\n<p>また、展開したフォントをシステムが使えるようにフォント展開後、fc-cacheも実行していきます。</p>\n<p>ちなみにCJKというのは<strong>Chinese</strong>, <strong>Japanese</strong>, <strong>Korean</strong>のことらしいです。</p>\n<p>ついでにASCIIフォントのfreefontもインストールします。</p>\n<div class=\"gatsby-highlight\" data-language=\"docker\"><pre class=\"language-docker\"><code class=\"language-docker\"><span class=\"token instruction\"><span class=\"token keyword\">RUN</span> apk add --update <span class=\"token operator\">\\</span>\n        ttf-freefont <span class=\"token operator\">\\</span>\n        freetype <span class=\"token operator\">\\</span>\n        fontconfig <span class=\"token operator\">\\</span>\n      mkdir noto &amp;&amp; <span class=\"token operator\">\\</span>\n        wget -P /app/noto https://noto-website.storage.googleapis.com/pkgs/NotoSansCJKjp-hinted.zip &amp;&amp; <span class=\"token operator\">\\</span>\n        wget -P /app/noto https://noto-website-2.storage.googleapis.com/pkgs/NotoSerifCJKjp-hinted.zip &amp;&amp; <span class=\"token operator\">\\</span>\n        unzip /app/noto/NotoSansCJKjp-hinted.zip -d /app/noto &amp;&amp; <span class=\"token operator\">\\</span>\n        unzip -o /app/noto/NotoSerifCJKjp-hinted.zip -d /app/noto &amp;&amp; <span class=\"token operator\">\\</span>\n        mkdir -p /usr/share/fonts/noto &amp;&amp; <span class=\"token operator\">\\</span>\n        cp /app/noto/*.otf /usr/share/fonts/noto &amp;&amp; <span class=\"token operator\">\\</span>\n        chmod 644 -R /usr/share/fonts/noto/ &amp;&amp; <span class=\"token operator\">\\</span>\n        rm -rf /app/noto &amp;&amp; <span class=\"token operator\">\\</span>\n        fc-cache -fv</span></code></pre></div>\n<p>これでフォント問題は解決...のはずですが、後半で「だめです」が出るので、さらに改良していくことになります。</p>\n<h2 id=\"entrypoint他設定\" style=\"position:relative;\"><a href=\"#entrypoint%E4%BB%96%E8%A8%AD%E5%AE%9A\" aria-label=\"entrypoint他設定 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Entrypoint他設定</h2>\n<p>Lambdaでの起動のため、DockerのEntrypointとCMDを設定します。</p>\n<p><a href=\"https://github.com/aws/aws-lambda-python-runtime-interface-client/blob/main/README.md#creating-a-docker-image-for-lambda-with-the-runtime-interface-client\" target=\"_blank\" rel=\"noopener noreferrer\">README</a>に書いてあるとおり、Entrypointは<strong>awslambdaric</strong>をCMDは実際のLambdaが起動するときに動く関数を選択します。(ここでは、app.pyのhandler関数)</p>\n<div class=\"gatsby-highlight\" data-language=\"docker\"><pre class=\"language-docker\"><code class=\"language-docker\"><span class=\"token instruction\"><span class=\"token keyword\">ENTRYPOINT</span> [ <span class=\"token string\">\"/usr/local/bin/python\"</span>, <span class=\"token string\">\"-m\"</span>, <span class=\"token string\">\"awslambdaric\"</span> ]</span>\n<span class=\"token instruction\"><span class=\"token keyword\">CMD</span> [ <span class=\"token string\">\"app.handler\"</span> ]</span></code></pre></div>\n<h2 id=\"seleniumが動くようにする\" style=\"position:relative;\"><a href=\"#selenium%E3%81%8C%E5%8B%95%E3%81%8F%E3%82%88%E3%81%86%E3%81%AB%E3%81%99%E3%82%8B\" aria-label=\"seleniumが動くようにする permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Seleniumが動くようにする</h2>\n<p>さてSeleniumのランナーに移っていきます。</p>\n<p>さきほどコマンドでapp.handlerを指定したので、モジュール名はapp.py、関数名はhandlerでいきます。</p>\n<p>また、apkでインストールしたChrome(Chromium)、Chrome-driverはそれぞれ**/usr/bin/chromium-browser** <strong>/usr/lib/chromium/chromedriver</strong>に存在してます。</p>\n<p>まずはとりあえずSlackのログインページを開き、タイトルを表示します。次のように組んでいきます。</p>\n<div class=\"gatsby-highlight\" data-language=\"python\"><pre class=\"language-python\"><code class=\"language-python\"><span class=\"token keyword\">from</span> selenium <span class=\"token keyword\">import</span> webdriver\n<span class=\"token keyword\">from</span> selenium<span class=\"token punctuation\">.</span>webdriver<span class=\"token punctuation\">.</span>chrome<span class=\"token punctuation\">.</span>options <span class=\"token keyword\">import</span> Options\n\nSLACK_LOGIN_URL <span class=\"token operator\">=</span> <span class=\"token string\">\"https://xxxxx.slack.com\"</span>\nchrome_path <span class=\"token operator\">=</span> <span class=\"token string\">\"/usr/bin/chromium-browser\"</span>\nchromedriver_path <span class=\"token operator\">=</span> <span class=\"token string\">\"/usr/lib/chromium/chromedriver\"</span>\n\n<span class=\"token keyword\">def</span> <span class=\"token function\">handler</span><span class=\"token punctuation\">(</span>event<span class=\"token punctuation\">,</span> context<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n    o <span class=\"token operator\">=</span> Options<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n    o<span class=\"token punctuation\">.</span>binary_location <span class=\"token operator\">=</span> chrome_path\n    o<span class=\"token punctuation\">.</span>add_argument<span class=\"token punctuation\">(</span><span class=\"token string\">'--headless'</span><span class=\"token punctuation\">)</span>\n    o<span class=\"token punctuation\">.</span>add_argument<span class=\"token punctuation\">(</span><span class=\"token string\">'--disable-gpu'</span><span class=\"token punctuation\">)</span>\n    o<span class=\"token punctuation\">.</span>add_argument<span class=\"token punctuation\">(</span><span class=\"token string\">'--no-sandbox'</span><span class=\"token punctuation\">)</span>\n    o<span class=\"token punctuation\">.</span>add_argument<span class=\"token punctuation\">(</span><span class=\"token string\">'--window-size=1920x1080'</span><span class=\"token punctuation\">)</span>\n    \n    d <span class=\"token operator\">=</span> webdriver<span class=\"token punctuation\">.</span>Chrome<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n    d<span class=\"token punctuation\">.</span>get<span class=\"token punctuation\">(</span>SLACK_LOGIN_URL<span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">print</span><span class=\"token punctuation\">(</span><span class=\"token string-interpolation\"><span class=\"token string\">f\"PageTitle </span><span class=\"token interpolation\"><span class=\"token punctuation\">{</span>d<span class=\"token punctuation\">.</span>title<span class=\"token punctuation\">}</span></span><span class=\"token string\">\"</span></span><span class=\"token punctuation\">)</span></code></pre></div>\n<p>Chromeの起動オプションに指定している**--headless**、<strong>--disable-gpu</strong>、<strong>--no-sandbox</strong>はいずれもLambdaでのSelenium起動には必須のオプションで、それぞれ**--headless<strong>はヘッドレス起動(ディスプレイやキーボード、マウスなどの入出力機器を接続しない状態をヘッドレスと言います)、</strong>--disable-gpu<strong>はGPU無効(--headlessオプションと併用必須らしい)、</strong>--no-sandbox**はサンドボックス起動無効化のことらしいです。</p>\n<p>ちなみに、Chrome(Chromium)はセキュリティ向上のため、レンダリングやスクリプトエンジンをSandboxというchrootで隔離された環境で動かすそうです。</p>\n<p>Dockerコンテナ内でchrootをするにはdocker側でそのホストのすべてのデバイスへのアクセスを許可する必要があり、–privilegedオプションが必要となります。</p>\n<p>ただ、Lambdaではこちらは許容されないため、–no-sandboxをつけてsandboxを無効化しなければいけません。脆弱性を突かれるとアプリのソースにアクセスされてしまう可能性は残りますが...。</p>\n<p>さて、こちらのコードでLambdaにイメージをデプロイして起動して見ると次のようなエラーを吐き出し動きませんでした..。</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">  File \"/app/python/lib/python3.6/site-packages/selenium/webdriver/remote/errorhandler.py\", line 242, in check_response\n    raise exception_class(message, screen, stacktrace)\nselenium.common.exceptions.WebDriverException: Message: unknown error: Chrome failed to start: crashed.\n  (unknown error: DevToolsActivePort file doesn't exist)\n  (The process started from chrome location /usr/bin/chromium-browser is no longer running, so ChromeDriver is assuming that Chrome has crashed.)</code></pre></div>\n<p>Chromeがクラッシュしてしまった、という意味合いとはわかりますがどうにもわかりません。エラーがわかりにくいのがSeleniumの悪いところです。</p>\n<h2 id=\"--disable-dev-shm-usage\" style=\"position:relative;\"><a href=\"#--disable-dev-shm-usage\" aria-label=\"  disable dev shm usage permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>--disable-dev-shm-usage</h2>\n<p>さらに調べていくと次のようなことがわかりました。<strong>--disable-dev-shm-usage</strong>というオプションが必要だったようです。</p>\n<p>Chromeではキャッシュ用にtmpfs(/dev/shmファイルシステムレベルの共有メモリ)を利用しているのですがLambdaがこちら64MBしかないので落ちてしまうそうです。なので、キャッシュは/tmp(ディスク)を利用してもらうべく**--disable-dev-shm-usage**も追加する必要があります。</p>\n<p>ちなみに、Lambdaの/tmpは最近調べたのですが512MBくらいありました。</p>\n<div class=\"gatsby-highlight\" data-language=\"python\"><pre class=\"language-python\"><code class=\"language-python\"><span class=\"token keyword\">def</span> <span class=\"token function\">handler</span><span class=\"token punctuation\">(</span>event<span class=\"token punctuation\">,</span> context<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n    o <span class=\"token operator\">=</span> Options<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n    o<span class=\"token punctuation\">.</span>binary_location <span class=\"token operator\">=</span> chrome_path\n    o<span class=\"token punctuation\">.</span>add_argument<span class=\"token punctuation\">(</span><span class=\"token string\">'--headless'</span><span class=\"token punctuation\">)</span>\n    o<span class=\"token punctuation\">.</span>add_argument<span class=\"token punctuation\">(</span><span class=\"token string\">'--disable-gpu'</span><span class=\"token punctuation\">)</span>\n    o<span class=\"token punctuation\">.</span>add_argument<span class=\"token punctuation\">(</span><span class=\"token string\">'--no-sandbox'</span><span class=\"token punctuation\">)</span>\n    o<span class=\"token punctuation\">.</span>add_argument<span class=\"token punctuation\">(</span><span class=\"token string\">'--window-size=1920x1080'</span><span class=\"token punctuation\">)</span>\n    o<span class=\"token punctuation\">.</span>add_argument<span class=\"token punctuation\">(</span><span class=\"token string\">'--disable-dev-shm-usage'</span><span class=\"token punctuation\">)</span>\n\n    d <span class=\"token operator\">=</span> webdriver<span class=\"token punctuation\">.</span>Chrome<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n    d<span class=\"token punctuation\">.</span>get<span class=\"token punctuation\">(</span>SLACK_LOGIN_URL<span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">print</span><span class=\"token punctuation\">(</span><span class=\"token string-interpolation\"><span class=\"token string\">f\"PageTitle </span><span class=\"token interpolation\"><span class=\"token punctuation\">{</span>d<span class=\"token punctuation\">.</span>title<span class=\"token punctuation\">}</span></span><span class=\"token string\">\"</span></span><span class=\"token punctuation\">)</span></code></pre></div>\n<p>こちらでエラーは出なくなりましたが、<strong>5分でタイムアウト</strong>してしまいました。</p>\n<h2 id=\"スピードアップはchrome-driverservice\" style=\"position:relative;\"><a href=\"#%E3%82%B9%E3%83%94%E3%83%BC%E3%83%89%E3%82%A2%E3%83%83%E3%83%97%E3%81%AFchrome-driverservice\" aria-label=\"スピードアップはchrome driverservice permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>スピードアップはChrome DriverService</h2>\n<p>と勝手に聞いてなんとなく納得してしまったので<strong>Chrome DriverService</strong>を使うように書き直したらちゃんとうごきました。なぜなんでしょうねぇー。</p>\n<div class=\"gatsby-highlight\" data-language=\"python\"><pre class=\"language-python\"><code class=\"language-python\"><span class=\"token keyword\">def</span> <span class=\"token function\">handler</span><span class=\"token punctuation\">(</span>event<span class=\"token punctuation\">,</span> context<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n    o <span class=\"token operator\">=</span> Options<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n    o<span class=\"token punctuation\">.</span>binary_location <span class=\"token operator\">=</span> chrome_path\n    o<span class=\"token punctuation\">.</span>add_argument<span class=\"token punctuation\">(</span><span class=\"token string\">'--headless'</span><span class=\"token punctuation\">)</span>\n    o<span class=\"token punctuation\">.</span>add_argument<span class=\"token punctuation\">(</span><span class=\"token string\">'--disable-gpu'</span><span class=\"token punctuation\">)</span>\n    o<span class=\"token punctuation\">.</span>add_argument<span class=\"token punctuation\">(</span><span class=\"token string\">'--no-sandbox'</span><span class=\"token punctuation\">)</span>\n    o<span class=\"token punctuation\">.</span>add_argument<span class=\"token punctuation\">(</span><span class=\"token string\">'--disable-dev-shm-usage'</span><span class=\"token punctuation\">)</span>\n    o<span class=\"token punctuation\">.</span>add_argument<span class=\"token punctuation\">(</span><span class=\"token string\">'--window-size=1920x1080'</span><span class=\"token punctuation\">)</span>\n\n    <span class=\"token keyword\">print</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"Start Chrome Session\"</span><span class=\"token punctuation\">)</span>\n    s <span class=\"token operator\">=</span> Service<span class=\"token punctuation\">(</span>executable_path<span class=\"token operator\">=</span>chromedriver_path<span class=\"token punctuation\">)</span>\n    s<span class=\"token punctuation\">.</span>start<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n    d <span class=\"token operator\">=</span> webdriver<span class=\"token punctuation\">.</span>Remote<span class=\"token punctuation\">(</span>\n        s<span class=\"token punctuation\">.</span>service_url<span class=\"token punctuation\">,</span>\n        desired_capabilities<span class=\"token operator\">=</span>o<span class=\"token punctuation\">.</span>to_capabilities<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">)</span>\n\n    d<span class=\"token punctuation\">.</span>get<span class=\"token punctuation\">(</span>SLACK_LOGIN_URL<span class=\"token punctuation\">)</span>\n\n    <span class=\"token keyword\">print</span><span class=\"token punctuation\">(</span><span class=\"token string-interpolation\"><span class=\"token string\">f\"PageTitle </span><span class=\"token interpolation\"><span class=\"token punctuation\">{</span>d<span class=\"token punctuation\">.</span>title<span class=\"token punctuation\">}</span></span><span class=\"token string\">\"</span></span><span class=\"token punctuation\">)</span></code></pre></div>\n<h2 id=\"slackにログインして勤怠チャンネルのスクリーンショットを撮る\" style=\"position:relative;\"><a href=\"#slack%E3%81%AB%E3%83%AD%E3%82%B0%E3%82%A4%E3%83%B3%E3%81%97%E3%81%A6%E5%8B%A4%E6%80%A0%E3%83%81%E3%83%A3%E3%83%B3%E3%83%8D%E3%83%AB%E3%81%AE%E3%82%B9%E3%82%AF%E3%83%AA%E3%83%BC%E3%83%B3%E3%82%B7%E3%83%A7%E3%83%83%E3%83%88%E3%82%92%E6%92%AE%E3%82%8B\" aria-label=\"slackにログインして勤怠チャンネルのスクリーンショットを撮る permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Slackにログインして勤怠チャンネルのスクリーンショットを撮る</h2>\n<p>さて、Seleniumも無事動いたので、Slackにログインして勤怠チャンネルをパシャっと撮りましょう。</p>\n<p>まずはログインページアクセスですが、これはブラウザで<a href=\"https://slack-workspace-url.slack.com%E3%81%AB%E3%82%A2%E3%82%AF%E3%82%BB%E3%82%B9%E3%81%97%E3%81%BE%E3%81%99%E3%81%A8%E3%80%81E%E3%83%A1%E3%83%BC%E3%83%AB%E3%81%A8%E3%83%91%E3%82%B9%E3%83%AF%E3%83%BC%E3%83%89%E3%82%92%E8%81%9E%E3%81%8B%E3%82%8C%E3%82%8B%E3%83%95%E3%82%A9%E3%83%BC%E3%83%A0%E3%81%8C%E5%87%BA%E3%81%A6%E3%81%8D%E3%81%BE%E3%81%99%E3%80%82\" target=\"_blank\" rel=\"noopener noreferrer\">https://slack-workspace-url.slack.comにアクセスしますと、Eメールとパスワードを聞かれるフォームが出てきます。</a></p>\n<p><img class=\"lozad\" src=\"data:image/gif;base64,R0lGODlhAQABAGAAACH5BAEKAP8ALAAAAAABAAEAAAgEAP8FBAA7\" data-src=\"https://i.imgur.com/LaMP20t.png\" alt=\"img\"></p>\n<p>こちら確認してみると、Elementのidがそれぞれ、email, passwordとなっております。また、Sign inボタンはID signin_btnとなっております。ありがたいですね。</p>\n<p><img class=\"lozad\" src=\"data:image/gif;base64,R0lGODlhAQABAGAAACH5BAEKAP8ALAAAAAABAAEAAAgEAP8FBAA7\" data-src=\"https://i.imgur.com/S8orasB.png\" alt=\"img\"></p>\n<p>ということで、idがemailのElementが描画されたらEメール、パスワードを入力し、ボチッとSign inボタンをクリックします。</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">from selenium.webdriver.common.by import By\nfrom selenium.webdriver.support.ui import WebDriverWait\nfrom selenium.webdriver.support import expected_conditions\n\n(中略)\n\n    wait = WebDriverWait(d, 10)\n\n    email = wait.until(expected_conditions.visibility_of_element_located((By.ID, \"email\")))\n\n    email.send_keys(tubone@email.com)\n\n    email = d.find_element(by=By.ID, value=\"password\")\n    email.send_keys(\"hogehoge\")\n\n    signin_btn = d.find_element(by=By.ID, value=\"signin_btn\")\n    signin_btn.click()\n\n    d.implicitly_wait(10)\n    print(f\"PageTitle {d.title}\")</code></pre></div>\n<p><a href=\"https://selenium-python.readthedocs.io/api.html#module-selenium.webdriver.support.wait\" target=\"_blank\" rel=\"noopener noreferrer\">WebDriverWait</a>で最大待機秒数を設定後、<a href=\"https://selenium-python.readthedocs.io/api.html#selenium.webdriver.support.expected_conditions.invisibility_of_element_located\" target=\"_blank\" rel=\"noopener noreferrer\">expected_conditions.visibility_of_element_located</a>で特定の要素が描画されるまで待つようにすることで明示的に要素の描画を待つことが実現できます。</p>\n<p>sleep(10)とかよりも効率的で安全ですね。</p>\n<p>また、<a href=\"https://selenium-python.readthedocs.io/api.html#selenium.webdriver.remote.webdriver.WebDriver.implicitly_wait\" target=\"_blank\" rel=\"noopener noreferrer\">implicitly_wait</a>を使うことで何かしらの要素が描画されるまで待つ、みたいなもうちょっと曖昧なこともできます。</p>\n<p>ともあれ、これでログインが無事できました。</p>\n<p>ログインしたらチャンネルのURLにアクセスします。チャンネルのURLは、</p>\n<p><a href=\"https://app.slack.com/client/xxxxxxxxx/yyyyyyyyy\" target=\"_blank\" rel=\"noopener noreferrer\">https://app.slack.com/client/xxxxxxxxx/yyyyyyyyy</a></p>\n<p>みたいな感じでyyyyyyがチャンネルと対応してます。あらかじめひかえておきます。</p>\n<p>スクリーンショットは<a href=\"https://selenium-python.readthedocs.io/api.html#selenium.webdriver.remote.webdriver.WebDriver.save_screenshot\" target=\"_blank\" rel=\"noopener noreferrer\">save_screenshot</a>を使えば画面のPNGが撮れます。</p>\n<p>ここで少し詰まったのは、Lambdaの場合、<strong>/tmpディレクトリしか書き込み権限がない</strong>ということです。ちょっとハマりました。</p>\n<p>/app配下にスクリーンショット吐き出そうとしたらIO Errorになってうまく吐き出せませんでした。</p>\n<div class=\"gatsby-highlight\" data-language=\"python\"><pre class=\"language-python\"><code class=\"language-python\"><span class=\"token keyword\">print</span><span class=\"token punctuation\">(</span>d<span class=\"token punctuation\">.</span>save_screenshot<span class=\"token punctuation\">(</span><span class=\"token string\">\"/tmp/screen.png\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span></code></pre></div>\n<p>ちなみに、save_screenshotの戻り値はboolとなっており、Trueは成功、Falseは失敗です。書き込みに失敗してもExceptionはraiseしないので、Python scriptが進んでいってしまい、後半のSlackアップロードでno such fileになってしまいました。難しい。</p>\n<h2 id=\"slackにアップロードする\" style=\"position:relative;\"><a href=\"#slack%E3%81%AB%E3%82%A2%E3%83%83%E3%83%97%E3%83%AD%E3%83%BC%E3%83%89%E3%81%99%E3%82%8B\" aria-label=\"slackにアップロードする permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Slackにアップロードする</h2>\n<p>アップロードはSlack APIのfile.uploadを使いました。</p>\n<p>あらかじめTOKENとPermissionを設定しておきましょう。</p>\n<p>Slack Appを作ったらSlackAPIのOAuth&#x26;Permissionsから確認できます。</p>\n<p><img class=\"lozad\" src=\"data:image/gif;base64,R0lGODlhAQABAGAAACH5BAEKAP8ALAAAAAABAAEAAAgEAP8FBAA7\" data-src=\"https://i.imgur.com/Tt6avAl.png\" alt=\"img\"></p>\n<p>Permissionsは<a href=\"https://api.slack.com/scopes/channels:join\" target=\"_blank\" rel=\"noopener noreferrer\">channels:join</a>、<a href=\"https://api.slack.com/scopes/chat:write\" target=\"_blank\" rel=\"noopener noreferrer\">chat:write</a>、<a href=\"https://api.slack.com/scopes/chat:write.public\" target=\"_blank\" rel=\"noopener noreferrer\">chat:write.public</a>、<a href=\"https://api.slack.com/scopes/files:write\" target=\"_blank\" rel=\"noopener noreferrer\">files:write</a>があれば十分だと思います。</p>\n<p><img class=\"lozad\" src=\"data:image/gif;base64,R0lGODlhAQABAGAAACH5BAEKAP8ALAAAAAABAAEAAAgEAP8FBAA7\" data-src=\"https://i.imgur.com/0O9dgma.png\" alt=\"img\"></p>\n<div class=\"gatsby-highlight\" data-language=\"python\"><pre class=\"language-python\"><code class=\"language-python\">        url <span class=\"token operator\">=</span> <span class=\"token string\">\"https://slack.com/api/files.upload\"</span>\n        data <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span>\n            <span class=\"token string\">\"token\"</span><span class=\"token punctuation\">:</span> SLACK_TOKEN<span class=\"token punctuation\">,</span>\n            <span class=\"token string\">\"channels\"</span><span class=\"token punctuation\">:</span> SLACK_CHANNEL_ID<span class=\"token punctuation\">,</span>\n            <span class=\"token string\">\"title\"</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"attend bot\"</span><span class=\"token punctuation\">,</span>\n            <span class=\"token string\">\"initial_comment\"</span><span class=\"token punctuation\">:</span> <span class=\"token string-interpolation\"><span class=\"token string\">f\"(</span><span class=\"token interpolation\"><span class=\"token punctuation\">{</span>d<span class=\"token punctuation\">.</span>title<span class=\"token punctuation\">}</span></span><span class=\"token string\">)のattend状況です\"</span></span>\n        <span class=\"token punctuation\">}</span>\n        files <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span><span class=\"token string\">\"file\"</span><span class=\"token punctuation\">:</span> <span class=\"token builtin\">open</span><span class=\"token punctuation\">(</span>FILENAME<span class=\"token punctuation\">,</span> <span class=\"token string\">\"rb\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">}</span>\n        <span class=\"token keyword\">print</span><span class=\"token punctuation\">(</span><span class=\"token string-interpolation\"><span class=\"token string\">f\"Upload To Slack\"</span></span><span class=\"token punctuation\">)</span>\n        resp <span class=\"token operator\">=</span> requests<span class=\"token punctuation\">.</span>post<span class=\"token punctuation\">(</span>url<span class=\"token punctuation\">,</span> data<span class=\"token operator\">=</span>data<span class=\"token punctuation\">,</span> files<span class=\"token operator\">=</span>files<span class=\"token punctuation\">)</span></code></pre></div>\n<p>ほとんどモザイクで申し訳ないですが、きっちりSlackにスクリーンショットを投稿できました。</p>\n<p><img class=\"lozad\" src=\"data:image/gif;base64,R0lGODlhAQABAGAAACH5BAEKAP8ALAAAAAABAAEAAAgEAP8FBAA7\" data-src=\"https://i.imgur.com/oHtRLCO.png\" alt=\"img\"></p>\n<h2 id=\"一部フォントが豆腐のままになる\" style=\"position:relative;\"><a href=\"#%E4%B8%80%E9%83%A8%E3%83%95%E3%82%A9%E3%83%B3%E3%83%88%E3%81%8C%E8%B1%86%E8%85%90%E3%81%AE%E3%81%BE%E3%81%BE%E3%81%AB%E3%81%AA%E3%82%8B\" aria-label=\"一部フォントが豆腐のままになる permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>一部フォントが豆腐のままになる</h2>\n<p>確かにうまく言ったのですが、Noto fontsを入れているにも関わらず一部フォントが豆腐のままになってしまう事象が起きてしまいました。</p>\n<p><img class=\"lozad\" src=\"data:image/gif;base64,R0lGODlhAQABAGAAACH5BAEKAP8ALAAAAAABAAEAAAgEAP8FBAA7\" data-src=\"https://i.imgur.com/QxSsfqy.png\" alt=\"img\"></p>\n<p><del>12/24なにがあるんでしょうねぇ...</del></p>\n<p>色々調べて、<a href=\"https://www.freedesktop.org/wiki/Software/fontconfig/\" target=\"_blank\" rel=\"noopener noreferrer\">fontconfig</a>でNoto fontを強制適用したり色々しましたがどうにもうまく行かず、しょうがないので日本語フォントの大御所<a href=\"https://ipafont.ipa.go.jp/\" target=\"_blank\" rel=\"noopener noreferrer\">IPAフォント</a>を入れることにします。</p>\n<p>そう言えば、IPAフォントは一般社団法人文字情報技術促進協議会に移管されたようですね。</p>\n<p>AlpineでIPAフォントを使うには、</p>\n<div class=\"gatsby-highlight\" data-language=\"docker\"><pre class=\"language-docker\"><code class=\"language-docker\"><span class=\"token instruction\"><span class=\"token keyword\">RUN</span> apk add font-ipa</span></code></pre></div>\n<p>でいいはずなのですが、次のようにパッケージが見つからない警告が出て<strong>うまくいきません</strong>でした。</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\"> ---> Running in 1098a4580fb6\nfetch http://dl-cdn.alpinelinux.org/alpine/v3.12/main/x86_64/APKINDEX.tar.gz\nfetch http://dl-cdn.alpinelinux.org/alpine/v3.12/community/x86_64/APKINDEX.tar.gz\nERROR: unsatisfiable constraints:\n  font-ipa (missing):\n    required by: world[font-ipa]</code></pre></div>\n<p>仕方がないので、<a href=\"https://ja.osdn.net/projects/ipafonts/\" target=\"_blank\" rel=\"noopener noreferrer\">OSDN</a>からTrueType Fontをダウンロードして、それをImageにADDします。</p>\n<p><a href=\"https://ja.osdn.net/projects/ipafonts/releases/51868\" target=\"_blank\" rel=\"noopener noreferrer\">IPA Fonts/IPAex Fonts 4書体パック_IPAフォント（Ver.003.03）</a>を使わせていただきました。ADDコマンドで/usr/share/fonts/TTF/配下にTTFファイルを展開して、fc-cache -fvです。</p>\n<div class=\"gatsby-highlight\" data-language=\"docker\"><pre class=\"language-docker\"><code class=\"language-docker\"><span class=\"token instruction\"><span class=\"token keyword\">ADD</span> ./font/*.ttf /usr/share/fonts/TTF/</span>\n<span class=\"token instruction\"><span class=\"token keyword\">RUN</span> fc-cache -fv</span></code></pre></div>\n<p>これでフォント豆腐問題は解消しました。やれやれ。</p>\n<h2 id=\"slackサインイン警告がでる\" style=\"position:relative;\"><a href=\"#slack%E3%82%B5%E3%82%A4%E3%83%B3%E3%82%A4%E3%83%B3%E8%AD%A6%E5%91%8A%E3%81%8C%E3%81%A7%E3%82%8B\" aria-label=\"slackサインイン警告がでる permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Slackサインイン警告がでる</h2>\n<p>もう一つ問題になったのは、LambdaのグローバルIPを固定化していなかったため、変なIPアドレスからログインを実行したという警告がでてしまうことです。</p>\n<p><img class=\"lozad\" src=\"data:image/gif;base64,R0lGODlhAQABAGAAACH5BAEKAP8ALAAAAAABAAEAAAgEAP8FBAA7\" data-src=\"https://i.imgur.com/dmGb7V6.png\" alt=\"img\"></p>\n<p>こちらは解決法があり、要は<strong>Lambda in VPC</strong>にしてNatGatewayにEIPを当てて、固定IPからインターネットアクセスをさせてあげればいいわけです。</p>\n<p><img class=\"lozad\" src=\"data:image/gif;base64,R0lGODlhAQABAGAAACH5BAEKAP8ALAAAAAABAAEAAAgEAP8FBAA7\" data-src=\"https://i.imgur.com/GPamgYL.png\" alt=\"img\"></p>\n<p>Container Image Supportとはいえ、ここらへんの仕組みはいつも使っているLambdaなので簡単に実現できました。</p>\n<h2 id=\"terraform化する\" style=\"position:relative;\"><a href=\"#terraform%E5%8C%96%E3%81%99%E3%82%8B\" aria-label=\"terraform化する permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Terraform化する</h2>\n<p>さぁ、すべての舞台が整ったので、Terraform化していきます。</p>\n<p><a href=\"https://registry.terraform.io/providers/hashicorp/aws/latest/docs/resources/lambda_function\" target=\"_blank\" rel=\"noopener noreferrer\">Resource: aws_lambda_function</a>も対応しているため、そこまで大変さはありませんでした。ありがとうございます。</p>\n<p>Container supportの場合は<a href=\"https://registry.terraform.io/providers/hashicorp/aws/latest/docs/resources/lambda_function#package_type\" target=\"_blank\" rel=\"noopener noreferrer\">package_type</a>をImageにして<a href=\"https://registry.terraform.io/providers/hashicorp/aws/latest/docs/resources/lambda_function#image_uri\" target=\"_blank\" rel=\"noopener noreferrer\">image_uri</a>をECRにプッシュしたイメージURIにします。</p>\n<p>イメージURIはECRのコンソール画面からでも確認できますが、CIに乗っけるなど考えた場合ちょっと取り回し悪いので、AWS CLI describe-imagesコマンドでimageDigestが確認できますので、Terraform実行時にShellで取得し、動的生成し、terraform apply -var=hogeの形式で変数として渡してやります。</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">aws ecr describe-images --repository-name selenium --image-ids imageTag=latest | jq \".imageDetails[].imageDigest\"\n\n\"sha256:7ec3ea6afd616c09b291c22e8e7676a8855e05beb1d4ea19af1abc6865e6fe6d\"</code></pre></div>\n<p>通常のLambdaで必要になる<a href=\"https://registry.terraform.io/providers/hashicorp/aws/latest/docs/resources/lambda_function#handler\" target=\"_blank\" rel=\"noopener noreferrer\">handler</a>や<a href=\"https://registry.terraform.io/providers/hashicorp/aws/latest/docs/resources/lambda_function#runtime\" target=\"_blank\" rel=\"noopener noreferrer\">runtime</a>の設定は不要です。Terraformドキュメント上、handlerは必須となっておりますが、<strong>不要</strong>です。</p>\n<p><a href=\"https://plugins.jetbrains.com/plugin/7808-hashicorp-terraform--hcl-language-support\" target=\"_blank\" rel=\"noopener noreferrer\">IntellJ HashiCorp Terraform / HCL language support</a>を使っているとhandlerとruntimeオプションが無いよ！と怒られてしまいますが、構わず不要で大丈夫です。</p>\n<p><img class=\"lozad\" src=\"data:image/gif;base64,R0lGODlhAQABAGAAACH5BAEKAP8ALAAAAAABAAEAAAgEAP8FBAA7\" data-src=\"https://i.imgur.com/cxxcBx0.png\" alt=\"img\"></p>\n<h2 id=\"完成\" style=\"position:relative;\"><a href=\"#%E5%AE%8C%E6%88%90\" aria-label=\"完成 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>完成</h2>\n<p>ということで完成しました。</p>\n<p><a href=\"https://github.com/tubone24/lambda_container_support_with_selenium\" target=\"_blank\" rel=\"noopener noreferrer\">https://github.com/tubone24/lambda_container_support_with_selenium</a></p>\n<p>いろんな技術でうまく行かないことが多かったですが、やりたかったことが無事できました。</p>","words":7783,"minutes":20}},"staticQueryHashes":["1319877725","2959249232"]}