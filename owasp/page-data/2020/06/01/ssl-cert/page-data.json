{"componentChunkName":"component---src-templates-blog-post-tsx","path":"/2020/06/01/ssl-cert","result":{"data":{"content":{"edges":[{"node":{"id":"db37d7d2-a05d-516f-9563-4a9393e565b0","excerpt":"2020/05/30に発生したDatadog AgentのCERTIFICATE_VERIFY_FAILED error\nについて少し考察してみようかと思います。 Table of Contents CERTIFICATE_VERIFY_FAILED は突然に Datadog…","fields":{"slug":"2020/06/01/ssl-cert"},"frontmatter":{"id":null,"title":"クロスルート証明書について考えてみる","slug":"2020/06/01/ssl-cert","date":"2020-06-01T14:51:53.352Z","headerImage":"https://i.imgur.com/iIZqvaV.jpg","tags":["Datadog","SSL"]}}}]}},"pageContext":{"id":"db37d7d2-a05d-516f-9563-4a9393e565b0","index":34,"repHtml":"<p>2020/05/30に発生したDatadog Agentの<a href=\"https://docs.datadoghq.com/agent/faq/certificate_verify_failed-error/\" target=\"_blank\" rel=\"noopener noreferrer\"><strong>CERTIFICATE_VERIFY_FAILED error</strong>\n</a>について少し考察してみようかと思います。</p>\n<h2 id=\"table-of-contents\" style=\"position:relative;\"><a href=\"#table-of-contents\" aria-label=\"table of contents permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Table of Contents</h2>\n<div class=\"toc\">\n<ul>\n<li>\n<p><a href=\"#certificate_verify_failed-%E3%81%AF%E7%AA%81%E7%84%B6%E3%81%AB\">CERTIFICATE_VERIFY_FAILED は突然に</a></p>\n</li>\n<li>\n<p><a href=\"#datadog%E3%81%8B%E3%82%89%E3%81%AE%E3%82%A2%E3%83%8A%E3%82%A6%E3%83%B3%E3%82%B9\">Datadogからのアナウンス</a></p>\n</li>\n<li>\n<p><a href=\"#%E3%81%9D%E3%82%82%E3%81%9D%E3%82%82ssl%E3%81%AE%E4%BB%95%E7%B5%84%E3%81%BF%E3%82%92%E3%81%8A%E3%81%95%E3%82%89%E3%81%84\">そもそもSSLの仕組みをおさらい</a></p>\n</li>\n<li>\n<p><a href=\"#ssl%E9%80%9A%E4%BF%A1%E3%81%AB%E3%81%8A%E3%81%91%E3%82%8B%E3%82%B5%E3%83%BC%E3%83%90%E3%83%BC%E8%AA%8D%E8%A8%BC%E3%81%A8%E3%82%B5%E3%83%BC%E3%83%90%E3%83%BC%E8%A8%BC%E6%98%8E%E6%9B%B8\">SSL通信におけるサーバー認証とサーバー証明書</a></p>\n<ul>\n<li><a href=\"#%E3%82%B5%E3%83%BC%E3%83%90%E3%83%BC%E8%A8%BC%E6%98%8E%E6%9B%B8%E3%81%AE%E4%B8%AD%E8%BA%AB\">サーバー証明書の中身</a></li>\n</ul>\n</li>\n<li>\n<p><a href=\"#%E8%AA%8D%E8%A8%BC%E5%B1%80\">認証局</a></p>\n<ul>\n<li><a href=\"#%E6%89%8B%E9%A0%86%E3%81%AE%E3%81%8A%E3%81%95%E3%82%89%E3%81%84\">手順のおさらい</a></li>\n<li><a href=\"#%E3%83%91%E3%83%83%E3%81%A8%E3%82%A4%E3%83%A1%E3%83%BC%E3%82%B8%E3%81%97%E3%82%84%E3%81%99%E3%81%84%E3%81%AE%E3%81%AF893%E3%81%AE%E4%BB%A3%E7%B4%8B%E3%81%A8%E8%A6%AA%E5%AD%90%E3%81%AE%E7%9B%83\">パッとイメージしやすいのは893の代紋と親子の盃</a></li>\n<li><a href=\"#%E5%A4%B1%E5%8A%B9%E3%83%AA%E3%82%B9%E3%83%88%E3%81%A8%E7%A0%B4%E9%96%80%E7%8A%B6\">失効リストと破門状</a></li>\n</ul>\n</li>\n<li>\n<p><a href=\"#%E8%A8%BC%E6%98%8E%E6%9B%B8%E3%83%81%E3%82%A7%E3%83%BC%E3%83%B3%E3%81%A8%E3%83%AB%E3%83%BC%E3%83%88%E8%A8%BC%E6%98%8E%E6%9B%B8\">証明書チェーンとルート証明書</a></p>\n</li>\n<li>\n<p><a href=\"#%E3%83%AB%E3%83%BC%E3%83%88%E8%A8%BC%E6%98%8E%E6%9B%B8%E3%81%AE%E7%A2%BA%E3%81%8B%E3%82%89%E3%81%97%E3%81%95\">ルート証明書の確からしさ</a></p>\n</li>\n<li>\n<p><a href=\"#%E3%83%AB%E3%83%BC%E3%83%88%E8%A8%BC%E6%98%8E%E6%9B%B8%E3%81%8C%E6%9B%B4%E6%96%B0%E3%81%A7%E3%81%8D%E3%81%AA%E3%81%84%E3%81%A8%E3%81%8D%E3%81%AE%E4%BB%A3%E6%9B%BF%E6%89%8B%E6%AE%B5%E3%81%A8%E3%81%AF\">ルート証明書が更新できないときの代替手段とは？</a></p>\n</li>\n<li>\n<p><a href=\"#%E3%82%AF%E3%83%AD%E3%82%B9%E3%83%AB%E3%83%BC%E3%83%88%E8%A8%BC%E6%98%8E%E6%9B%B8%E3%81%AB%E3%81%A4%E3%81%84%E3%81%A6\">クロスルート証明書について</a></p>\n</li>\n<li>\n<p><a href=\"#%E8%A9%B1%E3%82%92%E6%88%BB%E3%81%97%E3%81%A6datadog\">話を戻してDatadog</a></p>\n</li>\n<li>\n<p><a href=\"#datadog-agent%E3%81%AFtornado%E3%82%92%E4%BD%BF%E3%81%A3%E3%81%A6%E3%81%84%E3%82%8B\">Datadog AgentはTornadoを使っている</a></p>\n</li>\n<li>\n<p><a href=\"#%E7%B5%90%E8%AB%96\">結論</a></p>\n</li>\n<li>\n<p><a href=\"#%E8%BF%BD%E8%A8%98\">追記</a></p>\n</li>\n</ul>\n</div>\n<h2 id=\"certificate_verify_failed-は突然に\" style=\"position:relative;\"><a href=\"#certificate_verify_failed-%E3%81%AF%E7%AA%81%E7%84%B6%E3%81%AB\" aria-label=\"certificate_verify_failed は突然に permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>CERTIFICATE_VERIFY_FAILED は突然に</h2>\n<p>**「ギャー！めっちゃEC2の監視が落ちているんですけど！」**と連絡を受けた土曜日。</p>\n<p>カンパリオレンジならぬカンパリ野菜生活をゴクゴク飲んでいた私は意識朦朧とする中、Slackを見る。</p>\n<p>ギャー!!</p>\n<p><img class=\"lozad\" src=\"data:image/gif;base64,R0lGODlhAQABAGAAACH5BAEKAP8ALAAAAAABAAEAAAgEAP8FBAA7\" data-src=\"https://i.imgur.com/MQtTdnk.png\" alt=\"img\"></p>\n<p>めっちゃ落ちてますね....。</p>\n<p>一通りサービスの状態を見て問題なかったのでこの日は持ち前の「大丈夫ですよ(大嘘)」をかまして眠ることにしました。</p>\n<h2 id=\"datadogからのアナウンス\" style=\"position:relative;\"><a href=\"#datadog%E3%81%8B%E3%82%89%E3%81%AE%E3%82%A2%E3%83%8A%E3%82%A6%E3%83%B3%E3%82%B9\" aria-label=\"datadogからのアナウンス permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Datadogからのアナウンス</h2>\n<p>翌日、Datadogからアナウンスがありました。</p>\n<p><a href=\"https://docs.datadoghq.com/agent/faq/certificate_verify_failed-error/\" target=\"_blank\" rel=\"noopener noreferrer\">CERTIFICATE_VERIFY_FAILED error\n</a></p>\n<p>サイトを見ると何が起きていて、どんな対応がユーザーに必要かが書いてありました。</p>\n<blockquote>\n<p>On Saturday May 30th, 2020, at 10:48 UTC, an SSL root certificate used to cross-sign some of the Datadog certificates expired, and caused some of your Agents to lose connectivity with Datadog endpoints. Because this root certificate is embedded in certain Agent versions, you will need to take action to restore connectivity.</p>\n</blockquote>\n<p>ふむふむ... <strong>SSLのルート証明書(cross-sign)が失効</strong>してしまいましたわよ、という案件なのですね。</p>\n<p>よくあるSSL証明書失効と何が違うのでしょうか...よくわかりませんね..。</p>\n<p>とりあえずそこら辺の調査は後回しで直していきます。</p>\n<p>いくつかサイトに直し方が書いてありましたが今回は、</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">sudo rm /opt/datadog-agent/agent/datadog-cert.pem &amp;&amp; sudo service datadog-agent restart</code></pre></div>\n<p>の直し方にフォーカスしてみようかと思います。どうやら <strong>datadog-cert.pem</strong> を消してからdatadogの<strong>サービス再起動</strong>すればいいみたい。</p>\n<p>ということで、各EC2に入ってごにょごにょしたら<strong>直りました</strong>。よかった...ホッと...。</p>\n<h2 id=\"そもそもsslの仕組みをおさらい\" style=\"position:relative;\"><a href=\"#%E3%81%9D%E3%82%82%E3%81%9D%E3%82%82ssl%E3%81%AE%E4%BB%95%E7%B5%84%E3%81%BF%E3%82%92%E3%81%8A%E3%81%95%E3%82%89%E3%81%84\" aria-label=\"そもそもsslの仕組みをおさらい permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>そもそもSSLの仕組みをおさらい</h2>\n<p>直ったのはいいですが、何が起きていたかちゃんと把握したいですよね...。</p>\n<p>ということで5年ぶりにSSLのお勉強をしました。</p>\n<p>といっても私が知っているのは公開鍵暗号の話だけ...ですので実質初学習です。</p>\n<p>公開鍵暗号について詳しく知りたい人は、</p>\n<p><a href=\"https://amzn.to/3rypnvi\" target=\"_blank\" rel=\"noopener noreferrer\"><strong>暗号技術入門 第3版　秘密の国のアリス</strong></a>がいいと思います。</p>\n<p>私をこの業界に引き込んだ師が大学の頃に読め！と言われて買って読んだ記憶があります。</p>\n<p>今でも家の本棚にありました。マジで良書です。わかりやすいです。</p>\n<p><img class=\"lozad\" src=\"data:image/gif;base64,R0lGODlhAQABAGAAACH5BAEKAP8ALAAAAAABAAEAAAgEAP8FBAA7\" data-src=\"https://i.imgur.com/E0GC9w0.jpg\" alt=\"img\"></p>\n<p>さて簡単にSSL通信のおさらいをします。</p>\n<p><img class=\"lozad\" src=\"data:image/gif;base64,R0lGODlhAQABAGAAACH5BAEKAP8ALAAAAAABAAEAAAgEAP8FBAA7\" data-src=\"https://i.imgur.com/APQPDxd.png\" alt=\"img\">\n引用: <a href=\"https://ssl.sakura.ad.jp/column/ssl/\" target=\"_blank\" rel=\"noopener noreferrer\">https://ssl.sakura.ad.jp/column/ssl/</a></p>\n<p>わかりやすいイラストがさくらのSSLにありましたので拝借します。</p>\n<p>重要なポイントとして、ブラウザ(クライアント)はSSL通信をするときにSSLの通信リクエスト(ClientHello)を送信すると、サーバーから<strong>サーバー証明書</strong>と<strong>公開鍵</strong>が送られてきます。</p>\n<p>暗号通信についてはこのうち<strong>公開鍵</strong>が利用され、クライアント側でランダムな値を<strong>共通鍵のシークレット</strong>として利用することを決定し<strong>公開鍵</strong>を使って暗号化し、サーバーに送信します。</p>\n<p>するとサーバーでは秘密鍵を使って共通鍵が取り出せるのでここから共通鍵暗号(例えばAESとか)での通信ができるわけです。これが<strong>鍵交換</strong>というやつです。</p>\n<p>えっ!?普通に互いの公開鍵を交換して公開鍵暗号で通信すればいいだけじゃんアゼルバイジャンと思ったそこの君!!それは違いますね。</p>\n<p>まず、その場合クライアントに公開鍵と対応する秘密鍵を用意する必要がありますね。あなたは田舎のおばあちゃんにOpenSSLコマンドを打たせるんですか...それはきついですよね。</p>\n<p>もう一つの問題は一般的に公開鍵暗号は共通鍵暗号に比べて暗号コストが高いということです。それなりの桁数の乱数をぶつけていくので共通鍵の<strong>数十～数千倍遅い</strong>といわれてます。</p>\n<p>ちなみにSSLの通信で、出てきた公開鍵暗号や共通鍵暗号のアルゴリズムパターンを定義するのが皆さん大好きおなじみの\n<strong>Cipher suite</strong>です。</p>\n<p>サイト管理者ならひと昔前、<a href=\"https://developers.google.com/admob/ios/app-transport-security?hl=ja\" target=\"_blank\" rel=\"noopener noreferrer\">ATS対応</a>とかでツライ思いをした人もいるかもしれませんね。</p>\n<p><strong>ECDHE-RSA-AES128-GCM-SHA256</strong> こんなやつ...あぁ...SHA-1の悪夢がよみがえりますね。</p>\n<p>脱線ついでにもう一つ。</p>\n<p>上記で述べた鍵交換一つとってもたとえば<strong>RSA</strong>という方式ではほぼ上記で説明しているとおりの流れを組むのですが、<strong>前方秘匿性</strong>に弱い欠点(一言でいえば全暗号通信を記憶していた状態で秘密鍵を手に入れたらすべてがばれてしまう)があったりで最近ではDHE（DiffieHellman, Ephemeral）という鍵交換方式を楕円曲線暗号上で行なう<strong>ECDHE</strong>（RFC4492）が主流だったりします。</p>\n<p>ここまでのお話はぜひ<a href=\"https://amzn.to/3rypnvi\" target=\"_blank\" rel=\"noopener noreferrer\">暗号技術入門 第3版　秘密の国のアリス</a>を読んでいただければ私なんかよりわかりやすく説明しているので興味がある人はぜひ読んでみましょう!!</p>\n<h2 id=\"ssl通信におけるサーバー認証とサーバー証明書\" style=\"position:relative;\"><a href=\"#ssl%E9%80%9A%E4%BF%A1%E3%81%AB%E3%81%8A%E3%81%91%E3%82%8B%E3%82%B5%E3%83%BC%E3%83%90%E3%83%BC%E8%AA%8D%E8%A8%BC%E3%81%A8%E3%82%B5%E3%83%BC%E3%83%90%E3%83%BC%E8%A8%BC%E6%98%8E%E6%9B%B8\" aria-label=\"ssl通信におけるサーバー認証とサーバー証明書 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>SSL通信におけるサーバー認証とサーバー証明書</h2>\n<p>SSL通信でもう一つ重要な要素は <strong>なりすまし</strong> <strong>盗聴</strong> <strong>改ざん</strong>を防ぐことです。</p>\n<p>サイトが本物のサイトか、途中に暗号を盗聴しているものはいないか、通信内容を不正に書き換えられていないかをチェックできないとネットショッピングとかで使える安全な暗号通信の意味がありません。</p>\n<p>それを担保する仕組みが<strong>サーバー証明書</strong>となるわけです。</p>\n<p>デジタル証明書も公開鍵暗号の仕組みを応用した話になります。</p>\n<p>サーバー証明書が本物であるかどうかの話の前にサーバー証明書にはどんな情報が書いてあるか見ていきましょう。</p>\n<h3 id=\"サーバー証明書の中身\" style=\"position:relative;\"><a href=\"#%E3%82%B5%E3%83%BC%E3%83%90%E3%83%BC%E8%A8%BC%E6%98%8E%E6%9B%B8%E3%81%AE%E4%B8%AD%E8%BA%AB\" aria-label=\"サーバー証明書の中身 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>サーバー証明書の中身</h3>\n<p><img class=\"lozad\" src=\"data:image/gif;base64,R0lGODlhAQABAGAAACH5BAEKAP8ALAAAAAABAAEAAAgEAP8FBAA7\" data-src=\"https://i.imgur.com/r3Rhva4.png\" alt=\"img\"></p>\n<p>こちらはAWSのコンソールのSSL通信に使われているサーバー証明書です。</p>\n<p>いろんな情報が書かれているかと思いますがこちらは<a href=\"https://ja.wikipedia.org/wiki/X.509#.E8.A8.BC.E6.98.8E.E6.9B.B8.E3.81.AE.E6.A7.8B.E9.80.A0\" target=\"_blank\" rel=\"noopener noreferrer\">X.509</a>という規格に従って記載されています。</p>\n<p>詳しく知りたい人は<a href=\"https://ja.wikipedia.org/wiki/X.509#.E8.A8.BC.E6.98.8E.E6.9B.B8.E3.81.AE.E6.A7.8B.E9.80.A0\" target=\"_blank\" rel=\"noopener noreferrer\">X.509</a>を確認しましょう！</p>\n<p>簡単にAmazonの証明書の要素列挙しますと、</p>\n<ul>\n<li>バージョン</li>\n</ul>\n<p>: 3</p>\n<ul>\n<li>シリアル番号: 08 18 CC ....</li>\n<li>署名アルゴリズム: RSA暗号化を使用するSHA-256</li>\n<li>発行者</li>\n</ul>\n<p>: Amazon CA 1B</p>\n<ul>\n<li>有効期間\n<ul>\n<li>開始</li>\n</ul>\n</li>\n</ul>\n<p>: 2020/04/13 9:00:00 JST</p>\n<ul>\n<li>満了</li>\n</ul>\n<p>: 2021/03/15 21:00:00 JST</p>\n<ul>\n<li>主体者</li>\n</ul>\n<p>(サブジェクト)</p>\n<ul>\n<li>ap-northeast-1.console.aws.amazon.com</li>\n<li>主体者の公開鍵情報\n<ul>\n<li>公開鍵アルゴリズム: RSA暗号化</li>\n<li>主体者の公開鍵: 256バイト: 83 22 EB....</li>\n<li>証明書の署名アルゴリズム: SHA-256 ECDSA</li>\n<li>証明書の署名: 256バイト26 87 E2...</li>\n</ul>\n</li>\n<li>フィンガープリント\n<ul>\n<li>SHA-256: C0 75 7D...</li>\n<li>SHA-1:  CD 63 42...</li>\n</ul>\n</li>\n</ul>\n<p>Amazonが発行し、ドメインがAmazon所有の<strong>ap-northeast-1.console.aws.amazon.com</strong>がつらつらと書かれているわけです。</p>\n<p>他に重要な要素としてサーバー証明書の<strong>有効期限</strong>があります。有効期限切れの証明書は証明書して無効となります。</p>\n<p>基本的にサーバー証明書は有効期限が切れる前に更新しなければいけません。それをやり忘れるのがいわゆる**SSL証明書更新失敗！**というやつです。</p>\n<p><img class=\"lozad\" src=\"data:image/gif;base64,R0lGODlhAQABAGAAACH5BAEKAP8ALAAAAAABAAEAAAgEAP8FBAA7\" data-src=\"https://i.imgur.com/m4xqMek.png\" alt=\"img\"></p>\n<p>証明書の有効期限はOpenSSLコマンドで簡単に取れますので、そういうことがないようにZabbixのExternalScriptとかできっちり管理することをおすすめしますー。</p>\n<p>ちなみに下記コマンドで簡単に証明書期限は確認できます。</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">openssl s_client -connect hoge.com:443 -servername blog.tubone-project24.xyz &lt; /dev/null 2> /dev/null | openssl x509 -noout -startdate -enddate\n\nnotBefore=Jul  1 00:00:00 2019 GMT\nnotAfter=Aug 29 12:00:00 2021 GMT</code></pre></div>\n<p>我が家のサーバーのSSL証明書はZabbixで管理してます。(余談)</p>\n<p><img class=\"lozad\" src=\"data:image/gif;base64,R0lGODlhAQABAGAAACH5BAEKAP8ALAAAAAABAAEAAAgEAP8FBAA7\" data-src=\"https://i.imgur.com/KzVk6D2.png\" alt=\"img\"></p>\n<h2 id=\"認証局\" style=\"position:relative;\"><a href=\"#%E8%AA%8D%E8%A8%BC%E5%B1%80\" aria-label=\"認証局 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>認証局</h2>\n<p>しかし、サーバー証明書に書いてある内容は本当に改ざんなく正しいのでしょうか？</p>\n<p>実はサーバー証明書自体はOpenSSLのコマンドでだれでも発行はできてしまいます。(そういうのを俗にオレオレ証明書とか言ったりします)なので証明書自体の確からしさは<strong>別の人</strong>にケツ持ちしてもらうことで担保しましょう！というのがデジタル証明書の認証局という仕組みとなります。</p>\n<p>まずサーバー証明書の中身をハッシュ関数(SHA-256とかそういったやつ)にかけてサーバー証明書固有のハッシュ値を得ます。</p>\n<p>そのハッシュ値に<strong>認証局</strong>というケツ持ちが秘密鍵を使って暗号化処理を行います。</p>\n<p>すると、そのハッシュ値を複合できるのは認証局の公開鍵になるわけです。</p>\n<p>（ちなみに秘密鍵所有者が自身の情報の出所の確からしさを証明するため、秘密鍵で暗号化させ、相手に公開鍵で複合させるという発想が公開鍵暗号を利用したデジタル署名の基本的な考え方です）</p>\n<p>つまり..。</p>\n<p>サーバー証明書の確からしさを確かめるには、</p>\n<ol>\n<li>サーバー証明書のハッシュを得る</li>\n<li>サーバー証明書についている認証局の秘密鍵で暗号化されたハッシュ値を認証局の公開鍵で複合する</li>\n<li>1と2が一致しているか確認する</li>\n</ol>\n<p>という手順を踏むわけです。</p>\n<p><strong>ちなみに認証局の証明書にもちゃんと有効期限が存在します</strong>。ココ重要。</p>\n<h3 id=\"手順のおさらい\" style=\"position:relative;\"><a href=\"#%E6%89%8B%E9%A0%86%E3%81%AE%E3%81%8A%E3%81%95%E3%82%89%E3%81%84\" aria-label=\"手順のおさらい permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>手順のおさらい</h3>\n<p>サーバー証明書作成手順を理解すると実は仕組みがわかりやすいので蛇足ですがコマンド付きで解説します。</p>\n<p>まず、サイト管理者などサーバー証明書を作りたい人はサーバー証明書のタマゴである<strong>C</strong>ertificate <strong>S</strong>igning <strong>R</strong>equest、いわゆる<strong>CSR</strong>をOpenSSLのコマンドとかで作成します。</p>\n<p>作成の際はセキュリティ上OpenSSLが使う疑似乱数をきっちり回しておくことをお勧めします。</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\"># 疑似乱数作成\n./openssl md5 * > rand.dat\n\n# サーバ証明書の暗号化に使う秘密鍵\n./openssl genrsa -rand rand.dat -des3 2048 > private.pem\n\n# CSR作成\n./openssl req -new -key private.pem -out newcsr.pem\n\n# 証明書の内容について質問されるので答えていく\n\n\nCountry Name (2 letter code) [AU]:JP\n\nState or Province Name (full name) [Some-State]:Tokyo\n\nLocality Name (eg, city) []:Shinjuku-ku\n\nOrganization Name (eg, company) [Internet Widgits Pty Ltd]:Tojo-kai\n\nOrganizational Unit Name (eg, section) []:Majima-gumi\n\nCommon Name (eg, YOUR name) []:yakuza-kusowaru-boryoku.com\n</code></pre></div>\n<p>CSRができたらこちらをお近くの認証局(DigiCertとか)に送ると認証局の秘密鍵で署名を暗号化したものをCSRにくっつけたいわゆるサーバー証明書が出来上がります。</p>\n<h3 id=\"パッとイメージしやすいのは893の代紋と親子の盃\" style=\"position:relative;\"><a href=\"#%E3%83%91%E3%83%83%E3%81%A8%E3%82%A4%E3%83%A1%E3%83%BC%E3%82%B8%E3%81%97%E3%82%84%E3%81%99%E3%81%84%E3%81%AE%E3%81%AF893%E3%81%AE%E4%BB%A3%E7%B4%8B%E3%81%A8%E8%A6%AA%E5%AD%90%E3%81%AE%E7%9B%83\" aria-label=\"パッとイメージしやすいのは893の代紋と親子の盃 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>パッとイメージしやすいのは893の代紋と親子の盃</h3>\n<p><img class=\"lozad\" src=\"data:image/gif;base64,R0lGODlhAQABAGAAACH5BAEKAP8ALAAAAAABAAEAAAgEAP8FBAA7\" data-src=\"https://i.imgur.com/RfBcxD9.png\" alt=\"img\"></p>\n<p>893映画やゲームが好きなほうならピンとくるかもしれませんが、認証局って893の<strong>代紋</strong>みたいなもんなんですね。</p>\n<p>晴れてあなたが組の長になったとき、その組の正当性や所属を明らかにするために後ろ盾の組の代紋飾るじゃないですか。</p>\n<p>もちろんただでは代紋なんて飾れないので<strong>親子の盃</strong>を交わすことで許可がでるわけですが、これがCSRを認証局に提出すると思ってください。</p>\n<p>晴れて、代紋をいただければあとは好きに暴れて結構。(ダメ)</p>\n<p>まとめると代紋というのはいわゆる上位の組が下位の組を認証しているんですね！だからビジネスができるわけですね。</p>\n<p><img class=\"lozad\" src=\"data:image/gif;base64,R0lGODlhAQABAGAAACH5BAEKAP8ALAAAAAABAAEAAAgEAP8FBAA7\" data-src=\"https://i.imgur.com/30262FQ.png\" alt=\"img\"></p>\n<h3 id=\"失効リストと破門状\" style=\"position:relative;\"><a href=\"#%E5%A4%B1%E5%8A%B9%E3%83%AA%E3%82%B9%E3%83%88%E3%81%A8%E7%A0%B4%E9%96%80%E7%8A%B6\" aria-label=\"失効リストと破門状 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>失効リストと破門状</h3>\n<p>余談ですが、証明書には<strong>失効リスト</strong>というものがあります。</p>\n<p>認証局が発行した証明書は基本的には認証局自体のもしくはサーバー証明書の有効期限まで効力を持ちます。</p>\n<p>ただ、秘密鍵が流出したり、認証したサーバーが悪いことばかりやったりとで有効期限関係なく、　\n認証局の効力をなくしたい場合があります。</p>\n<p>その時使えるのが<strong>C</strong>ertificate <strong>R</strong>evocation <strong>L</strong>ist(<strong>CRL</strong>)です。失効リストでRevokeとしたサーバー証明書は認証局の署名効力を失います。これは認証局で行なうことができます。</p>\n<p>これって893でいうところの<strong>破門状</strong>ですよね..。</p>\n<p><img class=\"lozad\" src=\"data:image/gif;base64,R0lGODlhAQABAGAAACH5BAEKAP8ALAAAAAABAAEAAAgEAP8FBAA7\" data-src=\"https://i.imgur.com/f382RVO.jpg\" alt=\"img\"></p>\n<p>破門状のいい画像がなかったし、本物の破門状を載せるのもどうかと思ったので勝手に<a href=\"https://lineblog.me/ozawahitoshi/archives/1027317703.html\" target=\"_blank\" rel=\"noopener noreferrer\">小沢仁志オフィシャルブログ</a>から借りてきました。</p>\n<p>破門状は893の死刑宣告といわれてますが、まさに失効リストはサーバー証明書の死刑宣告なのです。</p>\n<h2 id=\"証明書チェーンとルート証明書\" style=\"position:relative;\"><a href=\"#%E8%A8%BC%E6%98%8E%E6%9B%B8%E3%83%81%E3%82%A7%E3%83%BC%E3%83%B3%E3%81%A8%E3%83%AB%E3%83%BC%E3%83%88%E8%A8%BC%E6%98%8E%E6%9B%B8\" aria-label=\"証明書チェーンとルート証明書 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>証明書チェーンとルート証明書</h2>\n<p>今度はこのブログのサーバー証明書を確認してみましょう。</p>\n<p><img class=\"lozad\" src=\"data:image/gif;base64,R0lGODlhAQABAGAAACH5BAEKAP8ALAAAAAABAAEAAAgEAP8FBAA7\" data-src=\"https://i.imgur.com/oh5oyKC.png\" alt=\"img\"></p>\n<p>このブログのドメインである<a href=\"https://blog.tubone-project24.xyz\" target=\"_blank\" rel=\"noopener noreferrer\">blog.tubone-project24.xyz</a>が確かに所有しているドメインとなっているわけですが認証局は<strong>Let's Encrypt Authority X3</strong>ですね。</p>\n<p>では<strong>Let's Encrypt Authority X3</strong>が本物の認証局かどうかはどうやって判断するのでしょうか？</p>\n<p>この仕組みが<strong>証明書チェーン</strong>です。</p>\n<p>実は先ほどのAWSの証明書もそうでしたがチェーンは簡単に追うことができます。</p>\n<p><img class=\"lozad\" src=\"data:image/gif;base64,R0lGODlhAQABAGAAACH5BAEKAP8ALAAAAAABAAEAAAgEAP8FBAA7\" data-src=\"https://i.imgur.com/wDLRAKk.png\" alt=\"img\"></p>\n<p>赤枠がチェーンです。</p>\n<p><strong>Let's Encrypt Authority X3</strong>の証明書を見てみましょう。</p>\n<p><img class=\"lozad\" src=\"data:image/gif;base64,R0lGODlhAQABAGAAACH5BAEKAP8ALAAAAAABAAEAAAgEAP8FBAA7\" data-src=\"https://i.imgur.com/gpaXTQe.png\" alt=\"img\"></p>\n<p><strong>Let's Encrypt Authority X3</strong>のケツ持ちはどうやら<strong>DST Root CA X3</strong>がやっているみたいですね。</p>\n<p>このように<strong>認証局を別の認証局にケツ持ち</strong>してもらうことができます。</p>\n<p>さらにチェーンを追ってみます。</p>\n<p><img class=\"lozad\" src=\"data:image/gif;base64,R0lGODlhAQABAGAAACH5BAEKAP8ALAAAAAABAAEAAAgEAP8FBAA7\" data-src=\"https://i.imgur.com/m8zYyuz.png\" alt=\"img\"></p>\n<p><strong>DST Root CA X3</strong>のケツ持ちは<strong>DST Root CA X3</strong>ですね...????ん????</p>\n<p>これはどういうことかというと言葉通り、<strong>DST Root CA X3</strong>のケツ持ちは<strong>DST Root CA X3</strong>がやっているということです。</p>\n<p>証明書チェーンではそれ以上、上位の認証局がいない証明書が必ず出てきます。これが<strong>ルート証明書</strong>というやつです。</p>\n<p>ルート証明書はそれ以上認証してくれるケツ持ちがいないのでクライアントは盲目的に信頼する必要があります。</p>\n<p>えっ！それでいいの？という声が聞こえてきますね...。</p>\n<h2 id=\"ルート証明書の確からしさ\" style=\"position:relative;\"><a href=\"#%E3%83%AB%E3%83%BC%E3%83%88%E8%A8%BC%E6%98%8E%E6%9B%B8%E3%81%AE%E7%A2%BA%E3%81%8B%E3%82%89%E3%81%97%E3%81%95\" aria-label=\"ルート証明書の確からしさ permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>ルート証明書の確からしさ</h2>\n<p>ではサーバー証明書にチェーンされるルート証明書はどのように確からしさをチェックすればいいのでしょうか？</p>\n<p>それは、PCを買ったときやブラウザを入れたときにルート証明書をクライアントそばに入れておいて<strong>共通のルート証明書を持ったサーバー証明書を検証</strong>する仕組みとしているわけです。</p>\n<p>Macだとインストールされているルート証明書を<strong>キーチェーン</strong>から確認できます。</p>\n<p><img class=\"lozad\" src=\"data:image/gif;base64,R0lGODlhAQABAGAAACH5BAEKAP8ALAAAAAABAAEAAAgEAP8FBAA7\" data-src=\"https://i.imgur.com/VGk9uYk.png\" alt=\"img\"></p>\n<p>当然ルート証明書にも有効期限があります。</p>\n<p>ルート証明書の有効期限が切れないようにOSの定期アップデートやブラウザのバージョンが更新タイミングで最新の証明書がインストールされる寸法になっています。</p>\n<h2 id=\"ルート証明書が更新できないときの代替手段とは\" style=\"position:relative;\"><a href=\"#%E3%83%AB%E3%83%BC%E3%83%88%E8%A8%BC%E6%98%8E%E6%9B%B8%E3%81%8C%E6%9B%B4%E6%96%B0%E3%81%A7%E3%81%8D%E3%81%AA%E3%81%84%E3%81%A8%E3%81%8D%E3%81%AE%E4%BB%A3%E6%9B%BF%E6%89%8B%E6%AE%B5%E3%81%A8%E3%81%AF\" aria-label=\"ルート証明書が更新できないときの代替手段とは permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>ルート証明書が更新できないときの代替手段とは？</h2>\n<p>そうはいってもデバイスがインターネットにつながっていなかったり、組み込み端末などたくさんのルート証明書をインストールする余裕がない場合などあるかと思います。</p>\n<p>そういった場合たくさんのルート証明書を検証することはおろか、期限が迫っている証明書更新もできません。</p>\n<p>そういった場合はどうやってルート証明書を使うのでしょうか？</p>\n<h2 id=\"クロスルート証明書について\" style=\"position:relative;\"><a href=\"#%E3%82%AF%E3%83%AD%E3%82%B9%E3%83%AB%E3%83%BC%E3%83%88%E8%A8%BC%E6%98%8E%E6%9B%B8%E3%81%AB%E3%81%A4%E3%81%84%E3%81%A6\" aria-label=\"クロスルート証明書について permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>クロスルート証明書について</h2>\n<p>そんなときに<strong>クロスルート証明書</strong>です。</p>\n<p>ルート証明書を更新できなかったり、複数のルート証明書をまとめあげるために使います。</p>\n<p>例えば下記の証明書チェーンがあったとします。</p>\n<p><img class=\"lozad\" src=\"data:image/gif;base64,R0lGODlhAQABAGAAACH5BAEKAP8ALAAAAAABAAEAAAgEAP8FBAA7\" data-src=\"https://i.imgur.com/JcUkWaJ.png\" alt=\"img\"></p>\n<p>ラーメン食べている人が<a href=\"https://blog.tubone-project24.xyz\" target=\"_blank\" rel=\"noopener noreferrer\">blog.tubone-project24.xyz</a>にアクセスする際のチェーンは<strong>中間証明書A</strong>から<strong>ルート証明書A</strong>をたどって自身の端末にあるルート証明書の検証します。</p>\n<p>ではルート証明書が更新された場合はいかがでしょうか？</p>\n<p>通常端末のアップデートなどでクライアント側のルート証明書も更新されますので、</p>\n<p><img class=\"lozad\" src=\"data:image/gif;base64,R0lGODlhAQABAGAAACH5BAEKAP8ALAAAAAABAAEAAAgEAP8FBAA7\" data-src=\"https://i.imgur.com/1uF5dA3.png\" alt=\"img\"></p>\n<p>と新しい<strong>ルート証明書B</strong>を使うことになりますね。</p>\n<p>ではさらにこの端末がアップデートできない場合やインストールしてないルート証明書へアクセスする場合はどうなるでしょうか？</p>\n<p><img class=\"lozad\" src=\"data:image/gif;base64,R0lGODlhAQABAGAAACH5BAEKAP8ALAAAAAABAAEAAAgEAP8FBAA7\" data-src=\"https://i.imgur.com/y0ul2Eg.png\" alt=\"img\"></p>\n<p>はい。当然ダメですね..。</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">(･ω･乂)\n(乂･ω･)\n(･ω･乂)\n(乂･ω･)</code></pre></div>\n<p><a href=\"https://blog.tubone-project24.xyz\" target=\"_blank\" rel=\"noopener noreferrer\">blog.tubone-project24.xyz</a>のサーバー証明書の中間証明書から先のルート証明書はルート証明書Bなので<strong>自端末に存在しないルート証明書</strong>になってしまいます。</p>\n<p>これを解決するのが<strong>クロスルート証明書</strong>というわけです。</p>\n<p><img class=\"lozad\" src=\"data:image/gif;base64,R0lGODlhAQABAGAAACH5BAEKAP8ALAAAAAABAAEAAAgEAP8FBAA7\" data-src=\"https://i.imgur.com/9fwz8jM.png\" alt=\"img\"></p>\n<p>クロスルート証明書を使った場合、仮にあなたの端末にルート証明書Aしかない場合、<a href=\"https://blog.tubone-project24.xyz\" target=\"_blank\" rel=\"noopener noreferrer\">blog.tubone-project24.xyz</a>へのアクセスをするとサーバー証明書から中間証明書をまずチェーンします。</p>\n<p>そのまま上のルート証明書を見てもこちら残念ながらさっきと同じなのですが中間証明書に紐づくクロスルート証明書というものがありこちらが内容はルート証明書Bと同じながらルート証明書Aで署名されている形を取ります。すると、クロスルート証明書からルート証明書Aをたどって検証が完了するわけです。</p>\n<p>えっ？中間証明書を複数のルート証明書で署名するみたいなそんなことできるんですか..?という疑問が出たそこの君！優秀ですね。</p>\n<p>クロスルート方式を利用する場合には、中間証明書とクロスルート設定証明書を連結させて1つにした中間証明書として利用することで上記の通りになります。</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">—–BEGIN CERTIFICATE—–\n  中間CA証明書の文字列\n—–END CERTIFICATE—–\n—–BEGIN CERTIFICATE—–\n  クロスルート設定用証明書の文字列\n—–END CERTIFICATE—–</code></pre></div>\n<p>レガシー端末や組み込み系ではこのような方法を利用してルート証明書の管理をしているわけです。</p>\n<h2 id=\"話を戻してdatadog\" style=\"position:relative;\"><a href=\"#%E8%A9%B1%E3%82%92%E6%88%BB%E3%81%97%E3%81%A6datadog\" aria-label=\"話を戻してdatadog permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>話を戻してDatadog</h2>\n<p>さて話を戻してDatadogのコードに移ります。</p>\n<p>さきほども申したとおり、通常ルート証明書はPC側のアップデートに追従して更新されていくのでそこまで気になりませんが、この手の<strong>エージェントやJDK</strong>などは独自にルート証明書を抱えていて、それを使うようにする場合も多いです。</p>\n<p>脱線しますが、たとえばJDKとかではJavaが使うルート証明書を<strong>cacerts</strong>に格納します。</p>\n<p>例えば<strong>OpenJDK1.8.0</strong>の場合、Macなら、</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">lib/jvm/java-1.8.0-openjdk-1.8.0.201.b09-2.el7_6.x86_64/jre/lib/security/cacerts</code></pre></div>\n<p>にcacertsがいます。</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">$ keytool -keystore cacerts -list -v</code></pre></div>\n<p>というコマンドでJDKにインストールされているルート証明書が確認できます。</p>\n<p>なんか回りくどいですがこうすることでJavaプロセス単体でSSL通信の検証ができるわけで<strong>30億のデバイスで走る</strong>ことができるわけですね。</p>\n<p><img class=\"lozad\" src=\"data:image/gif;base64,R0lGODlhAQABAGAAACH5BAEKAP8ALAAAAAABAAEAAAgEAP8FBAA7\" data-src=\"https://i.imgur.com/zKzF2Wa.jpg\" alt=\"img\"></p>\n<blockquote>\n<p>30億のデバイスで走るのに自分の環境では走らないJava</p>\n</blockquote>\n<p>(とか揶揄されたことありましたね。余談です。)</p>\n<p>DatadogもまさにJDKと同じような実装でした。</p>\n<p>ちなみに今回有効期限の切れた証明書はDatadogのサイト<a href=\"https://docs.datadoghq.com/agent/faq/certificate_verify_failed-error/\" target=\"_blank\" rel=\"noopener noreferrer\"><strong>CERTIFICATE_VERIFY_FAILED error</strong>\n</a>や本事象のdatadog-agent修正PRの<a href=\"https://github.com/DataDog/dd-agent/pull/3882\" target=\"_blank\" rel=\"noopener noreferrer\">Update the Sectigo / USERTrust CA Certificate #3882</a>に書いてある情報から判明しており、<a href=\"https://support.sectigo.com/articles/Knowledge/Sectigo-AddTrust-External-CA-Root-Expiring-May-30-2020\" target=\"_blank\" rel=\"noopener noreferrer\"><strong>Sectigo AddTrust External CA Root</strong></a>が<strong>2020/5/30</strong>に失効しました。</p>\n<h2 id=\"datadog-agentはtornadoを使っている\" style=\"position:relative;\"><a href=\"#datadog-agent%E3%81%AFtornado%E3%82%92%E4%BD%BF%E3%81%A3%E3%81%A6%E3%81%84%E3%82%8B\" aria-label=\"datadog agentはtornadoを使っている permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Datadog AgentはTornadoを使っている</h2>\n<p>そもそも<a href=\"https://docs.datadoghq.com/ja/agent/\" target=\"_blank\" rel=\"noopener noreferrer\">Datadog Agent</a>というのはEC2などの監視対象サーバーにサービスの形で常駐させるとCPUやディスクのメトリックを取得し、Datadogに送信してくれるやつです。</p>\n<p>Zabbix AgentのDatadog版ですね。</p>\n<p>Datadogへメトリックを送信しなければいけないので当然インターネット越しに通信をしなければいけません。もちろん通信はSSLで暗号化されてしかるべきです。</p>\n<p>これは知らなかったのですがDatadog Agentって<a href=\"https://www.tornadoweb.org/en/stable/index.html\" target=\"_blank\" rel=\"noopener noreferrer\">Tornado</a>を使っています。</p>\n<p>datadog-agent(version 5)をサービス起動するとlocalhostのport17123にTornadoのサーバーが立ち上がります。</p>\n<p><img class=\"lozad\" src=\"data:image/gif;base64,R0lGODlhAQABAGAAACH5BAEKAP8ALAAAAAABAAEAAAgEAP8FBAA7\" data-src=\"https://i.imgur.com/Z58AGfp.jpg\" alt=\"img\"></p>\n<p>この**Tornadoサーバー(Forwarder)**にmetricsのcollectorが収集した情報を投げ込むことでDatadogサーバーへmetricsをForwardingしてくれる仕組みのようです。</p>\n<p>こうすることでDatadog謹製のcollectorだけでなくDogStatusD経由でcustom metricsも効率的に収集できます。</p>\n<p><img class=\"lozad\" src=\"data:image/gif;base64,R0lGODlhAQABAGAAACH5BAEKAP8ALAAAAAABAAEAAAgEAP8FBAA7\" data-src=\"https://i.imgur.com/q1Ouk6Y.png\" alt=\"img\"></p>\n<p>詳しくはdatadog-agentのGitHub<a href=\"https://github.com/DataDog/dd-agent\" target=\"_blank\" rel=\"noopener noreferrer\">https://github.com/DataDog/dd-agent</a>や、</p>\n<p><a href=\"https://docs.datadoghq.com/ja/agent/basic_agent_usage/?tab=agentv5\" target=\"_blank\" rel=\"noopener noreferrer\">Agent アーキテクチャ</a></p>\n<p>をご覧ください。</p>\n<p>さてこのTornadoで実際にDatadogと通信しているところはシーケンス図上の<strong>Tornado HttpClient</strong>、正確には<a href=\"https://www.tornadoweb.org/en/stable/httpclient.html\" target=\"_blank\" rel=\"noopener noreferrer\">Asynchronous HTTP client</a>になるわけですが、datadog-agentの作りとして、Asynchronous HTTP clientに独自でca_certsを設定し、Datadogとの通信に<strong>datadog-cert.pem</strong>というクロスルート証明書を使っております。</p>\n<p>では<strong>datadog-cert.pem</strong>を見てみましょう。</p>\n<p>確認にはOpenSSLコマンドが利用できます。</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">$ openssl x509 -text -noout -in datadog-cert.pem                                                                                   \nCertificate:\n    Data:\n        Version: 3 (0x2)\n        Serial Number: 1 (0x1)\n        Signature Algorithm: sha1WithRSAEncryption\n        Issuer: C = SE, O = AddTrust AB, OU = AddTrust External TTP Network, CN = AddTrust External CA Root\n        Validity\n            Not Before: May 30 10:48:38 2000 GMT\n            Not After : May 30 10:48:38 2020 GMT\n        Subject: C = SE, O = AddTrust AB, OU = AddTrust External TTP Network, CN = AddTrust External CA Root\n        Subject Public Key Info:\n            Public Key Algorithm: rsaEncryption\n                RSA Public-Key: (2048 bit)\n                Modulus:\n                    00:b7:f7:1a:33:e6:f2:00:04:2d:39:e0:4e:5b:ed:\n                    1f:bc:6c:0f:cd:b5:fa:23:b6:ce:de:9b:11:33:97:\n                    a4:29:4c:7d:93:9f:bd:4a:bc:93:ed:03:1a:e3:8f:\n                    cf:e5:6d:50:5a:d6:97:29:94:5a:80:b0:49:7a:db:\n                    2e:95:fd:b8:ca:bf:37:38:2d:1e:3e:91:41:ad:70:\n                    56:c7:f0:4f:3f:e8:32:9e:74:ca:c8:90:54:e9:c6:\n                    5f:0f:78:9d:9a:40:3c:0e:ac:61:aa:5e:14:8f:9e:\n                    87:a1:6a:50:dc:d7:9a:4e:af:05:b3:a6:71:94:9c:\n                    71:b3:50:60:0a:c7:13:9d:38:07:86:02:a8:e9:a8:\n                    69:26:18:90:ab:4c:b0:4f:23:ab:3a:4f:84:d8:df:\n                    ce:9f:e1:69:6f:bb:d7:42:d7:6b:44:e4:c7:ad:ee:\n                    6d:41:5f:72:5a:71:08:37:b3:79:65:a4:59:a0:94:\n                    37:f7:00:2f:0d:c2:92:72:da:d0:38:72:db:14:a8:\n                    45:c4:5d:2a:7d:b7:b4:d6:c4:ee:ac:cd:13:44:b7:\n                    c9:2b:dd:43:00:25:fa:61:b9:69:6a:58:23:11:b7:\n                    a7:33:8f:56:75:59:f5:cd:29:d7:46:b7:0a:2b:65:\n                    b6:d3:42:6f:15:b2:b8:7b:fb:ef:e9:5d:53:d5:34:\n                    5a:27\n                Exponent: 65537 (0x10001)\n        X509v3 extensions:\n            X509v3 Subject Key Identifier:\n                AD:BD:98:7A:34:B4:26:F7:FA:C4:26:54:EF:03:BD:E0:24:CB:54:1A\n            X509v3 Key Usage:\n                Certificate Sign, CRL Sign\n            X509v3 Basic Constraints: critical\n                CA:TRUE\n            X509v3 Authority Key Identifier:\n                keyid:AD:BD:98:7A:34:B4:26:F7:FA:C4:26:54:EF:03:BD:E0:24:CB:54:1A\n                DirName:/C=SE/O=AddTrust AB/OU=AddTrust External TTP Network/CN=AddTrust External CA Root\n                serial:01\n    Signature Algorithm: sha1WithRSAEncryption\n         b0:9b:e0:85:25:c2:d6:23:e2:0f:96:06:92:9d:41:98:9c:d9:\n         84:79:81:d9:1e:5b:14:07:23:36:65:8f:b0:d8:77:bb:ac:41:\n         6c:47:60:83:51:b0:f9:32:3d:e7:fc:f6:26:13:c7:80:16:a5:\n         bf:5a:fc:87:cf:78:79:89:21:9a:e2:4c:07:0a:86:35:bc:f2:\n         de:51:c4:d2:96:b7:dc:7e:4e:ee:70:fd:1c:39:eb:0c:02:51:\n         14:2d:8e:bd:16:e0:c1:df:46:75:e7:24:ad:ec:f4:42:b4:85:\n         93:70:10:67:ba:9d:06:35:4a:18:d3:2b:7a:cc:51:42:a1:7a:\n         63:d1:e6:bb:a1:c5:2b:c2:36:be:13:0d:e6:bd:63:7e:79:7b:\n         a7:09:0d:40:ab:6a:dd:8f:8a:c3:f6:f6:8c:1a:42:05:51:d4:\n         45:f5:9f:a7:62:21:68:15:20:43:3c:99:e7:7c:bd:24:d8:a9:\n         91:17:73:88:3f:56:1b:31:38:18:b4:71:0f:9a:cd:c8:0e:9e:\n         8e:2e:1b:e1:8c:98:83:cb:1f:31:f1:44:4c:c6:04:73:49:76:\n         60:0f:c7:f8:bd:17:80:6b:2e:e9:cc:4c:0e:5a:9a:79:0f:20:\n         0a:2e:d5:9e:63:26:1e:55:92:94:d8:82:17:5a:7b:d0:bc:c7:\n         8f:4e:86:04</code></pre></div>\n<p>﻿\n確かに有効期限は切れてますね。</p>\n<p>sectigoのサイトによい図があったので拝借しますが、このようなチェーンをする証明書のようです。</p>\n<p><img class=\"lozad\" src=\"data:image/gif;base64,R0lGODlhAQABAGAAACH5BAEKAP8ALAAAAAABAAEAAAgEAP8FBAA7\" data-src=\"https://i.imgur.com/oMJmF1b.jpg\" alt=\"img\"></p>\n<p>Modern Browser側の動きでは最新の<strong>USERTrust RSA</strong>のルート証明書から検証ができますが、Legacy(Datadogもこっち)Browserは<strong>AddTrust External CA Root</strong>までチェーンしております。</p>\n<p>上記のdatadog-cert.pemのCN(CommonName)を見ても確かにAddTrust External CA Rootですね。</p>\n<p>よって2020/5/30～SSL通信できなくなってしまったというわけです。</p>\n<h2 id=\"結論\" style=\"position:relative;\"><a href=\"#%E7%B5%90%E8%AB%96\" aria-label=\"結論 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>結論</h2>\n<p>証明書周りでこれほど調べたのは久しぶりです...。</p>\n<h2 id=\"追記\" style=\"position:relative;\"><a href=\"#%E8%BF%BD%E8%A8%98\" aria-label=\"追記 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>追記</h2>\n<p>JDKにインストールされているルート証明書も気になったので調べたら、OpenJDK9(JEP319)のルート証明書にAddTrust External CA Rootがいました。</p>\n<p><img class=\"lozad\" src=\"data:image/gif;base64,R0lGODlhAQABAGAAACH5BAEKAP8ALAAAAAABAAEAAAgEAP8FBAA7\" data-src=\"https://i.imgur.com/yn4VUB3.png\" alt=\"img\"></p>\n<p><a href=\"https://openjdk.java.net/jeps/319\" target=\"_blank\" rel=\"noopener noreferrer\">https://openjdk.java.net/jeps/319</a></p>\n<p>ルート証明書の罠に引っかからないようにみんなも気を付けよう！</p>","words":8811,"minutes":23}},"staticQueryHashes":["1319877725","2959249232"]}