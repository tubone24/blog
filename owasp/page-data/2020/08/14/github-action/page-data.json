{"componentChunkName":"component---src-templates-blog-post-tsx","path":"/2020/08/14/github-action","result":{"data":{"content":{"edges":[{"node":{"id":"11fe654f-3ece-5f11-9ab1-bae0ef647ee1","excerpt":"ちょうどいい、GitHub Actionsがなかったので作ってみました。 Table of Contents なんで？ そこで、GitHub JavaScript Action action.yml tscでビルドNccでバンドル tsc ncc ソース input/output…","fields":{"slug":"2020/08/14/github-action"},"frontmatter":{"id":null,"title":"GitHub JavaScript Action で GitHub ReleaseのUpdate Releaseを作ってみた。","slug":"2020/08/14/github-action","date":"2020-09-13T12:41:20.699Z","headerImage":"https://i.imgur.com/kXVhSw7.png","tags":["GitHub","GitHub Actions"]}}}]}},"pageContext":{"id":"11fe654f-3ece-5f11-9ab1-bae0ef647ee1","index":29,"repHtml":"<p>ちょうどいい、<strong>GitHub Actions</strong>がなかったので作ってみました。</p>\n<h2 id=\"table-of-contents\" style=\"position:relative;\"><a href=\"#table-of-contents\" aria-label=\"table of contents permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Table of Contents</h2>\n<div class=\"toc\">\n<ul>\n<li>\n<p><a href=\"#%E3%81%AA%E3%82%93%E3%81%A7\">なんで？</a></p>\n</li>\n<li>\n<p><a href=\"#%E3%81%9D%E3%81%93%E3%81%A7github-javascript-action\">そこで、GitHub JavaScript Action</a></p>\n</li>\n<li>\n<p><a href=\"#actionyml\">action.yml</a></p>\n</li>\n<li>\n<p><a href=\"#tsc%E3%81%A7%E3%83%93%E3%83%AB%E3%83%89ncc%E3%81%A7%E3%83%90%E3%83%B3%E3%83%89%E3%83%AB\">tscでビルドNccでバンドル</a></p>\n<ul>\n<li><a href=\"#tsc\">tsc</a></li>\n<li><a href=\"#ncc\">ncc</a></li>\n</ul>\n</li>\n<li>\n<p><a href=\"#%E3%82%BD%E3%83%BC%E3%82%B9\">ソース</a></p>\n<ul>\n<li><a href=\"#inputoutput\">input/output</a></li>\n<li><a href=\"#update-release%E3%81%AFactionsgithub%E3%81%A7%E3%81%8B%E3%82%93%E3%81%9F%E3%82%93%E3%81%AB%E4%BD%9C%E3%82%8C%E3%81%BE%E3%81%97%E3%81%9F\">update releaseは@actions/githubでかんたんに作れました</a></li>\n</ul>\n</li>\n<li>\n<p><a href=\"#%E3%83%87%E3%83%97%E3%83%AD%E3%82%A4%E3%83%9E%E3%83%BC%E3%82%B1%E3%83%83%E3%83%88%E3%81%AB%E5%85%AC%E9%96%8B\">デプロイ、マーケットに公開</a></p>\n</li>\n<li>\n<p><a href=\"#%E7%B5%90%E8%AB%96\">結論</a></p>\n</li>\n</ul>\n</div>\n<h2 id=\"なんで\" style=\"position:relative;\"><a href=\"#%E3%81%AA%E3%82%93%E3%81%A7\" aria-label=\"なんで permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>なんで？</h2>\n<p>GitHub Actionsで<strong>uses</strong>を使ったことはありますか？</p>\n<div class=\"gatsby-highlight\" data-language=\"yaml\"><pre class=\"language-yaml\"><code class=\"language-yaml\"><span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> Generate Word Cloud\r\n\r\n<span class=\"token key atrule\">on</span><span class=\"token punctuation\">:</span>\r\n  <span class=\"token key atrule\">push</span><span class=\"token punctuation\">:</span>\r\n    <span class=\"token key atrule\">branches</span><span class=\"token punctuation\">:</span>\r\n      <span class=\"token punctuation\">-</span> master\r\n  <span class=\"token key atrule\">schedule</span><span class=\"token punctuation\">:</span>\r\n    <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">cron</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"0 5 * * *\"</span>\r\n\r\n<span class=\"token key atrule\">jobs</span><span class=\"token punctuation\">:</span>\r\n  <span class=\"token key atrule\">GenerateWordCloud</span><span class=\"token punctuation\">:</span>\r\n    <span class=\"token key atrule\">runs-on</span><span class=\"token punctuation\">:</span> ubuntu<span class=\"token punctuation\">-</span>latest\r\n    <span class=\"token key atrule\">steps</span><span class=\"token punctuation\">:</span>\r\n      <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">uses</span><span class=\"token punctuation\">:</span> actions/checkout@v2\r\n      <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> Set up Python 3.x\r\n        <span class=\"token key atrule\">uses</span><span class=\"token punctuation\">:</span> actions/setup<span class=\"token punctuation\">-</span>python@v1\r\n <span class=\"token comment\"># ここ</span>\r\n        <span class=\"token key atrule\">with</span><span class=\"token punctuation\">:</span>\r\n          <span class=\"token key atrule\">python-version</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"3.7\"</span>\r\n      <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">uses</span><span class=\"token punctuation\">:</span> actions/cache@v1\r\n <span class=\"token comment\"># ここ</span>\r\n        <span class=\"token key atrule\">with</span><span class=\"token punctuation\">:</span>\r\n          <span class=\"token key atrule\">path</span><span class=\"token punctuation\">:</span> ~/.cache/pip\r\n          <span class=\"token key atrule\">key</span><span class=\"token punctuation\">:</span> $<span class=\"token punctuation\">{</span><span class=\"token punctuation\">{</span> runner.os <span class=\"token punctuation\">}</span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">-</span>pip<span class=\"token punctuation\">-</span>$<span class=\"token punctuation\">{</span><span class=\"token punctuation\">{</span> hashFiles('<span class=\"token important\">**/requirements.txt')</span> <span class=\"token punctuation\">}</span><span class=\"token punctuation\">}</span>\r\n          <span class=\"token key atrule\">restore-keys</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">|</span><span class=\"token scalar string\">\r\n            ${{ runner.os }}-pip-</span></code></pre></div>\n<p>GitHub Actionsを使うときには何かと便利なやつですが、公式には<strong>actions</strong>というレポジトリにいます。</p>\n<p><a href=\"https://github.com/actions\" target=\"_blank\" rel=\"noopener noreferrer\">https://github.com/actions</a></p>\n<p>今回は、<a href=\"https://github.com/tubone24/post_twitter_on_work\" target=\"_blank\" rel=\"noopener noreferrer\">\r\npost_twitter_on_work</a>の開発のなかで、<strong>GitHub ReleasesにGitHub ActionsでBuildしたArtifactsをアップデートしたい</strong>欲求が出てきました。</p>\n<p>通常、GitHub ReleasesをGitHub Actionsで使うには、<a href=\"https://github.com/actions/create-release\" target=\"_blank\" rel=\"noopener noreferrer\">actions\r\n/\r\ncreate-release</a>を使うことが多いです。</p>\n<p>こちらの使い方としては、</p>\n<ol>\n<li>Git Tagを打ってPushする.</li>\n<li>Pushに反応して、actions</li>\n</ol>\n<p>/\r\ncreate-releaseが動く.\r\n3. 出来上がったReleasesに<a href=\"https://github.com/actions/upload-release-asset\" target=\"_blank\" rel=\"noopener noreferrer\">actions/upload-release-asset</a>でArtifactsを上げる.</p>\n<p>という感じの使い方になるかと思います。</p>\n<p>が、しかし、<a href=\"https://github.com/tubone24/post_twitter_on_work\" target=\"_blank\" rel=\"noopener noreferrer\">post_twitter_on_work</a>では下記理由でそれができない（やりたくない）のでした。</p>\n<ul>\n<li>Git Tagうつのめんどくさい。\n<ul>\n<li>GitHub ReleasesからDraft ReleaseでTag打ちたい</li>\n</ul>\n</li>\n<li>matrixで何度もJobが動く\n<ul>\n<li>重複して、Create Releasesできない</li>\n</ul>\n</li>\n</ul>\n<h2 id=\"そこでgithub-javascript-action\" style=\"position:relative;\"><a href=\"#%E3%81%9D%E3%81%93%E3%81%A7github-javascript-action\" aria-label=\"そこでgithub javascript action permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>そこで、GitHub JavaScript Action</h2>\n<p>いいものがないなら作る。それしかないです。</p>\n<p>GitHub Actionを作るには2種類の方法があります。</p>\n<ul>\n<li><a href=\"https://docs.github.com/ja/actions/creating-actions/about-actions#docker-container-actions\" target=\"_blank\" rel=\"noopener noreferrer\">Dockerコンテナ</a></li>\n<li><a href=\"https://docs.github.com/ja/actions/creating-actions/about-actions#javascript-actions\" target=\"_blank\" rel=\"noopener noreferrer\">JavaScript</a></li>\n</ul>\n<p>Dockerコンテナで作る場合、GitHub ActionsのLinux上でコンテナを起動するので、<strong>WindowsやMacのOSでは動きません</strong>。また、いろんなことができる一方、コンテナが立ち上がるための<strong>時間もかかり</strong>ます。</p>\n<p>JavaScriptでは、Node.js 12で動くJSコードを書くだけです。WindowsやMacのOS上でも問題なく動きます。JavaScriptに慣れていて、特定のライブラリや言語を使わないといけない状況でなければJavaScript一択だと思います。</p>\n<p>JavaScript　Actionは、公式にテンプレートがありますので、かんたんに作ることができます。</p>\n<p><a href=\"https://github.com/actions/javascript-action\" target=\"_blank\" rel=\"noopener noreferrer\">https://github.com/actions/javascript-action</a></p>\n<p>さらにTypeScript用のテンプレートもあります。嬉しいですね。</p>\n<p><a href=\"https://github.com/actions/typescript-action\" target=\"_blank\" rel=\"noopener noreferrer\">https://github.com/actions/typescript-action</a></p>\n<p>今回はJavaScript Action(TypeScript)を使って開発していこうと思います。</p>\n<h2 id=\"actionyml\" style=\"position:relative;\"><a href=\"#actionyml\" aria-label=\"actionyml permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>action.yml</h2>\n<p>GitHub Actionのメタデータとして、<strong>action.yml</strong>を作ります。</p>\n<p>名前や説明のほかwithで定義するinputやoutputで使える変数や、ランタイムを定義できます。</p>\n<p>inputやoutputは変数名の他、説明とrequiredを定義できます。</p>\n<p>また、JavaScript Actionのランタイムはnode12一択です。</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">name: 'Update GitHub Release'\r\ndescription: 'Update GitHub Release'\r\nauthor: 'tubone24'\r\ninputs:\r\n  release_name:\r\n    description: 'new release name, if not, take over before name'\r\n    required: false\r\n  body:\r\n    description: 'new body text, if not, take over before text'\r\n    required: false\r\n  draft:\r\n    description: 'new draft, if not, take over before draft'\r\n    required: false\r\n  prerelease:\r\n    description: 'new prerelease, if not, take over prerelease'\r\n    required: false\r\n  is_append_body:\r\n    description: 'If true, append body text, If false, overwrite body text, default is false'\r\n    required: false\r\n  body_path:\r\n    description: 'Path to file with new body text.'\r\n    required: false\r\noutputs:\r\n  id:\r\n    description: 'The ID of the Release'\r\n  html_url:\r\n    description: 'The HTML url of the Release'\r\n  upload_url:\r\n    description: 'The upload url of the Release'\r\n  name:\r\n    description: 'The name of the Release'\r\n  body:\r\n    description: 'The body of the Release'\r\n  published_at:\r\n    description: 'The publish at of the Release'\r\n  tag_name:\r\n    description: 'The tag name of the Release'\r\nruns:\r\n  using: 'node12'\r\n  main: 'dist/index.js'\r\nbranding:\r\n  icon: 'tag'\r\n  color: 'green'</code></pre></div>\n<h2 id=\"tscでビルドnccでバンドル\" style=\"position:relative;\"><a href=\"#tsc%E3%81%A7%E3%83%93%E3%83%AB%E3%83%89ncc%E3%81%A7%E3%83%90%E3%83%B3%E3%83%89%E3%83%AB\" aria-label=\"tscでビルドnccでバンドル permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>tscでビルドNccでバンドル</h2>\n<h3 id=\"tsc\" style=\"position:relative;\"><a href=\"#tsc\" aria-label=\"tsc permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>tsc</h3>\n<p>TypeScriptを使って開発したことがある人なら一度は使ったことのある<strong>tsc</strong>。TypeScriptでGitHub Actionを作るにはtscでJavaScriptにビルドしてあげる必要があります。</p>\n<p>まず、srcディレクトリのtsファイルをlibディレクリにビルドするので、tsconfig.jsonを書きましょう。</p>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\"><span class=\"token punctuation\">{</span>\r\n  <span class=\"token string-property property\">\"compilerOptions\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>\r\n    <span class=\"token string-property property\">\"target\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"es6\"</span><span class=\"token punctuation\">,</span>\r\n    <span class=\"token string-property property\">\"module\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"commonjs\"</span><span class=\"token punctuation\">,</span>\r\n    <span class=\"token string-property property\">\"outDir\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"./lib\"</span><span class=\"token punctuation\">,</span>\r\n    <span class=\"token string-property property\">\"rootDir\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"./src\"</span><span class=\"token punctuation\">,</span>\r\n    <span class=\"token string-property property\">\"strict\"</span><span class=\"token operator\">:</span> <span class=\"token boolean\">false</span><span class=\"token punctuation\">,</span>\r\n    <span class=\"token string-property property\">\"noImplicitAny\"</span><span class=\"token operator\">:</span> <span class=\"token boolean\">false</span><span class=\"token punctuation\">,</span>\r\n    <span class=\"token string-property property\">\"esModuleInterop\"</span><span class=\"token operator\">:</span> <span class=\"token boolean\">true</span>\r\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\r\n  <span class=\"token string-property property\">\"exclude\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span><span class=\"token string\">\"node_modules\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"**/*.test.ts\"</span><span class=\"token punctuation\">]</span>\r\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>rootディレクトリはsrc, outディレクトリはlibとなります。strictがfalseでごめんなさい。真面目にTypeScriptやってなくてすみません。</p>\n<p>packages.jsonでもbuildはtscで設定してしまいます。</p>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\"><span class=\"token punctuation\">{</span>\r\n  <span class=\"token string-property property\">\"scripts\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>\r\n    <span class=\"token string-property property\">\"build\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"tsc\"</span>\r\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span></code></pre></div>\n<p>npm run buildすれば、libディレクトリにJavaScriptでビルドされるようになりました。</p>\n<h3 id=\"ncc\" style=\"position:relative;\"><a href=\"#ncc\" aria-label=\"ncc permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>ncc</h3>\n<p>JavaScriptにビルドされたjsファイルを<a href=\"https://github.com/vercel/ncc\" target=\"_blank\" rel=\"noopener noreferrer\">vercel/ncc</a>というバンドルツールを使って、1ファイルにバンドルしてaction.ymlで定義しているmainのjsファイルとして指定してあげる必要があります。</p>\n<p>バンドルツールといえば<strong>Webpack</strong>が有名ですが、それこそVercelでSSRをfunctionに乗っかるJavaScriptをコンパイルするための軽量ツールです。GitHub Actionsでも使えるんですね。</p>\n<p>packages.jsonで、</p>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\">  <span class=\"token string-property property\">\"scripts\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>\r\n    <span class=\"token string-property property\">\"build\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"tsc\"</span><span class=\"token punctuation\">,</span>\r\n    <span class=\"token string-property property\">\"package\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"ncc build lib/main.js -o dist --source-map --license licenses.txt\"</span><span class=\"token punctuation\">,</span>\r\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span></code></pre></div>\n<p>npm run packageとすることで、さきほどtscでつくったJavaScriptをバンドルできます。</p>\n<h2 id=\"ソース\" style=\"position:relative;\"><a href=\"#%E3%82%BD%E3%83%BC%E3%82%B9\" aria-label=\"ソース permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>ソース</h2>\n<h3 id=\"inputoutput\" style=\"position:relative;\"><a href=\"#inputoutput\" aria-label=\"inputoutput permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>input/output</h3>\n<p>action.ymlで設定したinputやoutputは <strong>@actions/core</strong> のgetInput, setOutputでかんたんに使うことができます。</p>\n<div class=\"gatsby-highlight\" data-language=\"typescript\"><pre class=\"language-typescript\"><code class=\"language-typescript\"><span class=\"token keyword\">import</span> <span class=\"token punctuation\">{</span>getInput<span class=\"token punctuation\">,</span> setFailed<span class=\"token punctuation\">,</span> setOutput<span class=\"token punctuation\">,</span> info<span class=\"token punctuation\">}</span> <span class=\"token keyword\">from</span> <span class=\"token string\">'@actions/core'</span>\r\n\r\n<span class=\"token keyword\">export</span> <span class=\"token keyword\">const</span> run <span class=\"token operator\">=</span> <span class=\"token keyword\">async</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token operator\">:</span> <span class=\"token builtin\">Promise</span><span class=\"token operator\">&lt;</span><span class=\"token keyword\">void</span><span class=\"token operator\">></span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\r\n\r\n    <span class=\"token keyword\">const</span> newReleaseName <span class=\"token operator\">=</span> <span class=\"token function\">getInput</span><span class=\"token punctuation\">(</span><span class=\"token string\">'release_name'</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">{</span>required<span class=\"token operator\">:</span> <span class=\"token boolean\">false</span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\r\n    <span class=\"token keyword\">const</span> newBody <span class=\"token operator\">=</span> <span class=\"token function\">getInput</span><span class=\"token punctuation\">(</span><span class=\"token string\">'body'</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">{</span>required<span class=\"token operator\">:</span> <span class=\"token boolean\">false</span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\r\n    <span class=\"token keyword\">const</span> newDraft <span class=\"token operator\">=</span> <span class=\"token function\">getInput</span><span class=\"token punctuation\">(</span><span class=\"token string\">'draft'</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">{</span>required<span class=\"token operator\">:</span> <span class=\"token boolean\">false</span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\r\n    <span class=\"token keyword\">const</span> newPrerelease <span class=\"token operator\">=</span> <span class=\"token function\">getInput</span><span class=\"token punctuation\">(</span><span class=\"token string\">'prerelease'</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">{</span>required<span class=\"token operator\">:</span> <span class=\"token boolean\">false</span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\r\n    \r\n    <span class=\"token punctuation\">(</span>中略<span class=\"token operator\">...</span><span class=\"token punctuation\">)</span>\r\n    \r\n    <span class=\"token function\">setOutput</span><span class=\"token punctuation\">(</span><span class=\"token string\">'id'</span><span class=\"token punctuation\">,</span> updatedReleaseId<span class=\"token punctuation\">.</span><span class=\"token function\">toString</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\r\n    <span class=\"token function\">setOutput</span><span class=\"token punctuation\">(</span><span class=\"token string\">'html_url'</span><span class=\"token punctuation\">,</span> updatedHtmlUrl<span class=\"token punctuation\">)</span>\r\n    <span class=\"token function\">setOutput</span><span class=\"token punctuation\">(</span><span class=\"token string\">'upload_url'</span><span class=\"token punctuation\">,</span> updatedUploadUrl<span class=\"token punctuation\">)</span>\r\n    <span class=\"token function\">setOutput</span><span class=\"token punctuation\">(</span><span class=\"token string\">'name'</span><span class=\"token punctuation\">,</span> updatedReleaseName<span class=\"token punctuation\">)</span>\r\n    <span class=\"token function\">setOutput</span><span class=\"token punctuation\">(</span><span class=\"token string\">'body'</span><span class=\"token punctuation\">,</span> updatedBody<span class=\"token punctuation\">)</span>\r\n    <span class=\"token function\">setOutput</span><span class=\"token punctuation\">(</span><span class=\"token string\">'published_at'</span><span class=\"token punctuation\">,</span> updatedPublishAt<span class=\"token punctuation\">)</span>\r\n    <span class=\"token function\">setOutput</span><span class=\"token punctuation\">(</span><span class=\"token string\">'tag_name'</span><span class=\"token punctuation\">,</span> tag<span class=\"token punctuation\">)</span>\r\n  <span class=\"token punctuation\">}</span> <span class=\"token keyword\">catch</span> <span class=\"token punctuation\">(</span>error<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\r\n    <span class=\"token function\">setFailed</span><span class=\"token punctuation\">(</span>error<span class=\"token punctuation\">.</span>message<span class=\"token punctuation\">)</span>\r\n  <span class=\"token punctuation\">}</span>\r\n<span class=\"token punctuation\">}</span>\r\n</code></pre></div>\n<h3 id=\"update-releaseはactionsgithubでかんたんに作れました\" style=\"position:relative;\"><a href=\"#update-release%E3%81%AFactionsgithub%E3%81%A7%E3%81%8B%E3%82%93%E3%81%9F%E3%82%93%E3%81%AB%E4%BD%9C%E3%82%8C%E3%81%BE%E3%81%97%E3%81%9F\" aria-label=\"update releaseはactionsgithubでかんたんに作れました permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>update releaseは@actions/githubでかんたんに作れました</h3>\n<p>GitHub ActionでGitHubの機能を使うには便利な**@actions/github**を使えば一発でした。</p>\n<p>GitHub Actionsから取れるSecretをenvで渡してあげるだけで使えます。便利。</p>\n<p>レポジトリ情報や、Tag情報はcontextから取れます。</p>\n<p>updateReleaseはgithub.repos.updateReleaseからできます。</p>\n<div class=\"gatsby-highlight\" data-language=\"typescript\"><pre class=\"language-typescript\"><code class=\"language-typescript\"><span class=\"token keyword\">import</span> <span class=\"token punctuation\">{</span>GitHub<span class=\"token punctuation\">,</span> context<span class=\"token punctuation\">}</span> <span class=\"token keyword\">from</span> <span class=\"token string\">'@actions/github'</span>\r\n\r\n<span class=\"token keyword\">export</span> <span class=\"token keyword\">const</span> run <span class=\"token operator\">=</span> <span class=\"token keyword\">async</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token operator\">:</span> <span class=\"token builtin\">Promise</span><span class=\"token operator\">&lt;</span><span class=\"token keyword\">void</span><span class=\"token operator\">></span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\r\n  <span class=\"token keyword\">try</span> <span class=\"token punctuation\">{</span>\r\n    <span class=\"token keyword\">const</span> github <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">GitHub</span><span class=\"token punctuation\">(</span>process<span class=\"token punctuation\">.</span>env<span class=\"token punctuation\">.</span><span class=\"token constant\">GITHUB_TOKEN</span><span class=\"token punctuation\">)</span>\r\n    <span class=\"token keyword\">const</span> <span class=\"token punctuation\">{</span>owner<span class=\"token punctuation\">,</span> repo<span class=\"token punctuation\">}</span> <span class=\"token operator\">=</span> context<span class=\"token punctuation\">.</span>repo\r\n    <span class=\"token keyword\">const</span> tagName <span class=\"token operator\">=</span> context<span class=\"token punctuation\">.</span>ref\r\n    <span class=\"token keyword\">const</span> tag <span class=\"token operator\">=</span> tagName<span class=\"token punctuation\">.</span><span class=\"token function\">replace</span><span class=\"token punctuation\">(</span><span class=\"token string\">'refs/tags/'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">''</span><span class=\"token punctuation\">)</span>\r\n    <span class=\"token keyword\">const</span> getReleaseResponse <span class=\"token operator\">=</span> <span class=\"token keyword\">await</span> github<span class=\"token punctuation\">.</span>repos<span class=\"token punctuation\">.</span><span class=\"token function\">getReleaseByTag</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span>\r\n      owner<span class=\"token punctuation\">,</span>\r\n      repo<span class=\"token punctuation\">,</span>\r\n      tag\r\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\r\n\r\n    <span class=\"token keyword\">const</span> <span class=\"token punctuation\">{</span>\r\n      data<span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>\r\n        id<span class=\"token operator\">:</span> oldReleaseId<span class=\"token punctuation\">,</span>\r\n        html_url<span class=\"token operator\">:</span> oldHtmlUrl<span class=\"token punctuation\">,</span>\r\n        upload_url<span class=\"token operator\">:</span> oldUploadUrl<span class=\"token punctuation\">,</span>\r\n        body<span class=\"token operator\">:</span> oldBody<span class=\"token punctuation\">,</span>\r\n        draft<span class=\"token operator\">:</span> oldDraft<span class=\"token punctuation\">,</span>\r\n        name<span class=\"token operator\">:</span> oldName<span class=\"token punctuation\">,</span>\r\n        prerelease<span class=\"token operator\">:</span> oldPrerelease\r\n      <span class=\"token punctuation\">}</span>\r\n    <span class=\"token punctuation\">}</span> <span class=\"token operator\">=</span> <span class=\"token function\">getReleaseResponse</span>\r\n\r\n    <span class=\"token punctuation\">(</span>中略<span class=\"token operator\">...</span><span class=\"token punctuation\">)</span>\r\n\r\n    <span class=\"token keyword\">const</span> updateReleaseResponse <span class=\"token operator\">=</span> <span class=\"token keyword\">await</span> github<span class=\"token punctuation\">.</span>repos<span class=\"token punctuation\">.</span><span class=\"token function\">updateRelease</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span>\r\n      owner<span class=\"token punctuation\">,</span>\r\n      release_id<span class=\"token operator\">:</span> oldReleaseId<span class=\"token punctuation\">,</span>\r\n      repo<span class=\"token punctuation\">,</span>\r\n      body<span class=\"token operator\">:</span> bodyFileContent <span class=\"token operator\">||</span> body<span class=\"token punctuation\">,</span>\r\n      name<span class=\"token punctuation\">,</span>\r\n      draft<span class=\"token punctuation\">,</span>\r\n      prerelease\r\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\r\n\r\n    <span class=\"token keyword\">const</span> <span class=\"token punctuation\">{</span>\r\n      data<span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>\r\n        id<span class=\"token operator\">:</span> updatedReleaseId<span class=\"token punctuation\">,</span>\r\n        body<span class=\"token operator\">:</span> updatedBody<span class=\"token punctuation\">,</span>\r\n        upload_url<span class=\"token operator\">:</span> updatedUploadUrl<span class=\"token punctuation\">,</span>\r\n        html_url<span class=\"token operator\">:</span> updatedHtmlUrl<span class=\"token punctuation\">,</span>\r\n        name<span class=\"token operator\">:</span> updatedReleaseName<span class=\"token punctuation\">,</span>\r\n        published_at<span class=\"token operator\">:</span> updatedPublishAt\r\n      <span class=\"token punctuation\">}</span>\r\n    <span class=\"token punctuation\">}</span> <span class=\"token operator\">=</span> updateReleaseResponse\r\n<span class=\"token punctuation\">}</span></code></pre></div>\n<h2 id=\"デプロイマーケットに公開\" style=\"position:relative;\"><a href=\"#%E3%83%87%E3%83%97%E3%83%AD%E3%82%A4%E3%83%9E%E3%83%BC%E3%82%B1%E3%83%83%E3%83%88%E3%81%AB%E5%85%AC%E9%96%8B\" aria-label=\"デプロイマーケットに公開 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>デプロイ、マーケットに公開</h2>\n<p>デプロイはdistディレクトリを含めた形でpushすればいいだけです。</p>\n<p>せっかくなので、distディレクトリのデプロイはGitHub Actionsでpushで動くワークフローでやってます。</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">name: Test and Build\r\n\r\non:\r\n  push:\r\n    branches:\r\n      - '*'\r\n    tags-ignore:\r\n      - 'v*' # version Tag push use release workflow\r\n\r\njobs:\r\n  build:\r\n    runs-on: ubuntu-latest\r\n    steps:\r\n      - uses: actions/checkout@v1\r\n      - name: Install Dependencies\r\n        run: npm install\r\n      - name: Test and Build\r\n        run: npm run all\r\n      - name: Use Coveralls\r\n        uses: coverallsapp/github-action@master\r\n        with:\r\n          github-token: ${{ secrets.GITHUB_TOKEN }}\r\n      - name: Setup git\r\n        env:\r\n          GITHUB_TOKEN: ${{ secrets.github_token }}\r\n        run: |\r\n          git config --local user.name GitHubActions\r\n          git remote set-url origin https://${GITHUB_ACTOR}:${GITHUB_TOKEN}@github.com/${GITHUB_REPOSITORY}.git\r\n      - name: Git push, tag, upload assets\r\n        run: |\r\n          git checkout master\r\n          git pull origin master\r\n          git add -A\r\n          DIFF=`git diff --cached --numstat | wc -l`\r\n          if [ $DIFF -eq 0 ]; then\r\n            exit 0\r\n          fi\r\n          git commit -am 'GitHub Actions commit' --allow-empty\r\n          git push origin master</code></pre></div>\n<p>pushが終わったらGitHub ReleaseからReleaseを切ってあげることで、marketに公開する形になります。</p>\n<p><img class=\"lozad\" src=\"data:image/gif;base64,R0lGODlhAQABAGAAACH5BAEKAP8ALAAAAAABAAEAAAgEAP8FBAA7\" data-src=\"https://i.imgur.com/5715wbc.png\" alt=\"img\"></p>\n<p>うまく公開できると、こんな漢字で、usesで使えるActionとして公開されます。</p>\n<p><img class=\"lozad\" src=\"data:image/gif;base64,R0lGODlhAQABAGAAACH5BAEKAP8ALAAAAAABAAEAAAgEAP8FBAA7\" data-src=\"https://i.imgur.com/kXVhSw7.png\" alt=\"img\"></p>\n<h2 id=\"結論\" style=\"position:relative;\"><a href=\"#%E7%B5%90%E8%AB%96\" aria-label=\"結論 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>結論</h2>\n<p>今回のソースコード一式は<a href=\"https://github.com/tubone24/update_release\" target=\"_blank\" rel=\"noopener noreferrer\">https://github.com/tubone24/update_release</a>に、</p>\n<p>マーケットプレイスは<a href=\"https://github.com/marketplace/actions/update-github-release\" target=\"_blank\" rel=\"noopener noreferrer\">https://github.com/marketplace/actions/update-github-release</a>で公開してます。</p>\n<p>GitHub Actionsが徐々に使われるようになってきましたのでビッグウェーブに乗りたいですね。</p>\n<p><img class=\"lozad\" src=\"data:image/gif;base64,R0lGODlhAQABAGAAACH5BAEKAP8ALAAAAAABAAEAAAgEAP8FBAA7\" data-src=\"https://i.imgur.com/rp2VEVO.jpg\" alt=\"img\"></p>","words":2808,"minutes":8}},"staticQueryHashes":["1319877725","2959249232"]}