{"componentChunkName":"component---src-templates-blog-post-tsx","path":"/2020/1/20/x-ray-datadog","result":{"data":{"content":{"edges":[{"node":{"id":"44902524-ad39-56a4-bd58-e625fe852841","excerpt":"AWSのTracingサービスのX-Rayを使って、LambdaのService MapやTraceを取得しつつ、DatadogのAPMに連携していきます。 Table of Contents AWS X-Ray とは何ですか。 X-Rayを使う for Lambda…","fields":{"slug":"2020/1/20/x-ray-datadog"},"frontmatter":{"id":null,"title":"AWS X-RayでLambdaのトレースをしつつ、Datadog APMに連携する","slug":"2020/1/20/x-ray-datadog","date":"2020-01-20T14:08:11.212Z","headerImage":"https://i.imgur.com/WbF4DOc.png","tags":["AWS","Lambda","X-Ray","Datadog","APM"]}}}]}},"pageContext":{"id":"44902524-ad39-56a4-bd58-e625fe852841","index":45,"repHtml":"<p>AWSのTracingサービスのX-Rayを使って、LambdaのService MapやTraceを取得しつつ、DatadogのAPMに連携していきます。</p>\n<h2 id=\"table-of-contents\" style=\"position:relative;\"><a href=\"#table-of-contents\" aria-label=\"table of contents permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Table of Contents</h2>\n<div class=\"toc\">\n<ul>\n<li>\n<p><a href=\"#aws-x-ray-%E3%81%A8%E3%81%AF%E4%BD%95%E3%81%A7%E3%81%99%E3%81%8B\">AWS X-Ray とは何ですか。</a></p>\n</li>\n<li>\n<p><a href=\"#x-ray%E3%82%92%E4%BD%BF%E3%81%86-for-lambda-python\">X-Rayを使う for Lambda (Python)</a></p>\n<ul>\n<li><a href=\"#lambda-layer%E3%82%92%E4%BD%9C%E3%81%A3%E3%81%A6%E5%88%A9%E7%94%A8%E3%81%A7%E3%81%8D%E3%82%8B%E3%82%88%E3%81%86%E3%81%AB%E3%81%99%E3%82%8B\">Lambda Layerを作って利用できるようにする</a></li>\n<li><a href=\"#python%E3%82%B3%E3%83%BC%E3%83%89%E5%AE%9F%E8%A3%85\">Pythonコード実装</a></li>\n</ul>\n</li>\n<li>\n<p><a href=\"#datadog-apm%E3%81%A8%E9%80%A3%E6%90%BA%E3%81%99%E3%82%8B\">Datadog APMと連携する</a></p>\n<ul>\n<li><a href=\"#datadog%E3%81%8C%E3%82%A2%E3%82%AF%E3%82%BB%E3%82%B9%E3%81%99%E3%82%8Brole%E3%81%AE%E3%83%9D%E3%83%AA%E3%82%B7%E3%83%BC%E8%A8%AD%E5%AE%9A\">DatadogがアクセスするRoleのポリシー設定</a></li>\n<li><a href=\"#datadog%E3%81%AEaws-integration%E3%82%92%E7%A2%BA%E8%AA%8D\">DatadogのAWS Integrationを確認</a></li>\n<li><a href=\"#apm%E3%81%8B%E3%82%89tracing%E6%83%85%E5%A0%B1%E3%82%92%E7%A2%BA%E8%AA%8D%E3%81%99%E3%82%8B\">APMからTracing情報を確認する</a></li>\n<li><a href=\"#monitor%E3%82%92%E8%A8%AD%E5%AE%9A%E3%81%99%E3%82%8B\">Monitorを設定する</a></li>\n</ul>\n</li>\n<li>\n<p><a href=\"#%E7%B5%90%E8%AB%96\">結論</a></p>\n</li>\n</ul>\n</div>\n<h2 id=\"aws-x-ray-とは何ですか\" style=\"position:relative;\"><a href=\"#aws-x-ray-%E3%81%A8%E3%81%AF%E4%BD%95%E3%81%A7%E3%81%99%E3%81%8B\" aria-label=\"aws x ray とは何ですか permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>AWS X-Ray とは何ですか。</h2>\n<p><a href=\"https://docs.aws.amazon.com/ja_jp/xray/latest/devguide/aws-xray.html\" target=\"_blank\" rel=\"noopener noreferrer\">公式サイト</a>によると、</p>\n<blockquote>\n<p>AWS X-Ray はアプリケーションが処理するリクエストに関するデータを収集するサービスです。</p>\n<p>データを表示、フィルタリング、洞察を取得して問題の識別や最適化の機会を識別するために使用するツールを提供します。</p>\n<p>アプリケーションに対するトレース対象のリクエストの場合、リクエストとレスポンスに関する情報だけではなく、アプリケーションがダウンストリーム AWS リソース、マイクロサービス、データベース、および HTTP ウェブ API に対して行う呼び出しの詳細な情報も表示できます。</p>\n<p><site><a href=\"https://docs.aws.amazon.com/ja_jp/xray/latest/devguide/aws-xray.html\" target=\"_blank\" rel=\"noopener noreferrer\">公式Doc AWS X-Ray とは何ですか。</a></site></p>\n</blockquote>\n<p>とのことです。</p>\n<p>難しいですね・・。もう少し簡単に言ってみると、</p>\n<p><strong>アプリケーション</strong>が<strong>AWSのサービス(DynamoDBとかS3とか)と通信したり</strong>、<strong>外部サービスのAPIをコールしたり</strong>するリクエストとレスポンスを<strong>収集</strong>し、<strong>記録</strong>し、良き感じに<strong>可視化</strong>してくれるサービスです。</p>\n<p>このようなサービスのことを<strong>Tracing</strong>とか言ったりします。</p>\n<p>実は、X-Rayをお勉強する前に、この手のサービス(Tracing)の基本を押さえる必要があると思い、お正月に<a href=\"https://blog.tubone-project24.xyz/2019/1/3/go-jaeger\" target=\"_blank\" rel=\"noopener noreferrer\">GoのEchoでJaegerを使ってボトルネックを調査する\n</a>という記事を書いてました。</p>\n<p>X-Rayからは若干離れますが、<a href=\"https://opentracing.io/\" target=\"_blank\" rel=\"noopener noreferrer\">OpenTracing</a>な情報を知りたいほうは上記も読んでみてくださいませ。</p>\n<p>さて、話をX-Rayに戻すと、X-Rayを使うと<strong>Tracing</strong>と、</p>\n<p><img class=\"lozad\" src=\"data:image/gif;base64,R0lGODlhAQABAGAAACH5BAEKAP8ALAAAAAABAAEAAAgEAP8FBAA7\" data-src=\"https://i.imgur.com/CSr8mCd.png\" alt=\"img\"></p>\n<p><strong>Service Map</strong>を作ることができます。</p>\n<p><img class=\"lozad\" src=\"data:image/gif;base64,R0lGODlhAQABAGAAACH5BAEKAP8ALAAAAAABAAEAAAgEAP8FBAA7\" data-src=\"https://i.imgur.com/Fs498Yd.png\" alt=\"img\"></p>\n<p>今回はService Mapで監視するような多段でマイクロサービスなアーキテクチャの監視はしませんが、さっそく、X-RayでLambdaのリクエストをTracingしていきましょう！</p>\n<h2 id=\"x-rayを使う-for-lambda-python\" style=\"position:relative;\"><a href=\"#x-ray%E3%82%92%E4%BD%BF%E3%81%86-for-lambda-python\" aria-label=\"x rayを使う for lambda python permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>X-Rayを使う for Lambda (Python)</h2>\n<p>Lambdaは<strong>Python</strong>で作っていくことにします。</p>\n<h3 id=\"lambda-layerを作って利用できるようにする\" style=\"position:relative;\"><a href=\"#lambda-layer%E3%82%92%E4%BD%9C%E3%81%A3%E3%81%A6%E5%88%A9%E7%94%A8%E3%81%A7%E3%81%8D%E3%82%8B%E3%82%88%E3%81%86%E3%81%AB%E3%81%99%E3%82%8B\" aria-label=\"lambda layerを作って利用できるようにする permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Lambda Layerを作って利用できるようにする</h3>\n<p>X-Rayを使うには、X-Rayクライアント(<a href=\"https://github.com/aws/aws-xray-sdk-python\" target=\"_blank\" rel=\"noopener noreferrer\">https://github.com/aws/aws-xray-sdk-python</a>)をソースコード上で使えるようにするため、X-Rayを入れた<strong>Lambda Layer</strong>を作っていきます。</p>\n<p>ローカル上で、</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token function\">mkdir</span> python\n\npip <span class=\"token function\">install</span> aws-xray-sdk -t python/\n\n<span class=\"token function\">zip</span> -r python.zip python/</code></pre></div>\n<p>としてX-Ray Client入りの<strong>python.zip</strong>を作ります。</p>\n<p>そして、AWSコンソールのLambda Layersからアップロードします。</p>\n<p><img class=\"lozad\" src=\"data:image/gif;base64,R0lGODlhAQABAGAAACH5BAEKAP8ALAAAAAABAAEAAAgEAP8FBAA7\" data-src=\"https://i.imgur.com/iyjRI2u.png\" alt=\"img\"></p>\n<p>作ったLambda LayerはLambda関数にアタッチ(マージ)することで利用できるようになります。</p>\n<p>Lambdaで外部APIをたたくため、<a href=\"https://requests-docs-ja.readthedocs.io/en/latest/\" target=\"_blank\" rel=\"noopener noreferrer\">Requests</a>のLambda Layerも作ってアタッチしてます。</p>\n<p><img class=\"lozad\" src=\"data:image/gif;base64,R0lGODlhAQABAGAAACH5BAEKAP8ALAAAAAABAAEAAAgEAP8FBAA7\" data-src=\"https://i.imgur.com/ho3V22u.png\" alt=\"img\"></p>\n<h3 id=\"pythonコード実装\" style=\"position:relative;\"><a href=\"#python%E3%82%B3%E3%83%BC%E3%83%89%E5%AE%9F%E8%A3%85\" aria-label=\"pythonコード実装 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Pythonコード実装</h3>\n<p>PythonでX-RayのTracingを使うには大きく2種類の方法があります。</p>\n<ul>\n<li>xray_recorder</li>\n<li>patch</li>\n</ul>\n<p>xray_recorderはPython関数に<strong>デコレータ</strong>として設定することで、関数のIn/Outをキャプチャできます。</p>\n<p>patchは<strong>Requests</strong>や<strong>Boto3</strong>などいくつかライブラリをPatchして、リクエストをTracingします。\n今回はめんどくさいのでpatch対応しているライブラリに全部Patchする<strong>patch_all</strong>を使います。</p>\n<div class=\"gatsby-highlight\" data-language=\"python\"><pre class=\"language-python\"><code class=\"language-python\"><span class=\"token keyword\">from</span> aws_xray_sdk<span class=\"token punctuation\">.</span>core <span class=\"token keyword\">import</span> xray_recorder <span class=\"token comment\"># デコレータをつけた関数をキャプチャ</span>\n<span class=\"token keyword\">from</span> aws_xray_sdk<span class=\"token punctuation\">.</span>core <span class=\"token keyword\">import</span> patch_all <span class=\"token comment\"># boto3やrequestsにX-Rayパッチを適用し、監視する</span>\n\npatch_all<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token comment\"># X-Rayパッチ</span>\n\n<span class=\"token decorator annotation punctuation\">@xray_recorder<span class=\"token punctuation\">.</span>capture</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"hoge_function\"</span><span class=\"token punctuation\">)</span> <span class=\"token comment\"># 関数キャプチャ</span>\n<span class=\"token keyword\">def</span> <span class=\"token function\">hoge_function</span><span class=\"token punctuation\">(</span>hogeeee<span class=\"token punctuation\">,</span> hogeeee<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n    hogehoge_logic<span class=\"token punctuation\">(</span>hogeeee<span class=\"token punctuation\">)</span></code></pre></div>\n<p>さぁ、Lambdaのコードを無事に書き終えたらLambdaをデプロイして終わりです。</p>\n<p>今回は手でLambdaを作りましたので、特にCIな話題はないです。すみません。</p>\n<p>最後に、<strong>LambdaのコンソールからX-Rayを有効化することを忘れずに</strong></p>\n<p><img class=\"lozad\" src=\"data:image/gif;base64,R0lGODlhAQABAGAAACH5BAEKAP8ALAAAAAABAAEAAAgEAP8FBAA7\" data-src=\"https://i.imgur.com/5MzpyAw.png\" alt=\"img\"></p>\n<p>これで無事にX-Rayが利用できるようになりました。</p>\n<p>Lambdaが動くことでTracingされます。</p>\n<p><img class=\"lozad\" src=\"data:image/gif;base64,R0lGODlhAQABAGAAACH5BAEKAP8ALAAAAAABAAEAAAgEAP8FBAA7\" data-src=\"https://i.imgur.com/cpAdeXe.png\" alt=\"img\"></p>\n<p>Lambda単体なのでService Mapもショボいですができてます。</p>\n<p><img class=\"lozad\" src=\"data:image/gif;base64,R0lGODlhAQABAGAAACH5BAEKAP8ALAAAAAABAAEAAAgEAP8FBAA7\" data-src=\"https://i.imgur.com/Y3aQ44O.png\" alt=\"img\"></p>\n<h2 id=\"datadog-apmと連携する\" style=\"position:relative;\"><a href=\"#datadog-apm%E3%81%A8%E9%80%A3%E6%90%BA%E3%81%99%E3%82%8B\" aria-label=\"datadog apmと連携する permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Datadog APMと連携する</h2>\n<p>X-Rayは<strong>Datadogにも連携可能</strong>です。</p>\n<p>早速Datadogに連携していきましょう。</p>\n<h3 id=\"datadogがアクセスするroleのポリシー設定\" style=\"position:relative;\"><a href=\"#datadog%E3%81%8C%E3%82%A2%E3%82%AF%E3%82%BB%E3%82%B9%E3%81%99%E3%82%8Brole%E3%81%AE%E3%83%9D%E3%83%AA%E3%82%B7%E3%83%BC%E8%A8%AD%E5%AE%9A\" aria-label=\"datadogがアクセスするroleのポリシー設定 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>DatadogがアクセスするRoleのポリシー設定</h3>\n<p>DatadogがあなたのアカウントにIntegrationするRoleに<strong>X-Rayの読み取り権限</strong>を追加します。</p>\n<p>追加するポリシーは以下です。</p>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\"><span class=\"token punctuation\">{</span>\n    <span class=\"token string-property property\">\"Version\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"2012-10-17\"</span><span class=\"token punctuation\">,</span>\n    <span class=\"token string-property property\">\"Statement\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span>\n        <span class=\"token punctuation\">{</span>\n            <span class=\"token string-property property\">\"Sid\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"XRay\"</span><span class=\"token punctuation\">,</span>\n            <span class=\"token string-property property\">\"Effect\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"Allow\"</span><span class=\"token punctuation\">,</span>\n            <span class=\"token string-property property\">\"Action\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span>\n                <span class=\"token string\">\"xray:GetSamplingTargets\"</span><span class=\"token punctuation\">,</span>\n                <span class=\"token string\">\"xray:GetGroup\"</span><span class=\"token punctuation\">,</span>\n                <span class=\"token string\">\"xray:GetTraceGraph\"</span><span class=\"token punctuation\">,</span>\n                <span class=\"token string\">\"xray:GetServiceGraph\"</span><span class=\"token punctuation\">,</span>\n                <span class=\"token string\">\"xray:GetTimeSeriesServiceStatistics\"</span><span class=\"token punctuation\">,</span>\n                <span class=\"token string\">\"xray:GetEncryptionConfig\"</span><span class=\"token punctuation\">,</span>\n                <span class=\"token string\">\"xray:GetSamplingRules\"</span><span class=\"token punctuation\">,</span>\n                <span class=\"token string\">\"xray:GetGroups\"</span><span class=\"token punctuation\">,</span>\n                <span class=\"token string\">\"xray:GetTraceSummaries\"</span><span class=\"token punctuation\">,</span>\n                <span class=\"token string\">\"xray:GetSamplingStatisticSummaries\"</span><span class=\"token punctuation\">,</span>\n                <span class=\"token string\">\"xray:BatchGetTraces\"</span><span class=\"token punctuation\">,</span>\n                <span class=\"token string\">\"xray:PutEncryptionConfig\"</span>\n            <span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>\n            <span class=\"token string-property property\">\"Resource\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"*\"</span>\n        <span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">]</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<h3 id=\"datadogのaws-integrationを確認\" style=\"position:relative;\"><a href=\"#datadog%E3%81%AEaws-integration%E3%82%92%E7%A2%BA%E8%AA%8D\" aria-label=\"datadogのaws integrationを確認 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>DatadogのAWS Integrationを確認</h3>\n<p>DatadogのWebコンソールから、X-Rayを取得する設定が入っているか確認します。入っていなければチェックしてください。</p>\n<p><img class=\"lozad\" src=\"data:image/gif;base64,R0lGODlhAQABAGAAACH5BAEKAP8ALAAAAAABAAEAAAgEAP8FBAA7\" data-src=\"https://i.imgur.com/XWhfj7x.png\" alt=\"img\"></p>\n<p>これでAPMからX-Rayが使えるようになります。次のメトリック取得でAPMにTracing関連が追加されているはず。</p>\n<p><img class=\"lozad\" src=\"data:image/gif;base64,R0lGODlhAQABAGAAACH5BAEKAP8ALAAAAAABAAEAAAgEAP8FBAA7\" data-src=\"https://i.imgur.com/YxAhK5X.png\" alt=\"img\"></p>\n<h3 id=\"apmからtracing情報を確認する\" style=\"position:relative;\"><a href=\"#apm%E3%81%8B%E3%82%89tracing%E6%83%85%E5%A0%B1%E3%82%92%E7%A2%BA%E8%AA%8D%E3%81%99%E3%82%8B\" aria-label=\"apmからtracing情報を確認する permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>APMからTracing情報を確認する</h3>\n<p>Serviceからダッシュボードの形で、APMに送られてくるTracingをパパっと見ることができます。</p>\n<p><img class=\"lozad\" src=\"data:image/gif;base64,R0lGODlhAQABAGAAACH5BAEKAP8ALAAAAAABAAEAAAgEAP8FBAA7\" data-src=\"https://i.imgur.com/uRkRqqP.png\" alt=\"img\"></p>\n<p>細かくみると、こんな感じでAPMからRequestの内訳やレイテンシーが確認できるようになっているはずです。</p>\n<p><img class=\"lozad\" src=\"data:image/gif;base64,R0lGODlhAQABAGAAACH5BAEKAP8ALAAAAAABAAEAAAgEAP8FBAA7\" data-src=\"https://i.imgur.com/WbF4DOc.png\" alt=\"img\"></p>\n<p>Service MapもDatadogから確認できますが、こちらはAWSのコンソールのほうが見やすいですね。</p>\n<p><img class=\"lozad\" src=\"data:image/gif;base64,R0lGODlhAQABAGAAACH5BAEKAP8ALAAAAAABAAEAAAgEAP8FBAA7\" data-src=\"https://i.imgur.com/cecuvOW.png\" alt=\"img\"></p>\n<h3 id=\"monitorを設定する\" style=\"position:relative;\"><a href=\"#monitor%E3%82%92%E8%A8%AD%E5%AE%9A%E3%81%99%E3%82%8B\" aria-label=\"monitorを設定する permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Monitorを設定する</h3>\n<p>APMのメトリックを使って、Monitorを作ることもできます。</p>\n<p>例えば、P99のレイテンシーがxx秒を超えてきたらWarningなどにしておくと安心感あるかもですね。</p>\n<p><img class=\"lozad\" src=\"data:image/gif;base64,R0lGODlhAQABAGAAACH5BAEKAP8ALAAAAAABAAEAAAgEAP8FBAA7\" data-src=\"https://i.imgur.com/2FB3QjB.png\" alt=\"img\"></p>\n<h2 id=\"結論\" style=\"position:relative;\"><a href=\"#%E7%B5%90%E8%AB%96\" aria-label=\"結論 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>結論</h2>\n<p>DatadogのAPMはLambda + X-Rayでも問題なく利用できる機能とわかりました。</p>\n<p>もう少しX-Rayを使いこなせるように頑張りますね。</p>","words":2451,"minutes":7}},"staticQueryHashes":["1319877725","2959249232"]}