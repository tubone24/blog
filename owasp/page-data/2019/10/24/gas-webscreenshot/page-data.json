{"componentChunkName":"component---src-templates-blog-post-tsx","path":"/2019/10/24/gas-webscreenshot","result":{"data":{"content":{"edges":[{"node":{"id":"77f84cb6-5b84-50fb-acdc-d4d28fcb7215","excerpt":"タイトル長い くっそ長いタイトルで恐縮ですが、Google Apps Script(GAS)とAPI FLASHとSlackAPIをClaspとJestとGitHub Actionで調理して定期的にWeb…","fields":{"slug":"2019/10/24/gas-webscreenshot"},"frontmatter":{"id":null,"title":"Google Apps Script(GAS)とAPI FLASHとSlackAPIをClaspとJestとGitHub Actionで調理して定期的にWebページのスクリーンショットを撮る","slug":"2019/10/24/gas-webscreenshot","date":"2019-10-23T22:22:00.000Z","headerImage":"https://i.imgur.com/QCjxEBN.png","tags":["JavaScript","TypeScript","Google Apps Script","API FLASH","SlackAPI","Clasp","GitHub Action","Jest","自動テスト","Unit Test"]}}}]}},"pageContext":{"id":"77f84cb6-5b84-50fb-acdc-d4d28fcb7215","index":69,"repHtml":"<p>タイトル長い</p>\n<p>くっそ長いタイトルで恐縮ですが、Google Apps Script(GAS)とAPI FLASHとSlackAPIをClaspとJestとGitHub Actionで調理して定期的にWebページのスクリーンショットを撮っていきたいと思います。</p>\n<p>作成したコード <a href=\"https://github.com/tubone24/web-screenshot-to-slack-gas\" target=\"_blank\" rel=\"noopener noreferrer\">GitHub</a>はこちらとなります。</p>\n<p>GASへの詳しい設定方法は拙作コードの<a href=\"https://github.com/tubone24/web-screenshot-to-slack-gas/blob/master/README.md\" target=\"_blank\" rel=\"noopener noreferrer\">Readme</a>をご参照いただければと思います。</p>\n<h2 id=\"table-of-contents\" style=\"position:relative;\"><a href=\"#table-of-contents\" aria-label=\"table of contents permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Table of Contents</h2>\n<div class=\"toc\">\n<ul>\n<li>\n<p><a href=\"#google-apps-scriptgas%E3%81%A8%E3%81%AF\">Google Apps Script(GAS)とは？</a></p>\n</li>\n<li>\n<p><a href=\"#javascript%E3%81%AFjavascript%E3%81%AA%E3%82%93%E3%81%A0%E3%81%91%E3%81%A9%E3%81%95\">JavaScriptはJavaScriptなんだけどさ</a></p>\n</li>\n<li>\n<p><a href=\"#%E6%82%B2%E3%81%97%E3%81%84%E4%B8%96%E7%95%8C%E3%81%AB%E3%81%AF%E7%BE%8E%E3%81%97%E3%81%84%E8%8A%B1%E3%81%8C%E5%92%B2%E3%81%8F\">悲しい世界には美しい花が咲く</a></p>\n</li>\n<li>\n<p><a href=\"#api-flash-%E3%81%AE%E3%82%B5%E3%83%BC%E3%83%93%E3%82%B9%E5%B1%A4%E4%BD%9C%E6%88%90\">API FLASH のサービス層作成</a></p>\n<ul>\n<li><a href=\"#api-flash%E3%81%A8%E3%81%AF\">API FLASHとは</a></li>\n<li><a href=\"#%E5%AE%9F%E9%9A%9B%E3%81%A7%E3%81%8D%E3%81%82%E3%81%8C%E3%81%A3%E3%81%9F%E3%82%B3%E3%83%BC%E3%83%89\">実際できあがったコード</a></li>\n</ul>\n</li>\n<li>\n<p><a href=\"#slack%E3%81%AE%E3%82%B5%E3%83%BC%E3%83%93%E3%82%B9%E5%B1%A4\">Slackのサービス層</a></p>\n</li>\n<li>\n<p><a href=\"#%E3%83%86%E3%82%B9%E3%83%88\">テスト</a></p>\n</li>\n<li>\n<p><a href=\"#build%E3%81%A8deploy\">Buildとdeploy</a></p>\n</li>\n<li>\n<p><a href=\"#github-action%E3%81%A7%E8%87%AA%E5%8B%95%E3%83%87%E3%83%97%E3%83%AD%E3%82%A4%E3%81%95%E3%81%9B%E3%82%8B\">GitHub Actionで自動デプロイさせる</a></p>\n</li>\n<li>\n<p><a href=\"#%E5%AE%8C%E6%88%90\">完成！</a></p>\n</li>\n</ul>\n</div>\n<h2 id=\"google-apps-scriptgasとは\" style=\"position:relative;\"><a href=\"#google-apps-scriptgas%E3%81%A8%E3%81%AF\" aria-label=\"google apps scriptgasとは permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Google Apps Script(GAS)とは？</h2>\n<p>Google Driveをご存じでしょうか？</p>\n<p>スプレッドシートやらプレゼンテーションと呼ばれる某ExcelやPowerPointの基本機能がWeb画面で扱えるアレです。</p>\n<p>Google Apps Scriptはそれのマクロだと思っていただけるとイメージがつきやすいかと思います。</p>\n<p>ExcelやPowerPointだとVBAがマクロ言語ですが、Google Apps ScriptはJavaScriptが言語です。</p>\n<p>さすがGoogle公式言語。</p>\n<p>またGoogle Apps Scriptのことを省略してGASとか言ったりするそうです。</p>\n<p>ｶﾞｽｶﾞｽ</p>\n<p>GAS専用のマクロ用関数がある程度用意されてるのでマクロを組むのも簡単ですし、時間で関数をキックするトリガー機能もあるので、簡単なFaaS（Function as a Service）として\n利用することもできます。</p>\n<p>今回は後者の使い方が中心となります。</p>\n<h2 id=\"javascriptはjavascriptなんだけどさ\" style=\"position:relative;\"><a href=\"#javascript%E3%81%AFjavascript%E3%81%AA%E3%82%93%E3%81%A0%E3%81%91%E3%81%A9%E3%81%95\" aria-label=\"javascriptはjavascriptなんだけどさ permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>JavaScriptはJavaScriptなんだけどさ</h2>\n<p>さきほど書いたとおり、ほとんどGASはJavaScriptなのですが、ES6な記法ではないので、JavaScriptとは恐れ多くても言えないというのが実状です。</p>\n<p>なので上記と合わせ素のGASを使うと下記のような悲しいことがおきます。</p>\n<ul>\n<li>古くさいJavaScriptを書く</li>\n<li>テストできない</li>\n<li>CIに乗っけられない（手デプロイ）</li>\n</ul>\n<p>これは悲しいですね。</p>\n<h2 id=\"悲しい世界には美しい花が咲く\" style=\"position:relative;\"><a href=\"#%E6%82%B2%E3%81%97%E3%81%84%E4%B8%96%E7%95%8C%E3%81%AB%E3%81%AF%E7%BE%8E%E3%81%97%E3%81%84%E8%8A%B1%E3%81%8C%E5%92%B2%E3%81%8F\" aria-label=\"悲しい世界には美しい花が咲く permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>悲しい世界には美しい花が咲く</h2>\n<p>と悲しい気持ちになってるところで見つけたのがclaspです。</p>\n<p>claspはGoogle謹製のGASデプロイツールなのですが、勇者が\n<a href=\"https://github.com/howdy39/gas-clasp-starter\" target=\"_blank\" rel=\"noopener noreferrer\">Claspを使ったTypeSciptテンプレートを作ってました。</a>天才かよ。</p>\n<p>今回はこちらのテンプレートを借りて開発を進めたいとおもいます。</p>\n<h2 id=\"api-flash-のサービス層作成\" style=\"position:relative;\"><a href=\"#api-flash-%E3%81%AE%E3%82%B5%E3%83%BC%E3%83%93%E3%82%B9%E5%B1%A4%E4%BD%9C%E6%88%90\" aria-label=\"api flash のサービス層作成 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>API FLASH のサービス層作成</h2>\n<p>今回のGASの目的は、<strong>WEBページのスクリーンショットを撮る</strong>ということですので、スクリーンショットを簡単に取得する方法としてAPI FLASHを使います、</p>\n<h3 id=\"api-flashとは\" style=\"position:relative;\"><a href=\"#api-flash%E3%81%A8%E3%81%AF\" aria-label=\"api flashとは permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>API FLASHとは</h3>\n<p><a href=\"https://apiflash.com/\" target=\"_blank\" rel=\"noopener noreferrer\">API FLASH</a>とは、<strong>Chrome</strong>ベースのWebscreenshotAPI提供サービスです。</p>\n<p>API FLASH自体はAWS Lambdaを使ってるらしく、スケーラビリティが高いと主張してます。</p>\n<p>おそらく、<a href=\"https://github.com/adieuadieu/serverless-chrome\" target=\"_blank\" rel=\"noopener noreferrer\">Serverless-chrome</a>をLambdaで実行しているものと思われます。</p>\n<p>Chromeベースのキャプチャリングなので、レンダリングも正確で非対応ページがすくないのもうれしいところです。</p>\n<p>さらに、うれしい機能として遅延キャプチャリング機能があり、ページのレンダリングを待ってからキャプチャを撮ることも可能です。</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">https://api.apiflash.com/v1/urltoimage?access_key=hoge&amp;url=hoge&amp;delay=10</code></pre></div>\n<p>のようなURLでHttp Getをするだけでキャプチャが撮れるんです、すごいですね。</p>\n<p>ちなみに、無料版には1ヶ月あたりの利用制限がありますのでご注意を。</p>\n<h3 id=\"実際できあがったコード\" style=\"position:relative;\"><a href=\"#%E5%AE%9F%E9%9A%9B%E3%81%A7%E3%81%8D%E3%81%82%E3%81%8C%E3%81%A3%E3%81%9F%E3%82%B3%E3%83%BC%E3%83%89\" aria-label=\"実際できあがったコード permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>実際できあがったコード</h3>\n<p>TypeSciptでこんな感じのサービス層を作りました。</p>\n<div class=\"gatsby-highlight\" data-language=\"typescript\"><pre class=\"language-typescript\"><code class=\"language-typescript\"><span class=\"token keyword\">export</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">ApiFlashService</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">static</span> captureWebPage <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span>\n    url<span class=\"token operator\">:</span> <span class=\"token builtin\">string</span><span class=\"token punctuation\">,</span>\n    accessKey<span class=\"token operator\">:</span> <span class=\"token builtin\">string</span><span class=\"token punctuation\">,</span>\n    width<span class=\"token operator\">:</span> <span class=\"token builtin\">string</span><span class=\"token punctuation\">,</span>\n    height<span class=\"token operator\">:</span> <span class=\"token builtin\">string</span><span class=\"token punctuation\">,</span>\n    delay<span class=\"token operator\">:</span> <span class=\"token builtin\">string</span>\n  <span class=\"token punctuation\">)</span><span class=\"token operator\">:</span> GoogleAppsScript<span class=\"token punctuation\">.</span>Base<span class=\"token punctuation\">.</span>Blob <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">const</span> captureUrl <span class=\"token operator\">=</span> ApiFlashService<span class=\"token punctuation\">.</span><span class=\"token function\">createChaptureUrl</span><span class=\"token punctuation\">(</span>url<span class=\"token punctuation\">,</span> accessKey<span class=\"token punctuation\">,</span> width<span class=\"token punctuation\">,</span> height<span class=\"token punctuation\">,</span> delay<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">const</span> responseData <span class=\"token operator\">=</span> UrlFetchApp<span class=\"token punctuation\">.</span><span class=\"token function\">fetch</span><span class=\"token punctuation\">(</span>captureUrl<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">return</span> responseData<span class=\"token punctuation\">.</span><span class=\"token function\">getBlob</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">private</span> <span class=\"token keyword\">static</span> createChaptureUrl <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span>\n    url<span class=\"token operator\">:</span> <span class=\"token builtin\">string</span><span class=\"token punctuation\">,</span>\n    accessKey<span class=\"token operator\">:</span> <span class=\"token builtin\">string</span><span class=\"token punctuation\">,</span>\n    width<span class=\"token operator\">:</span> <span class=\"token builtin\">string</span><span class=\"token punctuation\">,</span>\n    height<span class=\"token operator\">:</span> <span class=\"token builtin\">string</span><span class=\"token punctuation\">,</span>\n    delay<span class=\"token operator\">:</span> <span class=\"token builtin\">string</span>\n  <span class=\"token punctuation\">)</span><span class=\"token operator\">:</span> <span class=\"token builtin\">string</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">return</span> <span class=\"token template-string\"><span class=\"token template-punctuation string\">`</span><span class=\"token string\">https://api.apiflash.com/v1/urltoimage?access_key=</span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">${</span>accessKey<span class=\"token interpolation-punctuation punctuation\">}</span></span><span class=\"token string\">&amp;url=</span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">${</span>url<span class=\"token interpolation-punctuation punctuation\">}</span></span><span class=\"token string\">&amp;width=</span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">${</span>width<span class=\"token interpolation-punctuation punctuation\">}</span></span><span class=\"token string\">&amp;height=</span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">${</span>height<span class=\"token interpolation-punctuation punctuation\">}</span></span><span class=\"token string\">&amp;delay=</span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">${</span>delay<span class=\"token interpolation-punctuation punctuation\">}</span></span><span class=\"token string\">&amp;fresh=true</span><span class=\"token template-punctuation string\">`</span></span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>GASの場合APIのコールには<strong>URLFetchApp</strong>が利用できます。</p>\n<p><code class=\"language-text\">UrlFetchApp.fetch(url)</code> とするだけでAPIがコールできます。</p>\n<p>URLFetchAppはもちろんGAS専用のAPIですが、TypeSciptのLintがちゃんと利くのが何気にすごいと思いました。</p>\n<p><img class=\"lozad\" src=\"data:image/gif;base64,R0lGODlhAQABAGAAACH5BAEKAP8ALAAAAAABAAEAAAgEAP8FBAA7\" data-src=\"https://i.imgur.com/gul9s4W.png\" alt=\"img\"></p>\n<h2 id=\"slackのサービス層\" style=\"position:relative;\"><a href=\"#slack%E3%81%AE%E3%82%B5%E3%83%BC%E3%83%93%E3%82%B9%E5%B1%A4\" aria-label=\"slackのサービス層 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Slackのサービス層</h2>\n<p>コードは省略しますが上と同じ要領でURLFetchを使って、Slackコール部も作ります。</p>\n<h2 id=\"テスト\" style=\"position:relative;\"><a href=\"#%E3%83%86%E3%82%B9%E3%83%88\" aria-label=\"テスト permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>テスト</h2>\n<p>テストはJestで作ります。</p>\n<p>ポイントは先ほどから利用しているURLFetchをMock化する必要があることです。</p>\n<p>Jestのグローバル変数定義であらかじめURLFetchを作り、JestのMock関数をテストケースごとにfetch関数と置き換えることで実現できます。</p>\n<p>package.jsonに</p>\n<div class=\"gatsby-highlight\" data-language=\"json\"><pre class=\"language-json\"><code class=\"language-json\">  <span class=\"token property\">\"jest\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token property\">\"verbose\"</span><span class=\"token operator\">:</span> <span class=\"token boolean\">true</span><span class=\"token punctuation\">,</span>\n    <span class=\"token property\">\"globals\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token property\">\"UrlFetchApp\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span><span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span></code></pre></div>\n<p>とすることでグローバルにUrlFetchAppができますので、テストコードで</p>\n<div class=\"gatsby-highlight\" data-language=\"typescript\"><pre class=\"language-typescript\"><code class=\"language-typescript\"><span class=\"token keyword\">const</span> mockFetch <span class=\"token operator\">=</span> jest<span class=\"token punctuation\">.</span><span class=\"token function\">fn</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\nUrlFetchApp<span class=\"token punctuation\">.</span>fetch <span class=\"token operator\">=</span> mockFetch<span class=\"token punctuation\">;</span>\n\n<span class=\"token function\">describe</span><span class=\"token punctuation\">(</span><span class=\"token string\">'sendSlackServiceOK'</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n  <span class=\"token function\">it</span><span class=\"token punctuation\">(</span><span class=\"token string\">'sendImage'</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">const</span> actual <span class=\"token operator\">=</span> SendSlackService<span class=\"token punctuation\">.</span><span class=\"token function\">sendImage</span><span class=\"token punctuation\">(</span><span class=\"token string\">'test-token'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'test-image'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'test-title'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'#test'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">const</span> expectedOption <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span>\n      method<span class=\"token operator\">:</span> <span class=\"token string\">'post'</span><span class=\"token punctuation\">,</span>\n      payload<span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span> token<span class=\"token operator\">:</span> <span class=\"token string\">'test-token'</span><span class=\"token punctuation\">,</span> file<span class=\"token operator\">:</span> <span class=\"token string\">'test-image'</span><span class=\"token punctuation\">,</span> channels<span class=\"token operator\">:</span> <span class=\"token string\">'#test'</span><span class=\"token punctuation\">,</span> title<span class=\"token operator\">:</span> <span class=\"token string\">'test-title'</span> <span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n    <span class=\"token function\">expect</span><span class=\"token punctuation\">(</span>mockFetch<span class=\"token punctuation\">.</span>mock<span class=\"token punctuation\">.</span>calls<span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">toBe</span><span class=\"token punctuation\">(</span><span class=\"token string\">'https://slack.com/api/files.upload'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token function\">expect</span><span class=\"token punctuation\">(</span>mockFetch<span class=\"token punctuation\">.</span>mock<span class=\"token punctuation\">.</span>calls<span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">[</span><span class=\"token number\">1</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">toEqual</span><span class=\"token punctuation\">(</span>expectedOption<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token function\">expect</span><span class=\"token punctuation\">(</span>actual<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">toBe</span><span class=\"token punctuation\">(</span><span class=\"token boolean\">true</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p>とすることでfetch関数がmockに置き換わり、テスト可能です。</p>\n<p>mock関数をあらかじめ作成しておくと、コールのassertも可能です。</p>\n<h2 id=\"buildとdeploy\" style=\"position:relative;\"><a href=\"#build%E3%81%A8deploy\" aria-label=\"buildとdeploy permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Buildとdeploy</h2>\n<p>StarterではWebpackを使ってTypeSciptのGAS化を実行しているようです。</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">npm run build</code></pre></div>\n<p>とすることで、dist配下にGASのコードが配置されました。</p>\n<p>デプロイは、claspを利用します。</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">clasp login\nclasp push</code></pre></div>\n<p>とするだけでデプロイできちゃいます。</p>\n<h2 id=\"github-actionで自動デプロイさせる\" style=\"position:relative;\"><a href=\"#github-action%E3%81%A7%E8%87%AA%E5%8B%95%E3%83%87%E3%83%97%E3%83%AD%E3%82%A4%E3%81%95%E3%81%9B%E3%82%8B\" aria-label=\"github actionで自動デプロイさせる permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>GitHub Actionで自動デプロイさせる</h2>\n<p>ここまできたらあとはCIに乗っけるだけです。</p>\n<p>clasp loginをローカル上で実施したときに取得できるトークンがclasprc.jsonに出力されているので、こちらをGitHub ActionのSecret機能で渡してあげます。</p>\n<p><img class=\"lozad\" src=\"data:image/gif;base64,R0lGODlhAQABAGAAACH5BAEKAP8ALAAAAAABAAEAAAgEAP8FBAA7\" data-src=\"https://i.imgur.com/ogQ4ILr.png\" alt=\"img\"></p>\n<p>あとは、testが通ったらclasp loginして、build, deployする定義をかけばよいです。</p>\n<p>GitHub ActionのSecretにはこのようにアクセスします。</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">echo \"${{ secrets.CLASPRC_JSON }}\" > ~/.clasprc.json</code></pre></div>\n<h2 id=\"完成\" style=\"position:relative;\"><a href=\"#%E5%AE%8C%E6%88%90\" aria-label=\"完成 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>完成！</h2>\n<p>GASにデプロイできたらcronでトリガーさせてあげれば定期的にキャプチャをとります。</p>\n<p>やったー!!</p>\n<p>無事にSlackへキャプチャが送られてきました！</p>\n<p><img class=\"lozad\" src=\"data:image/gif;base64,R0lGODlhAQABAGAAACH5BAEKAP8ALAAAAAABAAEAAAgEAP8FBAA7\" data-src=\"https://raw.githubusercontent.com/tubone24/web-screenshot-to-slack-gas/master/docs/images/slack-preview.png\" alt=\"Img\"></p>","words":2418,"minutes":7}},"staticQueryHashes":["1319877725","2959249232"]}