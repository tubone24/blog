{"componentChunkName":"component---src-templates-blog-post-tsx","path":"/2019/10/08/serverspec","result":{"data":{"content":{"edges":[{"node":{"id":"8a01d7d3-11e1-554f-b5f2-661535dc48df","excerpt":"Serverspecで構築した環境を確認したい!! 前回、Ansibleを使って、Macの環境を構築しました。一部べきとう性が保てない箇所があったりしたので、正しく設定値が入っているかServerspecを使ってMacの状態を確認していきます。 Table of Contents…","fields":{"slug":"2019/10/08/serverspec"},"frontmatter":{"id":null,"title":"Ansible + Serverspecを使ってMacの環境構築を自動でする (Serverspec編)","slug":"2019/10/08/serverspec","date":"2019-10-09T11:34:59.707Z","headerImage":"https://i.imgur.com/9iGRHft.png","tags":["Auto Provisioning","Ansible","Serverspec","Mac"]}}}]}},"pageContext":{"id":"8a01d7d3-11e1-554f-b5f2-661535dc48df","index":74,"repHtml":"<p>Serverspecで構築した環境を確認したい!!</p>\n<p>前回、Ansibleを使って、Macの環境を構築しました。一部べきとう性が保てない箇所があったりしたので、正しく設定値が入っているかServerspecを使ってMacの状態を確認していきます。</p>\n<h2 id=\"table-of-contents\" style=\"position:relative;\"><a href=\"#table-of-contents\" aria-label=\"table of contents permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Table of Contents</h2>\n<div class=\"toc\">\n<ul>\n<li>\n<p><a href=\"#serverspec%E3%81%A8%E3%81%AF\">Serverspecとは</a></p>\n</li>\n<li>\n<p><a href=\"#serverspec%E3%81%AE%E3%82%A4%E3%83%B3%E3%82%B9%E3%83%88%E3%83%BC%E3%83%AB\">Serverspecのインストール</a></p>\n</li>\n<li>\n<p><a href=\"#serverspec%E3%81%AE%E5%88%9D%E6%9C%9F%E5%8C%96\">Serverspecの初期化</a></p>\n</li>\n<li>\n<p><a href=\"#%E3%83%86%E3%82%B9%E3%83%88%E3%83%98%E3%83%AB%E3%83%91%E3%83%BC%E3%81%AE%E4%BD%9C%E6%88%90\">テストヘルパーの作成</a></p>\n</li>\n<li>\n<p><a href=\"#spec%E3%83%95%E3%82%A1%E3%82%A4%E3%83%AB%E3%83%86%E3%82%B9%E3%83%88%E3%82%B3%E3%83%BC%E3%83%89%E3%81%AE%E4%BD%9C%E6%88%90\">Specファイル（テストコード）の作成</a></p>\n<ul>\n<li><a href=\"#%E3%82%A2%E3%83%97%E3%83%AA%E3%81%8C%E3%82%A4%E3%83%B3%E3%82%B9%E3%83%88%E3%83%BC%E3%83%AB%E3%81%95%E3%82%8C%E3%81%A6%E3%81%84%E3%82%8B%E3%81%8B%E3%81%AE%E7%A2%BA%E8%AA%8D\">アプリがインストールされているかの確認</a></li>\n<li><a href=\"#%E3%82%B3%E3%83%9E%E3%83%B3%E3%83%89%E3%81%AE%E7%B5%90%E6%9E%9C%E3%82%92%E7%A2%BA%E8%AA%8D%E3%81%99%E3%82%8B\">コマンドの結果を確認する</a></li>\n<li><a href=\"#%E3%83%95%E3%82%A1%E3%82%A4%E3%83%AB%E3%81%AB%E6%96%87%E5%AD%97%E5%88%97%E3%81%8C%E5%90%AB%E3%81%BE%E3%82%8C%E3%81%A6%E3%81%84%E3%82%8B%E3%81%8B\">ファイルに文字列が含まれているか？</a></li>\n</ul>\n</li>\n<li>\n<p><a href=\"#makefile%E3%81%A7%E4%B8%80%E7%99%BA%E5%AE%9F%E8%A1%8C\">Makefileで一発実行</a></p>\n</li>\n<li>\n<p><a href=\"#%E7%B5%90%E8%AB%96\">結論</a></p>\n</li>\n</ul>\n</div>\n<h2 id=\"serverspecとは\" style=\"position:relative;\"><a href=\"#serverspec%E3%81%A8%E3%81%AF\" aria-label=\"serverspecとは permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Serverspecとは</h2>\n<p><img class=\"lozad\" src=\"data:image/gif;base64,R0lGODlhAQABAGAAACH5BAEKAP8ALAAAAAABAAEAAAgEAP8FBAA7\" data-src=\"https://i.imgur.com/E3tw8J2.png\" alt=\"Img\"></p>\n<p>Serverspecとはサーバーの自動テストツールです。</p>\n<p>せっかくAnsibleとかで自動でたくさんのサーバーをプロビジョニングしたのに、確認はテスト項目書片手に目で見て確認…みたいな頭の悪いことをしないために作られたツールです。</p>\n<p>RubyのRSpecベースでできているツールなのでRubyでテストを書いたことある人なら取っつきやすいのも特徴です。</p>\n<h2 id=\"serverspecのインストール\" style=\"position:relative;\"><a href=\"#serverspec%E3%81%AE%E3%82%A4%E3%83%B3%E3%82%B9%E3%83%88%E3%83%BC%E3%83%AB\" aria-label=\"serverspecのインストール permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Serverspecのインストール</h2>\n<p>まずServerspecを入れるディレクトリにServerspecをインストールします。</p>\n<p>あらかじめRubyが動く環境を作ったうえでbundle installしていきます。</p>\n<p>まずbundleのベースファイルを作っていきます。</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\">bundle init</code></pre></div>\n<p>次に、GemfileにserverspecとRakeを指定しておきます。</p>\n<div class=\"gatsby-highlight\" data-language=\"ruby\"><pre class=\"language-ruby\"><code class=\"language-ruby\"><span class=\"token comment\"># frozen_string_literal: true</span>\n\nsource <span class=\"token string-literal\"><span class=\"token string\">\"https://rubygems.org\"</span></span>\n\ngit_source<span class=\"token punctuation\">(</span><span class=\"token symbol\">:github</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span><span class=\"token operator\">|</span>repo_name<span class=\"token operator\">|</span> <span class=\"token string-literal\"><span class=\"token string\">\"https://github.com/</span><span class=\"token interpolation\"><span class=\"token delimiter punctuation\">#{</span><span class=\"token content\">repo_name</span><span class=\"token delimiter punctuation\">}</span></span><span class=\"token string\">\"</span></span> <span class=\"token punctuation\">}</span>\n\n<span class=\"token comment\"># gem \"rails\"</span>\ngem <span class=\"token string-literal\"><span class=\"token string\">\"serverspec\"</span></span>\ngem <span class=\"token string-literal\"><span class=\"token string\">\"rake\"</span></span></code></pre></div>\n<p>そうしたら、bundle installしていきます。</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\">bundle <span class=\"token function\">install</span> --path<span class=\"token operator\">=</span>vendor/bundle</code></pre></div>\n<h2 id=\"serverspecの初期化\" style=\"position:relative;\"><a href=\"#serverspec%E3%81%AE%E5%88%9D%E6%9C%9F%E5%8C%96\" aria-label=\"serverspecの初期化 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Serverspecの初期化</h2>\n<p>ServerspecがインストールできたらServerspecの初期化をしていきます。</p>\n<p>bundleで、</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\">bundle <span class=\"token builtin class-name\">exec</span> serverspec-init</code></pre></div>\n<p>と実行すると、</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\">Select OS type:\n \n  <span class=\"token number\">1</span><span class=\"token punctuation\">)</span> UN*X\n  <span class=\"token number\">2</span><span class=\"token punctuation\">)</span> Windows\n \nSelect number: <span class=\"token number\">1</span>  <span class=\"token comment\"># MacなのでUnix系を選択</span>\n \nSelect a backend type:\n \n  <span class=\"token number\">1</span><span class=\"token punctuation\">)</span> SSH\n  <span class=\"token number\">2</span><span class=\"token punctuation\">)</span> Exec <span class=\"token punctuation\">(</span>local<span class=\"token punctuation\">)</span> <span class=\"token comment\"># MacなのでLocal Execを選択</span>\n \nSelect number: <span class=\"token number\">2</span>\n \n + spec/\n + spec/localhost/\n + spec/localhost/sample_spec.rb\n + spec/spec_helper.rb\n + Rakefile\n + .rspec</code></pre></div>\n<p>とします。これで準備はOKです。</p>\n<h2 id=\"テストヘルパーの作成\" style=\"position:relative;\"><a href=\"#%E3%83%86%E3%82%B9%E3%83%88%E3%83%98%E3%83%AB%E3%83%91%E3%83%BC%E3%81%AE%E4%BD%9C%E6%88%90\" aria-label=\"テストヘルパーの作成 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>テストヘルパーの作成</h2>\n<p>Serverspecは上述したとおり、Ruby(RSpec)でできてるので、テスト用のヘルパーを作成し、テストに使う変数をspecファイル（テストコード）で利用できるようにしておきます。</p>\n<p>今回は <code class=\"language-text\">spec/spec_helper.rb</code> に、</p>\n<div class=\"gatsby-highlight\" data-language=\"ruby\"><pre class=\"language-ruby\"><code class=\"language-ruby\"><span class=\"token keyword\">require</span> <span class=\"token string-literal\"><span class=\"token string\">'serverspec'</span></span>\n\nset <span class=\"token symbol\">:backend</span><span class=\"token punctuation\">,</span> <span class=\"token symbol\">:exec</span>\n\n<span class=\"token comment\"># Load Variables for variables.yml</span>\n<span class=\"token keyword\">def</span> <span class=\"token method-definition\"><span class=\"token function\">load_configuration</span></span> <span class=\"token punctuation\">(</span>key<span class=\"token punctuation\">)</span>\n    configuration <span class=\"token operator\">=</span> <span class=\"token constant\">YAML</span><span class=\"token punctuation\">.</span>load_file <span class=\"token string-literal\"><span class=\"token string\">'variables.yml'</span></span>\n    configuration<span class=\"token punctuation\">[</span><span class=\"token string-literal\"><span class=\"token string\">'vars'</span></span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">[</span>key<span class=\"token punctuation\">]</span><span class=\"token punctuation\">.</span>map <span class=\"token keyword\">do</span> <span class=\"token operator\">|</span>package<span class=\"token operator\">|</span>\n      package<span class=\"token punctuation\">.</span>kind_of<span class=\"token operator\">?</span><span class=\"token punctuation\">(</span><span class=\"token builtin\">Hash</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">?</span> package<span class=\"token punctuation\">[</span><span class=\"token string-literal\"><span class=\"token string\">'name'</span></span><span class=\"token punctuation\">]</span> <span class=\"token operator\">:</span> package\n    <span class=\"token keyword\">end</span>\n<span class=\"token keyword\">end</span>\n\n<span class=\"token comment\"># Load Homebrew packages</span>\n<span class=\"token keyword\">def</span> <span class=\"token method-definition\"><span class=\"token function\">homebrew_packages</span></span>\n    load_configuration <span class=\"token string-literal\"><span class=\"token string\">'homebrew_packages'</span></span>\n<span class=\"token keyword\">end</span>\n\n<span class=\"token keyword\">def</span> <span class=\"token method-definition\"><span class=\"token function\">git_conf</span></span>\n  load_configuration <span class=\"token string-literal\"><span class=\"token string\">'git_conf'</span></span>\n<span class=\"token keyword\">end</span></code></pre></div>\n<p>という感じでhelperを作り、別に <code class=\"language-text\">variables.yml</code> を作りました。</p>\n<div class=\"gatsby-highlight\" data-language=\"yaml\"><pre class=\"language-yaml\"><code class=\"language-yaml\"><span class=\"token key atrule\">vars</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">homebrew_packages</span><span class=\"token punctuation\">:</span>\n    <span class=\"token punctuation\">-</span> git\n    <span class=\"token punctuation\">-</span> nodenv\n    <span class=\"token punctuation\">-</span> pyenv\n    <span class=\"token punctuation\">-</span> pyenv<span class=\"token punctuation\">-</span>virtualenv\n    <span class=\"token punctuation\">-</span> rbenv\n    <span class=\"token punctuation\">-</span> ruby<span class=\"token punctuation\">-</span>build\n    <span class=\"token punctuation\">-</span> tfenv\n    <span class=\"token punctuation\">-</span> awscli\n    <span class=\"token punctuation\">-</span> packer\n    <span class=\"token punctuation\">-</span> jq\n    <span class=\"token punctuation\">-</span> docker\n  <span class=\"token key atrule\">git_conf</span><span class=\"token punctuation\">:</span>\n    <span class=\"token punctuation\">-</span> tubone24\n    <span class=\"token punctuation\">-</span> hogehoge@gmail.com</code></pre></div>\n<h2 id=\"specファイルテストコードの作成\" style=\"position:relative;\"><a href=\"#spec%E3%83%95%E3%82%A1%E3%82%A4%E3%83%AB%E3%83%86%E3%82%B9%E3%83%88%E3%82%B3%E3%83%BC%E3%83%89%E3%81%AE%E4%BD%9C%E6%88%90\" aria-label=\"specファイルテストコードの作成 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Specファイル（テストコード）の作成</h2>\n<p>ここまで準備できたらいよいよSpecファイルを書いていきます。</p>\n<p>今回はHomebrewでインストールするパッケージの一覧とgit configで設定する名前、メール情報を変数化してます。</p>\n<p>helperでYamlに記載した変数をSpecで利用できるようになりました。</p>\n<h3 id=\"アプリがインストールされているかの確認\" style=\"position:relative;\"><a href=\"#%E3%82%A2%E3%83%97%E3%83%AA%E3%81%8C%E3%82%A4%E3%83%B3%E3%82%B9%E3%83%88%E3%83%BC%E3%83%AB%E3%81%95%E3%82%8C%E3%81%A6%E3%81%84%E3%82%8B%E3%81%8B%E3%81%AE%E7%A2%BA%E8%AA%8D\" aria-label=\"アプリがインストールされているかの確認 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>アプリがインストールされているかの確認</h3>\n<p>Homebrewで正しくアプリがインストールされているかの確認は、</p>\n<div class=\"gatsby-highlight\" data-language=\"ruby\"><pre class=\"language-ruby\"><code class=\"language-ruby\">describe package<span class=\"token punctuation\">(</span>hoge<span class=\"token punctuation\">)</span> <span class=\"token keyword\">do</span>\n  it <span class=\"token punctuation\">{</span> should be_installed <span class=\"token punctuation\">}</span>\n<span class=\"token keyword\">end</span></code></pre></div>\n<p>とします。(hogeをテストしたいアプリ名にしてください)</p>\n<p>HomebrewでインストールしていればAssert OKとなるはずです。</p>\n<h3 id=\"コマンドの結果を確認する\" style=\"position:relative;\"><a href=\"#%E3%82%B3%E3%83%9E%E3%83%B3%E3%83%89%E3%81%AE%E7%B5%90%E6%9E%9C%E3%82%92%E7%A2%BA%E8%AA%8D%E3%81%99%E3%82%8B\" aria-label=\"コマンドの結果を確認する permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>コマンドの結果を確認する</h3>\n<p>コマンドの結果、例えばインストールしたアプリのバージョン確認は、</p>\n<div class=\"gatsby-highlight\" data-language=\"ruby\"><pre class=\"language-ruby\"><code class=\"language-ruby\">describe command<span class=\"token punctuation\">(</span><span class=\"token string-literal\"><span class=\"token string\">'pyenv versions'</span></span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">do</span>\n  its<span class=\"token punctuation\">(</span><span class=\"token symbol\">:stdout</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span> should match <span class=\"token regex-literal\"><span class=\"token regex\">/py361/</span></span> <span class=\"token punctuation\">}</span>\n<span class=\"token keyword\">end</span></code></pre></div>\n<p>とすることで実現できます。 上記では<code class=\"language-text\">pyenv versions</code> のコマンドの実行結果を比較してます。</p>\n<p>正規表現でマッチさせるため、例えば否定系は先読み否定を使い、</p>\n<div class=\"gatsby-highlight\" data-language=\"ruby\"><pre class=\"language-ruby\"><code class=\"language-ruby\">describe command<span class=\"token punctuation\">(</span><span class=\"token string-literal\"><span class=\"token string\">'git --version'</span></span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">do</span>\n  its<span class=\"token punctuation\">(</span><span class=\"token symbol\">:stdout</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span> should match <span class=\"token regex-literal\"><span class=\"token regex\">/(?!Apple Git-98)/</span></span> <span class=\"token punctuation\">}</span>\n<span class=\"token keyword\">end</span></code></pre></div>\n<p>と書けます。</p>\n<h3 id=\"ファイルに文字列が含まれているか\" style=\"position:relative;\"><a href=\"#%E3%83%95%E3%82%A1%E3%82%A4%E3%83%AB%E3%81%AB%E6%96%87%E5%AD%97%E5%88%97%E3%81%8C%E5%90%AB%E3%81%BE%E3%82%8C%E3%81%A6%E3%81%84%E3%82%8B%E3%81%8B\" aria-label=\"ファイルに文字列が含まれているか permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>ファイルに文字列が含まれているか？</h3>\n<p>今回作ったレポジトリには入れてませんが、configファイルに文字列が含まれているかということもServerspecで確認できます。</p>\n<div class=\"gatsby-highlight\" data-language=\"ruby\"><pre class=\"language-ruby\"><code class=\"language-ruby\">describe file<span class=\"token punctuation\">(</span><span class=\"token string-literal\"><span class=\"token string\">'/etc/sysconfig/clock'</span></span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">do</span>\n  its<span class=\"token punctuation\">(</span><span class=\"token symbol\">:content</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span> should match <span class=\"token regex-literal\"><span class=\"token regex\">/ZONE=\"Asia\\/Tokyo\"/</span></span> <span class=\"token punctuation\">}</span>\n<span class=\"token keyword\">end</span></code></pre></div>\n<p>このようにすることで、ファイルが存在することとファイルに指定した文字列が記載されてるかをテストできます。</p>\n<p>詳しくは公式Docを御確認ください。</p>\n<h2 id=\"makefileで一発実行\" style=\"position:relative;\"><a href=\"#makefile%E3%81%A7%E4%B8%80%E7%99%BA%E5%AE%9F%E8%A1%8C\" aria-label=\"makefileで一発実行 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Makefileで一発実行</h2>\n<p>最後にMakefileを作って終わりです。</p>\n<p>下記の通りに定義を作りました。</p>\n<p>Rubyのbundle installがあるため、before-checkという定義も作ってます。</p>\n<div class=\"gatsby-highlight\" data-language=\"makefile\"><pre class=\"language-makefile\"><code class=\"language-makefile\">TARGET <span class=\"token operator\">=</span> <span class=\"token variable\">$1</span>\nCD_SERVERSPEC <span class=\"token operator\">=</span> cd serverspec/<span class=\"token variable\">$</span><span class=\"token punctuation\">{</span>TARGET<span class=\"token punctuation\">}</span>\n\n<span class=\"token target symbol\">before-check</span><span class=\"token punctuation\">:</span>\n\t<span class=\"token operator\">@</span><span class=\"token variable\">$</span><span class=\"token punctuation\">{</span>CD_SERVERSPEC<span class=\"token punctuation\">}</span> &amp;&amp; \\\n\tbundle install --path<span class=\"token operator\">=</span>vendor/bundle\n\n<span class=\"token target symbol\">check</span><span class=\"token punctuation\">:</span>\n\t<span class=\"token operator\">@</span><span class=\"token variable\">$</span><span class=\"token punctuation\">{</span>CD_SERVERSPEC<span class=\"token punctuation\">}</span> &amp;&amp; \\\n\tbundle exec rake</code></pre></div>\n<h2 id=\"結論\" style=\"position:relative;\"><a href=\"#%E7%B5%90%E8%AB%96\" aria-label=\"結論 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>結論</h2>\n<p>Macの構成管理をAnsibleで行い確認をServerspecで行なうところまで無事できました！</p>\n<p>次回はもうすることないかと思いきや、こいつをCIにのっけてみようかと思います!!</p>\n<p>もうめちゃくちゃだよ。</p>","words":1597,"minutes":4}},"staticQueryHashes":["1319877725","2959249232"]}