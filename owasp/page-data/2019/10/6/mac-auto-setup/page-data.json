{"componentChunkName":"component---src-templates-blog-post-tsx","path":"/2019/10/6/mac-auto-setup","result":{"data":{"content":{"edges":[{"node":{"id":"6af419c2-486b-58a8-8bdd-e326334e7e16","excerpt":"毎回Macの環境構築めんどくさい。 開発用MacBookの構成管理がしたくなり、AnsibleとServerspecを使って作りました。 記事が長くなりそうなので、今回は前半戦ということでAnsibleの設定について解説します。 Table of Contents Ansible…","fields":{"slug":"2019/10/6/mac-auto-setup"},"frontmatter":{"id":null,"title":"Ansible + Serverspecを使ってMacの環境構築を自動でする (Ansible編)","slug":"2019/10/6/mac-auto-setup","date":"2019-10-06T02:20:10.067Z","headerImage":"https://i.imgur.com/9iGRHft.png","tags":["Auto Provisioning","Ansible","Serverspec","Mac"]}}}]}},"pageContext":{"id":"6af419c2-486b-58a8-8bdd-e326334e7e16","index":75,"repHtml":"<p>毎回Macの環境構築めんどくさい。</p>\n<p>開発用MacBookの構成管理がしたくなり、AnsibleとServerspecを使って作りました。</p>\n<p>記事が長くなりそうなので、今回は前半戦ということでAnsibleの設定について解説します。</p>\n<h2 id=\"table-of-contents\" style=\"position:relative;\"><a href=\"#table-of-contents\" aria-label=\"table of contents permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Table of Contents</h2>\n<div class=\"toc\">\n<ul>\n<li>\n<p><a href=\"#ansible\">Ansible</a></p>\n<ul>\n<li>\n<p><a href=\"#mac%E3%81%A7ansible%E3%82%92%E4%BD%BF%E3%81%86\">MacでAnsibleを使う</a></p>\n</li>\n<li>\n<p><a href=\"#inventory%E3%82%92%E8%A8%AD%E5%AE%9A%E3%81%99%E3%82%8B\">Inventoryを設定する</a></p>\n</li>\n<li>\n<p><a href=\"#role%E3%82%92%E8%A8%AD%E5%AE%9A\">Roleを設定</a></p>\n<ul>\n<li><a href=\"#homebrew\">Homebrew</a></li>\n<li><a href=\"#path%E3%81%AE%E9%80%9A%E3%81%97%E6%96%B9\">PATHの通し方</a></li>\n<li><a href=\"#shell\">shell</a></li>\n<li><a href=\"#%E5%A4%89%E6%95%B0%E3%81%AE%E7%AE%A1%E7%90%86\">変数の管理</a></li>\n</ul>\n</li>\n<li>\n<p><a href=\"#playbook%E3%81%AE%E8%A8%AD%E5%AE%9A\">playbookの設定</a></p>\n</li>\n</ul>\n</li>\n<li>\n<p><a href=\"#makefile%E3%81%A7%E4%B8%80%E7%99%BA%E5%AE%9F%E8%A1%8C\">Makefileで一発実行</a></p>\n</li>\n<li>\n<p><a href=\"#%E7%B5%90%E8%AB%96\">結論</a></p>\n</li>\n</ul>\n</div>\n<h2 id=\"ansible\" style=\"position:relative;\"><a href=\"#ansible\" aria-label=\"ansible permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Ansible</h2>\n<p><img class=\"lozad\" src=\"data:image/gif;base64,R0lGODlhAQABAGAAACH5BAEKAP8ALAAAAAABAAEAAAgEAP8FBAA7\" data-src=\"https://i.imgur.com/oBucHNe.png\" alt=\"Img\"></p>\n<p>Ansibleとは<strong>Python</strong>製の<strong>OSS構成管理ツール</strong>です。</p>\n<p>便利なモジュールが多数用意されており、パッケージのインストール、コンフィグの書き換え、サービスの立ち上げ、有効化etc.. さまざまな構成を<strong>Yaml形式</strong>でパパっとかけることがポイントです。</p>\n<p>また、<strong>冪等（べきとう）性</strong>、つまり何回実行しても結果が変わらないことを保証したり、<strong>エージェントレス</strong>で構成管理対象のサーバーに事前インストールが必要ないことが評価されている点です。</p>\n<h3 id=\"macでansibleを使う\" style=\"position:relative;\"><a href=\"#mac%E3%81%A7ansible%E3%82%92%E4%BD%BF%E3%81%86\" aria-label=\"macでansibleを使う permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>MacでAnsibleを使う</h3>\n<p>ローカル環境であるMacの構成管理にもAnsibleが使えます。</p>\n<p>ansible_connectionというパラメータをlocalにすることで、localhost上のマシンに対してコマンドが発行できるのでそれをうまく使います。</p>\n<p>また、Macでパッケージをインストールするときにたびたびお世話になる<strong>Homebrew</strong>もAnsibleのモジュールにちゃんと用意されていますのでそちらを使います。</p>\n<p>Homebrewでのインストールは次のように定義します。</p>\n<div class=\"gatsby-highlight\" data-language=\"yaml\"><pre class=\"language-yaml\"><code class=\"language-yaml\"><span class=\"token punctuation\">-</span> <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> <span class=\"token string\">'Install Git'</span>\n  <span class=\"token key atrule\">homebrew</span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> <span class=\"token string\">'git'</span>\n    <span class=\"token key atrule\">state</span><span class=\"token punctuation\">:</span> <span class=\"token string\">'present'</span></code></pre></div>\n<p>簡単そうですね。では早速作っていきましょう。</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">├─ansible\n│  └─mac\n│      ├─inventory\n|      |  ├─default\n│      │  └─group_vars\n│      │      └─local\n│      ├─playbooks\n│      └─roles\n│          └─dev-tools\n│              ├─tasks\n|              |   |\n|              |   └─main.yml\n|              |   └─hoge.yml\n│              └─vars\n|                 └─main.yml</code></pre></div>\n<p>Ansibleのディレクトリ構成は上記のようにしてます。</p>\n<p>Ansibleのplaybookを作るにはざっくり3つの手順を取ります。</p>\n<ol>\n<li>接続先情報をまとめたInventoryを設定</li>\n<li>実際の構成情報を記載したRoleを設定</li>\n<li>InventoryとRoleをひとまとめにしたplaybookを設定</li>\n</ol>\n<p>では早速Inventoryの設定から進めていきます。</p>\n<h3 id=\"inventoryを設定する\" style=\"position:relative;\"><a href=\"#inventory%E3%82%92%E8%A8%AD%E5%AE%9A%E3%81%99%E3%82%8B\" aria-label=\"inventoryを設定する permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Inventoryを設定する</h3>\n<p>Inventoryは複数のサーバーをグルーピングして、同時にプロビジョンするためにサーバーの接続情報をまとめておくコンフィグです。</p>\n<p>今回はMacに適用するため、接続先情報はlocalとなります。</p>\n<p>inventoryをコマンドで指定しない場合にdefalutで設定される<code class=\"language-text\">defalut</code>ファイルに下記を設定します。</p>\n<p><a href=\"https://github.com/tubone24/mac-auto-setup/blob/master/ansible/mac/inventory/default\" target=\"_blank\" rel=\"noopener noreferrer\">inventory/defalut</a> に、</p>\n<div class=\"gatsby-highlight\" data-language=\"ini\"><pre class=\"language-ini\"><code class=\"language-ini\"><span class=\"token section\"><span class=\"token punctuation\">[</span><span class=\"token section-name selector\">local</span><span class=\"token punctuation\">]</span></span>\nlocalhost</code></pre></div>\n<p>これで、特にInventoryを指定しない場合は<code class=\"language-text\">localhost</code>として接続がされます。また、InventoryGroupとして<code class=\"language-text\">local</code>を指定しているため、<code class=\"language-text\">group_vars/local</code>にlocalとして共通の変数を定義できます。</p>\n<p>今回は複数サーバーで共有させる変数が見当たらないので特に設定しません。</p>\n<p><a href=\"https://github.com/tubone24/mac-auto-setup/blob/master/ansible/mac/inventory/group_vars/local/ansible.yml\" target=\"_blank\" rel=\"noopener noreferrer\">inventory/group_vars/local/ansible.yml</a> に、</p>\n<div class=\"gatsby-highlight\" data-language=\"yaml\"><pre class=\"language-yaml\"><code class=\"language-yaml\"><span class=\"token key atrule\">ansible_connection</span><span class=\"token punctuation\">:</span> <span class=\"token string\">'local'</span></code></pre></div>\n<p>と設定しておけばいいです。</p>\n<h3 id=\"roleを設定\" style=\"position:relative;\"><a href=\"#role%E3%82%92%E8%A8%AD%E5%AE%9A\" aria-label=\"roleを設定 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Roleを設定</h3>\n<p>次にRoleを設定していきます。</p>\n<p>今回は特にRoleを分ける必要もないのですが、たとえば、</p>\n<ul>\n<li>開発者のMac</li>\n<li>デザイナーのMac</li>\n<li>運用者のMac</li>\n</ul>\n<p>とそれぞれインストールするアプリが異なる場合、全員に共通して入れたい設定やAさんは開発者兼デザイナーで両方のアプリが入れたいなどの要求もある場合はそれぞれ、</p>\n<ul>\n<li>dev-tools</li>\n<li>design-tools</li>\n<li>ops-tools</li>\n</ul>\n<p>みたくRoleをわけておくのがセオリーです。</p>\n<p>さて、今回は開発者用のRoleだけつくればいいことにしますので、</p>\n<p>dev-toolsだけ用意します。</p>\n<p>また、各RoleにはTaskというプロビジョニングの実行単位があります。</p>\n<p>例えば、Pythonを入れるTask、Node.jsを入れるTaskという具合です。</p>\n<p>AnsibleではTasksディレクトリのmain.ymlが読み込まれるため、<strong>各Taskごとに分けたYaml</strong>を<strong>main.ymlでInclude</strong>して上げればいいわけです。</p>\n<p>roles/dev-tools/tasks/main.ymlに、</p>\n<div class=\"gatsby-highlight\" data-language=\"yaml\"><pre class=\"language-yaml\"><code class=\"language-yaml\"><span class=\"token punctuation\">-</span> <span class=\"token key atrule\">include</span><span class=\"token punctuation\">:</span> <span class=\"token string\">'tools.yml'</span>\n<span class=\"token punctuation\">-</span> <span class=\"token key atrule\">include</span><span class=\"token punctuation\">:</span> <span class=\"token string\">'git.yml'</span>\n<span class=\"token punctuation\">-</span> <span class=\"token key atrule\">include</span><span class=\"token punctuation\">:</span> <span class=\"token string\">'nodejs.yml'</span>\n<span class=\"token punctuation\">-</span> <span class=\"token key atrule\">include</span><span class=\"token punctuation\">:</span> <span class=\"token string\">'terraform.yml'</span>\n<span class=\"token punctuation\">-</span> <span class=\"token key atrule\">include</span><span class=\"token punctuation\">:</span> <span class=\"token string\">'python.yml'</span>\n<span class=\"token punctuation\">-</span> <span class=\"token key atrule\">include</span><span class=\"token punctuation\">:</span> <span class=\"token string\">'ruby.yml'</span>\n<span class=\"token punctuation\">-</span> <span class=\"token key atrule\">include</span><span class=\"token punctuation\">:</span> <span class=\"token string\">'docker.yml'</span></code></pre></div>\n<p>とIncludeさせるだけです。かんたんです。</p>\n<h4 id=\"homebrew\" style=\"position:relative;\"><a href=\"#homebrew\" aria-label=\"homebrew permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Homebrew</h4>\n<p>上記にも書いたとおり、AnsibleではHomebrewモジュールが用意されているため、</p>\n<p><a href=\"https://github.com/tubone24/mac-auto-setup/blob/master/ansible/mac/roles/dev-tools/tasks/nodejs.yml\" target=\"_blank\" rel=\"noopener noreferrer\">roles/dev-tools/tasks/nodejs.yml</a></p>\n<div class=\"gatsby-highlight\" data-language=\"yaml\"><pre class=\"language-yaml\"><code class=\"language-yaml\"><span class=\"token punctuation\">-</span> <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> <span class=\"token string\">'Install nodenv'</span>\n  <span class=\"token key atrule\">homebrew</span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> <span class=\"token string\">'nodenv'</span>\n    <span class=\"token key atrule\">state</span><span class=\"token punctuation\">:</span> <span class=\"token string\">'present'</span></code></pre></div>\n<p>と記載すればインストールが実現できます。</p>\n<p>また、用意されているモジュールを使うことで、すでにインストール、設定済みでも、</p>\n<p>エラーにならずプロビジョニングが終了しますのでなるべく使えるモジュールがないか探しましょう。</p>\n<h4 id=\"pathの通し方\" style=\"position:relative;\"><a href=\"#path%E3%81%AE%E9%80%9A%E3%81%97%E6%96%B9\" aria-label=\"pathの通し方 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>PATHの通し方</h4>\n<p>構成のなかでいくつかPATHを通す必要があり、bash_profileに環境変数のexportを記載する必要がでてきました。</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token comment\"># bash_profileに書きたい</span>\n<span class=\"token builtin class-name\">export</span> <span class=\"token assign-left variable\">PYENV_ROOT</span><span class=\"token operator\">=</span><span class=\"token string\">\"<span class=\"token variable\">${<span class=\"token environment constant\">HOME</span>}</span>/.pyenv\"</span>\n<span class=\"token builtin class-name\">export</span> <span class=\"token assign-left variable\"><span class=\"token environment constant\">PATH</span></span><span class=\"token operator\">=</span><span class=\"token variable\">${PYENV_ROOT}</span>/bin:<span class=\"token variable\">${PYENV_ROOT}</span>/shims:<span class=\"token variable\">${<span class=\"token environment constant\">PATH</span>}</span>\n\n<span class=\"token keyword\">if</span> <span class=\"token punctuation\">[</span> -d <span class=\"token string\">\"<span class=\"token variable\">${PYENV_ROOT}</span>\"</span> <span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span> <span class=\"token keyword\">then</span>\n    <span class=\"token builtin class-name\">eval</span> <span class=\"token string\">\"<span class=\"token variable\"><span class=\"token variable\">$(</span>pyenv init -<span class=\"token variable\">)</span></span>\"</span>\n    <span class=\"token builtin class-name\">eval</span> <span class=\"token string\">\"<span class=\"token variable\"><span class=\"token variable\">$(</span>pyenv virtualenv-init -<span class=\"token variable\">)</span></span>\"</span>\n<span class=\"token keyword\">fi</span></code></pre></div>\n<p>そのようなときに役立つのが<strong>inlinefile</strong>と<strong>blockinline</strong>です。</p>\n<p><a href=\"https://github.com/tubone24/mac-auto-setup/blob/master/ansible/mac/roles/dev-tools/tasks/python.yml\" target=\"_blank\" rel=\"noopener noreferrer\">roles/dev-tools/tasks/python.yml</a></p>\n<div class=\"gatsby-highlight\" data-language=\"yaml\"><pre class=\"language-yaml\"><code class=\"language-yaml\"><span class=\"token comment\"># inlinefile</span>\n<span class=\"token punctuation\">-</span> <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> <span class=\"token string\">'Add PATH'</span>\n  <span class=\"token key atrule\">lineinfile</span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">dest</span><span class=\"token punctuation\">:</span> <span class=\"token string\">'~/.bash_profile'</span>\n    <span class=\"token key atrule\">line</span><span class=\"token punctuation\">:</span> <span class=\"token string\">'{{ item }}'</span>\n  <span class=\"token key atrule\">with_items</span><span class=\"token punctuation\">:</span>\n    <span class=\"token punctuation\">-</span> <span class=\"token string\">'export PYENV_ROOT=\"${HOME}/.pyenv\"'</span>\n    <span class=\"token punctuation\">-</span> <span class=\"token string\">'export PATH=${PYENV_ROOT}/bin:${PYENV_ROOT}/shims:${PATH}'</span>\n\n<span class=\"token comment\"># blockinline</span>\n<span class=\"token punctuation\">-</span> <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> <span class=\"token string\">'Setup pyenv-virtualenv'</span>\n  <span class=\"token key atrule\">blockinfile</span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">dest</span><span class=\"token punctuation\">:</span> <span class=\"token string\">'~/.bash_profile'</span>\n    <span class=\"token key atrule\">block</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">|</span><span class=\"token scalar string\">\n      if [ -d \"${PYENV_ROOT}\" ]; then\n        eval \"$(pyenv init -)\"\n        eval \"$(pyenv virtualenv-init -)\"\n      fi</span></code></pre></div>\n<p>のように呼び出すだけでbash_profileに<strong>冪等性を保ったまま、コンフィグを書き込むこと</strong>ができます。</p>\n<p>inlinefileとblockinlineの違いは一行か複数行かということです。</p>\n<p>blockinlineで複数行を記載するとblockの中身の順番が<strong>担保</strong>されます。</p>\n<h4 id=\"shell\" style=\"position:relative;\"><a href=\"#shell\" aria-label=\"shell permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>shell</h4>\n<p>モジュールが見あたらなく、プロビジョニングができないときは仕方なくshellモジュールを使うことができます。</p>\n<p><a href=\"https://github.com/tubone24/mac-auto-setup/blob/master/ansible/mac/roles/dev-tools/tasks/python.yml\" target=\"_blank\" rel=\"noopener noreferrer\">roles/dev-tools/tasks/python.yml</a></p>\n<div class=\"gatsby-highlight\" data-language=\"yaml\"><pre class=\"language-yaml\"><code class=\"language-yaml\"><span class=\"token punctuation\">-</span> <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> <span class=\"token string\">'Install Python 3.6.1'</span>\n  <span class=\"token key atrule\">shell</span><span class=\"token punctuation\">:</span> <span class=\"token string\">'pyenv install 3.6.1'</span>\n  <span class=\"token key atrule\">ignore_errors</span><span class=\"token punctuation\">:</span> yes</code></pre></div>\n<p>ただし、冪等性は保たれないため、すでに環境ができていた場合、エラーになってしまう可能性があります。</p>\n<p>少し乱暴ですが、<strong>ignore_errors: yes</strong> を使うことでエラーがでても読み飛ばして次のタスクに進むことができます。</p>\n<p>今回はignore_errors: yesした部分をServerspecで確認する形でOKとしてます。</p>\n<h4 id=\"変数の管理\" style=\"position:relative;\"><a href=\"#%E5%A4%89%E6%95%B0%E3%81%AE%E7%AE%A1%E7%90%86\" aria-label=\"変数の管理 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>変数の管理</h4>\n<p>変数を管理したくなったらvarsに記載することでtask側でも呼び出すことができます。</p>\n<p><a href=\"https://github.com/tubone24/mac-auto-setup/blob/master/ansible/mac/roles/dev-tools/vars/main.yml\" target=\"_blank\" rel=\"noopener noreferrer\">vars/main.yml</a> に、</p>\n<div class=\"gatsby-highlight\" data-language=\"yaml\"><pre class=\"language-yaml\"><code class=\"language-yaml\"><span class=\"token key atrule\">git</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"foobar\"</span>\n  <span class=\"token key atrule\">mail</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"hoge@example.com\"</span></code></pre></div>\n<p>と記載し、</p>\n<div class=\"gatsby-highlight\" data-language=\"yaml\"><pre class=\"language-yaml\"><code class=\"language-yaml\"><span class=\"token punctuation\">-</span> <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> <span class=\"token string\">'Set git name'</span>\n  <span class=\"token key atrule\">shell</span><span class=\"token punctuation\">:</span> <span class=\"token string\">'git config --global user.name \"{{ git.name }}\"'</span>\n\n<span class=\"token punctuation\">-</span> <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> <span class=\"token string\">'Set git mail'</span>\n  <span class=\"token key atrule\">shell</span><span class=\"token punctuation\">:</span> <span class=\"token string\">'git config --global user.email \"{{ git.mail }}\"'</span></code></pre></div>\n<p>と宣言すれば利用できます。</p>\n<h3 id=\"playbookの設定\" style=\"position:relative;\"><a href=\"#playbook%E3%81%AE%E8%A8%AD%E5%AE%9A\" aria-label=\"playbookの設定 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>playbookの設定</h3>\n<p>Ansible最後はplaybookです。</p>\n<p>とはいったものの、roleとinventoryを紐づければいいだけですので、</p>\n<p><a href=\"https://github.com/tubone24/mac-auto-setup/blob/master/ansible/mac/playbooks/my-mac.yml\" target=\"_blank\" rel=\"noopener noreferrer\">playbooks/my-mac.yml</a></p>\n<div class=\"gatsby-highlight\" data-language=\"yaml\"><pre class=\"language-yaml\"><code class=\"language-yaml\"><span class=\"token punctuation\">-</span> <span class=\"token key atrule\">hosts</span><span class=\"token punctuation\">:</span> <span class=\"token string\">'local'</span>\n  <span class=\"token key atrule\">roles</span><span class=\"token punctuation\">:</span>\n    <span class=\"token punctuation\">-</span> <span class=\"token string\">'dev-tools'</span></code></pre></div>\n<p>とすれば出来上がりです。</p>\n<p>これで、</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\">ansible-playbook playbooks/my-mac.yml</code></pre></div>\n<p>のように実行すればansibleの実行が可能です。</p>\n<h2 id=\"makefileで一発実行\" style=\"position:relative;\"><a href=\"#makefile%E3%81%A7%E4%B8%80%E7%99%BA%E5%AE%9F%E8%A1%8C\" aria-label=\"makefileで一発実行 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Makefileで一発実行</h2>\n<p>仕上げにMakefileをディレクトリルートに作り、煩わしいコマンドから解放されましょう。</p>\n<p><a href=\"https://github.com/tubone24/mac-auto-setup/blob/master/Makefile\" target=\"_blank\" rel=\"noopener noreferrer\">Makefile</a>に、</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">TARGET = $1\nCD_ANSIBLE = cd ansible/${TARGET}\nCD_SERVERSPEC = cd serverspec/${TARGET}\n\nsetup:\n\t@${CD_ANSIBLE} &amp;&amp; \\\n\tansible-playbook playbooks/my-mac.yml</code></pre></div>\n<p>のように設定しました。</p>\n<p>これで、</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token function\">make</span> setup <span class=\"token assign-left variable\">TARGET</span><span class=\"token operator\">=</span>mac</code></pre></div>\n<p>で実行可能になりました。</p>\n<h2 id=\"結論\" style=\"position:relative;\"><a href=\"#%E7%B5%90%E8%AB%96\" aria-label=\"結論 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>結論</h2>\n<p>長くなったのでServerspecは次項で話します。</p>\n<p>Ansibleはディレクトリが複雑なイメージがありますが、意味を理解すれば簡単です。</p>\n<p>みなさまもMacの構成管理にトライしてみてください。</p>","words":2799,"minutes":7}},"staticQueryHashes":["1319877725","2959249232"]}