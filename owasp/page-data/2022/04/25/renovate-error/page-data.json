{"componentChunkName":"component---src-templates-blog-post-tsx","path":"/2022/04/25/renovate-error","result":{"data":{"content":{"edges":[{"node":{"id":"7bdfff1b-ceb9-534a-ae60-66207cfbc722","excerpt":"エラーは突然に。 Table of Contents Renovate Artifact update problem 結論 Renovate Renovateとはプロジェクトが使っているライブラリの依存関係 (Dependency…","fields":{"slug":"2022/04/25/renovate-error"},"frontmatter":{"id":null,"title":"Renovateの作るPRでArtifact update problemが出た時の対処法","slug":"2022/04/25/renovate-error","date":"2022-04-25T14:54:39.263Z","headerImage":"https://i.imgur.com/61v14dU.png","tags":["Renovate"]}}}]}},"pageContext":{"id":"7bdfff1b-ceb9-534a-ae60-66207cfbc722","index":1,"repHtml":"<p>エラーは突然に。</p>\n<h2 id=\"table-of-contents\" style=\"position:relative;\"><a href=\"#table-of-contents\" aria-label=\"table of contents permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Table of Contents</h2>\n<div class=\"toc\">\n<ul>\n<li><a href=\"#renovate\">Renovate</a></li>\n<li><a href=\"#artifact-update-problem\">Artifact update problem</a></li>\n<li><a href=\"#%E7%B5%90%E8%AB%96\">結論</a></li>\n</ul>\n</div>\n<h2 id=\"renovate\" style=\"position:relative;\"><a href=\"#renovate\" aria-label=\"renovate permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Renovate</h2>\n<p><a href=\"https://www.whitesourcesoftware.com/free-developer-tools/renovate/\" target=\"_blank\" rel=\"noopener noreferrer\">Renovate</a>とはプロジェクトが使っているライブラリの依存関係 (Dependency) の更新を自動化するツールです。</p>\n<p>さまざまな言語に対応しており、もちろんnpmにも対応してます。</p>\n<p>JavaScriptのライブラリ更新は特に追いかけるのが大変なのでこのブログでもRenovateを使ってライブラリの依存関係をできるだけ最新に保つようにしてます。</p>\n<p>Renovateがライブラリを更新する際はpackage.jsonやpackage-loc.json、yarn.lockなどの依存グラフを保存しているファイルを直接変更の上、PRの形で更新依頼を作成します。</p>\n<p>なので、CIでテストがきちんと回るようにしていたり、PRごとにデプロイが走るような形にしていれば、その成功を持って機械的にmerge(auto merge機能もあります)できます。便利ですね。</p>\n<h2 id=\"artifact-update-problem\" style=\"position:relative;\"><a href=\"#artifact-update-problem\" aria-label=\"artifact update problem permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Artifact update problem</h2>\n<p>ところが、ある日を境にRenovateが作るPRが軒並みCI Checkに失敗する事象が発生しました。</p>\n<p>Renovate artifactと呼ばれるcheckが失敗していてPRコメントには次のようなメッセージが出てました。</p>\n<p><img class=\"lozad\" src=\"data:image/gif;base64,R0lGODlhAQABAGAAACH5BAEKAP8ALAAAAAABAAEAAAgEAP8FBAA7\" data-src=\"https://i.imgur.com/61v14dU.png\" alt=\"renovate error\"></p>\n\n        <div class=\"gatsby-code-title\">\n          <span>renovateコメント</span>\n        </div>\n       \n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\">\nRenovate failed to update an artifact related to this branch. You probably <span class=\"token keyword\">do</span> not want to merge this PR as-is.\n\n♻ Renovate will retry this branch, including artifacts, only when one of the following happens:\n\nany of the package files <span class=\"token keyword\">in</span> this branch needs updating, or\nthe branch becomes conflicted, or\nyou click the rebase/retry checkbox <span class=\"token keyword\">if</span> found above, or\nyou <span class=\"token function\">rename</span> this PR's title to start with <span class=\"token string\">\"rebase!\"</span> to trigger it manually\nThe artifact failure details are included below:\n\nFile name: package-lock.json\n\n\n<span class=\"token function\">npm</span> notice \n<span class=\"token function\">npm</span> notice New minor version of <span class=\"token function\">npm</span> available<span class=\"token operator\">!</span> <span class=\"token number\">8.1</span>.2 -<span class=\"token operator\">></span> <span class=\"token number\">8.7</span>.0\n<span class=\"token function\">npm</span> notice Changelog: <span class=\"token operator\">&lt;</span>https://github.com/npm/cli/releases/tag/v8.7.<span class=\"token operator\"><span class=\"token file-descriptor important\">0</span>></span>\n<span class=\"token function\">npm</span> notice Run <span class=\"token variable\"><span class=\"token variable\">`</span><span class=\"token function\">npm</span> <span class=\"token function\">install</span> -g npm@8.7.0<span class=\"token variable\">`</span></span> to update<span class=\"token operator\">!</span>\n<span class=\"token function\">npm</span> notice \n<span class=\"token function\">npm</span> ERR<span class=\"token operator\">!</span> code ERESOLVE\n<span class=\"token function\">npm</span> ERR<span class=\"token operator\">!</span> ERESOLVE could not resolve\n<span class=\"token function\">npm</span> ERR<span class=\"token operator\">!</span> \n<span class=\"token function\">npm</span> ERR<span class=\"token operator\">!</span> While resolving: gatsby-plugin-netlify@3.14.0\n<span class=\"token function\">npm</span> ERR<span class=\"token operator\">!</span> Found: gatsby@4.7.0\n<span class=\"token function\">npm</span> ERR<span class=\"token operator\">!</span> node_modules/gatsby\n<span class=\"token function\">npm</span> ERR<span class=\"token operator\">!</span>   gatsby@<span class=\"token string\">\"4.7.0\"</span> from the root project\n<span class=\"token function\">npm</span> ERR<span class=\"token operator\">!</span>   peer gatsby@<span class=\"token string\">\"^2.0.0 || ^3.0.0 || ^4.0.0\"</span> from gatsby-plugin-algolia@0.26.0\n<span class=\"token function\">npm</span> ERR<span class=\"token operator\">!</span>   node_modules/gatsby-plugin-algolia\n<span class=\"token function\">npm</span> ERR<span class=\"token operator\">!</span>     gatsby-plugin-algolia@<span class=\"token string\">\"0.26.0\"</span> from the root project\n<span class=\"token function\">npm</span> ERR<span class=\"token operator\">!</span>   <span class=\"token number\">27</span> <span class=\"token function\">more</span> <span class=\"token punctuation\">(</span>gatsby-plugin-cdn-files, gatsby-plugin-feed, <span class=\"token punctuation\">..</span>.<span class=\"token punctuation\">)</span>\n<span class=\"token function\">npm</span> ERR<span class=\"token operator\">!</span> \n<span class=\"token function\">npm</span> ERR<span class=\"token operator\">!</span> Could not resolve dependency:\n<span class=\"token function\">npm</span> ERR<span class=\"token operator\">!</span> peer gatsby@<span class=\"token string\">\"^3.0.0\"</span> from gatsby-plugin-netlify@3.14.0\n<span class=\"token function\">npm</span> ERR<span class=\"token operator\">!</span> node_modules/gatsby-plugin-netlify\n<span class=\"token function\">npm</span> ERR<span class=\"token operator\">!</span>   gatsby-plugin-netlify@<span class=\"token string\">\"3.14.0\"</span> from the root project\n<span class=\"token function\">npm</span> ERR<span class=\"token operator\">!</span> \n<span class=\"token function\">npm</span> ERR<span class=\"token operator\">!</span> Conflicting peer dependency: gatsby@3.14.6\n<span class=\"token function\">npm</span> ERR<span class=\"token operator\">!</span> node_modules/gatsby\n<span class=\"token function\">npm</span> ERR<span class=\"token operator\">!</span>   peer gatsby@<span class=\"token string\">\"^3.0.0\"</span> from gatsby-plugin-netlify@3.14.0\n<span class=\"token function\">npm</span> ERR<span class=\"token operator\">!</span>   node_modules/gatsby-plugin-netlify\n<span class=\"token function\">npm</span> ERR<span class=\"token operator\">!</span>     gatsby-plugin-netlify@<span class=\"token string\">\"3.14.0\"</span> from the root project\n<span class=\"token function\">npm</span> ERR<span class=\"token operator\">!</span> \n<span class=\"token function\">npm</span> ERR<span class=\"token operator\">!</span> Fix the upstream dependency conflict, or retry\n<span class=\"token function\">npm</span> ERR<span class=\"token operator\">!</span> this <span class=\"token builtin class-name\">command</span> with --force, or --legacy-peer-deps\n<span class=\"token function\">npm</span> ERR<span class=\"token operator\">!</span> to accept an incorrect <span class=\"token punctuation\">(</span>and potentially broken<span class=\"token punctuation\">)</span> dependency resolution.\n<span class=\"token function\">npm</span> ERR<span class=\"token operator\">!</span> \n<span class=\"token function\">npm</span> ERR<span class=\"token operator\">!</span> See /tmp/renovate-cache/others/npm/eresolve-report.txt <span class=\"token keyword\">for</span> a full report.\n\n<span class=\"token function\">npm</span> ERR<span class=\"token operator\">!</span> A complete log of this run can be found in:\n<span class=\"token function\">npm</span> ERR<span class=\"token operator\">!</span>     /tmp/renovate-cache/others/npm/_logs/2022-04-24T15_15_32_316Z-debug-0.log</code></pre></div>\n<p>こちらについていくつかIssuesとかを確認してみたのですが、これといって参考になるものもなくどうしようかなと思っていたところ、ちゃんとPRコメントで何が原因かエラーが出てました。</p>\n<p>ちゃんとエラーを見る癖をつけたいものですね。</p>\n\n        <div class=\"gatsby-code-title\">\n          <span>renovateError</span>\n        </div>\n       \n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token function\">npm</span> ERR<span class=\"token operator\">!</span> ERESOLVE could not resolve\n<span class=\"token function\">npm</span> ERR<span class=\"token operator\">!</span> \n<span class=\"token function\">npm</span> ERR<span class=\"token operator\">!</span> While resolving: gatsby-plugin-netlify@3.14.0\n<span class=\"token function\">npm</span> ERR<span class=\"token operator\">!</span> Found: gatsby@4.7.0\n<span class=\"token function\">npm</span> ERR<span class=\"token operator\">!</span> node_modules/gatsby\n<span class=\"token function\">npm</span> ERR<span class=\"token operator\">!</span>   gatsby@<span class=\"token string\">\"4.7.0\"</span> from the root project\n<span class=\"token function\">npm</span> ERR<span class=\"token operator\">!</span>   peer gatsby@<span class=\"token string\">\"^2.0.0 || ^3.0.0 || ^4.0.0\"</span> from gatsby-plugin-algolia@0.26.0\n<span class=\"token function\">npm</span> ERR<span class=\"token operator\">!</span>   node_modules/gatsby-plugin-algolia\n<span class=\"token function\">npm</span> ERR<span class=\"token operator\">!</span>     gatsby-plugin-algolia@<span class=\"token string\">\"0.26.0\"</span> from the root project\n<span class=\"token function\">npm</span> ERR<span class=\"token operator\">!</span>   <span class=\"token number\">27</span> <span class=\"token function\">more</span> <span class=\"token punctuation\">(</span>gatsby-plugin-cdn-files, gatsby-plugin-feed, <span class=\"token punctuation\">..</span>.<span class=\"token punctuation\">)</span>\n<span class=\"token function\">npm</span> ERR<span class=\"token operator\">!</span> \n<span class=\"token function\">npm</span> ERR<span class=\"token operator\">!</span> Could not resolve dependency:\n<span class=\"token function\">npm</span> ERR<span class=\"token operator\">!</span> peer gatsby@<span class=\"token string\">\"^3.0.0\"</span> from gatsby-plugin-netlify@3.14.0\n<span class=\"token function\">npm</span> ERR<span class=\"token operator\">!</span> node_modules/gatsby-plugin-netlify\n<span class=\"token function\">npm</span> ERR<span class=\"token operator\">!</span>   gatsby-plugin-netlify@<span class=\"token string\">\"3.14.0\"</span> from the root project\n<span class=\"token function\">npm</span> ERR<span class=\"token operator\">!</span> \n<span class=\"token function\">npm</span> ERR<span class=\"token operator\">!</span> Conflicting peer dependency: gatsby@3.14.6\n<span class=\"token function\">npm</span> ERR<span class=\"token operator\">!</span> node_modules/gatsby\n<span class=\"token function\">npm</span> ERR<span class=\"token operator\">!</span>   peer gatsby@<span class=\"token string\">\"^3.0.0\"</span> from gatsby-plugin-netlify@3.14.0\n<span class=\"token function\">npm</span> ERR<span class=\"token operator\">!</span>   node_modules/gatsby-plugin-netlify\n<span class=\"token function\">npm</span> ERR<span class=\"token operator\">!</span>     gatsby-plugin-netlify@<span class=\"token string\">\"3.14.0\"</span> from the root project\n<span class=\"token function\">npm</span> ERR<span class=\"token operator\">!</span> \n<span class=\"token function\">npm</span> ERR<span class=\"token operator\">!</span> Fix the upstream dependency conflict, or retry\n<span class=\"token function\">npm</span> ERR<span class=\"token operator\">!</span> this <span class=\"token builtin class-name\">command</span> with --force, or --legacy-peer-deps\n<span class=\"token function\">npm</span> ERR<span class=\"token operator\">!</span> to accept an incorrect <span class=\"token punctuation\">(</span>and potentially broken<span class=\"token punctuation\">)</span> dependency resolution.</code></pre></div>\n<p>本ブログで使っているGatsbyのバージョンは4.7.0ですが、プラグインのgatsby-plugin-netlifyが3.14.0のバージョンで、それがgatsbyのv3系に依存しているので依存関係が解決できません！という何ともよくあるエラーでした。</p>\n<p>にしても、こちらで組んでいるCIでは特にそんなエラーも出ずに完了しているところを見ると何が原因なんでしょうね...。偉い人教えてください。</p>\n<p>あと、Renovate自体がgatsby-plugin-netlifyのバージョンアップのPRを作らなかったのも気になります...わからん。</p>\n<p>エラーの原因がわかれば直すのは簡単です。package.jsonを編集して、gatsby-plugin-netlifyのバージョンをgatsby v.4.7.0に対応しているところまで手動で上げれば良いだけです。</p>\n<p>その後npm installしてpackage-lock.jsonの依存グラフを直してあげれば完成です。</p>\n\n        <div class=\"gatsby-code-title\">\n          <span>package.json</span>\n        </div>\n       \n<div class=\"gatsby-highlight\" data-language=\"json\"><pre class=\"language-json\"><code class=\"language-json\">  <span class=\"token property\">\"dependencies\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token property\">\"gatsby\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"4.7.0\"</span><span class=\"token punctuation\">,</span>\n    <span class=\"token property\">\"gatsby-plugin-netlify\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"4.3.0\"</span><span class=\"token punctuation\">,</span>\n   <span class=\"token punctuation\">}</span></code></pre></div>\n<p>これでエラーは解消されました。</p>\n<h2 id=\"結論\" style=\"position:relative;\"><a href=\"#%E7%B5%90%E8%AB%96\" aria-label=\"結論 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>結論</h2>\n<p>なんか今回の記事はあっさりとしたものになってしまいましたが、Renovateもこういったエラーを吐くことがあるので、その際は出力されているコンソールログを見て手元で修正する必要がありそうですよ。という共有でした。</p>","words":1253,"minutes":4}},"staticQueryHashes":["1319877725","2959249232"]}