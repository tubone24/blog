{"componentChunkName":"component---src-templates-blog-post-tsx","path":"/2022/04/09/lambda-urls","result":{"data":{"content":{"edges":[{"node":{"id":"c160d14e-a11e-5cca-b051-fd26c29ec845","excerpt":"花粉. Table of Contents AWS Lambda Function URLs 使ってみる 確かに便利ではありますが... 認証 タイムアウト 結論 AWS Lambda Function URLs AWS Lambda Function URLs…","fields":{"slug":"2022/04/09/lambda-urls"},"frontmatter":{"id":"","title":"AWS Lambda Function URLsがリリースされたのでタイムアウトの挙動を確かめてみる","slug":"2022/04/09/lambda-urls","date":"2022-04-09T02:50:46.360Z","headerImage":"https://i.imgur.com/alxzd7y.png","tags":["AWS","Lambda"]}}}]}},"pageContext":{"id":"c160d14e-a11e-5cca-b051-fd26c29ec845","index":4,"repHtml":"<p>花粉.</p>\n<h2 id=\"table-of-contents\" style=\"position:relative;\"><a href=\"#table-of-contents\" aria-label=\"table of contents permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Table of Contents</h2>\n<div class=\"toc\">\n<ul>\n<li><a href=\"#aws-lambda-function-urls\">AWS Lambda Function URLs</a></li>\n<li><a href=\"#%E4%BD%BF%E3%81%A3%E3%81%A6%E3%81%BF%E3%82%8B\">使ってみる</a></li>\n<li><a href=\"#%E7%A2%BA%E3%81%8B%E3%81%AB%E4%BE%BF%E5%88%A9%E3%81%A7%E3%81%AF%E3%81%82%E3%82%8A%E3%81%BE%E3%81%99%E3%81%8C\">確かに便利ではありますが...</a></li>\n<li><a href=\"#%E8%AA%8D%E8%A8%BC\">認証</a></li>\n<li><a href=\"#%E3%82%BF%E3%82%A4%E3%83%A0%E3%82%A2%E3%82%A6%E3%83%88\">タイムアウト</a></li>\n<li><a href=\"#%E7%B5%90%E8%AB%96\">結論</a></li>\n</ul>\n</div>\n<h2 id=\"aws-lambda-function-urls\" style=\"position:relative;\"><a href=\"#aws-lambda-function-urls\" aria-label=\"aws lambda function urls permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>AWS Lambda Function URLs</h2>\n<p><a href=\"https://aws.amazon.com/jp/about-aws/whats-new/2022/04/aws-lambda-function-urls-built-in-https-endpoints/\" target=\"_blank\" rel=\"noopener noreferrer\">AWS Lambda Function URLs</a>がリリースされました!!</p>\n<p>今まではLambdaを使ってHTTPのエンドポイントを作る際は<a href=\"https://docs.aws.amazon.com/ja_jp/lambda/latest/dg/services-apigateway.html\" target=\"_blank\" rel=\"noopener noreferrer\">Amazon API Gateway</a>と組み合わせて作るか<a href=\"https://aws.amazon.com/jp/blogs/news/lambda-functions-as-targets-for-application-load-balancers/\" target=\"_blank\" rel=\"noopener noreferrer\">アプリケーションロードバランサー(ALB)のターゲットにAWS Lambdaを選ぶ</a>かいずれかが必要でした。</p>\n<p>今回のアップデートでAWS Lambdaサービスの組み込み機能として、HTTPSエンドポイントをLambda単体で作成できるのでLambdaでAPIを作ったりWebhookの連携先として機能させる際にAPI Gatewayなどをかませる必要がなくなり便利かと思います。</p>\n<h2 id=\"使ってみる\" style=\"position:relative;\"><a href=\"#%E4%BD%BF%E3%81%A3%E3%81%A6%E3%81%BF%E3%82%8B\" aria-label=\"使ってみる permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>使ってみる</h2>\n<p>使い方は超簡単でLambdaを作る際に関数を作る際に関数URLを有効化にしてあげるだけです。</p>\n<p><img class=\"lozad\" src=\"data:image/gif;base64,R0lGODlhAQABAGAAACH5BAEKAP8ALAAAAAABAAEAAAgEAP8FBAA7\" data-src=\"https://i.imgur.com/tD6NepW.png\" alt=\"コンソール\"></p>\n<p>後々の検証のため次のようなコードをデプロイしてみます。</p>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\"><span class=\"token keyword\">async</span> <span class=\"token keyword\">function</span> <span class=\"token function\">sleep</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">time</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">return</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Promise</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">resolve<span class=\"token punctuation\">,</span> _reject</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n    <span class=\"token function\">setTimeout</span><span class=\"token punctuation\">(</span>resolve<span class=\"token punctuation\">,</span> time<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span>\n\nexports<span class=\"token punctuation\">.</span><span class=\"token function-variable function\">handler</span> <span class=\"token operator\">=</span> <span class=\"token keyword\">async</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">event</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n    console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span>event<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">let</span> sleepTime <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>event<span class=\"token punctuation\">.</span>queryStringParameters <span class=\"token operator\">!==</span> <span class=\"token keyword\">undefined</span> <span class=\"token operator\">&amp;&amp;</span> event<span class=\"token punctuation\">.</span>queryStringParameters<span class=\"token punctuation\">.</span>sleep <span class=\"token operator\">!==</span> <span class=\"token keyword\">undefined</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n      sleepTime <span class=\"token operator\">=</span> <span class=\"token function\">Number</span><span class=\"token punctuation\">(</span>event<span class=\"token punctuation\">.</span>queryStringParameters<span class=\"token punctuation\">.</span>sleep<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n    <span class=\"token keyword\">const</span> response <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token literal-property property\">statusCode</span><span class=\"token operator\">:</span> <span class=\"token number\">200</span><span class=\"token punctuation\">,</span>\n        <span class=\"token literal-property property\">body</span><span class=\"token operator\">:</span> <span class=\"token constant\">JSON</span><span class=\"token punctuation\">.</span><span class=\"token function\">stringify</span><span class=\"token punctuation\">(</span><span class=\"token template-string\"><span class=\"token template-punctuation string\">`</span><span class=\"token string\">Hello from Lambda and sleep </span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">${</span>sleepTime<span class=\"token interpolation-punctuation punctuation\">}</span></span><span class=\"token string\">!!!</span><span class=\"token template-punctuation string\">`</span></span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">await</span> <span class=\"token function\">sleep</span><span class=\"token punctuation\">(</span>sleepTime<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">return</span> response<span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p><img class=\"lozad\" src=\"data:image/gif;base64,R0lGODlhAQABAGAAACH5BAEKAP8ALAAAAAABAAEAAAgEAP8FBAA7\" data-src=\"https://i.imgur.com/Fe6zbrS.png\" alt=\"lambda概要\"></p>\n<p>デプロイできると関数URLが発行されます。</p>\n<p>https://{url-id}.lambda-url-region.on.awsという不思議なTLDのURLができました。</p>\n<p>こちらにアクセスしてみると、</p>\n<p><img class=\"lozad\" src=\"data:image/gif;base64,R0lGODlhAQABAGAAACH5BAEKAP8ALAAAAAABAAEAAAgEAP8FBAA7\" data-src=\"https://i.imgur.com/OaIFZxx.png\" alt=\"ブラウザアクセス\"></p>\n<p>確かにちゃんと関数が実行されてレスポンスが返ってきました！</p>\n<p>また、handlerの引数で取得するeventの中身も、</p>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\"><span class=\"token punctuation\">{</span>\n  <span class=\"token literal-property property\">version</span><span class=\"token operator\">:</span> <span class=\"token string\">'2.0'</span><span class=\"token punctuation\">,</span>\n  <span class=\"token literal-property property\">routeKey</span><span class=\"token operator\">:</span> <span class=\"token string\">'$default'</span><span class=\"token punctuation\">,</span>\n  <span class=\"token literal-property property\">rawPath</span><span class=\"token operator\">:</span> <span class=\"token string\">'/'</span><span class=\"token punctuation\">,</span>\n  <span class=\"token literal-property property\">rawQueryString</span><span class=\"token operator\">:</span> <span class=\"token string\">''</span><span class=\"token punctuation\">,</span>\n  <span class=\"token literal-property property\">headers</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token string-property property\">'sec-fetch-mode'</span><span class=\"token operator\">:</span> <span class=\"token string\">'navigate'</span><span class=\"token punctuation\">,</span>\n    <span class=\"token string-property property\">'sec-fetch-site'</span><span class=\"token operator\">:</span> <span class=\"token string\">'none'</span><span class=\"token punctuation\">,</span>\n    <span class=\"token string-property property\">'accept-language'</span><span class=\"token operator\">:</span> <span class=\"token string\">'ja'</span><span class=\"token punctuation\">,</span>\n    <span class=\"token string-property property\">'x-forwarded-proto'</span><span class=\"token operator\">:</span> <span class=\"token string\">'https'</span><span class=\"token punctuation\">,</span>\n    <span class=\"token string-property property\">'x-forwarded-port'</span><span class=\"token operator\">:</span> <span class=\"token string\">'443'</span><span class=\"token punctuation\">,</span>\n    <span class=\"token literal-property property\">dnt</span><span class=\"token operator\">:</span> <span class=\"token string\">'1'</span><span class=\"token punctuation\">,</span>\n    <span class=\"token string-property property\">'x-forwarded-for'</span><span class=\"token operator\">:</span> <span class=\"token string\">'xxx.xxx.xxx.xxx'</span><span class=\"token punctuation\">,</span>\n    <span class=\"token string-property property\">'sec-fetch-user'</span><span class=\"token operator\">:</span> <span class=\"token string\">'?1'</span><span class=\"token punctuation\">,</span>\n    <span class=\"token literal-property property\">accept</span><span class=\"token operator\">:</span> <span class=\"token string\">'text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3;q=0.9'</span><span class=\"token punctuation\">,</span>\n    <span class=\"token string-property property\">'sec-ch-ua'</span><span class=\"token operator\">:</span> <span class=\"token string\">'\" Not A;Brand\";v=\"99\", \"Chromium\";v=\"100\", \"Google Chrome\";v=\"100\"'</span><span class=\"token punctuation\">,</span>\n    <span class=\"token string-property property\">'sec-ch-ua-mobile'</span><span class=\"token operator\">:</span> <span class=\"token string\">'?0'</span><span class=\"token punctuation\">,</span>\n    <span class=\"token string-property property\">'x-amzn-trace-id'</span><span class=\"token operator\">:</span> <span class=\"token string\">'Root=1-62510b5b-xxxxxxxxxxxxxxxxxxxx'</span><span class=\"token punctuation\">,</span>\n    <span class=\"token string-property property\">'sec-ch-ua-platform'</span><span class=\"token operator\">:</span> <span class=\"token string\">'\"Windows\"'</span><span class=\"token punctuation\">,</span>\n    <span class=\"token literal-property property\">host</span><span class=\"token operator\">:</span> <span class=\"token string\">'xxxxxxxxxxxxxxxxxxxxxxxxx.lambda-url.ap-northeast-1.on.aws'</span><span class=\"token punctuation\">,</span>\n    <span class=\"token string-property property\">'upgrade-insecure-requests'</span><span class=\"token operator\">:</span> <span class=\"token string\">'1'</span><span class=\"token punctuation\">,</span>\n    <span class=\"token string-property property\">'accept-encoding'</span><span class=\"token operator\">:</span> <span class=\"token string\">'gzip, deflate, br'</span><span class=\"token punctuation\">,</span>\n    <span class=\"token string-property property\">'sec-fetch-dest'</span><span class=\"token operator\">:</span> <span class=\"token string\">'document'</span><span class=\"token punctuation\">,</span>\n    <span class=\"token string-property property\">'user-agent'</span><span class=\"token operator\">:</span> <span class=\"token string\">'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/100.0.4896.75 Safari/537.36'</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n  <span class=\"token literal-property property\">requestContext</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token literal-property property\">accountId</span><span class=\"token operator\">:</span> <span class=\"token string\">'anonymous'</span><span class=\"token punctuation\">,</span>\n    <span class=\"token literal-property property\">apiId</span><span class=\"token operator\">:</span> <span class=\"token string\">'xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx'</span><span class=\"token punctuation\">,</span>\n    <span class=\"token literal-property property\">domainName</span><span class=\"token operator\">:</span> <span class=\"token string\">'xxxxxxxxxxxxxxxxxxxxxxxxxx.lambda-url.ap-northeast-1.on.aws'</span><span class=\"token punctuation\">,</span>\n    <span class=\"token literal-property property\">domainPrefix</span><span class=\"token operator\">:</span> <span class=\"token string\">'xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx'</span><span class=\"token punctuation\">,</span>\n    <span class=\"token literal-property property\">http</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token literal-property property\">method</span><span class=\"token operator\">:</span> <span class=\"token string\">'GET'</span><span class=\"token punctuation\">,</span>\n      <span class=\"token literal-property property\">path</span><span class=\"token operator\">:</span> <span class=\"token string\">'/'</span><span class=\"token punctuation\">,</span>\n      <span class=\"token literal-property property\">protocol</span><span class=\"token operator\">:</span> <span class=\"token string\">'HTTP/1.1'</span><span class=\"token punctuation\">,</span>\n      <span class=\"token literal-property property\">sourceIp</span><span class=\"token operator\">:</span> <span class=\"token string\">'xxx.xxx.xxx.xxx'</span><span class=\"token punctuation\">,</span>\n      <span class=\"token literal-property property\">userAgent</span><span class=\"token operator\">:</span> <span class=\"token string\">'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/100.0.4896.75 Safari/537.36'</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n    <span class=\"token literal-property property\">requestId</span><span class=\"token operator\">:</span> <span class=\"token string\">'xxxxxxxxxxxxxxxxxxxxxxxxxxxxxx'</span><span class=\"token punctuation\">,</span>\n    <span class=\"token literal-property property\">routeKey</span><span class=\"token operator\">:</span> <span class=\"token string\">'$default'</span><span class=\"token punctuation\">,</span>\n    <span class=\"token literal-property property\">stage</span><span class=\"token operator\">:</span> <span class=\"token string\">'$default'</span><span class=\"token punctuation\">,</span>\n    <span class=\"token literal-property property\">time</span><span class=\"token operator\">:</span> <span class=\"token string\">'09/Apr/2022:04:28:11 +0000'</span><span class=\"token punctuation\">,</span>\n    <span class=\"token literal-property property\">timeEpoch</span><span class=\"token operator\">:</span> <span class=\"token number\">1649478491452</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n  <span class=\"token literal-property property\">isBase64Encoded</span><span class=\"token operator\">:</span> <span class=\"token boolean\">false</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>みたいな感じで<a href=\"https://docs.aws.amazon.com/ja_jp/lambda/latest/dg/services-apigateway.html#apigateway-example-even\" target=\"_blank\" rel=\"noopener noreferrer\">API Gatewayのイベント形式</a>とよく似てます。</p>\n<p>なので、API Gatewayで動かしていたLambdaの置き換え、みたいなこともそこまで苦労しないかもしれませんね。</p>\n<h2 id=\"確かに便利ではありますが\" style=\"position:relative;\"><a href=\"#%E7%A2%BA%E3%81%8B%E3%81%AB%E4%BE%BF%E5%88%A9%E3%81%A7%E3%81%AF%E3%81%82%E3%82%8A%E3%81%BE%E3%81%99%E3%81%8C\" aria-label=\"確かに便利ではありますが permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>確かに便利ではありますが...</h2>\n<p>実際API Gatewayと組み合わせる構成と比べて、リソースを作るのが楽、以外何がうれしいの？という気はしますのでもう少しDeep Diveしてみたいと思います。</p>\n<h2 id=\"認証\" style=\"position:relative;\"><a href=\"#%E8%AA%8D%E8%A8%BC\" aria-label=\"認証 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>認証</h2>\n<p>認証的な設定は<a href=\"https://docs.aws.amazon.com/lambda/latest/dg/urls-auth.html\" target=\"_blank\" rel=\"noopener noreferrer\">今のところAWS IAM認証</a>がまずサポートされてます。</p>\n<p>クレデンシャルとかから署名バージョン4を作成してアクセス時にして認証させる方法です。</p>\n<p>独自のオーソライザーが挟めないので、あくまでも同じアカウントにアクセスできる開発者向けのAPIとして使うのがよさそうです。もっと込み入ったことがやりたいならAPI Gatewayをおとなしく使いましょう...。(もうちょっと色々試してみます。)</p>\n<p>IAM認証を設定したうえで、署名を付けず未認証の状態でアクセスすると、</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">{\"Message\":\"Forbidden\"}</code></pre></div>\n<p>が返ってきました。</p>\n<h2 id=\"タイムアウト\" style=\"position:relative;\"><a href=\"#%E3%82%BF%E3%82%A4%E3%83%A0%E3%82%A2%E3%82%A6%E3%83%88\" aria-label=\"タイムアウト permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>タイムアウト</h2>\n<p>いよいよ本題です。API GatewayとLambdaの組み合わせを使っているとよく困る話がAPI Gatewayのタイムアウトだと思ってます。</p>\n<p>Lambdaのタイムアウトは15分まで拡張されてますが、API Gatewayの最大統合タイムアウトは30秒でそれを<a href=\"https://docs.aws.amazon.com/ja_jp/apigateway/latest/developerguide/limits.html\" target=\"_blank\" rel=\"noopener noreferrer\">クオータで</a>引き上げることもできないのでAPI Gateway + Lambdaの構成の際はどう頑張ってもAPIが30秒でタイムアウトしないような設計が求められます。</p>\n<p>確かにHTTPで30秒以上かかるようなAPIは非同期APIにして完了をポーリングさせたり、pushさせたりしたほうが正しい設計だと思いますが思いのほか30秒タイムアウトが厳しい...。という経験は多いのではないでしょうか？</p>\n<p>この記事を見たとき私はLambdaにURLエンドポイントがビルトインされるならタイムアウトはLambdanのそれになるのでは？と思いました。実験してみます。</p>\n<p>さきほどデプロイしたコードをもう一度見てみましょう。</p>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\"><span class=\"token keyword\">async</span> <span class=\"token keyword\">function</span> <span class=\"token function\">sleep</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">time</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">return</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Promise</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">resolve<span class=\"token punctuation\">,</span> _reject</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n    <span class=\"token function\">setTimeout</span><span class=\"token punctuation\">(</span>resolve<span class=\"token punctuation\">,</span> time<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span>\n\nexports<span class=\"token punctuation\">.</span><span class=\"token function-variable function\">handler</span> <span class=\"token operator\">=</span> <span class=\"token keyword\">async</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">event</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n    console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span>event<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">let</span> sleepTime <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>event<span class=\"token punctuation\">.</span>queryStringParameters <span class=\"token operator\">!==</span> <span class=\"token keyword\">undefined</span> <span class=\"token operator\">&amp;&amp;</span> event<span class=\"token punctuation\">.</span>queryStringParameters<span class=\"token punctuation\">.</span>sleep <span class=\"token operator\">!==</span> <span class=\"token keyword\">undefined</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n      sleepTime <span class=\"token operator\">=</span> <span class=\"token function\">Number</span><span class=\"token punctuation\">(</span>event<span class=\"token punctuation\">.</span>queryStringParameters<span class=\"token punctuation\">.</span>sleep<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n    <span class=\"token keyword\">const</span> response <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token literal-property property\">statusCode</span><span class=\"token operator\">:</span> <span class=\"token number\">200</span><span class=\"token punctuation\">,</span>\n        <span class=\"token literal-property property\">body</span><span class=\"token operator\">:</span> <span class=\"token constant\">JSON</span><span class=\"token punctuation\">.</span><span class=\"token function\">stringify</span><span class=\"token punctuation\">(</span><span class=\"token template-string\"><span class=\"token template-punctuation string\">`</span><span class=\"token string\">Hello from Lambda and sleep </span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">${</span>sleepTime<span class=\"token interpolation-punctuation punctuation\">}</span></span><span class=\"token string\">!!!</span><span class=\"token template-punctuation string\">`</span></span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">await</span> <span class=\"token function\">sleep</span><span class=\"token punctuation\">(</span>sleepTime<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">return</span> response<span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p>returnの手前でsleep(setTimeout)を入れてます。そしてクエリパラメーターでsleepのミリ秒を指定できるようにしてます。</p>\n<p>まず、何も設定しないときはsleepはしないのですぐレスポンスが返ってきます。</p>\n<p>sleepを1000にすれば1秒待ってレスポンスが返ってきます。</p>\n<p><img class=\"lozad\" src=\"data:image/gif;base64,R0lGODlhAQABAGAAACH5BAEKAP8ALAAAAAABAAEAAAgEAP8FBAA7\" data-src=\"https://i.imgur.com/V6AQ1kl.png\" alt=\"1秒\"></p>\n<p>では、API Gatewayのタイムアウトの30秒に設定してみましょう。(Lambdaのタイムアウトは2分にしてます)</p>\n<p><img class=\"lozad\" src=\"data:image/gif;base64,R0lGODlhAQABAGAAACH5BAEKAP8ALAAAAAABAAEAAAgEAP8FBAA7\" data-src=\"https://i.imgur.com/Jh9cixG.png\" alt=\"30秒\"></p>\n<p>タイムアウトしませんでした!!ではLambdaのタイムアウトまで引き延ばしてみましょう！</p>\n<p><img class=\"lozad\" src=\"data:image/gif;base64,R0lGODlhAQABAGAAACH5BAEKAP8ALAAAAAABAAEAAAgEAP8FBAA7\" data-src=\"https://i.imgur.com/UCbN8Df.png\" alt=\"タイムアウト\"></p>\n<p>Internal Server Errorしました。これは直感的でいいですね。</p>\n<h2 id=\"結論\" style=\"position:relative;\"><a href=\"#%E7%B5%90%E8%AB%96\" aria-label=\"結論 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>結論</h2>\n<p>Lambdaライフを楽しみましょう！</p>","words":1750,"minutes":5}},"staticQueryHashes":["1319877725","2959249232"]}