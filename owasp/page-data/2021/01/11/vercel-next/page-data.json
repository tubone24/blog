{"componentChunkName":"component---src-templates-blog-post-tsx","path":"/2021/01/11/vercel-next","result":{"data":{"content":{"edges":[{"node":{"id":"2864b0d2-d0a2-5cb0-a131-dca7bc8d8482","excerpt":"腰が痛い. Table of Contents AWSのステータス確認難しいよね クビになるぞ！ Next.js Material Table Recoil 思わぬ落とし穴 Material TablesでRecoilが使えない Chart.js Vercel…","fields":{"slug":"2021/01/11/vercel-next"},"frontmatter":{"id":null,"title":"Next.jsとVercelとRecoilとMaterial Tableを使ってAWSのステータスダッシュボードを作ってみた話","slug":"2021/01/11/vercel-next","date":"2021-01-11T13:20:51.060Z","headerImage":"https://i.imgur.com/XblRysI.png","tags":["JavaScript","Next.js","Vercel","Recoil"]}}}]}},"pageContext":{"id":"2864b0d2-d0a2-5cb0-a131-dca7bc8d8482","index":24,"repHtml":"<p>腰が痛い.</p>\n<h2 id=\"table-of-contents\" style=\"position:relative;\"><a href=\"#table-of-contents\" aria-label=\"table of contents permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Table of Contents</h2>\n<div class=\"toc\">\n<ul>\n<li><a href=\"#aws%E3%81%AE%E3%82%B9%E3%83%86%E3%83%BC%E3%82%BF%E3%82%B9%E7%A2%BA%E8%AA%8D%E9%9B%A3%E3%81%97%E3%81%84%E3%82%88%E3%81%AD\">AWSのステータス確認難しいよね</a></li>\n<li><a href=\"#%E3%82%AF%E3%83%93%E3%81%AB%E3%81%AA%E3%82%8B%E3%81%9E\">クビになるぞ！</a></li>\n<li><a href=\"#nextjs\">Next.js</a></li>\n<li><a href=\"#material-table\">Material Table</a></li>\n<li><a href=\"#recoil\">Recoil</a></li>\n<li><a href=\"#%E6%80%9D%E3%82%8F%E3%81%AC%E8%90%BD%E3%81%A8%E3%81%97%E7%A9%B4-material-tables%E3%81%A7recoil%E3%81%8C%E4%BD%BF%E3%81%88%E3%81%AA%E3%81%84\">思わぬ落とし穴 Material TablesでRecoilが使えない</a></li>\n<li><a href=\"#chartjs\">Chart.js</a></li>\n<li><a href=\"#vercel%E3%81%AB%E3%83%87%E3%83%97%E3%83%AD%E3%82%A4\">Vercelにデプロイ</a></li>\n<li><a href=\"#%E5%AE%8C%E6%88%90\">完成</a></li>\n<li><a href=\"#%E3%81%BE%E3%81%A8%E3%82%81\">まとめ</a></li>\n<li><a href=\"#20210220%E8%BF%BD%E8%A8%98\">2021/02/20追記</a></li>\n</ul>\n</div>\n<h2 id=\"awsのステータス確認難しいよね\" style=\"position:relative;\"><a href=\"#aws%E3%81%AE%E3%82%B9%E3%83%86%E3%83%BC%E3%82%BF%E3%82%B9%E7%A2%BA%E8%AA%8D%E9%9B%A3%E3%81%97%E3%81%84%E3%82%88%E3%81%AD\" aria-label=\"awsのステータス確認難しいよね permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>AWSのステータス確認難しいよね</h2>\n<p>AWSを使ったことのある人ならばわかると思いますが、公式がAWSの障害情報を掲載する<a href=\"https://status.aws.amazon.com/\" target=\"_blank\" rel=\"noopener noreferrer\">AWS Service Health Dashboard</a>があまり使いやすくないです。</p>\n<p><img class=\"lozad\" src=\"data:image/gif;base64,R0lGODlhAQABAGAAACH5BAEKAP8ALAAAAAABAAEAAAgEAP8FBAA7\" data-src=\"https://i.imgur.com/XghDulZ.png\" alt=\"img\"></p>\n<p>それぞれのリージョンの障害がRSSで配信される形式になっているのですが、わざわざRSSを登録するのもめんどくさい。Slackとかの連携に乗っけるのもそれはそれで便利なのですが、そもそもSlackを見ていないほかの人でも障害情報を共有したいです。</p>\n<p>実は、AWS Service Health Dashboardの情報はJSONで取得できます。</p>\n<p><a href=\"https://status.aws.amazon.com/data.json\" target=\"_blank\" rel=\"noopener noreferrer\">https://status.aws.amazon.com/data.json</a></p>\n<p>こちらのJSONを活用して勉強がてら使いやすいダッシュボードを作っていきます。</p>\n<h2 id=\"クビになるぞ\" style=\"position:relative;\"><a href=\"#%E3%82%AF%E3%83%93%E3%81%AB%E3%81%AA%E3%82%8B%E3%81%9E\" aria-label=\"クビになるぞ permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>クビになるぞ！</h2>\n<p>最近、これといった新しい技術に触れておらず、このままだとクビになりそうなので、そろそろ重い腰を上げてNext.jsを勉強することにしました。</p>\n<p>また、Next.jsを使う場合はVercelが便利だよーとのことですので、こちらも使っていきます。</p>\n<h2 id=\"nextjs\" style=\"position:relative;\"><a href=\"#nextjs\" aria-label=\"nextjs permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Next.js</h2>\n<p>Next.jsではpages/api配下に格納したコードについては、サーバーサイドとして振る舞います。</p>\n<p>クライアントから直接status情報がかかれたJSONを読みとってもよかったのですが、HTMLの面倒なサニタイジング処理やら、値の補完など面倒なことはサーバーサイドに持ってこようということで、\r\nstatusJSONを取得して、フロントに返却するサーバーコードを書いていきます。</p>\n<p>次のようなコードになりました。</p>\n<div class=\"gatsby-highlight\" data-language=\"typescript\"><pre class=\"language-typescript\"><code class=\"language-typescript\"><span class=\"token keyword\">import</span> <span class=\"token punctuation\">{</span> NextApiRequest<span class=\"token punctuation\">,</span> NextApiResponse <span class=\"token punctuation\">}</span> <span class=\"token keyword\">from</span> <span class=\"token string\">'next'</span>\r\n<span class=\"token keyword\">import</span> axios <span class=\"token keyword\">from</span> <span class=\"token string\">'axios'</span>\r\n\r\n<span class=\"token keyword\">export</span> <span class=\"token keyword\">interface</span> <span class=\"token class-name\">AwsStatusResp</span> <span class=\"token punctuation\">{</span>\r\n  archive<span class=\"token operator\">:</span> AwsStatusArchive<span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span>\r\n<span class=\"token punctuation\">}</span>\r\n\r\n<span class=\"token keyword\">export</span> <span class=\"token keyword\">interface</span> <span class=\"token class-name\">AwsStatusArchive</span> <span class=\"token punctuation\">{</span>\r\n  service_name<span class=\"token operator\">:</span> <span class=\"token builtin\">string</span>\r\n  summary<span class=\"token operator\">:</span> <span class=\"token builtin\">string</span>\r\n  date<span class=\"token operator\">:</span> <span class=\"token builtin\">string</span>\r\n  status<span class=\"token operator\">:</span> <span class=\"token builtin\">string</span>\r\n  details<span class=\"token operator\">:</span> <span class=\"token builtin\">string</span>\r\n  description<span class=\"token operator\">:</span> <span class=\"token builtin\">string</span>\r\n  service<span class=\"token operator\">:</span> <span class=\"token builtin\">string</span>\r\n<span class=\"token punctuation\">}</span>\r\n\r\n<span class=\"token keyword\">const</span> <span class=\"token function-variable function\">handler</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span>req<span class=\"token operator\">:</span> NextApiRequest<span class=\"token punctuation\">,</span> res<span class=\"token operator\">:</span> NextApiResponse<span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\r\n  axios\r\n    <span class=\"token punctuation\">.</span><span class=\"token generic-function\"><span class=\"token function\">get</span><span class=\"token generic class-name\"><span class=\"token operator\">&lt;</span>AwsStatusResp<span class=\"token operator\">></span></span></span><span class=\"token punctuation\">(</span><span class=\"token string\">'https://status.aws.amazon.com/data.json'</span><span class=\"token punctuation\">)</span>\r\n    <span class=\"token punctuation\">.</span><span class=\"token function\">then</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>resp<span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\r\n      <span class=\"token keyword\">const</span> handlerResp <span class=\"token operator\">=</span> resp<span class=\"token punctuation\">.</span>data<span class=\"token punctuation\">.</span>archive<span class=\"token punctuation\">.</span><span class=\"token function\">map</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>x<span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span>\r\n        <span class=\"token comment\">// eslint-disable-next-line @typescript-eslint/camelcase</span>\r\n        service_name<span class=\"token operator\">:</span> x<span class=\"token punctuation\">.</span>service_name<span class=\"token punctuation\">,</span>\r\n        summary<span class=\"token operator\">:</span> x<span class=\"token punctuation\">.</span>summary<span class=\"token punctuation\">,</span>\r\n        region<span class=\"token operator\">:</span> x<span class=\"token punctuation\">.</span>service<span class=\"token punctuation\">.</span><span class=\"token function\">includes</span><span class=\"token punctuation\">(</span><span class=\"token string\">'management-console'</span><span class=\"token punctuation\">)</span>\r\n          <span class=\"token operator\">?</span> <span class=\"token string\">'global'</span>\r\n          <span class=\"token operator\">:</span> x<span class=\"token punctuation\">.</span>service<span class=\"token punctuation\">.</span><span class=\"token function\">split</span><span class=\"token punctuation\">(</span><span class=\"token string\">'-'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">slice</span><span class=\"token punctuation\">(</span><span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">join</span><span class=\"token punctuation\">(</span><span class=\"token string\">'-'</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">===</span> <span class=\"token string\">''</span>\r\n          <span class=\"token operator\">?</span> <span class=\"token string\">'global'</span>\r\n          <span class=\"token operator\">:</span> x<span class=\"token punctuation\">.</span>service<span class=\"token punctuation\">.</span><span class=\"token function\">split</span><span class=\"token punctuation\">(</span><span class=\"token string\">'-'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">slice</span><span class=\"token punctuation\">(</span><span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">join</span><span class=\"token punctuation\">(</span><span class=\"token string\">'-'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\r\n        date<span class=\"token operator\">:</span> x<span class=\"token punctuation\">.</span>date<span class=\"token punctuation\">,</span>\r\n        status<span class=\"token operator\">:</span> x<span class=\"token punctuation\">.</span>status<span class=\"token punctuation\">,</span>\r\n        details<span class=\"token operator\">:</span> x<span class=\"token punctuation\">.</span>details<span class=\"token punctuation\">,</span>\r\n        service<span class=\"token operator\">:</span> x<span class=\"token punctuation\">.</span>service<span class=\"token punctuation\">.</span><span class=\"token function\">includes</span><span class=\"token punctuation\">(</span><span class=\"token string\">'management-console'</span><span class=\"token punctuation\">)</span>\r\n          <span class=\"token operator\">?</span> <span class=\"token string\">'management-console'</span>\r\n          <span class=\"token operator\">:</span> x<span class=\"token punctuation\">.</span>service<span class=\"token punctuation\">.</span><span class=\"token function\">split</span><span class=\"token punctuation\">(</span><span class=\"token string\">'-'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>\r\n        description<span class=\"token operator\">:</span> x<span class=\"token punctuation\">.</span>description\r\n          <span class=\"token punctuation\">.</span><span class=\"token function\">replace</span><span class=\"token punctuation\">(</span><span class=\"token regex\"><span class=\"token regex-delimiter\">/</span><span class=\"token regex-source language-regex\">&lt;(\"[^\"]*\"|'[^']*'|[^'\">])*></span><span class=\"token regex-delimiter\">/</span><span class=\"token regex-flags\">g</span></span><span class=\"token punctuation\">,</span> <span class=\"token string\">''</span><span class=\"token punctuation\">)</span>\r\n          <span class=\"token punctuation\">.</span><span class=\"token function\">replace</span><span class=\"token punctuation\">(</span><span class=\"token regex\"><span class=\"token regex-delimiter\">/</span><span class=\"token regex-source language-regex\">&amp;nbsp;</span><span class=\"token regex-delimiter\">/</span><span class=\"token regex-flags\">g</span></span><span class=\"token punctuation\">,</span> <span class=\"token string\">'\\n'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\r\n      <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\r\n      res<span class=\"token punctuation\">.</span>statusCode <span class=\"token operator\">=</span> <span class=\"token number\">200</span>\r\n      <span class=\"token comment\">// eslint-disable-next-line no-console</span>\r\n      <span class=\"token builtin\">console</span><span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span>handlerResp<span class=\"token punctuation\">)</span>\r\n      res<span class=\"token punctuation\">.</span><span class=\"token function\">json</span><span class=\"token punctuation\">(</span>handlerResp<span class=\"token punctuation\">)</span>\r\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\r\n    <span class=\"token punctuation\">.</span><span class=\"token function\">catch</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>error<span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\r\n      <span class=\"token builtin\">console</span><span class=\"token punctuation\">.</span><span class=\"token function\">error</span><span class=\"token punctuation\">(</span>error<span class=\"token punctuation\">.</span>response<span class=\"token punctuation\">)</span>\r\n      res<span class=\"token punctuation\">.</span>statusCode <span class=\"token operator\">=</span> error<span class=\"token punctuation\">.</span>response<span class=\"token punctuation\">.</span>status <span class=\"token operator\">||</span> <span class=\"token number\">500</span>\r\n      res<span class=\"token punctuation\">.</span>statusMessage <span class=\"token operator\">=</span> error<span class=\"token punctuation\">.</span>response<span class=\"token punctuation\">.</span>statusText <span class=\"token operator\">||</span> <span class=\"token string\">'InternalServerError'</span>\r\n      res<span class=\"token punctuation\">.</span><span class=\"token function\">json</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span> error<span class=\"token operator\">:</span> error<span class=\"token punctuation\">.</span>response<span class=\"token punctuation\">.</span>statusText <span class=\"token operator\">||</span> <span class=\"token string\">'InternalServerError'</span> <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\r\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\r\n<span class=\"token punctuation\">}</span>\r\n\r\n<span class=\"token keyword\">export</span> <span class=\"token keyword\">default</span> handler</code></pre></div>\n<p>注意点として、必ずハンドラーはexport defaultを指定してあげないこと以外はいたって直感的なコードとなっております。</p>\n<p>Vercelに載っけるとわかるのですが、こちらのコード、Lambdaにデプロイされることになります。たしかに見覚えある感じですね。</p>\n<p>また、Next.jsと関係ないのですが、axiosのレスポンスに型がつけられるって知ってましたか？</p>\n<div class=\"gatsby-highlight\" data-language=\"typescript\"><pre class=\"language-typescript\"><code class=\"language-typescript\"><span class=\"token keyword\">export</span> <span class=\"token keyword\">interface</span> <span class=\"token class-name\">AwsStatusResp</span> <span class=\"token punctuation\">{</span>\r\n  archive<span class=\"token operator\">:</span> AwsStatusArchive<span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span>\r\n<span class=\"token punctuation\">}</span>\r\n\r\n<span class=\"token keyword\">export</span> <span class=\"token keyword\">interface</span> <span class=\"token class-name\">AwsStatusArchive</span> <span class=\"token punctuation\">{</span>\r\n  service_name<span class=\"token operator\">:</span> <span class=\"token builtin\">string</span>\r\n  summary<span class=\"token operator\">:</span> <span class=\"token builtin\">string</span>\r\n  date<span class=\"token operator\">:</span> <span class=\"token builtin\">string</span>\r\n  status<span class=\"token operator\">:</span> <span class=\"token builtin\">string</span>\r\n  details<span class=\"token operator\">:</span> <span class=\"token builtin\">string</span>\r\n  description<span class=\"token operator\">:</span> <span class=\"token builtin\">string</span>\r\n  service<span class=\"token operator\">:</span> <span class=\"token builtin\">string</span>\r\n<span class=\"token punctuation\">}</span>\r\n\r\n  axios\r\n    <span class=\"token punctuation\">.</span><span class=\"token generic-function\"><span class=\"token function\">get</span><span class=\"token generic class-name\"><span class=\"token operator\">&lt;</span>AwsStatusResp<span class=\"token operator\">></span></span></span><span class=\"token punctuation\">(</span><span class=\"token string\">'https://status.aws.amazon.com/data.json'</span><span class=\"token punctuation\">)</span>\r\n    <span class=\"token punctuation\">.</span><span class=\"token function\">then</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>resp<span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span> <span class=\"token operator\">...</span><span class=\"token operator\">...</span><span class=\"token operator\">...</span><span class=\"token punctuation\">.</span></code></pre></div>\n<h2 id=\"material-table\" style=\"position:relative;\"><a href=\"#material-table\" aria-label=\"material table permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Material Table</h2>\n<p>Material UI準拠のテーブルとして、Material Tableなるものがありましたので今回採用することにしました。</p>\n<div class=\"gatsby-highlight\" data-language=\"typescript\"><pre class=\"language-typescript\"><code class=\"language-typescript\"><span class=\"token keyword\">import</span> MaterialTable <span class=\"token keyword\">from</span> <span class=\"token string\">'material-table'</span>\r\n<span class=\"token keyword\">import</span> tableIcons <span class=\"token keyword\">from</span> <span class=\"token string\">'../components/tableIcons'</span>\r\n\r\n<span class=\"token operator\">&lt;</span>MaterialTable\r\n          icons<span class=\"token operator\">=</span><span class=\"token punctuation\">{</span>tableIcons<span class=\"token punctuation\">}</span>\r\n          columns<span class=\"token operator\">=</span><span class=\"token punctuation\">{</span><span class=\"token punctuation\">[</span>\r\n            <span class=\"token punctuation\">{</span> title<span class=\"token operator\">:</span> <span class=\"token string\">'Service Name'</span><span class=\"token punctuation\">,</span> field<span class=\"token operator\">:</span> <span class=\"token string\">'service_name'</span> <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\r\n            <span class=\"token punctuation\">{</span> title<span class=\"token operator\">:</span> <span class=\"token string\">'Service'</span><span class=\"token punctuation\">,</span> field<span class=\"token operator\">:</span> <span class=\"token string\">'service'</span><span class=\"token punctuation\">,</span> width<span class=\"token operator\">:</span> <span class=\"token number\">10</span> <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\r\n            <span class=\"token punctuation\">{</span> title<span class=\"token operator\">:</span> <span class=\"token string\">'Region'</span><span class=\"token punctuation\">,</span> field<span class=\"token operator\">:</span> <span class=\"token string\">'region'</span><span class=\"token punctuation\">,</span> lookup<span class=\"token operator\">:</span> regionNameMapping <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\r\n            <span class=\"token punctuation\">{</span> title<span class=\"token operator\">:</span> <span class=\"token string\">'Summary'</span><span class=\"token punctuation\">,</span> field<span class=\"token operator\">:</span> <span class=\"token string\">'summary'</span> <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\r\n            <span class=\"token punctuation\">{</span>\r\n              title<span class=\"token operator\">:</span> <span class=\"token string\">'Date ('</span> <span class=\"token operator\">+</span> dayjs<span class=\"token punctuation\">.</span>tz<span class=\"token punctuation\">.</span><span class=\"token function\">guess</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">+</span> <span class=\"token string\">')'</span><span class=\"token punctuation\">,</span>\r\n              field<span class=\"token operator\">:</span> <span class=\"token string\">'date'</span><span class=\"token punctuation\">,</span>\r\n              <span class=\"token function-variable function\">render</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">(</span>rowData<span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">(</span>\r\n                <span class=\"token operator\">&lt;</span>div<span class=\"token operator\">></span>\r\n                  <span class=\"token punctuation\">{</span>dayjs\r\n                    <span class=\"token punctuation\">.</span><span class=\"token function\">unix</span><span class=\"token punctuation\">(</span><span class=\"token function\">Number</span><span class=\"token punctuation\">(</span>rowData<span class=\"token punctuation\">.</span>date<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\r\n                    <span class=\"token punctuation\">.</span><span class=\"token function\">format</span><span class=\"token punctuation\">(</span><span class=\"token string\">'YYYY-MM-DDTHH:mm:ssZ[Z]'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">}</span>\r\n                <span class=\"token operator\">&lt;</span><span class=\"token operator\">/</span>div<span class=\"token operator\">></span>\r\n              <span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\r\n              defaultSort<span class=\"token operator\">:</span> <span class=\"token string\">'desc'</span><span class=\"token punctuation\">,</span>\r\n              type<span class=\"token operator\">:</span> <span class=\"token string\">'string'</span><span class=\"token punctuation\">,</span>\r\n            <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\r\n            <span class=\"token punctuation\">{</span>\r\n              title<span class=\"token operator\">:</span> <span class=\"token string\">'Status'</span><span class=\"token punctuation\">,</span>\r\n              field<span class=\"token operator\">:</span> <span class=\"token string\">'status'</span><span class=\"token punctuation\">,</span>\r\n              lookup<span class=\"token operator\">:</span> statusMapping<span class=\"token punctuation\">,</span>\r\n            <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\r\n          <span class=\"token punctuation\">]</span><span class=\"token punctuation\">}</span>\r\n          data<span class=\"token operator\">=</span><span class=\"token punctuation\">{</span>aws<span class=\"token punctuation\">}</span>\r\n          detailPanel<span class=\"token operator\">=</span><span class=\"token punctuation\">{</span><span class=\"token punctuation\">[</span>\r\n            <span class=\"token punctuation\">{</span>\r\n              tooltip<span class=\"token operator\">:</span> <span class=\"token string\">'Details'</span><span class=\"token punctuation\">,</span>\r\n              <span class=\"token function-variable function\">render</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">(</span>rowData<span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\r\n                <span class=\"token keyword\">return</span> <span class=\"token punctuation\">(</span>\r\n                  <span class=\"token operator\">&lt;</span><span class=\"token operator\">></span>\r\n                    <span class=\"token operator\">&lt;</span>div className<span class=\"token operator\">=</span><span class=\"token string\">\"title\"</span><span class=\"token operator\">></span><span class=\"token punctuation\">{</span>rowData<span class=\"token punctuation\">.</span>summary<span class=\"token punctuation\">}</span><span class=\"token operator\">&lt;</span><span class=\"token operator\">/</span>div<span class=\"token operator\">></span>\r\n                    <span class=\"token operator\">&lt;</span>div className<span class=\"token operator\">=</span><span class=\"token string\">\"description\"</span><span class=\"token operator\">></span>\r\n                      <span class=\"token punctuation\">{</span>dayjs\r\n                        <span class=\"token punctuation\">.</span><span class=\"token function\">unix</span><span class=\"token punctuation\">(</span><span class=\"token function\">Number</span><span class=\"token punctuation\">(</span>rowData<span class=\"token punctuation\">.</span>date<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\r\n                        <span class=\"token punctuation\">.</span><span class=\"token function\">format</span><span class=\"token punctuation\">(</span><span class=\"token string\">'YYYY-MM-DDTHH:mm:ss'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">{</span><span class=\"token string\">' '</span><span class=\"token punctuation\">}</span>\r\n                      <span class=\"token punctuation\">{</span>rowData<span class=\"token punctuation\">.</span>service_name<span class=\"token punctuation\">}</span>\r\n                    <span class=\"token operator\">&lt;</span><span class=\"token operator\">/</span>div<span class=\"token operator\">></span>\r\n                    <span class=\"token operator\">&lt;</span>div className<span class=\"token operator\">=</span><span class=\"token string\">\"code\"</span><span class=\"token operator\">></span><span class=\"token punctuation\">{</span>rowData<span class=\"token punctuation\">.</span>description<span class=\"token punctuation\">}</span><span class=\"token operator\">&lt;</span><span class=\"token operator\">/</span>div<span class=\"token operator\">></span>\r\n                  <span class=\"token operator\">&lt;</span><span class=\"token operator\">/</span><span class=\"token operator\">></span>\r\n                <span class=\"token punctuation\">)</span>\r\n              <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\r\n            <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\r\n          <span class=\"token punctuation\">]</span><span class=\"token punctuation\">}</span>\r\n          options<span class=\"token operator\">=</span><span class=\"token punctuation\">{</span><span class=\"token punctuation\">{</span>\r\n            filtering<span class=\"token operator\">:</span> <span class=\"token boolean\">true</span><span class=\"token punctuation\">,</span>\r\n            grouping<span class=\"token operator\">:</span> <span class=\"token boolean\">true</span><span class=\"token punctuation\">,</span>\r\n            exportButton<span class=\"token operator\">:</span> <span class=\"token boolean\">true</span><span class=\"token punctuation\">,</span>\r\n            exportFileName<span class=\"token operator\">:</span> <span class=\"token string\">'exported'</span><span class=\"token punctuation\">,</span>\r\n            headerStyle<span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>\r\n              backgroundColor<span class=\"token operator\">:</span> <span class=\"token string\">'#e77f2f'</span><span class=\"token punctuation\">,</span>\r\n              color<span class=\"token operator\">:</span> <span class=\"token string\">'#FFF'</span><span class=\"token punctuation\">,</span>\r\n            <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\r\n          <span class=\"token punctuation\">}</span><span class=\"token punctuation\">}</span>\r\n          isLoading<span class=\"token operator\">=</span><span class=\"token punctuation\">{</span>loading<span class=\"token punctuation\">}</span>\r\n          actions<span class=\"token operator\">=</span><span class=\"token punctuation\">{</span><span class=\"token punctuation\">[</span>\r\n            <span class=\"token punctuation\">{</span>\r\n              <span class=\"token comment\">// Issue: https://github.com/mbrn/material-table/issues/51</span>\r\n              <span class=\"token comment\">//@ts-ignore</span>\r\n              icon<span class=\"token operator\">:</span> tableIcons<span class=\"token punctuation\">.</span>BarChartIcon<span class=\"token punctuation\">,</span>\r\n              tooltip<span class=\"token operator\">:</span> <span class=\"token string\">'Show Bar Chart'</span><span class=\"token punctuation\">,</span>\r\n              isFreeAction<span class=\"token operator\">:</span> <span class=\"token boolean\">true</span><span class=\"token punctuation\">,</span>\r\n              disabled<span class=\"token operator\">:</span> loading<span class=\"token punctuation\">,</span>\r\n              <span class=\"token function-variable function\">onClick</span><span class=\"token operator\">:</span> <span class=\"token keyword\">async</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\r\n                <span class=\"token function\">setShowGraph</span><span class=\"token punctuation\">(</span><span class=\"token operator\">!</span>showG<span class=\"token punctuation\">)</span>\r\n              <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\r\n            <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\r\n            <span class=\"token punctuation\">{</span>\r\n              <span class=\"token comment\">// Issue: https://github.com/mbrn/material-table/issues/51</span>\r\n              <span class=\"token comment\">//@ts-ignore</span>\r\n              icon<span class=\"token operator\">:</span> tableIcons<span class=\"token punctuation\">.</span>Refresh<span class=\"token punctuation\">,</span>\r\n              tooltip<span class=\"token operator\">:</span> <span class=\"token string\">'Refresh Data'</span><span class=\"token punctuation\">,</span>\r\n              isFreeAction<span class=\"token operator\">:</span> <span class=\"token boolean\">true</span><span class=\"token punctuation\">,</span>\r\n              disabled<span class=\"token operator\">:</span> loading<span class=\"token punctuation\">,</span>\r\n              <span class=\"token function-variable function\">onClick</span><span class=\"token operator\">:</span> <span class=\"token keyword\">async</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\r\n                <span class=\"token function\">setLoading</span><span class=\"token punctuation\">(</span><span class=\"token boolean\">true</span><span class=\"token punctuation\">)</span>\r\n                <span class=\"token keyword\">await</span> <span class=\"token function\">getAwsStatus</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\r\n              <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\r\n            <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\r\n          <span class=\"token punctuation\">]</span><span class=\"token punctuation\">}</span>\r\n          title<span class=\"token operator\">=</span><span class=\"token punctuation\">{</span>\r\n            <span class=\"token operator\">&lt;</span>div className<span class=\"token operator\">=</span><span class=\"token string\">\"header\"</span><span class=\"token operator\">></span>\r\n              <span class=\"token operator\">&lt;</span>img src<span class=\"token operator\">=</span><span class=\"token string\">\"/awslogo.png\"</span> <span class=\"token operator\">/</span><span class=\"token operator\">></span>\r\n              <span class=\"token operator\">&lt;</span>a href<span class=\"token operator\">=</span><span class=\"token string\">\"https://aws-health-dashboard.vercel.app/\"</span><span class=\"token operator\">></span>\r\n                <span class=\"token constant\">AWS</span> Health Dashboard\r\n              <span class=\"token operator\">&lt;</span><span class=\"token operator\">/</span>a<span class=\"token operator\">></span>\r\n            <span class=\"token operator\">&lt;</span><span class=\"token operator\">/</span>div<span class=\"token operator\">></span>\r\n          <span class=\"token punctuation\">}</span>\r\n        <span class=\"token operator\">/</span><span class=\"token operator\">></span></code></pre></div>\n<p>使い方もシンプルかつ比較的高機能でいい感じです。</p>\n<p>いい感じですが後述するRecoilとの相性問題とDatetimeの扱いが微妙なのがツラミでした。</p>\n<p>本当はDate型を渡してあげるとSearchableの際、カレンダーでの絞り込みができるのかなと思ったのですが、こちらがうまくいきませんでした。</p>\n<p>あと、微妙に型もおかしく例えば、actionsはactionを複数指定できるはずですが、型チェックで怒られるので、仕方なくts-ignoreしてます。</p>\n<p>あなたが直せばいいじゃんアゼルバイジャンって言われそうですが、めんどくさくなってしまいIssueだけあげてしまいました。申し訳ねぇ...。</p>\n<p><a href=\"https://github.com/mbrn/material-table/issues/2762\" target=\"_blank\" rel=\"noopener noreferrer\">https://github.com/mbrn/material-table/issues/2762</a></p>\n<h2 id=\"recoil\" style=\"position:relative;\"><a href=\"#recoil\" aria-label=\"recoil permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recoil</h2>\n<p>RecoilとはReactの新しい状態管理ライブラリで、いわゆるReact HooksでGlobal Storeを作ろうというものです。</p>\n<p>基本的な使い方はまず、storeとしてatomという共有ステートを作成します。</p>\n<p>atomのkeyはプロジェクトで一意にする必要がありますが、今回はそこまで大規模なプロジェクトではないのでawsとかいう適当な名をつけてます。</p>\n<p>storeなので、store/aws.tsとして格納します。</p>\n<div class=\"gatsby-highlight\" data-language=\"typescript\"><pre class=\"language-typescript\"><code class=\"language-typescript\"><span class=\"token keyword\">import</span> <span class=\"token punctuation\">{</span> atom <span class=\"token punctuation\">}</span> <span class=\"token keyword\">from</span> <span class=\"token string\">'recoil'</span>\r\n\r\n<span class=\"token keyword\">const</span> awsState <span class=\"token operator\">=</span> <span class=\"token function\">atom</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span>\r\n  key<span class=\"token operator\">:</span> <span class=\"token string\">'aws'</span><span class=\"token punctuation\">,</span>\r\n  <span class=\"token keyword\">default</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span>\r\n    <span class=\"token punctuation\">{</span>\r\n      <span class=\"token comment\">// eslint-disable-next-line @typescript-eslint/camelcase</span>\r\n      service_name<span class=\"token operator\">:</span> <span class=\"token string\">'Auto Scaling (N. Virginia)'</span><span class=\"token punctuation\">,</span>\r\n      summary<span class=\"token operator\">:</span> <span class=\"token string\">'[RESOLVED] Example Error'</span><span class=\"token punctuation\">,</span>\r\n      date<span class=\"token operator\">:</span> <span class=\"token string\">'1542849575'</span><span class=\"token punctuation\">,</span>\r\n      status<span class=\"token operator\">:</span> <span class=\"token string\">'1'</span><span class=\"token punctuation\">,</span>\r\n      details<span class=\"token operator\">:</span> <span class=\"token string\">''</span><span class=\"token punctuation\">,</span>\r\n      description<span class=\"token operator\">:</span>\r\n        <span class=\"token string\">'The issue has been resolved and the service is operating normally.'</span><span class=\"token punctuation\">,</span>\r\n      service<span class=\"token operator\">:</span> <span class=\"token string\">'autoscaling'</span><span class=\"token punctuation\">,</span>\r\n      region<span class=\"token operator\">:</span> <span class=\"token string\">'us-east-1'</span><span class=\"token punctuation\">,</span>\r\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\r\n  <span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>\r\n  dangerouslyAllowMutability<span class=\"token operator\">:</span> <span class=\"token boolean\">true</span><span class=\"token punctuation\">,</span>\r\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\r\n\r\n<span class=\"token keyword\">export</span> <span class=\"token keyword\">default</span> awsState</code></pre></div>\n<p>次にステートを共有したいコンポーネントのルートにRecoilRootを設置します。</p>\n<p>Next.jsの場合、_app.tsxが全ページのルートにあたるのでここに置けばいいですね。</p>\n<div class=\"gatsby-highlight\" data-language=\"typescript\"><pre class=\"language-typescript\"><code class=\"language-typescript\"><span class=\"token keyword\">import</span> <span class=\"token punctuation\">{</span> AppProps <span class=\"token punctuation\">}</span> <span class=\"token keyword\">from</span> <span class=\"token string\">'next/app'</span>\r\n<span class=\"token keyword\">import</span> Head <span class=\"token keyword\">from</span> <span class=\"token string\">'next/head'</span>\r\n<span class=\"token keyword\">import</span> <span class=\"token punctuation\">{</span> RecoilRoot <span class=\"token punctuation\">}</span> <span class=\"token keyword\">from</span> <span class=\"token string\">'recoil'</span>\r\n<span class=\"token keyword\">import</span> React <span class=\"token keyword\">from</span> <span class=\"token string\">'react'</span>\r\n\r\n<span class=\"token keyword\">const</span> <span class=\"token function-variable function\">App</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span> Component<span class=\"token punctuation\">,</span> pageProps <span class=\"token punctuation\">}</span><span class=\"token operator\">:</span> AppProps<span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">(</span>\r\n  <span class=\"token operator\">&lt;</span><span class=\"token operator\">></span>\r\n    <span class=\"token operator\">&lt;</span>RecoilRoot<span class=\"token operator\">></span>\r\n      <span class=\"token operator\">&lt;</span>Head<span class=\"token operator\">></span>\r\n        <span class=\"token operator\">&lt;</span>meta\r\n          name<span class=\"token operator\">=</span><span class=\"token string\">\"viewport\"</span>\r\n          content<span class=\"token operator\">=</span><span class=\"token string\">\"width=device-width, initial-scale=1, shrink-to-fit=no\"</span>\r\n        <span class=\"token operator\">/</span><span class=\"token operator\">></span>\r\n        <span class=\"token operator\">&lt;</span>title<span class=\"token operator\">></span><span class=\"token constant\">AWS</span> Health Dashboard<span class=\"token operator\">&lt;</span><span class=\"token operator\">/</span>title<span class=\"token operator\">></span>\r\n      <span class=\"token operator\">&lt;</span><span class=\"token operator\">/</span>Head<span class=\"token operator\">></span>\r\n      <span class=\"token operator\">&lt;</span>Component <span class=\"token punctuation\">{</span><span class=\"token operator\">...</span>pageProps<span class=\"token punctuation\">}</span> <span class=\"token operator\">/</span><span class=\"token operator\">></span>\r\n    <span class=\"token operator\">&lt;</span><span class=\"token operator\">/</span>RecoilRoot<span class=\"token operator\">></span>\r\n  <span class=\"token operator\">&lt;</span><span class=\"token operator\">/</span><span class=\"token operator\">></span>\r\n<span class=\"token punctuation\">)</span>\r\n\r\n<span class=\"token keyword\">export</span> <span class=\"token keyword\">default</span> App</code></pre></div>\n<p>そして、利用するときはuseRecoilStateをReact Hooksのように利用するだけです。簡単ですね。</p>\n<div class=\"gatsby-highlight\" data-language=\"typescript\"><pre class=\"language-typescript\"><code class=\"language-typescript\"><span class=\"token keyword\">import</span> React<span class=\"token punctuation\">,</span> <span class=\"token punctuation\">{</span> useState<span class=\"token punctuation\">,</span> useEffect <span class=\"token punctuation\">}</span> <span class=\"token keyword\">from</span> <span class=\"token string\">'react'</span>\r\n<span class=\"token keyword\">import</span> <span class=\"token punctuation\">{</span> useRecoilState <span class=\"token punctuation\">}</span> <span class=\"token keyword\">from</span> <span class=\"token string\">'recoil'</span>\r\n<span class=\"token keyword\">import</span> awsState <span class=\"token keyword\">from</span> <span class=\"token string\">'../store/aws'</span>\r\n<span class=\"token keyword\">import</span> showGraph <span class=\"token keyword\">from</span> <span class=\"token string\">'../store/showGraph'</span>\r\n<span class=\"token keyword\">import</span> axios <span class=\"token keyword\">from</span> <span class=\"token string\">'axios'</span>\r\n<span class=\"token keyword\">import</span> dayjs <span class=\"token keyword\">from</span> <span class=\"token string\">'dayjs'</span>\r\n\r\ndayjs<span class=\"token punctuation\">.</span><span class=\"token function\">extend</span><span class=\"token punctuation\">(</span>utc<span class=\"token punctuation\">)</span>\r\ndayjs<span class=\"token punctuation\">.</span><span class=\"token function\">extend</span><span class=\"token punctuation\">(</span>timezone<span class=\"token punctuation\">)</span>\r\n\r\n<span class=\"token keyword\">const</span> <span class=\"token function-variable function\">Alert</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span>props<span class=\"token operator\">:</span> AlertProps<span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\r\n  <span class=\"token keyword\">return</span> <span class=\"token operator\">&lt;</span>MuiAlert elevation<span class=\"token operator\">=</span><span class=\"token punctuation\">{</span><span class=\"token number\">6</span><span class=\"token punctuation\">}</span> variant<span class=\"token operator\">=</span><span class=\"token string\">\"filled\"</span> <span class=\"token punctuation\">{</span><span class=\"token operator\">...</span>props<span class=\"token punctuation\">}</span> <span class=\"token operator\">/</span><span class=\"token operator\">></span>\r\n<span class=\"token punctuation\">}</span>\r\n\r\n<span class=\"token keyword\">export</span> <span class=\"token keyword\">const</span> Table <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token operator\">:</span> <span class=\"token constant\">JSX</span><span class=\"token punctuation\">.</span>Element <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\r\n  <span class=\"token comment\">// 20200112: dangerouslyAllowMutabilityでできた</span>\r\n  <span class=\"token keyword\">const</span> <span class=\"token punctuation\">[</span>aws<span class=\"token punctuation\">,</span> setAws<span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token function\">useRecoilState</span><span class=\"token punctuation\">(</span>awsState<span class=\"token punctuation\">)</span>\r\n  <span class=\"token keyword\">const</span> <span class=\"token punctuation\">[</span>showG<span class=\"token punctuation\">,</span> setShowGraph<span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token function\">useRecoilState</span><span class=\"token punctuation\">(</span>showGraph<span class=\"token punctuation\">)</span>\r\n  <span class=\"token keyword\">const</span> <span class=\"token punctuation\">[</span>loading<span class=\"token punctuation\">,</span> setLoading<span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token function\">useState</span><span class=\"token punctuation\">(</span><span class=\"token boolean\">true</span><span class=\"token punctuation\">)</span>\r\n  <span class=\"token keyword\">const</span> <span class=\"token punctuation\">[</span>slackBarOpen<span class=\"token punctuation\">,</span> setSlackBarOpen<span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> React<span class=\"token punctuation\">.</span><span class=\"token function\">useState</span><span class=\"token punctuation\">(</span><span class=\"token boolean\">false</span><span class=\"token punctuation\">)</span>\r\n  <span class=\"token keyword\">const</span> <span class=\"token punctuation\">[</span>apiErrorMsg<span class=\"token punctuation\">,</span> setApiErrorMsg<span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> React<span class=\"token punctuation\">.</span><span class=\"token function\">useState</span><span class=\"token punctuation\">(</span><span class=\"token string\">''</span><span class=\"token punctuation\">)</span>\r\n  <span class=\"token function\">useEffect</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\r\n    <span class=\"token function\">getAwsStatus</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\r\n    <span class=\"token function\">setLoading</span><span class=\"token punctuation\">(</span><span class=\"token boolean\">false</span><span class=\"token punctuation\">)</span>\r\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span>\r\n  <span class=\"token keyword\">const</span> <span class=\"token function-variable function\">getAwsStatus</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\r\n    axios\r\n      <span class=\"token punctuation\">.</span><span class=\"token function\">get</span><span class=\"token punctuation\">(</span><span class=\"token string\">'/api/aws'</span><span class=\"token punctuation\">)</span>\r\n      <span class=\"token punctuation\">.</span><span class=\"token function\">then</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>resp<span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\r\n        <span class=\"token function\">setAws</span><span class=\"token punctuation\">(</span>resp<span class=\"token punctuation\">.</span>data<span class=\"token punctuation\">)</span>\r\n        <span class=\"token function\">setLoading</span><span class=\"token punctuation\">(</span><span class=\"token boolean\">false</span><span class=\"token punctuation\">)</span>\r\n      <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\r\n      <span class=\"token punctuation\">.</span><span class=\"token function\">catch</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>error<span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\r\n        <span class=\"token builtin\">console</span><span class=\"token punctuation\">.</span><span class=\"token function\">error</span><span class=\"token punctuation\">(</span>error<span class=\"token punctuation\">.</span>response<span class=\"token punctuation\">)</span>\r\n        <span class=\"token function\">setSlackBarOpen</span><span class=\"token punctuation\">(</span><span class=\"token boolean\">true</span><span class=\"token punctuation\">)</span>\r\n        <span class=\"token function\">setApiErrorMsg</span><span class=\"token punctuation\">(</span>error<span class=\"token punctuation\">.</span>response<span class=\"token punctuation\">.</span>statusText <span class=\"token operator\">||</span> <span class=\"token string\">'Error'</span><span class=\"token punctuation\">)</span>\r\n        <span class=\"token function\">setAws</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span>\r\n        <span class=\"token function\">setLoading</span><span class=\"token punctuation\">(</span><span class=\"token boolean\">false</span><span class=\"token punctuation\">)</span>\r\n      <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\r\n  <span class=\"token punctuation\">}</span></code></pre></div>\n<p>stateの読み込みはgetterから、書き込みはsetterから行います。</p>\n<p>React Hooksに慣れていれば簡単ですね。</p>\n<h2 id=\"思わぬ落とし穴-material-tablesでrecoilが使えない\" style=\"position:relative;\"><a href=\"#%E6%80%9D%E3%82%8F%E3%81%AC%E8%90%BD%E3%81%A8%E3%81%97%E7%A9%B4-material-tables%E3%81%A7recoil%E3%81%8C%E4%BD%BF%E3%81%88%E3%81%AA%E3%81%84\" aria-label=\"思わぬ落とし穴 material tablesでrecoilが使えない permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>思わぬ落とし穴 Material TablesでRecoilが使えない</h2>\n<p>Recoilのatomは基本値の書き換えはset stateを使うことが求められます。ですが、material tablesはテーブルを作るときにdataにIDの書き込みが発生するようでそのままだと怒られてしまいます。</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">Cannot add property tableData, object is not extensible</code></pre></div>\n<p>これの解決策はRecoilにstateへの直接的な書き換えを許可することです。こちらはatomのoptionでdangerouslyAllowMutabilityを有効にすることで解決できます。</p>\n<div class=\"gatsby-highlight\" data-language=\"typescript\"><pre class=\"language-typescript\"><code class=\"language-typescript\"><span class=\"token keyword\">import</span> <span class=\"token punctuation\">{</span> atom <span class=\"token punctuation\">}</span> <span class=\"token keyword\">from</span> <span class=\"token string\">'recoil'</span>\r\n\r\n<span class=\"token keyword\">const</span> awsState <span class=\"token operator\">=</span> <span class=\"token function\">atom</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span>\r\n  key<span class=\"token operator\">:</span> <span class=\"token string\">'aws'</span><span class=\"token punctuation\">,</span>\r\n  <span class=\"token keyword\">default</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span>\r\n    <span class=\"token punctuation\">{</span>\r\n\r\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\r\n  <span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>\r\n  dangerouslyAllowMutability<span class=\"token operator\">:</span> <span class=\"token boolean\">true</span><span class=\"token punctuation\">,</span>\r\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span></code></pre></div>\n<p>これがわかるのに半日くらい使っちまいました。</p>\n<h2 id=\"chartjs\" style=\"position:relative;\"><a href=\"#chartjs\" aria-label=\"chartjs permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Chart.js</h2>\n<p>さて、無事にRecoilでstateの共有ができたのでせっかくなので別コンポーネントも作ります。</p>\n<p>意味があるかどうか不明ですが、AWSの障害発生状況を可視化してみようと思います。</p>\n<p>ということで、採用したのがChart.js。</p>\n<p>次のようにデータを渡すだけできれいめなグラフを書いてくれます。</p>\n<div class=\"gatsby-highlight\" data-language=\"typescript\"><pre class=\"language-typescript\"><code class=\"language-typescript\"><span class=\"token keyword\">import</span> <span class=\"token punctuation\">{</span> useRecoilValue <span class=\"token punctuation\">}</span> <span class=\"token keyword\">from</span> <span class=\"token string\">'recoil'</span>\r\n<span class=\"token keyword\">import</span> awsState <span class=\"token keyword\">from</span> <span class=\"token string\">'../store/aws'</span>\r\n<span class=\"token keyword\">import</span> React <span class=\"token keyword\">from</span> <span class=\"token string\">'react'</span>\r\n<span class=\"token keyword\">import</span> <span class=\"token punctuation\">{</span>\r\n  regionNameMapping<span class=\"token punctuation\">,</span>\r\n<span class=\"token punctuation\">}</span> <span class=\"token keyword\">from</span> <span class=\"token string\">'./const'</span>\r\n<span class=\"token keyword\">import</span> BarGraph <span class=\"token keyword\">from</span> <span class=\"token string\">'./barGraph'</span>\r\n\r\n<span class=\"token keyword\">export</span> <span class=\"token keyword\">const</span> AlertPerRegion <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token operator\">:</span> <span class=\"token constant\">JSX</span><span class=\"token punctuation\">.</span>Element <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\r\n\r\n  <span class=\"token keyword\">const</span> aws <span class=\"token operator\">=</span> <span class=\"token function\">useRecoilValue</span><span class=\"token punctuation\">(</span>awsState<span class=\"token punctuation\">)</span>\r\n  <span class=\"token keyword\">const</span> labels <span class=\"token operator\">=</span> <span class=\"token builtin\">Array</span><span class=\"token punctuation\">.</span><span class=\"token function\">from</span><span class=\"token punctuation\">(</span>\r\n    <span class=\"token keyword\">new</span> <span class=\"token class-name\">Set</span><span class=\"token punctuation\">(</span>aws<span class=\"token punctuation\">.</span><span class=\"token function\">map</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>data<span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> regionNameMapping<span class=\"token punctuation\">[</span>data<span class=\"token punctuation\">.</span>region<span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\r\n  <span class=\"token punctuation\">)</span>\r\n  <span class=\"token keyword\">const</span> data <span class=\"token operator\">=</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span>\r\n  <span class=\"token keyword\">for</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">const</span> r <span class=\"token keyword\">of</span> labels<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\r\n    data<span class=\"token punctuation\">.</span><span class=\"token function\">push</span><span class=\"token punctuation\">(</span>\r\n      aws\r\n        <span class=\"token punctuation\">.</span><span class=\"token function\">map</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>data<span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> regionNameMapping<span class=\"token punctuation\">[</span>data<span class=\"token punctuation\">.</span>region<span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span>\r\n        <span class=\"token punctuation\">.</span><span class=\"token function\">reduce</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>total<span class=\"token punctuation\">,</span> x<span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\r\n          <span class=\"token keyword\">return</span> x <span class=\"token operator\">===</span> r <span class=\"token operator\">?</span> total <span class=\"token operator\">+</span> <span class=\"token number\">1</span> <span class=\"token operator\">:</span> total\r\n        <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span>\r\n    <span class=\"token punctuation\">)</span>\r\n  <span class=\"token punctuation\">}</span>\r\n  <span class=\"token keyword\">return</span> <span class=\"token punctuation\">(</span>\r\n    <span class=\"token operator\">&lt;</span>div className<span class=\"token operator\">=</span><span class=\"token string\">\"container\"</span><span class=\"token operator\">></span>\r\n      <span class=\"token operator\">&lt;</span>BarGraph labels<span class=\"token operator\">=</span><span class=\"token punctuation\">{</span>labels<span class=\"token punctuation\">}</span> data<span class=\"token operator\">=</span><span class=\"token punctuation\">{</span>data<span class=\"token punctuation\">}</span> title<span class=\"token operator\">=</span><span class=\"token string\">\"Alert per region\"</span> <span class=\"token operator\">/</span><span class=\"token operator\">></span>\r\n    <span class=\"token operator\">&lt;</span><span class=\"token operator\">/</span>div<span class=\"token operator\">></span>\r\n  <span class=\"token punctuation\">)</span>\r\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>どうでもいい実装ですが、各グラフを一覧で見れる画面を用意し、実際のグラフは遷移先で表示するようにしてます。</p>\n<p><img class=\"lozad\" src=\"data:image/gif;base64,R0lGODlhAQABAGAAACH5BAEKAP8ALAAAAAABAAEAAAgEAP8FBAA7\" data-src=\"https://i.imgur.com/tfnpq4w.png\" alt=\"img\"></p>\n<p><img class=\"lozad\" src=\"data:image/gif;base64,R0lGODlhAQABAGAAACH5BAEKAP8ALAAAAAABAAEAAAgEAP8FBAA7\" data-src=\"https://i.imgur.com/hpJ70fR.png\" alt=\"img\"></p>\n<h2 id=\"vercelにデプロイ\" style=\"position:relative;\"><a href=\"#vercel%E3%81%AB%E3%83%87%E3%83%97%E3%83%AD%E3%82%A4\" aria-label=\"vercelにデプロイ permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Vercelにデプロイ</h2>\n<p>さて、実装ができたので後はVercelにあげるだけです。</p>\n<p>もうここはほとんど書くことがないのですが、Next.jsで作ったアプリケーションはVercelでレポジトリと使っているフレームワークを設定するだけで簡単にデプロイできてしまいます。</p>\n<p>これはすごい。</p>\n<h2 id=\"完成\" style=\"position:relative;\"><a href=\"#%E5%AE%8C%E6%88%90\" aria-label=\"完成 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>完成</h2>\n<p>ということで、AWS Health Dashboardが完成しました。</p>\n<p>アクセスすると、Next.jsのapiをコールし、AWSのstatusを取得加工したものを返却します。</p>\n<p>フロントでは受け取ったデータをRecoilのatomに格納しつつ、material tableで表として描画します。</p>\n<p>また右上のグラフボタンを押すことで色々な切り口の可視化を行なうことができます。</p>\n<p><a href=\"https://aws-health-dashboard.vercel.app/\" target=\"_blank\" rel=\"noopener noreferrer\">https://aws-health-dashboard.vercel.app/</a></p>\n<p>できれば使う場面にならないことを祈りつつ、ご活用いただければとおもいます。</p>\n<h2 id=\"まとめ\" style=\"position:relative;\"><a href=\"#%E3%81%BE%E3%81%A8%E3%82%81\" aria-label=\"まとめ permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>まとめ</h2>\n<p>食わず嫌いでやらなかったNext.js+Recoilをやってみましたが、楽しく実装ができました。</p>\n<h2 id=\"20210220追記\" style=\"position:relative;\"><a href=\"#20210220%E8%BF%BD%E8%A8%98\" aria-label=\"20210220追記 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>2021/02/20追記</h2>\n<p>2021/02/19～20にかけて起きた<a href=\"https://status.aws.amazon.com/rss/ec2-ap-northeast-1.rss\" target=\"_blank\" rel=\"noopener noreferrer\">AWS EC2障害</a>ですが、本ダッシュボードでは更新がされませんでした。</p>\n<p>どうやら、data.jsonはRSSとは違い、同期的に更新されないようです。</p>\n<p>大変ご迷惑をおかけしました。あらためて、改修しRSS更新にも対応できるように頑張ります。</p>","words":2872,"minutes":8}},"staticQueryHashes":["1319877725","2959249232"]}