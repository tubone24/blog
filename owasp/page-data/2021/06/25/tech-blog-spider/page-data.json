{"componentChunkName":"component---src-templates-blog-post-tsx","path":"/2021/06/25/tech-blog-spider","result":{"data":{"content":{"edges":[{"node":{"id":"405541f2-306e-5f7e-82ec-5b2eb1c64caa","excerpt":"貧乏人はつらいです。 Table of Contents 皆さん、どうやって技術ネタ、キャッチアップしてますか？ 皆さん、どうやってブログ記事を通知してますか？ 問題点 IFTTTはどうなの？ じゃあ作ろっか feedparser ステート管理 HarperDB OGP…","fields":{"slug":"2021/06/25/tech-blog-spider"},"frontmatter":{"id":null,"title":"スーパー完全無料でRSSをSlackに投稿できるやつを作った","slug":"2021/06/25/tech-blog-spider","date":"2021-06-25T11:59:57.951Z","headerImage":"https://i.imgur.com/Ip4IaYs.png","tags":["RSS","HarperDB","feedparser","termextract"]}}}]}},"pageContext":{"id":"405541f2-306e-5f7e-82ec-5b2eb1c64caa","index":19,"repHtml":"<p>貧乏人はつらいです。</p>\n<h2 id=\"table-of-contents\" style=\"position:relative;\"><a href=\"#table-of-contents\" aria-label=\"table of contents permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Table of Contents</h2>\n<div class=\"toc\">\n<ul>\n<li>\n<p><a href=\"#%E7%9A%86%E3%81%95%E3%82%93%E3%81%A9%E3%81%86%E3%82%84%E3%81%A3%E3%81%A6%E6%8A%80%E8%A1%93%E3%83%8D%E3%82%BF%E3%82%AD%E3%83%A3%E3%83%83%E3%83%81%E3%82%A2%E3%83%83%E3%83%97%E3%81%97%E3%81%A6%E3%81%BE%E3%81%99%E3%81%8B\">皆さん、どうやって技術ネタ、キャッチアップしてますか？</a></p>\n</li>\n<li>\n<p><a href=\"#%E7%9A%86%E3%81%95%E3%82%93%E3%81%A9%E3%81%86%E3%82%84%E3%81%A3%E3%81%A6%E3%83%96%E3%83%AD%E3%82%B0%E8%A8%98%E4%BA%8B%E3%82%92%E9%80%9A%E7%9F%A5%E3%81%97%E3%81%A6%E3%81%BE%E3%81%99%E3%81%8B\">皆さん、どうやってブログ記事を通知してますか？</a></p>\n</li>\n<li>\n<p><a href=\"#%E5%95%8F%E9%A1%8C%E7%82%B9\">問題点</a></p>\n<ul>\n<li><a href=\"#ifttt%E3%81%AF%E3%81%A9%E3%81%86%E3%81%AA%E3%81%AE\">IFTTTはどうなの？</a></li>\n</ul>\n</li>\n<li>\n<p><a href=\"#%E3%81%98%E3%82%83%E3%81%82%E4%BD%9C%E3%82%8D%E3%81%A3%E3%81%8B\">じゃあ作ろっか</a></p>\n</li>\n<li>\n<p><a href=\"#feedparser\">feedparser</a></p>\n</li>\n<li>\n<p><a href=\"#%E3%82%B9%E3%83%86%E3%83%BC%E3%83%88%E7%AE%A1%E7%90%86\">ステート管理</a></p>\n<ul>\n<li><a href=\"#harperdb\">HarperDB</a></li>\n</ul>\n</li>\n<li>\n<p><a href=\"#ogp%E7%94%BB%E5%83%8F%E3%82%92%E5%BE%97%E3%82%8B%E3%81%AB%E3%81%AF\">OGP画像を得るには？</a></p>\n<ul>\n<li><a href=\"#opengraph-py3\">opengraph-py3</a></li>\n</ul>\n</li>\n<li>\n<p><a href=\"#favicon\">Favicon</a></p>\n</li>\n<li>\n<p><a href=\"#%E3%82%AD%E3%83%BC%E3%83%AF%E3%83%BC%E3%83%89%E6%8A%BD%E5%87%BA\">キーワード抽出</a></p>\n<ul>\n<li><a href=\"#rss%E3%81%AEsummarytext%E3%81%A7%E3%81%AF%E7%B2%BE%E5%BA%A6%E3%81%8C%E3%81%A7%E3%81%AA%E3%81%84%E3%81%9D%E3%82%8A%E3%82%83%E3%81%9D%E3%81%86%E3%81%98%E3%82%83\">RSSのSummaryTextでは精度がでない、そりゃそうじゃ。</a></li>\n</ul>\n</li>\n<li>\n<p><a href=\"#slack%E6%8A%95%E7%A8%BF\">Slack投稿</a></p>\n</li>\n<li>\n<p><a href=\"#github-actions%E5%8C%96\">GitHub Actions化</a></p>\n</li>\n<li>\n<p><a href=\"#%E5%AE%8C%E6%88%90\">完成</a></p>\n</li>\n<li>\n<p><a href=\"#%E7%B5%90%E8%AB%96\">結論</a></p>\n</li>\n</ul>\n</div>\n<h2 id=\"皆さんどうやって技術ネタキャッチアップしてますか\" style=\"position:relative;\"><a href=\"#%E7%9A%86%E3%81%95%E3%82%93%E3%81%A9%E3%81%86%E3%82%84%E3%81%A3%E3%81%A6%E6%8A%80%E8%A1%93%E3%83%8D%E3%82%BF%E3%82%AD%E3%83%A3%E3%83%83%E3%83%81%E3%82%A2%E3%83%83%E3%83%97%E3%81%97%E3%81%A6%E3%81%BE%E3%81%99%E3%81%8B\" aria-label=\"皆さんどうやって技術ネタキャッチアップしてますか permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>皆さん、どうやって技術ネタ、キャッチアップしてますか？</h2>\n<p>皆さんはどうやって日々日進月歩な技術ネタをキャッチアップしてますか？</p>\n<p>私はよく企業や個人が書いている技術ブログから情報を得ることが多いです。本当に技術ブログって手軽なのにすごい勉強になりますよね。</p>\n<h2 id=\"皆さんどうやってブログ記事を通知してますか\" style=\"position:relative;\"><a href=\"#%E7%9A%86%E3%81%95%E3%82%93%E3%81%A9%E3%81%86%E3%82%84%E3%81%A3%E3%81%A6%E3%83%96%E3%83%AD%E3%82%B0%E8%A8%98%E4%BA%8B%E3%82%92%E9%80%9A%E7%9F%A5%E3%81%97%E3%81%A6%E3%81%BE%E3%81%99%E3%81%8B\" aria-label=\"皆さんどうやってブログ記事を通知してますか permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>皆さん、どうやってブログ記事を通知してますか？</h2>\n<p>ブログ記事確認はもちろん定期的にブログに訪問するのが一番ですが、なかなか時間の取れない中でそれは酷なので何かしら皆さん工夫していると思います。</p>\n<p>ブログの更新にあわせてTwitterを更新してくれる企業様であれば、Twitterのフォローをすればいいかもしれませんが、必ずしもそうでもないかもしれませんし、Twitterのフォローには技術以外の話題も飛び交うので、集中して記事を確認することも難しいかもしれません。</p>\n<p>そういったときに役立つのがRSSです。RSSとは<strong>R</strong>ich <strong>S</strong>ite <strong>S</strong>ummaryの略で、ニュースやブログなど各種のWebサイトの更新情報を配信するための仕組みやXMLフォーマットのことです。</p>\n<p>RSSの更新を定期的に取得し、記事更新を教えてくれるRSSリーダーは皆さんお世話になっている人も多いのではないでしょうか？</p>\n<p>私もGoogle Chromeに拡張としてRSSリーダーを入れていた時期もありました。</p>\n<h2 id=\"問題点\" style=\"position:relative;\"><a href=\"#%E5%95%8F%E9%A1%8C%E7%82%B9\" aria-label=\"問題点 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>問題点</h2>\n<p>RSSリーダーを使って技術ブログの更新を検知する方法はおそらくデファクトスタンダードだと思いますが、個人的にちょっと問題点がありました。</p>\n<p>それは、<strong>通勤時間の時間をうまく使ってキャッチアップするのが面倒ということです。</strong></p>\n<ul>\n<li>携帯にPCと同じRSSを登録するのがめんどくさい</li>\n<li>RSSリーダーを開かない\n<ul>\n<li>電車に乗っているとTwitterやSlackを開いている時間がほぼすべて</li>\n<li>Kindleで読書するのも細かく乗り換えがあって中断が多く発生するためストレス</li>\n</ul>\n</li>\n<li>(RSSリーダーによって違うのかもしれませんが)タイトルを見て中身を判断するのが難しい</li>\n</ul>\n<p>このような悩みがあるため、私は<strong>Slack</strong>の**/feed**機能を使ってRSSを購読してました。</p>\n<p>が、しかしこれもまたもや問題点。Slackの無料ワークスペースには、Appsが10個までしか登録できないのです。(/feedもAppsを消費します)</p>\n<p>Slackには他にもAppsをいくつか作って入れているため、実際登録できるRSSは5個くらいになってしまいちょっと心もとない感じになってしまいました。</p>\n<h3 id=\"iftttはどうなの\" style=\"position:relative;\"><a href=\"#ifttt%E3%81%AF%E3%81%A9%E3%81%86%E3%81%AA%E3%81%AE\" aria-label=\"iftttはどうなの permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>IFTTTはどうなの？</h3>\n<p>ちょっと詳しい人だと「じゃあIFTTT」はどうなんです？という意見が聞こえてきそうですが結果的にこちらも不採用。</p>\n<p>理由は上記とほぼ同じで、無料版だと設定できる数に制限があるためこちらもあえなく不採用。</p>\n<p>というより、お金出せよって声が聞こえてきますね。</p>\n<h2 id=\"じゃあ作ろっか\" style=\"position:relative;\"><a href=\"#%E3%81%98%E3%82%83%E3%81%82%E4%BD%9C%E3%82%8D%E3%81%A3%E3%81%8B\" aria-label=\"じゃあ作ろっか permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>じゃあ作ろっか</h2>\n<p>ということで、作ります。</p>\n<p>要求は次の通りのことを満たす必要があります。</p>\n<ul>\n<li>無制限にRSSを登録できること</li>\n<li>更新がある場合のみSlackに投稿すること</li>\n<li>SlackもAppsを消費しないこと(Custom Integration)</li>\n<li>できれば内容を要約したものや、OGP画像も一緒に投稿して記事の選別に役立てられる付加機能を作ること</li>\n</ul>\n<h2 id=\"feedparser\" style=\"position:relative;\"><a href=\"#feedparser\" aria-label=\"feedparser permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>feedparser</h2>\n<p>今回は時間もない中だったのでサクッとPythonで作っていきます。</p>\n<p>RSSの購読には<a href=\"https://pythonhosted.org/feedparser/\" target=\"_blank\" rel=\"noopener noreferrer\">feedparser</a>を使うと便利です。</p>\n<p>RSS2.0だけでなく、Atomや古いRSSの形式でも難なく読み込んでくれます。</p>\n<div class=\"gatsby-highlight\" data-language=\"python\"><pre class=\"language-python\"><code class=\"language-python\"><span class=\"token keyword\">import</span> feedparser\nentries <span class=\"token operator\">=</span> feedparser<span class=\"token punctuation\">.</span>parse<span class=\"token punctuation\">(</span><span class=\"token string\">'http://feedparser.org/docs/examples/rss20.xml'</span><span class=\"token punctuation\">)</span>\n<span class=\"token keyword\">for</span> e <span class=\"token keyword\">in</span> entries<span class=\"token punctuation\">:</span>\n    <span class=\"token keyword\">print</span><span class=\"token punctuation\">(</span>e<span class=\"token punctuation\">.</span>title<span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">print</span><span class=\"token punctuation\">(</span>e<span class=\"token punctuation\">.</span>link<span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">print</span><span class=\"token punctuation\">(</span>e<span class=\"token punctuation\">.</span>summary<span class=\"token punctuation\">)</span></code></pre></div>\n<p>Entry Itemへのアクセスはイテレーターになっているので取り出しもかんたんです。</p>\n<p>RSSのEntry Itemの取り出しはこれで進めます。本当にかんたんでありがたい。</p>\n<p>さらに便利なのは<strong>published_parsed</strong>という項目がEntry Itemから取れます。</p>\n<p>こちら、RSSのpublished_dateをdatetimeオブジェクトにパースしてくれます。</p>\n<p>おかげで、フォーマット差分をあまり意識することなく、更新差分チェック実装ができました。</p>\n<h2 id=\"ステート管理\" style=\"position:relative;\"><a href=\"#%E3%82%B9%E3%83%86%E3%83%BC%E3%83%88%E7%AE%A1%E7%90%86\" aria-label=\"ステート管理 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>ステート管理</h2>\n<p>RSSには記事の作成日付(Publish Date)があり、RSSの取得のたびに差分チェックとして活用できます。</p>\n<p>なので、以前取得した記事のPublish Dateを記憶して、更新があった場合のみ記事を取得するようにしたいのですが、それには何かしらのDB、もしくはデータ保存する仕組みが必要となります。</p>\n<p>今回は無料という縛りがあるため、当初はGitHubのレポジトリ上にステートファイルをコミットするようにしようとも思ったのですが、コミットが伸び過ぎてしまうのは色々問題なのでやはりDBを使いたいです。</p>\n<h3 id=\"harperdb\" style=\"position:relative;\"><a href=\"#harperdb\" aria-label=\"harperdb permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>HarperDB</h3>\n<p>HarperDBは、データ管理を容易にすることに重点を置いた分散型データベースで、ジョインを含むNoSQLとSQLをサポートしています。</p>\n<p>NoSQLでSQLがかけるのは便利ですね!!</p>\n<p>日本ではあまり聞きませんが、<a href=\"https://dev.to/\" target=\"_blank\" rel=\"noopener noreferrer\">dev.to</a>とかだとちょこちょこ話題に上がっております。</p>\n<p>こちらのHarperDB、HarperDB Cloud Instanceというマネージドサービスも提供されており、インスタンスタイプを選ぶだけで、手軽にHarperDBを使うことができるようになっております。</p>\n<p><img class=\"lozad\" src=\"data:image/gif;base64,R0lGODlhAQABAGAAACH5BAEKAP8ALAAAAAABAAEAAAgEAP8FBAA7\" data-src=\"https://i.imgur.com/CA1sLCU.png\" alt=\"harperdb\"></p>\n<p><img class=\"lozad\" src=\"data:image/gif;base64,R0lGODlhAQABAGAAACH5BAEKAP8ALAAAAAABAAEAAAgEAP8FBAA7\" data-src=\"https://i.imgur.com/48qXVQw.png\" alt=\"img\"></p>\n<p>え？でもお高いんじゃない？そんな声が聞こえてきますね。</p>\n<p>なんと、今だけかもしれませんがHarperDB Cloud Instanceの一番最小のInstance構成だと無料で使うことができます！これは嬉しいですね。</p>\n<table>\n<thead>\n<tr>\n<th>Name</th>\n<th>Value</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>RAM</td>\n<td>0.5GB</td>\n</tr>\n<tr>\n<td>DISK</td>\n<td>1GB</td>\n</tr>\n<tr>\n<td>VERSION</td>\n<td>3.0.0</td>\n</tr>\n<tr>\n<td>IOPS</td>\n<td>3000</td>\n</tr>\n</tbody>\n</table>\n<p>正直今回の使い方ではこのレベルで十分です。</p>\n<p>Python上でのHarperDB操作も<a href=\"https://pypi.org/project/harperdb/\" target=\"_blank\" rel=\"noopener noreferrer\">専用のライブラリ</a>が用意されているためかんたんに実装できます。</p>\n<div class=\"gatsby-highlight\" data-language=\"python\"><pre class=\"language-python\"><code class=\"language-python\">HARPERDB_URL <span class=\"token operator\">=</span> os<span class=\"token punctuation\">.</span>getenv<span class=\"token punctuation\">(</span><span class=\"token string\">\"HARPERDB_URL\"</span><span class=\"token punctuation\">)</span>\nHARPERDB_USERNAME <span class=\"token operator\">=</span> os<span class=\"token punctuation\">.</span>getenv<span class=\"token punctuation\">(</span><span class=\"token string\">\"HARPERDB_USERNAME\"</span><span class=\"token punctuation\">)</span>\nHARPERDB_PASSWORD <span class=\"token operator\">=</span> os<span class=\"token punctuation\">.</span>getenv<span class=\"token punctuation\">(</span><span class=\"token string\">\"HARPERDB_PASSWORD\"</span><span class=\"token punctuation\">)</span>\nHARPERDB_SCHEMA <span class=\"token operator\">=</span> os<span class=\"token punctuation\">.</span>getenv<span class=\"token punctuation\">(</span><span class=\"token string\">\"HARPERDB_SCHEMA\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"prd\"</span><span class=\"token punctuation\">)</span>\nFILEPATH <span class=\"token operator\">=</span> <span class=\"token string\">\"entry.csv\"</span>\n\ndb <span class=\"token operator\">=</span> harperdb<span class=\"token punctuation\">.</span>HarperDB<span class=\"token punctuation\">(</span>\n    url<span class=\"token operator\">=</span>HARPERDB_URL<span class=\"token punctuation\">,</span>\n    username<span class=\"token operator\">=</span>HARPERDB_USERNAME<span class=\"token punctuation\">,</span>\n    password<span class=\"token operator\">=</span>HARPERDB_PASSWORD<span class=\"token punctuation\">,</span><span class=\"token punctuation\">)</span>\n\ntest <span class=\"token operator\">=</span> db<span class=\"token punctuation\">.</span>search_by_hash<span class=\"token punctuation\">(</span>HARPERDB_SCHEMA<span class=\"token punctuation\">,</span> <span class=\"token string\">\"last_published\"</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">[</span>name<span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span> get_attributes<span class=\"token operator\">=</span><span class=\"token punctuation\">[</span><span class=\"token string\">\"time\"</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span>\n<span class=\"token keyword\">for</span> t <span class=\"token keyword\">in</span> test<span class=\"token punctuation\">:</span>\n    <span class=\"token keyword\">print</span><span class=\"token punctuation\">(</span>t<span class=\"token punctuation\">[</span><span class=\"token string\">\"time\"</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span></code></pre></div>\n<p>このようにNoSQLライクにHash Attributeを使って検索する感じで実装できます。もちろんValue引きも可能です。(遅くなるのかは不明だがNoSQLなら全走査になりそうなので多分遅い)</p>\n<p>UpdateやInsertも同様な感じで実施できます。</p>\n<div class=\"gatsby-highlight\" data-language=\"python\"><pre class=\"language-python\"><code class=\"language-python\">ef insert_last_published<span class=\"token punctuation\">(</span>name<span class=\"token punctuation\">:</span> <span class=\"token builtin\">str</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n    db<span class=\"token punctuation\">.</span>insert<span class=\"token punctuation\">(</span>HARPERDB_SCHEMA<span class=\"token punctuation\">,</span> <span class=\"token string\">\"last_published\"</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">{</span><span class=\"token string\">\"name\"</span><span class=\"token punctuation\">:</span> name<span class=\"token punctuation\">,</span> <span class=\"token string\">\"time\"</span><span class=\"token punctuation\">:</span> <span class=\"token number\">123456789</span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">return</span> <span class=\"token number\">123456789</span>\n\n\n<span class=\"token keyword\">def</span> <span class=\"token function\">update_last_published</span><span class=\"token punctuation\">(</span>name<span class=\"token punctuation\">:</span> <span class=\"token builtin\">str</span><span class=\"token punctuation\">,</span> time<span class=\"token punctuation\">:</span> <span class=\"token builtin\">int</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n    result <span class=\"token operator\">=</span> db<span class=\"token punctuation\">.</span>update<span class=\"token punctuation\">(</span>HARPERDB_SCHEMA<span class=\"token punctuation\">,</span> <span class=\"token string\">\"last_published\"</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">{</span><span class=\"token string\">\"name\"</span><span class=\"token punctuation\">:</span> name<span class=\"token punctuation\">,</span> <span class=\"token string\">\"time\"</span><span class=\"token punctuation\">:</span> time<span class=\"token punctuation\">}</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">return</span> result</code></pre></div>\n<p>また、便利だなと思ったのはやはりSQLでの走査です。</p>\n<div class=\"gatsby-highlight\" data-language=\"python\"><pre class=\"language-python\"><code class=\"language-python\"><span class=\"token keyword\">def</span> <span class=\"token function\">get_entry_urls</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n    <span class=\"token keyword\">return</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">{</span><span class=\"token string\">\"name\"</span><span class=\"token punctuation\">:</span> x<span class=\"token punctuation\">[</span><span class=\"token string\">\"name\"</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>\n             <span class=\"token string\">\"url\"</span><span class=\"token punctuation\">:</span> x<span class=\"token punctuation\">[</span><span class=\"token string\">\"url\"</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>\n             <span class=\"token string\">\"icon\"</span><span class=\"token punctuation\">:</span> x<span class=\"token punctuation\">[</span><span class=\"token string\">\"icon\"</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">}</span> <span class=\"token keyword\">for</span> x <span class=\"token keyword\">in</span> db<span class=\"token punctuation\">.</span>sql<span class=\"token punctuation\">(</span><span class=\"token string-interpolation\"><span class=\"token string\">f\"select * from </span><span class=\"token interpolation\"><span class=\"token punctuation\">{</span>HARPERDB_SCHEMA<span class=\"token punctuation\">}</span></span><span class=\"token string\">.entry_urls\"</span></span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">]</span></code></pre></div>\n<p>といった具合にテーブルの＊Selectやジョインなんかも書くことができます。テーブル全体をなめたいとき、これは楽でいいですね。</p>\n<p>また、CSV load機能もあり、CSVをHarperDBに食わせることもできちゃったりします。</p>\n<p>今回はこちらの機能はRSSのEntryURL登録機能として便利に使用させていただきました。</p>\n<div class=\"gatsby-highlight\" data-language=\"python\"><pre class=\"language-python\"><code class=\"language-python\"><span class=\"token keyword\">import</span> os\n<span class=\"token keyword\">import</span> harperdb\n\nHARPERDB_URL <span class=\"token operator\">=</span> os<span class=\"token punctuation\">.</span>getenv<span class=\"token punctuation\">(</span><span class=\"token string\">\"HARPERDB_URL\"</span><span class=\"token punctuation\">)</span>\nHARPERDB_USERNAME <span class=\"token operator\">=</span> os<span class=\"token punctuation\">.</span>getenv<span class=\"token punctuation\">(</span><span class=\"token string\">\"HARPERDB_USERNAME\"</span><span class=\"token punctuation\">)</span>\nHARPERDB_PASSWORD <span class=\"token operator\">=</span> os<span class=\"token punctuation\">.</span>getenv<span class=\"token punctuation\">(</span><span class=\"token string\">\"HARPERDB_PASSWORD\"</span><span class=\"token punctuation\">)</span>\nHARPERDB_SCHEMA <span class=\"token operator\">=</span> os<span class=\"token punctuation\">.</span>getenv<span class=\"token punctuation\">(</span><span class=\"token string\">\"HARPERDB_SCHEMA\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"prd\"</span><span class=\"token punctuation\">)</span>\nFILEPATH <span class=\"token operator\">=</span> <span class=\"token string\">\"entry.csv\"</span>\n\ndb <span class=\"token operator\">=</span> harperdb<span class=\"token punctuation\">.</span>HarperDB<span class=\"token punctuation\">(</span>\n    url<span class=\"token operator\">=</span>HARPERDB_URL<span class=\"token punctuation\">,</span>\n    username<span class=\"token operator\">=</span>HARPERDB_USERNAME<span class=\"token punctuation\">,</span>\n    password<span class=\"token operator\">=</span>HARPERDB_PASSWORD<span class=\"token punctuation\">,</span><span class=\"token punctuation\">)</span>\n\ndb<span class=\"token punctuation\">.</span>csv_data_load<span class=\"token punctuation\">(</span>HARPERDB_SCHEMA<span class=\"token punctuation\">,</span> <span class=\"token string\">\"entry_urls\"</span><span class=\"token punctuation\">,</span> FILEPATH<span class=\"token punctuation\">,</span> action<span class=\"token operator\">=</span><span class=\"token string\">\"upsert\"</span><span class=\"token punctuation\">)</span>\n</code></pre></div>\n<p>無料開発で一番ネックになるのがDBですが、正直これだけで大概のアプリは作れてしまうのではないでしょうか？</p>\n<h2 id=\"ogp画像を得るには\" style=\"position:relative;\"><a href=\"#ogp%E7%94%BB%E5%83%8F%E3%82%92%E5%BE%97%E3%82%8B%E3%81%AB%E3%81%AF\" aria-label=\"ogp画像を得るには permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>OGP画像を得るには？</h2>\n<p>OGPとは<strong>O</strong>pen <strong>G</strong>raph <strong>P</strong>rotocolの略で、TwitterやFacebookにURLリンクを貼り付けると出てくるあれです。</p>\n<p><img class=\"lozad\" src=\"data:image/gif;base64,R0lGODlhAQABAGAAACH5BAEKAP8ALAAAAAABAAEAAAgEAP8FBAA7\" data-src=\"https://i.imgur.com/4LAaL3b.png\" alt=\"img\"></p>\n<p>実際OGP作成を実装されたほうならわかりますが、OGPはHTMLのHeaderに決まりきったmetaタグを記載して表現しております。</p>\n<div class=\"gatsby-highlight\" data-language=\"html\"><pre class=\"language-html\"><code class=\"language-html\"><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>meta</span> <span class=\"token attr-name\">property</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>og:type<span class=\"token punctuation\">\"</span></span> <span class=\"token attr-name\">content</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>article<span class=\"token punctuation\">\"</span></span> <span class=\"token attr-name\">data-react-helmet</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>true<span class=\"token punctuation\">\"</span></span><span class=\"token punctuation\">></span></span>\n<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>meta</span> <span class=\"token attr-name\">property</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>og:url<span class=\"token punctuation\">\"</span></span> <span class=\"token attr-name\">content</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>https://blog.tubone-project24.xyz/2021/01/01/mqtt-nenga<span class=\"token punctuation\">\"</span></span> <span class=\"token attr-name\">data-react-helmet</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>true<span class=\"token punctuation\">\"</span></span><span class=\"token punctuation\">></span></span>\n<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>meta</span> <span class=\"token attr-name\">property</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>og:title<span class=\"token punctuation\">\"</span></span> <span class=\"token attr-name\">content</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>MQTTと電子ペーパーを使って年賀状を作る<span class=\"token punctuation\">\"</span></span> <span class=\"token attr-name\">data-react-helmet</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>true<span class=\"token punctuation\">\"</span></span><span class=\"token punctuation\">></span></span>\n<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>meta</span> <span class=\"token attr-name\">property</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>og:description<span class=\"token punctuation\">\"</span></span> <span class=\"token attr-name\">content</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>年賀書きたくないマン Table of Contents 一年の計は元旦にあり 注意 年末年始はやってみようBOX MQTT React Hooks Tailwind CSS 電子ペーパー やらないことにしようBOX アーキテクチャー 辛かったこと Hooks…<span class=\"token punctuation\">\"</span></span> <span class=\"token attr-name\">data-react-helmet</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>true<span class=\"token punctuation\">\"</span></span><span class=\"token punctuation\">></span></span>\n<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>meta</span> <span class=\"token attr-name\">property</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>og:image<span class=\"token punctuation\">\"</span></span> <span class=\"token attr-name\">content</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>https://i.imgur.com/tmkmoVA.png<span class=\"token punctuation\">\"</span></span> <span class=\"token attr-name\">data-react-helmet</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>true<span class=\"token punctuation\">\"</span></span><span class=\"token punctuation\">></span></span>\n<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>meta</span> <span class=\"token attr-name\">name</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>twitter:title<span class=\"token punctuation\">\"</span></span> <span class=\"token attr-name\">content</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>MQTTと電子ペーパーを使って年賀状を作る<span class=\"token punctuation\">\"</span></span> <span class=\"token attr-name\">data-react-helmet</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>true<span class=\"token punctuation\">\"</span></span><span class=\"token punctuation\">></span></span>\n<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>meta</span> <span class=\"token attr-name\">name</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>twitter:description<span class=\"token punctuation\">\"</span></span> <span class=\"token attr-name\">content</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>年賀書きたくないマン Table of Contents 一年の計は元旦にあり 注意 年末年始はやってみようBOX MQTT React Hooks Tailwind CSS 電子ペーパー やらないことにしようBOX アーキテクチャー 辛かったこと Hooks…<span class=\"token punctuation\">\"</span></span> <span class=\"token attr-name\">data-react-helmet</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>true<span class=\"token punctuation\">\"</span></span><span class=\"token punctuation\">></span></span>\n<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>meta</span> <span class=\"token attr-name\">name</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>twitter:image<span class=\"token punctuation\">\"</span></span> <span class=\"token attr-name\">content</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>https://i.imgur.com/tmkmoVA.png<span class=\"token punctuation\">\"</span></span> <span class=\"token attr-name\">data-react-helmet</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>true<span class=\"token punctuation\">\"</span></span><span class=\"token punctuation\">></span></span></code></pre></div>\n<p>Slackのattachmentsに入れる画像はOGPのImageから取るようにします。</p>\n<h3 id=\"opengraph-py3\" style=\"position:relative;\"><a href=\"#opengraph-py3\" aria-label=\"opengraph py3 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>opengraph-py3</h3>\n<p>PythonでOGPを解析するなら<a href=\"https://pypi.org/project/opengraph_py3/\" target=\"_blank\" rel=\"noopener noreferrer\">opengraph</a>ライブラリが便利です。ただし、</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">pip install opengraph</code></pre></div>\n<p>でインストールするとPython2用のライブラリがインストールされてしまいまともに動かないので、</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">pip install opengraph_py3</code></pre></div>\n<p>でインストールするようにします。</p>\n<p>使い方もかんたんで、<strong>opengraph_py3.OpenGraph</strong>でインスタンスを作ってあげれば、**ogp[\"image\"]**にOGPイメージURLが保存されます。</p>\n<p>一点注意としてopengraphは裏でBeautifulSoapが動いているようで、Headerのないページに対してOGPを取得しようとするとAttributeErrorが出てしまうので例外処理を入れております。</p>\n<p>本家にPR出すか迷いましたが、2017年から更新がないので骨折り損になりそうなので、やめておきます。</p>\n<div class=\"gatsby-highlight\" data-language=\"python\"><pre class=\"language-python\"><code class=\"language-python\"><span class=\"token keyword\">import</span> opengraph_py3\n\n<span class=\"token keyword\">def</span> <span class=\"token function\">get_ogp_image</span><span class=\"token punctuation\">(</span>link<span class=\"token punctuation\">:</span> <span class=\"token builtin\">str</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n    <span class=\"token keyword\">try</span><span class=\"token punctuation\">:</span>\n        ogp <span class=\"token operator\">=</span> opengraph_py3<span class=\"token punctuation\">.</span>OpenGraph<span class=\"token punctuation\">(</span>url<span class=\"token operator\">=</span>link<span class=\"token punctuation\">)</span>\n        <span class=\"token keyword\">if</span> ogp<span class=\"token punctuation\">.</span>is_valid<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n            <span class=\"token keyword\">return</span> ogp<span class=\"token punctuation\">[</span><span class=\"token string\">\"image\"</span><span class=\"token punctuation\">]</span>\n        <span class=\"token keyword\">else</span><span class=\"token punctuation\">:</span>\n            <span class=\"token keyword\">return</span> <span class=\"token string\">\"\"</span>\n    <span class=\"token keyword\">except</span> AttributeError <span class=\"token keyword\">as</span> e<span class=\"token punctuation\">:</span>\n        logger<span class=\"token punctuation\">.</span>debug<span class=\"token punctuation\">(</span><span class=\"token string-interpolation\"><span class=\"token string\">f\"No Head contents: </span><span class=\"token interpolation\"><span class=\"token punctuation\">{</span>e<span class=\"token punctuation\">}</span></span><span class=\"token string\">\"</span></span><span class=\"token punctuation\">)</span>\n        <span class=\"token keyword\">return</span> <span class=\"token string\">\"\"</span></code></pre></div>\n<h2 id=\"favicon\" style=\"position:relative;\"><a href=\"#favicon\" aria-label=\"favicon permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Favicon</h2>\n<p>できれば、Slack投稿するときに技術ブログのアイコンをブログごとに変えたいなと思ったので、Faviconを取る実装も入れます。</p>\n<p>Pythonにはfavicon取るためのライブラリ<a href=\"https://pypi.org/project/favicon/\" target=\"_blank\" rel=\"noopener noreferrer\">favicon</a>があります。</p>\n<p>使い方も超かんたんで、<strong>favicon.get</strong>で取得したオブジェクトの配列0番目が一番大きなfaviconなのでそれを取るだけです。</p>\n<div class=\"gatsby-highlight\" data-language=\"python\"><pre class=\"language-python\"><code class=\"language-python\"><span class=\"token keyword\">import</span> favicon\n<span class=\"token keyword\">def</span> <span class=\"token function\">get_favicon</span><span class=\"token punctuation\">(</span>link<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n    icons <span class=\"token operator\">=</span> favicon<span class=\"token punctuation\">.</span>get<span class=\"token punctuation\">(</span>link<span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">if</span> <span class=\"token builtin\">len</span><span class=\"token punctuation\">(</span>icons<span class=\"token punctuation\">)</span> <span class=\"token operator\">==</span> <span class=\"token number\">0</span><span class=\"token punctuation\">:</span>\n        <span class=\"token keyword\">return</span> <span class=\"token string\">\"\"</span>\n    <span class=\"token keyword\">else</span><span class=\"token punctuation\">:</span>\n        <span class=\"token keyword\">return</span> icons<span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">.</span>url</code></pre></div>\n<h2 id=\"キーワード抽出\" style=\"position:relative;\"><a href=\"#%E3%82%AD%E3%83%BC%E3%83%AF%E3%83%BC%E3%83%89%E6%8A%BD%E5%87%BA\" aria-label=\"キーワード抽出 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>キーワード抽出</h2>\n<p>さて、今回の醍醐味のキーワード抽出ですがこちらもかんたんに実装できます。</p>\n<p><a href=\"http://gensen.dl.itc.u-tokyo.ac.jp/pytermextract/\" target=\"_blank\" rel=\"noopener noreferrer\">pytermextract</a>という専門用語抽出ツールと形態素解析ライブラリ<a href=\"https://mocobeta.github.io/janome/\" target=\"_blank\" rel=\"noopener noreferrer\">janome</a>を組み合わせることでかんたんに実現できます。</p>\n<p>janomeは本当に便利で、特にCIに乗っけてぐるぐるしたい人にはmecabをインストールする必要も辞書をコンパイルする必要もなく、pipで一発入れれば使えるので重宝しています。</p>\n<p>pytermextractはPyPI登録されているライブラリではないのでインストールは公式サイトから落としたZIPを展開しsetup.pyから行います。</p>\n<p>また、janomeもpipでインストールします。</p>\n<div class=\"gatsby-highlight\" data-language=\"shell\"><pre class=\"language-shell\"><code class=\"language-shell\"><span class=\"token function\">unzip</span> pytermextract-0_01.zip\n<span class=\"token builtin class-name\">cd</span> pytermextract-0_01\npython setup.py <span class=\"token function\">install</span>\n\npip <span class=\"token function\">install</span> janome</code></pre></div>\n<p>まずは、キーワード抽出したいテキストをjanomeのTokenizerにかけて、結果を頻出度から単名詞の左右の連接情報スコア(LR)を算出し、</p>\n<p>重要度スコアとしてはじき出す、という仕組みらしいです。とは言っても私にはよくわからなったのでサンプルコード丸パクリです。</p>\n<p>得られる結果は**{\"単語\": スコア}**となってますので、こちらをスコア順にリバースソートして上位6位を取得する形にしました。</p>\n<p>しょうもない知識ですが、janomeのTokenizerインスタンス作るところは処理コストがちょっと高いので、リファクタでモジュールトップレベルでの宣言にしてます。</p>\n<div class=\"gatsby-highlight\" data-language=\"python\"><pre class=\"language-python\"><code class=\"language-python\"><span class=\"token keyword\">from</span> janome<span class=\"token punctuation\">.</span>tokenizer <span class=\"token keyword\">import</span> Tokenizer\n<span class=\"token keyword\">import</span> termextract<span class=\"token punctuation\">.</span>janome\n<span class=\"token keyword\">import</span> termextract<span class=\"token punctuation\">.</span>core\n\nt <span class=\"token operator\">=</span> Tokenizer<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n\n<span class=\"token keyword\">def</span> <span class=\"token function\">extract_keyword</span><span class=\"token punctuation\">(</span>text<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n    tokenize_text <span class=\"token operator\">=</span> t<span class=\"token punctuation\">.</span>tokenize<span class=\"token punctuation\">(</span>text<span class=\"token punctuation\">)</span>\n    frequency <span class=\"token operator\">=</span> termextract<span class=\"token punctuation\">.</span>janome<span class=\"token punctuation\">.</span>cmp_noun_dict<span class=\"token punctuation\">(</span>tokenize_text<span class=\"token punctuation\">)</span>\n    lr <span class=\"token operator\">=</span> termextract<span class=\"token punctuation\">.</span>core<span class=\"token punctuation\">.</span>score_lr<span class=\"token punctuation\">(</span>\n        frequency<span class=\"token punctuation\">,</span>\n        ignore_words<span class=\"token operator\">=</span>termextract<span class=\"token punctuation\">.</span>janome<span class=\"token punctuation\">.</span>IGNORE_WORDS<span class=\"token punctuation\">,</span>\n        lr_mode<span class=\"token operator\">=</span><span class=\"token number\">1</span><span class=\"token punctuation\">,</span> average_rate<span class=\"token operator\">=</span><span class=\"token number\">1</span><span class=\"token punctuation\">)</span>\n    term_imp <span class=\"token operator\">=</span> termextract<span class=\"token punctuation\">.</span>core<span class=\"token punctuation\">.</span>term_importance<span class=\"token punctuation\">(</span>frequency<span class=\"token punctuation\">,</span> lr<span class=\"token punctuation\">)</span>\n    score_sorted_term_imp <span class=\"token operator\">=</span> <span class=\"token builtin\">sorted</span><span class=\"token punctuation\">(</span>term_imp<span class=\"token punctuation\">.</span>items<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> key<span class=\"token operator\">=</span><span class=\"token keyword\">lambda</span> x<span class=\"token punctuation\">:</span> x<span class=\"token punctuation\">[</span><span class=\"token number\">1</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span> reverse<span class=\"token operator\">=</span><span class=\"token boolean\">True</span><span class=\"token punctuation\">)</span>\n    logger<span class=\"token punctuation\">.</span>debug<span class=\"token punctuation\">(</span><span class=\"token string-interpolation\"><span class=\"token string\">f\"keywords: </span><span class=\"token interpolation\"><span class=\"token punctuation\">{</span>score_sorted_term_imp<span class=\"token punctuation\">}</span></span><span class=\"token string\">\"</span></span><span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">return</span> score_sorted_term_imp<span class=\"token punctuation\">[</span><span class=\"token punctuation\">:</span><span class=\"token number\">6</span><span class=\"token punctuation\">]</span></code></pre></div>\n<h3 id=\"rssのsummarytextでは精度がでないそりゃそうじゃ\" style=\"position:relative;\"><a href=\"#rss%E3%81%AEsummarytext%E3%81%A7%E3%81%AF%E7%B2%BE%E5%BA%A6%E3%81%8C%E3%81%A7%E3%81%AA%E3%81%84%E3%81%9D%E3%82%8A%E3%82%83%E3%81%9D%E3%81%86%E3%81%98%E3%82%83\" aria-label=\"rssのsummarytextでは精度がでないそりゃそうじゃ permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>RSSのSummaryTextでは精度がでない、そりゃそうじゃ。</h3>\n<p>当初はfeedparserから取得できるEntry ItemのSummaryをpytermextractに食わせてましたが、SummaryTextが短すぎて全く期待する動作になりませんでしたので、BeautifulSoupを使って、実際の記事の本文を取得しpytermextractに食わせる実装に変更しました。</p>\n<div class=\"gatsby-highlight\" data-language=\"python\"><pre class=\"language-python\"><code class=\"language-python\"><span class=\"token keyword\">from</span> bs4 <span class=\"token keyword\">import</span> BeautifulSoup\n<span class=\"token keyword\">import</span> urllib<span class=\"token punctuation\">.</span>request <span class=\"token keyword\">as</span> req\n\n<span class=\"token keyword\">def</span> <span class=\"token function\">extract_html_text</span><span class=\"token punctuation\">(</span>url<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n    res <span class=\"token operator\">=</span> req<span class=\"token punctuation\">.</span>urlopen<span class=\"token punctuation\">(</span>url<span class=\"token punctuation\">)</span>\n    soup <span class=\"token operator\">=</span> BeautifulSoup<span class=\"token punctuation\">(</span>res<span class=\"token punctuation\">,</span> <span class=\"token string\">\"html.parser\"</span><span class=\"token punctuation\">)</span>\n    p_tag_list <span class=\"token operator\">=</span> soup<span class=\"token punctuation\">.</span>find_all<span class=\"token punctuation\">(</span><span class=\"token string\">\"p\"</span><span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">return</span> <span class=\"token string\">\" \"</span><span class=\"token punctuation\">.</span>join<span class=\"token punctuation\">(</span><span class=\"token punctuation\">[</span>p<span class=\"token punctuation\">.</span>get_text<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">for</span> p <span class=\"token keyword\">in</span> p_tag_list<span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span></code></pre></div>\n<p>本文はpタグと判断しfind_allするちんけな実装です。ごめんなさい。</p>\n<h2 id=\"slack投稿\" style=\"position:relative;\"><a href=\"#slack%E6%8A%95%E7%A8%BF\" aria-label=\"slack投稿 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Slack投稿</h2>\n<p>いよいよSlack投稿部分の作成です。</p>\n<p>Slack投稿はCustomIntegrationのIncoming Webhookで作ります。</p>\n<p>なので、<a href=\"https://api.slack.com/reference/messaging/attachments\" target=\"_blank\" rel=\"noopener noreferrer\">Slack attachment</a>が使えます。</p>\n<p>特質したことはないのですが、OGP画像はimage_urlに、faviconはauthor_imageにキーワードはfieldsに入れてます。</p>\n<h2 id=\"github-actions化\" style=\"position:relative;\"><a href=\"#github-actions%E5%8C%96\" aria-label=\"github actions化 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>GitHub Actions化</h2>\n<p>最後にGitHub Actionsに載せて、定期実行させます。</p>\n<p>その前にの<a href=\"#harperdb\">#harperdb</a>でも書いたとおり、RSS追加時のHarperDBへのEntry追加の定義を書いていきます。</p>\n<p>特定のファイルに更新があった場合のみ動くGitHub Actionsを作る場合は、 on_pushなどの条件にpathsを入れることで実現できます。これだけです。</p>\n<div class=\"gatsby-highlight\" data-language=\"yml\"><pre class=\"language-yml\"><code class=\"language-yml\"><span class=\"token key atrule\">on</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">push</span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">branches</span><span class=\"token punctuation\">:</span>\n      <span class=\"token punctuation\">-</span> main\n    <span class=\"token key atrule\">paths</span><span class=\"token punctuation\">:</span>\n      <span class=\"token punctuation\">-</span> <span class=\"token string\">\"entry.csv\"</span>\n  <span class=\"token key atrule\">pull_request</span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">branches</span><span class=\"token punctuation\">:</span>\n      <span class=\"token punctuation\">-</span> main\n    <span class=\"token key atrule\">paths</span><span class=\"token punctuation\">:</span>\n      <span class=\"token punctuation\">-</span> <span class=\"token string\">\"entry.csv\"</span></code></pre></div>\n<p>また、定期実行にはschedule cronが便利です。</p>\n<div class=\"gatsby-highlight\" data-language=\"yml\"><pre class=\"language-yml\"><code class=\"language-yml\"><span class=\"token key atrule\">on</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">push</span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">branches</span><span class=\"token punctuation\">:</span>\n      <span class=\"token punctuation\">-</span> main\n  <span class=\"token key atrule\">pull_request</span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">branches</span><span class=\"token punctuation\">:</span>\n      <span class=\"token punctuation\">-</span> main\n  <span class=\"token key atrule\">schedule</span><span class=\"token punctuation\">:</span>\n    <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">cron</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"*/30 * * * *\"</span></code></pre></div>\n<h2 id=\"完成\" style=\"position:relative;\"><a href=\"#%E5%AE%8C%E6%88%90\" aria-label=\"完成 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>完成</h2>\n<p>ということでできました。</p>\n<p><img class=\"lozad\" src=\"data:image/gif;base64,R0lGODlhAQABAGAAACH5BAEKAP8ALAAAAAABAAEAAAgEAP8FBAA7\" data-src=\"https://i.imgur.com/Ip4IaYs.png\" alt=\"img\"></p>\n<p>entry.csvに書いたRSS feedを30分ごとに確認しにいき、前回よりpublish_dateの更新があったばあいはOGP, favicon, キーワード付きでSlack投稿します。</p>\n<p>レポジトリはこちらです。</p>\n<p><a href=\"https://github.com/tubone24/tech_blog_spider\" target=\"_blank\" rel=\"noopener noreferrer\">https://github.com/tubone24/tech_blog_spider</a></p>\n<p>ForkするとGitHubA　ctionsがうまく発火しないっぽいので、もし利用する際はgit cloneして自身のレポジトリに再Pushして使っていただければと思います。</p>\n<h2 id=\"結論\" style=\"position:relative;\"><a href=\"#%E7%B5%90%E8%AB%96\" aria-label=\"結論 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>結論</h2>\n<p>HarperDBを使って何でもつくれそうな予感がするこの頃です。</p>","words":5095,"minutes":13}},"staticQueryHashes":["1319877725","2959249232"]}