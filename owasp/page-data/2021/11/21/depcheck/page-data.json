{"componentChunkName":"component---src-templates-blog-post-tsx","path":"/2021/11/21/depcheck","result":{"data":{"content":{"edges":[{"node":{"id":"fb9c2cab-81f9-5fdc-89d1-65249340f0a8","excerpt":"package.jsonはNodeのつらいところ。 Table of Contents はじめに depcheck これをGitHub Actionsに組み込みたい まとめ はじめに JavaScriptやTypeScriptでのシステム開発に必要不可欠なNode.js…","fields":{"slug":"2021/11/21/depcheck"},"frontmatter":{"id":null,"title":"depcheckをGitHub Actionで使い、PRコメントに結果を出力させる","slug":"2021/11/21/depcheck","date":"2021-11-21T11:16:54.648Z","headerImage":"https://i.imgur.com/x0HzZEF.png","tags":["JavaScript","depcheck","GitHub"]}}}]}},"pageContext":{"id":"fb9c2cab-81f9-5fdc-89d1-65249340f0a8","index":11,"repHtml":"<p>package.jsonはNodeのつらいところ。</p>\n<h2 id=\"table-of-contents\" style=\"position:relative;\"><a href=\"#table-of-contents\" aria-label=\"table of contents permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Table of Contents</h2>\n<div class=\"toc\">\n<ul>\n<li><a href=\"#%E3%81%AF%E3%81%98%E3%82%81%E3%81%AB\">はじめに</a></li>\n<li><a href=\"#depcheck\">depcheck</a></li>\n<li><a href=\"#%E3%81%93%E3%82%8C%E3%82%92github-actions%E3%81%AB%E7%B5%84%E3%81%BF%E8%BE%BC%E3%81%BF%E3%81%9F%E3%81%84\">これをGitHub Actionsに組み込みたい</a></li>\n<li><a href=\"#%E3%81%BE%E3%81%A8%E3%82%81\">まとめ</a></li>\n</ul>\n</div>\n<h2 id=\"はじめに\" style=\"position:relative;\"><a href=\"#%E3%81%AF%E3%81%98%E3%82%81%E3%81%AB\" aria-label=\"はじめに permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>はじめに</h2>\n<p>JavaScriptやTypeScriptでのシステム開発に必要不可欠なNode.js Package Manager、いわゆるnpmはしばしばライブラリサイズが大きくなりがちなことが問題になります。</p>\n<p><img class=\"lozad\" src=\"data:image/gif;base64,R0lGODlhAQABAGAAACH5BAEKAP8ALAAAAAABAAEAAAgEAP8FBAA7\" data-src=\"https://i.imgur.com/yxDDBOX.jpg\" alt=\"img\"></p>\n<p>もちろんこちらの問題はさまざまな議論が尽くされているわけですし、今更どうこう言うつもりはないです。</p>\n<iframe loading=\"lazy\" width=\"200\" height=\"113\" src=\"https://www.youtube.com/embed/SHIci8-6_gs?feature=oembed\" frameborder=\"0\" allow=\"accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture\" allowfullscreen title=\"Tink: A Next Generation Package Manager by Kat Marchán | JSConf EU 2019\"></iframe>\n<p>上記問題を解決する方法はいろいろあると思いますが、私のような末端開発者にはとりあえず使ってないライブラリを削除する、くらいしかできないのでそれらを加速させる方法を考えていきましょう。</p>\n<h2 id=\"depcheck\" style=\"position:relative;\"><a href=\"#depcheck\" aria-label=\"depcheck permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>depcheck</h2>\n<p><a href=\"https://github.com/depcheck/depcheck\" target=\"_blank\" rel=\"noopener noreferrer\">depcheck</a>とはnpmでパッケージ管理されたプロジェクトについて、各ライブラリの依存関係がどのように使用されているか、どの依存関係が使われていないか、package.jsonからどの依存関係が欠落しているかを確認するためのツールです。</p>\n<p>プロジェクトルートでnpxを使って、</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">npx depcheck</code></pre></div>\n<p>で実行することで簡単に結果を得ることができます。例えば<a href=\"https://github.com/tubone24/portfolio\" target=\"_blank\" rel=\"noopener noreferrer\">こちらのレポジトリ</a>で実行すると、</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">> npx depcheck\nnpx: installed 120 in 12.136s\n\nUnused dependencies\n* @fortawesome/free-regular-svg-icons\n* @fortawesome/free-solid-svg-icons\n* react-error-overlay\n* react-flickr-hero\n* sharp\n* tween\nUnused devDependencies\n* @storybook/addon-a11y\n* @storybook/addon-controls\n* @storybook/addon-docs\n* @storybook/addon-essentials\n* @storybook/addon-info\n* @storybook/addon-knobs\n* @storybook/addon-links\n* @storybook/addon-storyshots\n* @types/aws-lambda\n* @types/jest\n* @types/node\n* @types/react-fontawesome\n* @types/storybook__addon-info\n* babel-preset-gatsby\n* babel-preset-react-app\n* greenkeeper-lockfile\n* identity-obj-proxy\n* netlify-cli\n* netlify-lambda\n* react-test-renderer\n* stylelint-config-idiomatic-order\n* stylelint-config-prettier\n* stylelint-config-recommended\n* stylelint-config-styled-components\n* stylelint-processor-styled-components\n* ts-dedent\n* ts-jest\n* tslint-react\nMissing dependencies\n* build-url: .\\src\\components\\flickrHero.tsx\n* @fortawesome/fontawesome-common-types: .\\src\\components\\socialIcons.tsx\n* axios: .\\functions\\src\\contact.js\n* @babel/preset-react: .\\.storybook\\main.js\n* @babel/preset-env: .\\.storybook\\main.js\n* @babel/plugin-proposal-class-properties: .\\.storybook\\main.js\n* babel-plugin-remove-graphql-queries: .\\.storybook\\main.js</code></pre></div>\n<p>このようにpackage.jsonで定義されているにも関わらずコード上で使われてないライブラリ、もしくはコード上で見つかったけどpackage.jsonに定義されてないライブラリを一覧化できます。</p>\n<h2 id=\"これをgithub-actionsに組み込みたい\" style=\"position:relative;\"><a href=\"#%E3%81%93%E3%82%8C%E3%82%92github-actions%E3%81%AB%E7%B5%84%E3%81%BF%E8%BE%BC%E3%81%BF%E3%81%9F%E3%81%84\" aria-label=\"これをgithub actionsに組み込みたい permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>これをGitHub Actionsに組み込みたい</h2>\n<p>やはり、PRを出したときに自動でdepcheckが走るといいですよね。</p>\n<p>そしてその結果を通知してくれたらさらにうれしいですよね。</p>\n<p>そこで、GitHub Actionsを作りました。</p>\n<p><a href=\"https://github.com/marketplace/actions/depcheck-action-with-pr\" target=\"_blank\" rel=\"noopener noreferrer\">https://github.com/marketplace/actions/depcheck-action-with-pr</a></p>\n<p>使い方は簡単でお手元のGitHub Actionsでまず、Pull RequestをトリガーにしたYAMLを作ります。</p>\n<p>このとき、入力としてGitHub TokenとPRコメントのURLが必要になりますが、これらはGitHub Actionsの環境変数として取得できます。</p>\n<p>どちらもGitHub Actionsの環境変数として取得できます。</p>\n<ul>\n<li>GITHUB_TOKEN\n<ul>\n<li>これはsecrets.GITHUB_TOKENとして取得できます。</li>\n</ul>\n</li>\n<li>PR_COMMENT_URL\n<ul>\n<li>PRイベントの際に、github.event.pull_request.comments_urlから取得できます。</li>\n</ul>\n</li>\n</ul>\n<div class=\"gatsby-highlight\" data-language=\"yaml\"><pre class=\"language-yaml\"><code class=\"language-yaml\"><span class=\"token key atrule\">on</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">pull_request</span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">branches</span><span class=\"token punctuation\">:</span>\n      <span class=\"token punctuation\">-</span> master\n      \n  <span class=\"token key atrule\">build</span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">runs-on</span><span class=\"token punctuation\">:</span> ubuntu<span class=\"token punctuation\">-</span>latest\n\n    <span class=\"token key atrule\">steps</span><span class=\"token punctuation\">:</span>\n      <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> Checkout source code\n        <span class=\"token key atrule\">uses</span><span class=\"token punctuation\">:</span> actions/checkout@v2\n      <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> Setup Node\n        <span class=\"token key atrule\">uses</span><span class=\"token punctuation\">:</span> actions/setup<span class=\"token punctuation\">-</span>node@v2\n        <span class=\"token key atrule\">with</span><span class=\"token punctuation\">:</span>\n          <span class=\"token key atrule\">node-version</span><span class=\"token punctuation\">:</span> 14.x\n      <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"depcheck\"</span>\n        <span class=\"token key atrule\">uses</span><span class=\"token punctuation\">:</span> tubone24/depcheck_action@v1.0.0\n        <span class=\"token key atrule\">with</span><span class=\"token punctuation\">:</span>\n          <span class=\"token key atrule\">GITHUB_TOKEN</span><span class=\"token punctuation\">:</span> $<span class=\"token punctuation\">{</span><span class=\"token punctuation\">{</span> secrets.GITHUB_TOKEN <span class=\"token punctuation\">}</span><span class=\"token punctuation\">}</span>\n          <span class=\"token key atrule\">PR_COMMENT_URL</span><span class=\"token punctuation\">:</span> $<span class=\"token punctuation\">{</span><span class=\"token punctuation\">{</span> github.event.pull_request.comments_url <span class=\"token punctuation\">}</span><span class=\"token punctuation\">}</span></code></pre></div>\n<p>のようにuseすればいいだけ。</p>\n<p>そうすれば、PRコメントとして結果が出力されます。</p>\n<p><img class=\"lozad\" src=\"data:image/gif;base64,R0lGODlhAQABAGAAACH5BAEKAP8ALAAAAAABAAEAAAgEAP8FBAA7\" data-src=\"https://i.imgur.com/x0HzZEF.png\" alt=\"img\"></p>\n<ul>\n<li>Unused dependenciesセクションは、package.jsonのdependenciesで定義されたライブラリが、.js、.ts、.jsx、.tsx、.coffee、.sass、.scss、.vueの各ファイルで使用されていないことを示しています。</li>\n<li>Unused devDpendenciesセクションは、package.jsonのdevDependenciesで定義されたライブラリが各ファイルに存在しないことを示しています。</li>\n<li>Missingセクションは、コードで使用されているライブラリがpackage.jsonに存在していないことを示しています。CDNからインポートされたライブラリや、グローバルに宣言されたライブラリを使用している可能性があります。</li>\n</ul>\n<h2 id=\"まとめ\" style=\"position:relative;\"><a href=\"#%E3%81%BE%E3%81%A8%E3%82%81\" aria-label=\"まとめ permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>まとめ</h2>\n<p>自分が欲してたものなのでサクッと作ってみたが、めんどくさかったので<a href=\"https://docs.github.com/ja/actions/creating-actions/creating-a-docker-container-action\" target=\"_blank\" rel=\"noopener noreferrer\">GitHub ActionsはDockerで作ってしまった</a>ので、主にスピード面で課題があります。</p>\n<p>一応、base imageを作って高速化はしてますが、Full JavaScriptで作って、もっと丁寧に作ってもよかったと大後悔。</p>","words":1575,"minutes":4}},"staticQueryHashes":["1319877725","2959249232"]}