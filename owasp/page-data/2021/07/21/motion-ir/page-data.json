{"componentChunkName":"component---src-templates-blog-post-tsx","path":"/2021/07/21/motion-ir","result":{"data":{"content":{"edges":[{"node":{"id":"b3da3f41-3b41-5166-a894-95722d0872ea","excerpt":"作ってみよう！ Table of Contents 我が家のラズパイ事情 監視カメラ 赤外線カメラ motion motionで動体検知をするconfigを設定する。 Stream配信 動画をSlackに投稿 Slack…","fields":{"slug":"2021/07/21/motion-ir"},"frontmatter":{"id":null,"title":"赤外線付きカメラモジュールとmotionを古いラズパイにつけてSlackと連動した監視システムを作ろう","slug":"2021/07/21/motion-ir","date":"2021-07-21T10:08:14.329Z","headerImage":"https://i.imgur.com/JaW3aQ0.jpg","tags":["RaspberryPi","motion","監視カメラ","Slack"]}}}]}},"pageContext":{"id":"b3da3f41-3b41-5166-a894-95722d0872ea","index":16,"repHtml":"<p>作ってみよう！</p>\n<h2 id=\"table-of-contents\" style=\"position:relative;\"><a href=\"#table-of-contents\" aria-label=\"table of contents permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Table of Contents</h2>\n<div class=\"toc\">\n<ul>\n<li><a href=\"#%E6%88%91%E3%81%8C%E5%AE%B6%E3%81%AE%E3%83%A9%E3%82%BA%E3%83%91%E3%82%A4%E4%BA%8B%E6%83%85\">我が家のラズパイ事情</a></li>\n<li><a href=\"#%E7%9B%A3%E8%A6%96%E3%82%AB%E3%83%A1%E3%83%A9\">監視カメラ</a></li>\n<li><a href=\"#%E8%B5%A4%E5%A4%96%E7%B7%9A%E3%82%AB%E3%83%A1%E3%83%A9\">赤外線カメラ</a></li>\n<li><a href=\"#motion\">motion</a></li>\n<li><a href=\"#motion%E3%81%A7%E5%8B%95%E4%BD%93%E6%A4%9C%E7%9F%A5%E3%82%92%E3%81%99%E3%82%8Bconfig%E3%82%92%E8%A8%AD%E5%AE%9A%E3%81%99%E3%82%8B\">motionで動体検知をするconfigを設定する。</a></li>\n<li><a href=\"#stream%E9%85%8D%E4%BF%A1\">Stream配信</a></li>\n<li><a href=\"#%E5%8B%95%E7%94%BB%E3%82%92slack%E3%81%AB%E6%8A%95%E7%A8%BF\">動画をSlackに投稿</a></li>\n<li><a href=\"#slack%E3%81%AB%E7%94%BB%E5%83%8F%E3%82%92%E6%8A%95%E7%A8%BF\">Slackに画像を投稿</a></li>\n<li><a href=\"#%E3%81%A7%E3%81%8D%E3%81%9F\">できた！</a></li>\n<li><a href=\"#%E5%95%8F%E9%A1%8C%E7%99%BA%E7%94%9F\">問題発生</a></li>\n<li><a href=\"#%E7%B5%90%E8%AB%96\">結論</a></li>\n</ul>\n</div>\n<h2 id=\"我が家のラズパイ事情\" style=\"position:relative;\"><a href=\"#%E6%88%91%E3%81%8C%E5%AE%B6%E3%81%AE%E3%83%A9%E3%82%BA%E3%83%91%E3%82%A4%E4%BA%8B%E6%83%85\" aria-label=\"我が家のラズパイ事情 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>我が家のラズパイ事情</h2>\n<p>多くのご家庭でお困りかもしれませんが、使ってないラズパイが転がりまくってます。</p>\n<p>ラズパイって結構直近の進化がすごくて、性能が上がったから買ってみよう！とか、液晶モジュール付けてしまったから特に使ってないけど外すのめんどくさいしそのままにしておこうとか、そういった感じで眠ったラズパイが何種類かあります。</p>\n<p>で、こいつらを眠らせておいても仕方がないので、早速こちらを使って何かHomeIoTチックなことをやってみたいと想います。</p>\n<h2 id=\"監視カメラ\" style=\"position:relative;\"><a href=\"#%E7%9B%A3%E8%A6%96%E3%82%AB%E3%83%A1%E3%83%A9\" aria-label=\"監視カメラ permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>監視カメラ</h2>\n<p>そこまで我が家は大したセキュリティ意識はないですが、せっかくなら玄関に監視カメラでもつけたいなと思い始めました。</p>\n<p>とりあえず、人がきたらSlackに検知状況とそのときの画像や動画を投稿します。</p>\n<h2 id=\"赤外線カメラ\" style=\"position:relative;\"><a href=\"#%E8%B5%A4%E5%A4%96%E7%B7%9A%E3%82%AB%E3%83%A1%E3%83%A9\" aria-label=\"赤外線カメラ permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>赤外線カメラ</h2>\n<p>いつも玄関は省エネの観点で電気を消してますので、通常のカメラではちょっと明るさがたりません。</p>\n<p>そこで、ラズパイのカメラモジュールに挿すことのできる赤外線カメラを探したところありました。</p>\n<p><a href=\"https://www.amazon.co.jp/gp/product/B07T5DZY73/ref=as_li_tl?ie=UTF8&#x26;camp=247&#x26;creative=1211&#x26;creativeASIN=B07T5DZY73&#x26;linkCode=as2&#x26;tag=tubone2403-22&#x26;linkId=034a4706556d75193eef893e1d8c3e2a\" target=\"_blank\" rel=\"noopener noreferrer\">5MP 1080P Camera for raspberry pi 4 Model b カメラモジュールraspberryカメラモ赤外線ケース付き夜間LEDラズベリーパイ4 / 3 / Pi Zero Wに適して (IR with Case)</a></p>\n<p>値段もお手頃でこいつはいいですね。</p>\n<p>組み立て方も簡単で、カメラ部分に赤外線センサーをねじ止めし、ラズパイのカメラモジュールに差し込むだけです。</p>\n<p><img class=\"lozad\" src=\"data:image/gif;base64,R0lGODlhAQABAGAAACH5BAEKAP8ALAAAAAABAAEAAAgEAP8FBAA7\" data-src=\"https://i.imgur.com/JaW3aQ0l.jpg\" alt=\"inmf\"></p>\n<p>組み立てると上のようになります。</p>\n<p>私の用意していたラズパイがWifi非対応の超古いタイプ<a href=\"https://jp.rs-online.com/web/p/raspberry-pi/8111284/\" target=\"_blank\" rel=\"noopener noreferrer\">Raspberry Pi B+</a>だったので有線LANを引きまして、高さが足りないのでiPadminiの箱の上にガムテープで固定するという何とも残念な仕上がりですが、とりあえず装着完了。</p>\n<p><img class=\"lozad\" src=\"data:image/gif;base64,R0lGODlhAQABAGAAACH5BAEKAP8ALAAAAAABAAEAAAgEAP8FBAA7\" data-src=\"https://i.imgur.com/Eda8D6Il.jpg\" alt=\"img\"></p>\n<p>試しにカメラが使えるか、テストしてみます。</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">raspistill -o test.jpg</code></pre></div>\n<p><img class=\"lozad\" src=\"data:image/gif;base64,R0lGODlhAQABAGAAACH5BAEKAP8ALAAAAAABAAEAAAgEAP8FBAA7\" data-src=\"https://i.imgur.com/YOUDPIcl.jpg\" alt=\"img\"></p>\n<p>無事写真が撮れました。色味がちょっと変なのは赤外線だから仕方ありませんね。</p>\n<h2 id=\"motion\" style=\"position:relative;\"><a href=\"#motion\" aria-label=\"motion permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>motion</h2>\n<p><a href=\"https://motion-project.github.io/index.html\" target=\"_blank\" rel=\"noopener noreferrer\">motion</a>という、カメラからのビデオ信号をリアルタイムに解析し、動体検知や録画撮影などができるLinuxプログラムがあります。</p>\n<p>こちらを使えば簡単に監視カメラを作ることができます。</p>\n<p>早速motionをインストールして設定していきます。</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">sudo apt install motion\n\nsudo motion</code></pre></div>\n<p>さきほど写真の撮影には成功したので起動するかなーと思ったのですがダメです！motionが起動しません!!エラーが出ます。</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">[1:ml1] [NTC] [VID] [Jul 21 21:00:03] vid_start: Opening V4L2 device\n[1:ml1] [NTC] [VID] [Jul 21 21:00:03] v4l2_start: Using videodevice /dev/video0 and input -1\n[1:ml1] [ALR] [VID] [Jul 21 21:00:03] v4l2_start: Failed to open video device /dev/video0: No such file or directory\n[1:ml1] [ERR] [VID] [Jul 21 21:00:03] vid_start: V4L2 device failed to open\n[1:ml1] [WRN] [ALL] [Jul 21 21:00:03] mlp_retry: Retrying until successful connection with camera\n[1:ml1] [NTC] [VID] [Jul 21 21:00:03] vid_start: Opening V4L2 device\n[1:ml1] [NTC] [VID] [Jul 21 21:00:03] v4l2_start: Using videodevice /dev/video0 and input -1\n[1:ml1] [ALR] [VID] [Jul 21 21:00:03] v4l2_start: Failed to open video device /dev/video0: No such file or directory\n[1:ml1] [ERR] [VID] [Jul 21 21:00:03] vid_start: V4L2 device failed to open</code></pre></div>\n<p><strong>Failed to open video device /dev/video0: No such file or directory</strong>というエラーが出てますね。</p>\n<p>ラズパイのカメラモジュールは/dev/video0として認識されないのですかね。</p>\n<p>途方に暮れてしまいましたがラズパイのフォーラムに解決策が書いてありました。</p>\n<p><a href=\"https://www.raspberrypi.org/forums/viewtopic.php?t=255442\" target=\"_blank\" rel=\"noopener noreferrer\">Motion -> v4l2_start: Failed to open video device /dev/video0: No such file or directory</a></p>\n<p>どうやらラズパイカメラモジュール用のV4L2ドライバは標準ではロードされず、video0デバイスを取得するには <strong>modprobe bcm2835-v4l2</strong>を実行する必要があったとのこと。</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">sudo modprobe bcm2835-v4l2</code></pre></div>\n<p>これで再起動したところ無事、<strong>/dev/video0</strong>ができていました。</p>\n<p>とりあえずmotionを起動させたところ、無事起動しました。</p>\n<h2 id=\"motionで動体検知をするconfigを設定する\" style=\"position:relative;\"><a href=\"#motion%E3%81%A7%E5%8B%95%E4%BD%93%E6%A4%9C%E7%9F%A5%E3%82%92%E3%81%99%E3%82%8Bconfig%E3%82%92%E8%A8%AD%E5%AE%9A%E3%81%99%E3%82%8B\" aria-label=\"motionで動体検知をするconfigを設定する permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>motionで動体検知をするconfigを設定する。</h2>\n<p>motion.confは下記の通りに設定しました。後ほど検知後の動きを設定するスクリプトについてもご紹介しますがインラインで軽く解説していきます。</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">daemon on #デーモン化してサービスとして登録\nprocess_id_file /var/run/motion/motion.pid\nsetup_mode off\nlogfile /var/log/motion/motion.log\nlog_level 6\nlog_type all\nvideodevice /dev/video0\nv4l2_palette 17\ninput -1\nnorm 0\nfrequency 0\npower_line_frequency -1\nrotate 180 #画像が反転してたので直す\nwidth 640\nheight 480\nframerate 100 #とりあえず最大。ただし性能的にあんまりぬるぬるにはならなかった。監視カメラだし別にぬるぬるじゃなくてもいい。\nminimum_frame_time 0\nnetcam_keepalive off\nnetcam_tolerant_check off\nrtsp_uses_tcp on\nauto_brightness off\nbrightness 0\ncontrast 0\nsaturation 0\nhue 0\nroundrobin_frames 1\nroundrobin_skip 1\nswitchfilter off\nthreshold 1500\nthreshold_tune off\nnoise_level 32\nnoise_tune on\ndespeckle_filter EedDl\nsmart_mask_speed 0\nlightswitch 0\nminimum_motion_frames 1\npre_capture 0\npost_capture 0\nevent_gap 60 # 動体検知イベントから次のイベント検知までのインターバル。設定しないと連続撮影が続いてクッソ重くなる\nmax_movie_time 120\nemulate_motion off\noutput_pictures best # 動体検知した際に画像を出力する、bestにしていると動体検知イベント中一番大きな動体検知が発生したフレームを切り取ってくれる\noutput_debug_pictures off\nquality 75 # 画像の品質\npicture_type jpeg # 画像のフォーマット、jpgで問題ない\nffmpeg_output_movies on # 動体検知した際に、動体検知イベント中の動画を出力してくれる\nffmpeg_output_debug_movies off\nffmpeg_timelapse 0\nffmpeg_timelapse_mode daily\nffmpeg_bps 700000\nffmpeg_variable_bitrate 0\nffmpeg_video_codec mp4 # 動画コーデック、mp4一択だがmpeg4にするとaviにもできる\nffmpeg_duplicate_frames true\nuse_extpipe off\nsnapshot_interval 0\nlocate_motion_mode on # 動体検知イベントの画像、動画中に検知部分に四角を表示する\nlocate_motion_style redbox # 赤枠にする\ntext_right %Y-%m-%d\\n%T-%q\ntext_changes off\ntext_event %Y%m%d%H%M%S\ntext_double on # 監視カメラの端っこにある時間とか記載してあるテキストを大きくする\ntarget_dir /home/pi/motion/output # 動画、画像出力先\nsnapshot_filename %v-%Y%m%d%H%M%S-snapshot\npicture_filename %v-%Y%m%d%H%M%S-%q\nmovie_filename %v-%Y%m%d%H%M%S\ntimelapse_filename %Y%m%d-timelapse\nipv6_enabled off\nstream_port 8081\nstream_quality 50\nstream_motion off\nstream_maxrate 1\nstream_localhost off # offにしておくと、IPアドレス:8081でアクセスするとリアルタイムに動画ストリーミングされる\nstream_limit 0\nstream_auth_method 0\nwebcontrol_port 8080\nwebcontrol_localhost off　# offにしておくと、IPアドレス:8080でアクセスすると設定変更や再起動が可能なWebコンソールが出てくる\nwebcontrol_html_output on\ntrack_type 0\ntrack_auto off\ntrack_iomojo_id 0\ntrack_step_angle_x 10\ntrack_step_angle_y 10\ntrack_move_wait 10\ntrack_speed 255\ntrack_stepsize 40\nquiet on\non_picture_save \"/bin/sh /home/pi/motion/notify_picture_trigger.sh %f\" # 画像が保存されたときの追加起動スクリプト %fで保存された画像を引数で渡すことができる\non_movie_start \"/usr/bin/python3 /home/pi/motion/notify_fast_trigger.py\" # 動体検知され動画が記録され始めたら追加起動するスクリプト\non_movie_end \"/bin/sh /home/pi/motion/notify_movie_trigger.sh %f\" # 動画の記録が終了したら追加起動するスクリプト\non_camera_found \"/usr/bin/python3 /home/pi/motion/notify_camera_found.py\" # カメラモジュールとの疎通が回復したら起動するスクリプト\non_camera_lost \"/usr/bin/python3 /home/pi/motion/notify_camera_lost.py\" # カメラモジュールとの疎通が取れなくなったら起動するスクリプト</code></pre></div>\n<p>ここでポイントになるのは動体検知実行時に画像や動画を保存できるだけでなく、それを追加起動スクリプトで通知できるということです。</p>\n<p>動画や画像をSlackに送信すれば監視カメラシステム的に十分ですね。</p>\n<p>動画だけの配信でもいいかもしれませんが、モバイルSlackだと、動画の場合プレビューがされないので画像も送信することにします。</p>\n<p><img class=\"lozad\" src=\"data:image/gif;base64,R0lGODlhAQABAGAAACH5BAEKAP8ALAAAAAABAAEAAAgEAP8FBAA7\" data-src=\"https://i.imgur.com/IEF2Q1Rl.png\" alt=\"md\"></p>\n<h2 id=\"stream配信\" style=\"position:relative;\"><a href=\"#stream%E9%85%8D%E4%BF%A1\" aria-label=\"stream配信 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Stream配信</h2>\n<p>motion.confで<strong>stream_localhost off</strong>とすることで、他の端末からストリーム配信を視聴できるようになります。例えばVPNとかを自宅に構築済みの場合は気になったら外出先からカメラを確認する、という使い方ができます。</p>\n<p>我が家はOpenVPNでイントラ接続が可能になってます。</p>\n<p><img class=\"lozad\" src=\"data:image/gif;base64,R0lGODlhAQABAGAAACH5BAEKAP8ALAAAAAABAAEAAAgEAP8FBAA7\" data-src=\"https://i.imgur.com/MbyFzmel.png\" alt=\"img\"></p>\n<h2 id=\"動画をslackに投稿\" style=\"position:relative;\"><a href=\"#%E5%8B%95%E7%94%BB%E3%82%92slack%E3%81%AB%E6%8A%95%E7%A8%BF\" aria-label=\"動画をslackに投稿 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>動画をSlackに投稿</h2>\n<p>さて、ここからが本番のSlackへの画像投稿です。</p>\n<p>Slackへのファイル投稿はAPPSを使います。何番煎じかわからないくらいたくさん記事が転がっているのでここでは解説しませんが、Botトークンを入手する必要があります。</p>\n<p><a href=\"https://note.com/10mohi6/n/n0fd906a5f980\" target=\"_blank\" rel=\"noopener noreferrer\">ご参考: 超簡単PythonでSlackにファイルアップロード＆メッセージ投稿（Slack API利用）新方式</a></p>\n<p>動画が作成完了されたら動くスクリプトは<strong>on_movie_end</strong>で設定できますが今回はshellを呼び出して、shellのなかでSlack投稿用のPythonに連携します。</p>\n<p>特に理由はないですが、Slackアップロード以外に何かやることがある場合にこうしておくと便利かな、というのとアップロード済みの動画をラズパイから削除することを実施するためです。</p>\n<div class=\"gatsby-highlight\" data-language=\"shell\"><pre class=\"language-shell\"><code class=\"language-shell\"><span class=\"token shebang important\">#!/bin/bash</span>\n<span class=\"token assign-left variable\">FILE</span><span class=\"token operator\">=</span><span class=\"token variable\">$1</span>\npython3 /home/pi/motion/upload_slack.py <span class=\"token variable\">$FILE</span> <span class=\"token string\">\"MP4 File\"</span>\n<span class=\"token function\">rm</span> -f <span class=\"token variable\">$FILE</span></code></pre></div>\n<p>upload_slack.pyはこんな感じ.</p>\n<p>SlackのChannelIDはSlackWeb版を使うとURLの最後のパスがそれにあたります。公式は<a href=\"https://api.slack.com/methods/channels.list\" target=\"_blank\" rel=\"noopener noreferrer\">APIを叩いて調べる</a>のを進めてますが、Web版が一番簡単に見つけられます。</p>\n<div class=\"gatsby-highlight\" data-language=\"python\"><pre class=\"language-python\"><code class=\"language-python\"><span class=\"token keyword\">import</span> sys\n<span class=\"token keyword\">import</span> datetime\n<span class=\"token keyword\">import</span> json\n<span class=\"token keyword\">import</span> requests\n\nFILENAME <span class=\"token operator\">=</span> sys<span class=\"token punctuation\">.</span>argv<span class=\"token punctuation\">[</span><span class=\"token number\">1</span><span class=\"token punctuation\">]</span>\nFILEFORMAT <span class=\"token operator\">=</span> sys<span class=\"token punctuation\">.</span>argv<span class=\"token punctuation\">[</span><span class=\"token number\">2</span><span class=\"token punctuation\">]</span>\nTOKEN <span class=\"token operator\">=</span> <span class=\"token string\">\"xoxb-xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx\"</span> <span class=\"token comment\"># Slackトークン</span>\nCHANNEL <span class=\"token operator\">=</span> <span class=\"token string\">\"C0xxxxxxxxxxxx\"</span> <span class=\"token comment\"># ChannelID</span>\n\n<span class=\"token keyword\">print</span><span class=\"token punctuation\">(</span>FILENAME<span class=\"token punctuation\">)</span>\n<span class=\"token keyword\">with</span> <span class=\"token builtin\">open</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"{}\"</span><span class=\"token punctuation\">.</span><span class=\"token builtin\">format</span><span class=\"token punctuation\">(</span>FILENAME<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"rb\"</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">as</span> f<span class=\"token punctuation\">:</span>\n    dt_now <span class=\"token operator\">=</span> datetime<span class=\"token punctuation\">.</span>datetime<span class=\"token punctuation\">.</span>now<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n    files <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span><span class=\"token string\">\"file\"</span><span class=\"token punctuation\">:</span> f<span class=\"token punctuation\">.</span>read<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">}</span>\n    param <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token string\">\"token\"</span><span class=\"token punctuation\">:</span> TOKEN<span class=\"token punctuation\">,</span> \n        <span class=\"token string\">\"channels\"</span> <span class=\"token punctuation\">:</span>CHANNEL<span class=\"token punctuation\">,</span>\n        <span class=\"token string\">\"filename\"</span> <span class=\"token punctuation\">:</span>FILENAME<span class=\"token punctuation\">,</span>\n        <span class=\"token string\">\"title\"</span><span class=\"token punctuation\">:</span> FILEFORMAT\n        <span class=\"token punctuation\">}</span>\n    resp <span class=\"token operator\">=</span> requests<span class=\"token punctuation\">.</span>post<span class=\"token punctuation\">(</span>url<span class=\"token operator\">=</span><span class=\"token string\">\"https://slack.com/api/files.upload\"</span><span class=\"token punctuation\">,</span>params<span class=\"token operator\">=</span>param<span class=\"token punctuation\">,</span> files<span class=\"token operator\">=</span>files<span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">print</span><span class=\"token punctuation\">(</span>resp<span class=\"token punctuation\">.</span>text<span class=\"token punctuation\">)</span></code></pre></div>\n<p>何のことはないですね。ファイルをバイナリで読み込んで送るだけです。</p>\n<p>ちなみに、動画の投稿は検知から<strong>1分</strong>ほどかかります。古いラズパイの性能がかなり低いということもありますが、画像ファイル作成にはffmpegでのエンコードが発生するので時間がかかる、というわけです。</p>\n<p>それでは、監視カメラとしてはアウトな気がするので追加で<strong>on_movie_start</strong>を設定します。こちらは動画ファイルが作成されるタイミングでトリガーされるスクリプトなのでほぼ動体検知タイミングで通知を飛ばすことができます。</p>\n<p>投稿はただのincoming webhookです。画像や動画は置いておいてとりあえず何か起きたよ！って通知だけSlackにあげることにしました。</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">import datetime\nimport json\nimport requests\n\nWEB_HOOK_URL = \"https://hooks.slack.com/services/xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx\"\ndt_now = datetime.datetime.now()\nrequests.post(WEB_HOOK_URL, data = json.dumps({\n    \"text\": \"Alarm triggered. Check out the attached video! {}\".format(dt_now.strftime(\"%Y/%m/%d %H:%M:%S\")),\n    'username': \"motion_detect\",\n    'icon_emoji': \":robot_face:\",\n    'link_names': 1,\n}))</code></pre></div>\n<h2 id=\"slackに画像を投稿\" style=\"position:relative;\"><a href=\"#slack%E3%81%AB%E7%94%BB%E5%83%8F%E3%82%92%E6%8A%95%E7%A8%BF\" aria-label=\"slackに画像を投稿 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Slackに画像を投稿</h2>\n<p>モバイル版のSlackでもプレビュー見たい問題のため、画像も投稿します。ただ、こちらもほぼ上記と同じなのでスクリプトは割愛します。</p>\n<p>ちなみに、<strong>output_pictures best</strong>にすると、動画の作成完了まで画像は保存されませんので、投稿スピードは遅いです。</p>\n<h2 id=\"できた\" style=\"position:relative;\"><a href=\"#%E3%81%A7%E3%81%8D%E3%81%9F\" aria-label=\"できた permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>できた！</h2>\n<p><img class=\"lozad\" src=\"data:image/gif;base64,R0lGODlhAQABAGAAACH5BAEKAP8ALAAAAAABAAEAAAgEAP8FBAA7\" data-src=\"https://i.imgur.com/m5HEdzHl.png\" alt=\"img\"></p>\n<p>このように監視カメラで動体検知をするとSlackに通知が飛び、画像と動画が確認できるようになりました。</p>\n<p>ちょっと検知閾値が低すぎて、シーリングライトのオンオフでも反応しますが、反応しないよりはいいかなと思ってます。</p>\n<h2 id=\"問題発生\" style=\"position:relative;\"><a href=\"#%E5%95%8F%E9%A1%8C%E7%99%BA%E7%94%9F\" aria-label=\"問題発生 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>問題発生</h2>\n<p>無事完成となったのですが、早速致命的な問題が起きてしまいます。</p>\n<p>motion起動から3～4時間すると、カメラモジュールがハングってしまい釣られてmotion自体もdefunctして完全にOS再起動以外直す手段がなくなってしまう事象が発生しました。</p>\n<p>とりあえず、カメラモジュールがハングった場合最低でも検知できないとまずいので<strong>on_camera_lost</strong>を設定します。</p>\n<p>こちらもスクリプトは割愛しますが、incoming webhookでカメラモジュールのハングを通知する仕組みです。</p>\n<p><img class=\"lozad\" src=\"data:image/gif;base64,R0lGODlhAQABAGAAACH5BAEKAP8ALAAAAAABAAEAAAgEAP8FBAA7\" data-src=\"https://i.imgur.com/tpdlfLfl.png\" alt=\"img\"></p>\n<p>うまく検知できてますね。</p>\n<p>Slackで通知を受け取ることでますます再現性が高いことがわかったので、何か根本的な原因があると思いとりあえず思い当たる2つを修正しました。</p>\n<ul>\n<li>osのdist-upgrade不具合が解消されてるかもしれない</li>\n<li>オーバークロックの無効化</li>\n</ul>\n<p>こちら二つを実施したところ直りました。何だったんでしょうか。。</p>\n<h2 id=\"結論\" style=\"position:relative;\"><a href=\"#%E7%B5%90%E8%AB%96\" aria-label=\"結論 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>結論</h2>\n<p>とりあえず監視カメラが自作できたのでラズパイ有効活用は成功ではないでしょうか？</p>","words":3320,"minutes":9}},"staticQueryHashes":["1319877725","2959249232"]}