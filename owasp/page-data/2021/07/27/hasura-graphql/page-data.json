{"componentChunkName":"component---src-templates-blog-post-tsx","path":"/2021/07/27/hasura-graphql","result":{"data":{"content":{"edges":[{"node":{"id":"b9d74dd9-1196-5822-9f87-a901a8c2bbe1","excerpt":"勉強しようと思うと掃除してしまうのはなんででしょうかね。 Table of Contents Hasura Cloud Hasura PostgreSQLの準備はHerokuで アーキテクチャ DBとの接続 Pythonで定期的にGraphQLのmutation…","fields":{"slug":"2021/07/27/hasura-graphql"},"frontmatter":{"id":null,"title":"Hasura CloudのGraphQLが便利すぎた話","slug":"2021/07/27/hasura-graphql","date":"2021-07-27T02:45:28.646Z","headerImage":"https://i.imgur.com/R0GFe6X.png","tags":["Hasura","GraphQL","Vercel","Next.js","Heroku","imgur"]}}}]}},"pageContext":{"id":"b9d74dd9-1196-5822-9f87-a901a8c2bbe1","index":14,"repHtml":"<p>勉強しようと思うと掃除してしまうのはなんででしょうかね。</p>\n<h2 id=\"table-of-contents\" style=\"position:relative;\"><a href=\"#table-of-contents\" aria-label=\"table of contents permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Table of Contents</h2>\n<div class=\"toc\">\n<ul>\n<li><a href=\"#hasura-cloud\">Hasura Cloud</a></li>\n<li><a href=\"#hasura\">Hasura</a></li>\n<li><a href=\"#postgresql%E3%81%AE%E6%BA%96%E5%82%99%E3%81%AFheroku%E3%81%A7\">PostgreSQLの準備はHerokuで</a></li>\n<li><a href=\"#%E3%82%A2%E3%83%BC%E3%82%AD%E3%83%86%E3%82%AF%E3%83%81%E3%83%A3\">アーキテクチャ</a></li>\n<li><a href=\"#db%E3%81%A8%E3%81%AE%E6%8E%A5%E7%B6%9A\">DBとの接続</a></li>\n<li><a href=\"#python%E3%81%A7%E5%AE%9A%E6%9C%9F%E7%9A%84%E3%81%ABgraphql%E3%81%AEmutation%E3%82%92%E3%81%99%E3%82%8B\">Pythonで定期的にGraphQLのmutationをする</a></li>\n<li><a href=\"#%E3%83%AD%E3%83%BC%E3%83%AB%E3%82%92%E8%A8%AD%E5%AE%9A%E3%81%99%E3%82%8B\">ロールを設定する</a></li>\n<li><a href=\"#nextjsreact-typescript%E3%81%8B%E3%82%89graphql%E3%82%92%E5%88%A9%E7%94%A8%E3%81%99%E3%82%8B\">Next.js(React TypeScript)からGraphQLを利用する</a></li>\n<li><a href=\"#%E3%81%A7%E3%81%8D%E3%81%9F\">できた</a></li>\n<li><a href=\"#%E3%81%8A%E3%81%BE%E3%81%91-slack%E3%81%AB%E6%AF%8E%E6%97%A5%E7%8A%B6%E6%B3%81%E3%82%92%E3%82%B0%E3%83%A9%E3%83%95%E4%BB%98%E3%81%8D%E3%81%A7%E6%8A%95%E7%A8%BF%E3%81%99%E3%82%8B\">おまけ Slackに毎日状況をグラフ付きで投稿する</a></li>\n<li><a href=\"#%E5%8F%8D%E7%9C%81\">反省</a></li>\n</ul>\n</div>\n<h2 id=\"hasura-cloud\" style=\"position:relative;\"><a href=\"#hasura-cloud\" aria-label=\"hasura cloud permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Hasura Cloud</h2>\n<p>皆さんは<a href=\"https://hasura.io/\" target=\"_blank\" rel=\"noopener noreferrer\">Hasura Cloud</a>を知ってますか？</p>\n<p>PostgreSQLやMS SQL Serverに接続するだけで、DBのテーブルから<strong>GraphQLエンドポイント</strong>を作ってくれる、というSaaS(API as a Service)です。</p>\n<p>今更ながら最近この便利なサービスを知ったのでご紹介がてらゴーミー(Go Me!)サービスを作っていきます。</p>\n<h2 id=\"hasura\" style=\"position:relative;\"><a href=\"#hasura\" aria-label=\"hasura permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Hasura</h2>\n<p>Hasura自体はOSSで<a href=\"https://github.com/hasura/graphql-engine\" target=\"_blank\" rel=\"noopener noreferrer\">hasura/graphql-engine</a>にて公開されております。Dockerコンテナでコンソールも立ち上げることができるので気軽な検証はDockerを使うのもありだと思います。</p>\n<p>ですが、Hasura Cloudが<strong>Hobby用に無料枠を公開している</strong>のでそちらを今回使っていきたいと思います。</p>\n<p><img class=\"lozad\" src=\"data:image/gif;base64,R0lGODlhAQABAGAAACH5BAEKAP8ALAAAAAABAAEAAAgEAP8FBAA7\" data-src=\"https://raw.githubusercontent.com/hasura/graphql-engine/master/assets/demo.gif\" alt=\"img\"></p>\n<p>↑公式ドキュメントからの引用ですがこんな感じでWebコンソールでPostgreSQLに接続して簡単にGraphQLのエンドポイントを作れるようになるらしいです。</p>\n<h2 id=\"postgresqlの準備はherokuで\" style=\"position:relative;\"><a href=\"#postgresql%E3%81%AE%E6%BA%96%E5%82%99%E3%81%AFheroku%E3%81%A7\" aria-label=\"postgresqlの準備はherokuで permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>PostgreSQLの準備はHerokuで</h2>\n<p>Hasuraを使うためにPostgreSQLを作らなければいけません。もちろんお金はないので無料で作れるところを探します。</p>\n<p>これは個人Webサービス開発者なら定石過ぎて逆に嫌煙されるくらい有名な手段かもしれませんが、今回はHerokuの<a href=\"https://data.heroku.com/\" target=\"_blank\" rel=\"noopener noreferrer\">Database</a>にてPostgreSQLを作っていきます。</p>\n<p>作成は非常に簡単で、HerokuのダッシュボードからElementsを選択し、Addonsで<a href=\"https://elements.heroku.com/addons/heroku-postgresql\" target=\"_blank\" rel=\"noopener noreferrer\">Heroku-PostgreSQL</a>を選択するだけです。</p>\n<p><img class=\"lozad\" src=\"data:image/gif;base64,R0lGODlhAQABAGAAACH5BAEKAP8ALAAAAAABAAEAAAgEAP8FBAA7\" data-src=\"https://i.imgur.com/hkpshVql.png\" alt=\"ma\"></p>\n<p>こちらレプリケーションやレコード上限がありますが、無料枠があります。<strong>10000レコードを超えると課金対象</strong>になるので、ならないように定期レコード削除機能も開発する必要がありますね。</p>\n<h2 id=\"アーキテクチャ\" style=\"position:relative;\"><a href=\"#%E3%82%A2%E3%83%BC%E3%82%AD%E3%83%86%E3%82%AF%E3%83%81%E3%83%A3\" aria-label=\"アーキテクチャ permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>アーキテクチャ</h2>\n<p><img class=\"lozad\" src=\"data:image/gif;base64,R0lGODlhAQABAGAAACH5BAEKAP8ALAAAAAABAAEAAAgEAP8FBAA7\" data-src=\"https://i.imgur.com/iz9IpHf.png\" alt=\"arch\"></p>\n<p>今回はこのようなアーキテクチャにします。以前<a href=\"https://blog.tubone-project24.xyz/2020/05/10/plant-check\" target=\"_blank\" rel=\"noopener noreferrer\">Raspberry PIを使って植物の水やり監視システムを作る</a>で作ったラズパイ水やり管理システムのメトリックを定期的に収集してHasuraのGraphQL mutationを介してHeroku PostgreSQLに書き込み、それをVercel + Next.jsで作ったダッシュボードでこれまたHasura GraphQLを介してQuery取得し可視化する、というものです。</p>\n<p><del>別に毎日水やりすればいいだけなのですが...</del></p>\n<h2 id=\"dbとの接続\" style=\"position:relative;\"><a href=\"#db%E3%81%A8%E3%81%AE%E6%8E%A5%E7%B6%9A\" aria-label=\"dbとの接続 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>DBとの接続</h2>\n<p>Hasura CloudとPostgreSQLを接続するために先ほど作成したHeroku PostgreSQLの接続情報を確認します。DB自体はHerokuダッシュボードのDatabaseから確認できますのでそちらからSetting=>View Crendencialsを選択します。</p>\n<p><img class=\"lozad\" src=\"data:image/gif;base64,R0lGODlhAQABAGAAACH5BAEKAP8ALAAAAAABAAEAAAgEAP8FBAA7\" data-src=\"https://i.imgur.com/TR9WSti.png\" alt=\"ima\"></p>\n<p>こちらの情報を控え、Hasura CloudのコンソールからDataを選択し、新しいDababaseの情報を入れ込みます。執筆しながら気が付いたのですがよく見たらHeroku PostgreSQLが作れるメニューがありますね..。</p>\n<p><img class=\"lozad\" src=\"data:image/gif;base64,R0lGODlhAQABAGAAACH5BAEKAP8ALAAAAAABAAEAAAgEAP8FBAA7\" data-src=\"https://i.imgur.com/vzpBanB.png\" alt=\"ima\"></p>\n<p>無事接続が完了すると、このようにスキーマやテーブルが作れるようになります。</p>\n<p><img class=\"lozad\" src=\"data:image/gif;base64,R0lGODlhAQABAGAAACH5BAEKAP8ALAAAAAABAAEAAAgEAP8FBAA7\" data-src=\"https://i.imgur.com/c1BI53V.png\" alt=\"img\"></p>\n<p>テーブルを作ってみましょう。create tableから簡単に作れます。</p>\n<p><img class=\"lozad\" src=\"data:image/gif;base64,R0lGODlhAQABAGAAACH5BAEKAP8ALAAAAAABAAEAAAgEAP8FBAA7\" data-src=\"https://i.imgur.com/dm0FJPU.png\" alt=\"img\"></p>\n<p>default valueにnow()などの関数が入れられますのでtimestampはこちらで作っちゃうことにしました。便利ですね。</p>\n<p>無事接続ができて適当な行を作ればこのようにメインコンソールからGraphQLが実行できるようになります。</p>\n<p><img class=\"lozad\" src=\"data:image/gif;base64,R0lGODlhAQABAGAAACH5BAEKAP8ALAAAAAABAAEAAAgEAP8FBAA7\" data-src=\"https://i.imgur.com/R0GFe6X.png\" alt=\"img\"></p>\n<p>Query↓</p>\n<div class=\"gatsby-highlight\" data-language=\"graphql\"><pre class=\"language-graphql\"><code class=\"language-graphql\"><span class=\"token keyword\">query</span> <span class=\"token definition-query function\">MyQuery</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token property-query\">raspi_plant_checker</span><span class=\"token punctuation\">(</span><span class=\"token attr-name\">order_by</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">{</span><span class=\"token attr-name\">timestamp</span><span class=\"token punctuation\">:</span> <span class=\"token property\">desc</span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token property\">light</span>\n    <span class=\"token property\">id</span>\n    <span class=\"token property\">moisture</span>\n    <span class=\"token property\">timestamp</span>\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>結果↓</p>\n<div class=\"gatsby-highlight\" data-language=\"json\"><pre class=\"language-json\"><code class=\"language-json\"><span class=\"token punctuation\">{</span>\n  <span class=\"token property\">\"data\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token property\">\"raspi_plant_checker\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span>\n      <span class=\"token punctuation\">{</span>\n        <span class=\"token property\">\"light\"</span><span class=\"token operator\">:</span> <span class=\"token number\">175</span><span class=\"token punctuation\">,</span>\n        <span class=\"token property\">\"id\"</span><span class=\"token operator\">:</span> <span class=\"token number\">6</span><span class=\"token punctuation\">,</span>\n        <span class=\"token property\">\"moisture\"</span><span class=\"token operator\">:</span> <span class=\"token number\">0</span><span class=\"token punctuation\">,</span>\n        <span class=\"token property\">\"timestamp\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"2021-07-25T12:17:47.776369+00:00\"</span>\n      <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n      <span class=\"token punctuation\">{</span>\n        <span class=\"token property\">\"light\"</span><span class=\"token operator\">:</span> <span class=\"token number\">0</span><span class=\"token punctuation\">,</span>\n        <span class=\"token property\">\"id\"</span><span class=\"token operator\">:</span> <span class=\"token number\">5</span><span class=\"token punctuation\">,</span>\n        <span class=\"token property\">\"moisture\"</span><span class=\"token operator\">:</span> <span class=\"token number\">0</span><span class=\"token punctuation\">,</span>\n        <span class=\"token property\">\"timestamp\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"2021-07-24T02:48:54.994038+00:00\"</span>\n      <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n      <span class=\"token punctuation\">{</span>\n        <span class=\"token property\">\"light\"</span><span class=\"token operator\">:</span> <span class=\"token number\">175</span><span class=\"token punctuation\">,</span>\n        <span class=\"token property\">\"id\"</span><span class=\"token operator\">:</span> <span class=\"token number\">4</span><span class=\"token punctuation\">,</span>\n        <span class=\"token property\">\"moisture\"</span><span class=\"token operator\">:</span> <span class=\"token number\">0</span><span class=\"token punctuation\">,</span>\n        <span class=\"token property\">\"timestamp\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"2021-07-23T12:51:50.070372+00:00\"</span>\n      <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n      <span class=\"token punctuation\">{</span>\n        <span class=\"token property\">\"light\"</span><span class=\"token operator\">:</span> <span class=\"token number\">175</span><span class=\"token punctuation\">,</span>\n        <span class=\"token property\">\"id\"</span><span class=\"token operator\">:</span> <span class=\"token number\">3</span><span class=\"token punctuation\">,</span>\n        <span class=\"token property\">\"moisture\"</span><span class=\"token operator\">:</span> <span class=\"token number\">255</span><span class=\"token punctuation\">,</span>\n        <span class=\"token property\">\"timestamp\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"2021-07-23T08:26:12.603547+00:00\"</span>\n      <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n      <span class=\"token punctuation\">{</span>\n        <span class=\"token property\">\"light\"</span><span class=\"token operator\">:</span> <span class=\"token number\">175</span><span class=\"token punctuation\">,</span>\n        <span class=\"token property\">\"id\"</span><span class=\"token operator\">:</span> <span class=\"token number\">2</span><span class=\"token punctuation\">,</span>\n        <span class=\"token property\">\"moisture\"</span><span class=\"token operator\">:</span> <span class=\"token number\">255</span><span class=\"token punctuation\">,</span>\n        <span class=\"token property\">\"timestamp\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"2021-07-23T07:54:17.186706+00:00\"</span>\n      <span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">]</span>\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>まだロールを設定してないのでリクエストヘッダーにx-hasura-admin-secretを設定しないといけないですがこの状態ですでにエンドポイントURLが使えるようになっております。</p>\n<p>めちゃくちゃ簡単ですね。</p>\n<h2 id=\"pythonで定期的にgraphqlのmutationをする\" style=\"position:relative;\"><a href=\"#python%E3%81%A7%E5%AE%9A%E6%9C%9F%E7%9A%84%E3%81%ABgraphql%E3%81%AEmutation%E3%82%92%E3%81%99%E3%82%8B\" aria-label=\"pythonで定期的にgraphqlのmutationをする permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Pythonで定期的にGraphQLのmutationをする</h2>\n<p>PythonのGraphQLクライアントといえば、<a href=\"https://github.com/graphql-python/gql\" target=\"_blank\" rel=\"noopener noreferrer\">gql</a>が有名です。</p>\n<p>基本的にドキュメント通りなのですが、ポイントになるところはヘッダーに<strong>x-hasura-admin-secret</strong>を設定してあげると特に制限なくmutationできますので、Clientで設定してます。本当はちゃんとロール作ったほうがいいですが、JWT認証がめんどくさかったのでadmin使ってしまいました。</p>\n<p>また、mutationでDBにinsertするときは<strong>insert_{{table名}}_one</strong>でできます。さらに、下記の通りvariablesを渡すこともできます。</p>\n<div class=\"gatsby-highlight\" data-language=\"python\"><pre class=\"language-python\"><code class=\"language-python\"><span class=\"token keyword\">from</span> gql <span class=\"token keyword\">import</span> gql<span class=\"token punctuation\">,</span> Client\n<span class=\"token keyword\">from</span> gql<span class=\"token punctuation\">.</span>transport<span class=\"token punctuation\">.</span>requests <span class=\"token keyword\">import</span> RequestsHTTPTransport\n\nHASURA_URL <span class=\"token operator\">=</span> <span class=\"token string\">\"https://xxxxx\"</span>\nHASURA_SECRET <span class=\"token operator\">=</span> <span class=\"token string\">\"xxxxxxx\"</span>\n\n\n<span class=\"token keyword\">def</span> <span class=\"token function\">upload_metric_to_hasura</span><span class=\"token punctuation\">(</span>moisture<span class=\"token punctuation\">,</span> light<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n    client <span class=\"token operator\">=</span> Client<span class=\"token punctuation\">(</span>\n        transport<span class=\"token operator\">=</span>RequestsHTTPTransport<span class=\"token punctuation\">(</span>\n            url<span class=\"token operator\">=</span>HASURA_URL<span class=\"token punctuation\">,</span>\n            use_json<span class=\"token operator\">=</span><span class=\"token boolean\">True</span><span class=\"token punctuation\">,</span>\n            headers<span class=\"token operator\">=</span><span class=\"token punctuation\">{</span>\n                <span class=\"token string\">\"Content-type\"</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"application/json\"</span><span class=\"token punctuation\">,</span>\n                <span class=\"token string\">\"x-hasura-admin-secret\"</span><span class=\"token punctuation\">:</span> HASURA_SECRET\n            <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n            retries<span class=\"token operator\">=</span><span class=\"token number\">3</span><span class=\"token punctuation\">,</span>\n        <span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n        fetch_schema_from_transport<span class=\"token operator\">=</span><span class=\"token boolean\">True</span><span class=\"token punctuation\">,</span>\n    <span class=\"token punctuation\">)</span>\n    query <span class=\"token operator\">=</span> gql<span class=\"token punctuation\">(</span>\n        <span class=\"token triple-quoted-string string\">\"\"\"\n        mutation MyMutation ($light: numeric!, $moisture: numeric!){\n            insert_raspi_plant_checker_one(object: {light: $light, moisture: $moisture}) {\n                id\n                light\n                moisture\n                timestamp\n            }\n        }\n        \"\"\"</span>\n    <span class=\"token punctuation\">)</span>\n    params <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span><span class=\"token string\">\"light\"</span><span class=\"token punctuation\">:</span> light<span class=\"token punctuation\">,</span> <span class=\"token string\">\"moisture\"</span><span class=\"token punctuation\">:</span> moisture<span class=\"token punctuation\">}</span>\n    result <span class=\"token operator\">=</span> client<span class=\"token punctuation\">.</span>execute<span class=\"token punctuation\">(</span>query<span class=\"token punctuation\">,</span> variable_values<span class=\"token operator\">=</span>params<span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">print</span><span class=\"token punctuation\">(</span>result<span class=\"token punctuation\">)</span>\n    \nupload_metric_to_hasura<span class=\"token punctuation\">(</span><span class=\"token number\">2</span><span class=\"token punctuation\">,</span> <span class=\"token number\">3</span><span class=\"token punctuation\">)</span></code></pre></div>\n<p>GraphQLだけ切り出すとこんな感じ。</p>\n<div class=\"gatsby-highlight\" data-language=\"graphql\"><pre class=\"language-graphql\"><code class=\"language-graphql\">        <span class=\"token keyword\">mutation</span> <span class=\"token definition-mutation function\">MyMutation</span> <span class=\"token punctuation\">(</span><span class=\"token variable variable-input\">$light</span><span class=\"token punctuation\">:</span> <span class=\"token property\">numeric</span><span class=\"token operator\">!</span><span class=\"token punctuation\">,</span> <span class=\"token variable variable-input\">$moisture</span><span class=\"token punctuation\">:</span> <span class=\"token property\">numeric</span><span class=\"token operator\">!</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">{</span>\n            <span class=\"token property-query property-mutation\">insert_raspi_plant_checker_one</span><span class=\"token punctuation\">(</span><span class=\"token attr-name\">object</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">{</span><span class=\"token attr-name\">light</span><span class=\"token punctuation\">:</span> <span class=\"token variable variable-input\">$light</span><span class=\"token punctuation\">,</span> <span class=\"token attr-name\">moisture</span><span class=\"token punctuation\">:</span> <span class=\"token variable variable-input\">$moisture</span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n                <span class=\"token property\">id</span>\n                <span class=\"token property\">light</span>\n                <span class=\"token property\">moisture</span>\n                <span class=\"token property\">timestamp</span>\n            <span class=\"token punctuation\">}</span>\n        <span class=\"token punctuation\">}</span></code></pre></div>\n<p>また、今回はHeroku PostgreSQLのレコード制限があるので古いデータは消すことにします。</p>\n<p>なので、同じくmutationでdeleteを実現する必要があります。</p>\n<div class=\"gatsby-highlight\" data-language=\"python\"><pre class=\"language-python\"><code class=\"language-python\"><span class=\"token keyword\">def</span> <span class=\"token function\">delete_old_metrics_to_hasura</span><span class=\"token punctuation\">(</span>days_before<span class=\"token operator\">=</span><span class=\"token number\">7</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n    dt_now <span class=\"token operator\">=</span> datetime<span class=\"token punctuation\">.</span>now<span class=\"token punctuation\">(</span>timezone<span class=\"token punctuation\">.</span>utc<span class=\"token punctuation\">)</span>\n    before_day <span class=\"token operator\">=</span> dt_now <span class=\"token operator\">-</span> timedelta<span class=\"token punctuation\">(</span>days<span class=\"token operator\">=</span>days_before<span class=\"token punctuation\">)</span>\n    dt <span class=\"token operator\">=</span> before_day<span class=\"token punctuation\">.</span>astimezone<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span>isoformat<span class=\"token punctuation\">(</span>timespec<span class=\"token operator\">=</span><span class=\"token string\">'microseconds'</span><span class=\"token punctuation\">)</span>\n    client <span class=\"token operator\">=</span> Client<span class=\"token punctuation\">(</span>\n        transport<span class=\"token operator\">=</span>RequestsHTTPTransport<span class=\"token punctuation\">(</span>\n            url<span class=\"token operator\">=</span>HASURA_URL<span class=\"token punctuation\">,</span>\n            use_json<span class=\"token operator\">=</span><span class=\"token boolean\">True</span><span class=\"token punctuation\">,</span>\n            headers<span class=\"token operator\">=</span><span class=\"token punctuation\">{</span>\n                <span class=\"token string\">\"Content-type\"</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"application/json\"</span><span class=\"token punctuation\">,</span>\n                <span class=\"token string\">\"x-hasura-admin-secret\"</span><span class=\"token punctuation\">:</span> HASURA_SECRET\n            <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n            retries<span class=\"token operator\">=</span><span class=\"token number\">3</span><span class=\"token punctuation\">,</span>\n        <span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n        fetch_schema_from_transport<span class=\"token operator\">=</span><span class=\"token boolean\">True</span><span class=\"token punctuation\">,</span>\n    <span class=\"token punctuation\">)</span>\n    query <span class=\"token operator\">=</span> gql<span class=\"token punctuation\">(</span>\n        <span class=\"token triple-quoted-string string\">\"\"\"\n        mutation MyMutation ($dt: timestamptz){\n            delete_raspi_plant_checker(where: {timestamp: {_lt: $dt}}) {\n                returning {\n                    id\n                    light\n                    moisture\n                    timestamp\n                }\n            }\n        }\n        \"\"\"</span>\n    <span class=\"token punctuation\">)</span>\n    params <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span><span class=\"token string\">\"dt\"</span><span class=\"token punctuation\">:</span> dt<span class=\"token punctuation\">}</span>\n    result <span class=\"token operator\">=</span> client<span class=\"token punctuation\">.</span>execute<span class=\"token punctuation\">(</span>query<span class=\"token punctuation\">,</span> variable_values<span class=\"token operator\">=</span>params<span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">print</span><span class=\"token punctuation\">(</span>result<span class=\"token punctuation\">)</span>\n\ndelete_old_metrics_to_hasura<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span></code></pre></div>\n<p>_ltをwhere句で使えるので簡単ですね。↓がGraphQLです。</p>\n<div class=\"gatsby-highlight\" data-language=\"graphql\"><pre class=\"language-graphql\"><code class=\"language-graphql\">        <span class=\"token keyword\">mutation</span> <span class=\"token definition-mutation function\">MyMutation</span> <span class=\"token punctuation\">(</span><span class=\"token variable variable-input\">$dt</span><span class=\"token punctuation\">:</span> <span class=\"token property\">timestamptz</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">{</span>\n            <span class=\"token property-query property-mutation\">delete_raspi_plant_checker</span><span class=\"token punctuation\">(</span><span class=\"token attr-name\">where</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">{</span><span class=\"token attr-name\">timestamp</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">{</span><span class=\"token attr-name\">_lt</span><span class=\"token punctuation\">:</span> <span class=\"token variable variable-input\">$dt</span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n                <span class=\"token object\">returning</span> <span class=\"token punctuation\">{</span>\n                    <span class=\"token property\">id</span>\n                    <span class=\"token property\">light</span>\n                    <span class=\"token property\">moisture</span>\n                    <span class=\"token property\">timestamp</span>\n                <span class=\"token punctuation\">}</span>\n            <span class=\"token punctuation\">}</span>\n        <span class=\"token punctuation\">}</span></code></pre></div>\n<h2 id=\"ロールを設定する\" style=\"position:relative;\"><a href=\"#%E3%83%AD%E3%83%BC%E3%83%AB%E3%82%92%E8%A8%AD%E5%AE%9A%E3%81%99%E3%82%8B\" aria-label=\"ロールを設定する permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>ロールを設定する</h2>\n<p>今回はNext.jsで作ったフロントから直接Hasuraを叩く必要がありますので、やはりadminのままでは使いにくいので読み込みのみロールを作ることにします。といってもユーザー認証の必要ないanonymousのロールを作り、そこにテーブルのSelect権限だけつける形を取ります。</p>\n<p><img class=\"lozad\" src=\"data:image/gif;base64,R0lGODlhAQABAGAAACH5BAEKAP8ALAAAAAABAAEAAAgEAP8FBAA7\" data-src=\"https://i.imgur.com/gvA0pe2.png\" alt=\"img\"></p>\n<p>まず、テーブル設定画面からpermissionを設定し、とりあえず<strong>anonymous</strong>というユーザーを作ります。</p>\n<p>Hasuraではanonymous接続はデフォルトでOffになっているのでこちらを有効にしていきます。</p>\n<p>プロジェクトコンソールまで戻って、環境変数<strong>HASURA_GRAPHQL_UNAUTHORIZED_ROLE</strong>に先ほど作った<strong>anonymous</strong>を設定します。</p>\n<p><img class=\"lozad\" src=\"data:image/gif;base64,R0lGODlhAQABAGAAACH5BAEKAP8ALAAAAAABAAEAAAgEAP8FBAA7\" data-src=\"https://i.imgur.com/rRAVwPw.png\" alt=\"img\"></p>\n<p>さらに、いたずらにQueryを発行されて無料利用枠を消費されたくないのでリミットをつけます。こちらはコンソールのSecurityから設定できます。</p>\n<p>anonymousはglobalの設定を踏襲することにしますので、globalでそれぞれのリミットを設定して、IPアドレスごとにリミット制御するようにしました。</p>\n<p><img class=\"lozad\" src=\"data:image/gif;base64,R0lGODlhAQABAGAAACH5BAEKAP8ALAAAAAABAAEAAAgEAP8FBAA7\" data-src=\"https://i.imgur.com/FvSFqnx.png\" alt=\"img\"></p>\n<h2 id=\"nextjsreact-typescriptからgraphqlを利用する\" style=\"position:relative;\"><a href=\"#nextjsreact-typescript%E3%81%8B%E3%82%89graphql%E3%82%92%E5%88%A9%E7%94%A8%E3%81%99%E3%82%8B\" aria-label=\"nextjsreact typescriptからgraphqlを利用する permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Next.js(React TypeScript)からGraphQLを利用する</h2>\n<p>さて、準備ができましたのでいよいよダッシュボードの開発に移ります。</p>\n<p>JavaScriptで使えるGraphQLクライアントといえば<a href=\"https://www.apollographql.com/docs/\" target=\"_blank\" rel=\"noopener noreferrer\">Apollo</a>が有名なので今回はこちらを利用していきます。</p>\n<p>何番煎じかわからないので詳しい解説は抜きにしていきます。下のようにすればうまく取れるはずです。</p>\n<div class=\"gatsby-highlight\" data-language=\"tsx\"><pre class=\"language-tsx\"><code class=\"language-tsx\"><span class=\"token keyword\">import</span> <span class=\"token punctuation\">{</span> ApolloClient<span class=\"token punctuation\">,</span> InMemoryCache<span class=\"token punctuation\">,</span> gql <span class=\"token punctuation\">}</span> <span class=\"token keyword\">from</span> <span class=\"token string\">'@apollo/client'</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">const</span> <span class=\"token constant\">URI_ENDPOINT</span> <span class=\"token operator\">=</span> <span class=\"token string\">\"https://xxxxxxxxxxxx.hasura.app/v1/graphql\"</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">const</span> client <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">ApolloClient</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span>\n  uri<span class=\"token operator\">:</span> <span class=\"token constant\">URI_ENDPOINT</span><span class=\"token punctuation\">,</span>\n  cache<span class=\"token operator\">:</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">InMemoryCache</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">export</span> <span class=\"token keyword\">const</span> Table <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token operator\">:</span> <span class=\"token constant\">JSX</span><span class=\"token punctuation\">.</span>Element <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">const</span> <span class=\"token function-variable function\">getPlantData</span> <span class=\"token operator\">=</span> <span class=\"token keyword\">async</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">const</span> <span class=\"token punctuation\">{</span> data <span class=\"token punctuation\">}</span> <span class=\"token operator\">=</span> <span class=\"token keyword\">await</span> client<span class=\"token punctuation\">.</span><span class=\"token function\">query</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span>\n      query<span class=\"token operator\">:</span> gql<span class=\"token template-string\"><span class=\"token template-punctuation string\">`</span><span class=\"token string\">          \n          query MyQuery {\n              raspi_plant_checker {\n                  id\n                  light\n                  moisture\n                  timestamp\n              }\n          }\n      </span><span class=\"token template-punctuation string\">`</span></span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">const</span> plantCheckerData <span class=\"token operator\">=</span> data<span class=\"token punctuation\">.</span>raspi_plant_checker<span class=\"token punctuation\">.</span><span class=\"token function\">map</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>data<span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span>id<span class=\"token operator\">:</span> data<span class=\"token punctuation\">.</span>id<span class=\"token punctuation\">,</span> light<span class=\"token operator\">:</span> data<span class=\"token punctuation\">.</span>light<span class=\"token punctuation\">,</span> moisture<span class=\"token operator\">:</span> data<span class=\"token punctuation\">.</span>moisture<span class=\"token punctuation\">,</span> timestamp<span class=\"token operator\">:</span> data<span class=\"token punctuation\">.</span>timestamp<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">return</span> plantCheckerData\n    <span class=\"token operator\">...</span><span class=\"token punctuation\">(</span>省略<span class=\"token punctuation\">)</span></code></pre></div>\n<p>ちょっと詰まったなと思ったところはAppoloから取得したGraphQLの結果にはQueryで指定した項目以外に[[Prototype]]が付いてきます。今回取得した値をrecoilを使って状態管理しようと思ったのですが、このprototypeが邪魔でrecoilがうまく動かなかったので、mapで配列を再定義している、というわけです。</p>\n<p>他はmeterial table使ったり、chart.js使ったりしてますがこちらは以前作った<a href=\"https://blog.tubone-project24.xyz/2021/01/11/vercel-next\" target=\"_blank\" rel=\"noopener noreferrer\">Next.jsとVercelとRecoilとMaterial Tableを使ってAWSのステータスダッシュボードを作ってみた話</a>のパクリコードなので解説は割愛します。</p>\n<h2 id=\"できた\" style=\"position:relative;\"><a href=\"#%E3%81%A7%E3%81%8D%E3%81%9F\" aria-label=\"できた permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>できた</h2>\n<p>こんな感じでできました。我が家の植物情報なんてほかの人は興味なさそうですがVercelにあげて公開することにしました。</p>\n<p><a href=\"https://plant-check-graph.vercel.app/\" target=\"_blank\" rel=\"noopener noreferrer\">https://plant-check-graph.vercel.app/</a></p>\n<p><img class=\"lozad\" src=\"data:image/gif;base64,R0lGODlhAQABAGAAACH5BAEKAP8ALAAAAAABAAEAAAgEAP8FBAA7\" data-src=\"https://i.imgur.com/YznBG45.png\" alt=\"img\"></p>\n<p>ちょっと失敗したなと思ったのは土壌水分量(moisture)はセンサーの抵抗値から算出するのですが、0が抵抗値が低い状態を示しているので、つまり湿っているという状態です。直感的に逆ですね。</p>\n<p>ともあれ出来上がってよかったです。</p>\n<h2 id=\"おまけ-slackに毎日状況をグラフ付きで投稿する\" style=\"position:relative;\"><a href=\"#%E3%81%8A%E3%81%BE%E3%81%91-slack%E3%81%AB%E6%AF%8E%E6%97%A5%E7%8A%B6%E6%B3%81%E3%82%92%E3%82%B0%E3%83%A9%E3%83%95%E4%BB%98%E3%81%8D%E3%81%A7%E6%8A%95%E7%A8%BF%E3%81%99%E3%82%8B\" aria-label=\"おまけ slackに毎日状況をグラフ付きで投稿する permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>おまけ Slackに毎日状況をグラフ付きで投稿する</h2>\n<p>ここからは完全に余談なのですがせっかくダッシュボード作っても自分で毎日見に行くことはまずありません!!(なぜ作った)</p>\n<p>なので、せっかくなので、こちらのダッシュボードを毎日画面キャプチャし、Slackに投稿する機能も作ってみたいと思います。お勉強がてらキャプチャ機能はCypressで作ることにしました。</p>\n<p>まず、Cypressの設定をしていきます。</p>\n<p>cypressのインストールやpackage.jsonの設定は割愛します。</p>\n<p>specファイル**screenshot.spec.js ** は次のようになりました。</p>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\"><span class=\"token function\">describe</span><span class=\"token punctuation\">(</span><span class=\"token string\">'ScreenShotNetatmoDashboard'</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n  <span class=\"token function\">it</span><span class=\"token punctuation\">(</span><span class=\"token string\">'TopPageWithGraphs'</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n    cy<span class=\"token punctuation\">.</span><span class=\"token function\">visit</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"/\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    cy<span class=\"token punctuation\">.</span><span class=\"token function\">wait</span><span class=\"token punctuation\">(</span><span class=\"token number\">10000</span><span class=\"token punctuation\">)</span>\n    cy<span class=\"token punctuation\">.</span><span class=\"token function\">get</span><span class=\"token punctuation\">(</span><span class=\"token string\">'div > span:nth-child(2) > .MuiIconButton-colorInherit:nth-child(1) > .MuiIconButton-label > .MuiSvgIcon-root'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">click</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n    cy<span class=\"token punctuation\">.</span><span class=\"token function\">screenshot</span><span class=\"token punctuation\">(</span><span class=\"token string\">'screenShot'</span><span class=\"token punctuation\">,</span><span class=\"token punctuation\">{</span>\n      <span class=\"token literal-property property\">capture</span><span class=\"token operator\">:</span> <span class=\"token string\">'fullPage'</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p>変な要素指定がありますが、こちらはMaterial Tableにあるアクションボタンを押している動作です。そうしないとChart.jsで作ったグラフが開かない作りにしてしまったので。</p>\n<p>また、こんな変な要素、よく見つけられたと思ったほうに朗報でCypressにはChrome拡張がありまして、<a href=\"https://chrome.google.com/webstore/detail/cypress-scenario-recorder/fmpgoobcionmfneadjapdabmjfkmfekb?hl=ja\" target=\"_blank\" rel=\"noopener noreferrer\">Cypress Scenario Recorder</a>というものがあります。こちらを使えばツールが自動生成するようなボタンでも要素を取得することが簡単です。</p>\n<p><del>本当はスクラッチで作ってtest-idをつけるべきというのは知ってますよ..!!!!</del></p>\n<p><img class=\"lozad\" src=\"data:image/gif;base64,R0lGODlhAQABAGAAACH5BAEKAP8ALAAAAAABAAEAAAgEAP8FBAA7\" data-src=\"https://i.imgur.com/KaTx1pD.png\" alt=\"img\"></p>\n<p>また、上記SpecだとbaseURLの設定がされていないのでこのままでは動かないのでcypress.jsonも設定する必要があります。</p>\n<div class=\"gatsby-highlight\" data-language=\"json\"><pre class=\"language-json\"><code class=\"language-json\"><span class=\"token punctuation\">{</span>\n  <span class=\"token property\">\"baseUrl\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"https://plant-check-graph.vercel.app/\"</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>これで画面キャプチャが取れるようになったので次はSlackへのアップロードスクリプトです。</p>\n<p>例によってTypeScript化してません!!変換もめんどくさかったのでES modules JSファイルです。恥ずかしい!!<del>本当はDenoで作るつもりだったの!!うまく動かなかったの!!</del></p>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\"><span class=\"token keyword\">import</span> <span class=\"token punctuation\">{</span> ApolloClient<span class=\"token punctuation\">,</span> gql<span class=\"token punctuation\">,</span> HttpLink<span class=\"token punctuation\">,</span> InMemoryCache  <span class=\"token punctuation\">}</span> <span class=\"token keyword\">from</span> <span class=\"token string\">'@apollo/client'</span>\n<span class=\"token comment\">// \"fetch\" has not been found globally and no fetcher has been configured. To fix this, install a fetch package (like https://www.npmjs.com/package/cross-fetch), instantiate the fetcher, and pass it into your HttpLink constructor.</span>\n<span class=\"token keyword\">import</span> fetch <span class=\"token keyword\">from</span> <span class=\"token string\">'cross-fetch'</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">import</span> fs <span class=\"token keyword\">from</span> <span class=\"token string\">'fs'</span>\n<span class=\"token keyword\">import</span> axios <span class=\"token keyword\">from</span> <span class=\"token string\">'axios'</span>\n\n<span class=\"token keyword\">const</span> filePath <span class=\"token operator\">=</span> <span class=\"token string\">'./cypress/screenshots/screenshot.spec.js/screenShot.png'</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">const</span> slackWebhookUrl <span class=\"token operator\">=</span> process<span class=\"token punctuation\">.</span>env<span class=\"token punctuation\">.</span><span class=\"token constant\">SLACK_WEBHOOK_URL</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">const</span> imgurClientId <span class=\"token operator\">=</span> process<span class=\"token punctuation\">.</span>env<span class=\"token punctuation\">.</span><span class=\"token constant\">IMGUR_CLIENT_ID</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">const</span> <span class=\"token constant\">URI_ENDPOINT</span> <span class=\"token operator\">=</span> <span class=\"token string\">'https://xxxxxxxxxxxxx.hasura.app/v1/graphql'</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">const</span> dashBoardUrl <span class=\"token operator\">=</span> <span class=\"token string\">'https://plant-check-graph.vercel.app/'</span>\n\n<span class=\"token keyword\">const</span> client <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">ApolloClient</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span>\n  <span class=\"token literal-property property\">link</span><span class=\"token operator\">:</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">HttpLink</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span> <span class=\"token literal-property property\">uri</span><span class=\"token operator\">:</span> <span class=\"token constant\">URI_ENDPOINT</span><span class=\"token punctuation\">,</span> fetch <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n  <span class=\"token literal-property property\">cache</span><span class=\"token operator\">:</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">InMemoryCache</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">const</span> base64Data <span class=\"token operator\">=</span> fs<span class=\"token punctuation\">.</span><span class=\"token function\">readFileSync</span><span class=\"token punctuation\">(</span>filePath<span class=\"token punctuation\">,</span> <span class=\"token punctuation\">{</span> <span class=\"token literal-property property\">encoding</span><span class=\"token operator\">:</span> <span class=\"token string\">'base64'</span> <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">const</span> data <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token literal-property property\">image</span><span class=\"token operator\">:</span> base64Data<span class=\"token punctuation\">.</span><span class=\"token function\">replace</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">new</span> <span class=\"token class-name\">RegExp</span><span class=\"token punctuation\">(</span><span class=\"token string\">'data.*base64,'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token string\">''</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n  <span class=\"token literal-property property\">type</span><span class=\"token operator\">:</span> <span class=\"token string\">'base64'</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">const</span> config <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token literal-property property\">headers</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token literal-property property\">Authorization</span><span class=\"token operator\">:</span> <span class=\"token template-string\"><span class=\"token template-punctuation string\">`</span><span class=\"token string\">Client-ID </span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">${</span>imgurClientId<span class=\"token interpolation-punctuation punctuation\">}</span></span><span class=\"token template-punctuation string\">`</span></span>\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span>\n\naxios<span class=\"token punctuation\">.</span><span class=\"token function\">post</span><span class=\"token punctuation\">(</span><span class=\"token string\">'https://api.imgur.com/3/image'</span><span class=\"token punctuation\">,</span> data<span class=\"token punctuation\">,</span> config<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">then</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">resp</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">const</span> imageLink <span class=\"token operator\">=</span> resp<span class=\"token punctuation\">.</span>data<span class=\"token punctuation\">.</span>data<span class=\"token punctuation\">.</span>link\n  console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span>imageLink<span class=\"token punctuation\">)</span>\n  client<span class=\"token punctuation\">.</span><span class=\"token function\">query</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span>\n    <span class=\"token literal-property property\">query</span><span class=\"token operator\">:</span> gql<span class=\"token template-string\"><span class=\"token template-punctuation string\">`</span><span class=\"token string\">\n        query MyQuery {\n            raspi_plant_checker {\n                id\n                light\n                moisture\n                timestamp\n            }\n        }\n    </span><span class=\"token template-punctuation string\">`</span></span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">then</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">resp</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">const</span> latestData <span class=\"token operator\">=</span> resp<span class=\"token punctuation\">.</span>data<span class=\"token punctuation\">.</span>raspi_plant_checker<span class=\"token punctuation\">[</span>resp<span class=\"token punctuation\">.</span>data<span class=\"token punctuation\">.</span>raspi_plant_checker<span class=\"token punctuation\">.</span>length <span class=\"token operator\">-</span> <span class=\"token number\">1</span><span class=\"token punctuation\">]</span>\n    <span class=\"token keyword\">const</span> slackPayload <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token literal-property property\">text</span><span class=\"token operator\">:</span> <span class=\"token template-string\"><span class=\"token template-punctuation string\">`</span><span class=\"token string\">*How are you?* \\n&lt;</span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">${</span>dashBoardUrl<span class=\"token interpolation-punctuation punctuation\">}</span></span><span class=\"token string\">|Click here> for details! \\n</span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">${</span>imageLink<span class=\"token interpolation-punctuation punctuation\">}</span></span><span class=\"token template-punctuation string\">`</span></span><span class=\"token punctuation\">,</span>\n      <span class=\"token literal-property property\">attachments</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span>\n        <span class=\"token punctuation\">{</span>\n          <span class=\"token literal-property property\">fields</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span>\n            <span class=\"token punctuation\">{</span>\n              <span class=\"token literal-property property\">title</span><span class=\"token operator\">:</span> <span class=\"token string\">'Moisture'</span><span class=\"token punctuation\">,</span>\n              <span class=\"token literal-property property\">value</span><span class=\"token operator\">:</span> latestData<span class=\"token punctuation\">.</span>moisture<span class=\"token punctuation\">,</span>\n              <span class=\"token literal-property property\">short</span><span class=\"token operator\">:</span> <span class=\"token string\">'true'</span>\n            <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n            <span class=\"token punctuation\">{</span>\n              <span class=\"token literal-property property\">title</span><span class=\"token operator\">:</span> <span class=\"token string\">'Light'</span><span class=\"token punctuation\">,</span>\n              <span class=\"token literal-property property\">value</span><span class=\"token operator\">:</span> latestData<span class=\"token punctuation\">.</span>light<span class=\"token punctuation\">,</span>\n              <span class=\"token literal-property property\">short</span><span class=\"token operator\">:</span> <span class=\"token string\">'true'</span>\n            <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n          <span class=\"token punctuation\">]</span>\n        <span class=\"token punctuation\">}</span>\n      <span class=\"token punctuation\">]</span>\n    <span class=\"token punctuation\">}</span>\n    axios<span class=\"token punctuation\">.</span><span class=\"token function\">post</span><span class=\"token punctuation\">(</span>slackWebhookUrl<span class=\"token punctuation\">,</span> slackPayload<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">then</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">resp</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n      console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"OK\"</span><span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">)</span></code></pre></div>\n<p>ポイントとしては、</p>\n<ul>\n<li>画像の投稿にSlackのfileAPIを使わないでimgurのAPIを使っている(ただ使ってみたかっただけ)</li>\n<li>Appolo clientをnodeで使うとfetchが存在しないので個別にcross-fetchをインストールして <strong>link: new HttpLink({ uri: URI_ENDPOINT, fetch })</strong> という具合で設定してやる必要がある</li>\n<li>cypressのscreenshotは./cypress/screenshots/spec名/ファイル名で出力されるのでbase64で読み込んでいる</li>\n</ul>\n<p>さらにCypressやらSlackアップロードスクリプトを定期的に実行するRunnerを作ります。もうお分かりですね？　GitHub Actionsです。</p>\n<div class=\"gatsby-highlight\" data-language=\"yaml\"><pre class=\"language-yaml\"><code class=\"language-yaml\">  \n<span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> Upload Slack\n\n<span class=\"token key atrule\">on</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">push</span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">branches</span><span class=\"token punctuation\">:</span>\n      <span class=\"token punctuation\">-</span> main\n  <span class=\"token key atrule\">schedule</span><span class=\"token punctuation\">:</span>\n    <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">cron</span><span class=\"token punctuation\">:</span> <span class=\"token string\">'10 6 * * *'</span>\n\n<span class=\"token key atrule\">jobs</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">UploadSlack</span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">runs-on</span><span class=\"token punctuation\">:</span> ubuntu<span class=\"token punctuation\">-</span>latest\n    <span class=\"token key atrule\">steps</span><span class=\"token punctuation\">:</span>\n      <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">uses</span><span class=\"token punctuation\">:</span> actions/checkout@v2\n      <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">uses</span><span class=\"token punctuation\">:</span> actions/setup<span class=\"token punctuation\">-</span>node@v2\n        <span class=\"token key atrule\">with</span><span class=\"token punctuation\">:</span>\n          <span class=\"token key atrule\">node-version</span><span class=\"token punctuation\">:</span> <span class=\"token string\">'14'</span>\n      <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">uses</span><span class=\"token punctuation\">:</span> denoland/setup<span class=\"token punctuation\">-</span>deno@v1\n        <span class=\"token key atrule\">with</span><span class=\"token punctuation\">:</span>\n          <span class=\"token key atrule\">deno-version</span><span class=\"token punctuation\">:</span> <span class=\"token string\">'v1.x'</span>\n      <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> npm install\n        <span class=\"token key atrule\">run</span><span class=\"token punctuation\">:</span> npm install\n      <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> run cypress\n        <span class=\"token key atrule\">run</span><span class=\"token punctuation\">:</span> npm run cy<span class=\"token punctuation\">:</span>run\n      <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> Upload Slack\n        <span class=\"token key atrule\">env</span><span class=\"token punctuation\">:</span>\n          <span class=\"token key atrule\">IMGUR_CLIENT_ID</span><span class=\"token punctuation\">:</span> $<span class=\"token punctuation\">{</span><span class=\"token punctuation\">{</span> secrets.IMGUR_CLIENT_ID <span class=\"token punctuation\">}</span><span class=\"token punctuation\">}</span>\n          <span class=\"token key atrule\">SLACK_WEBHOOK_URL</span><span class=\"token punctuation\">:</span> $<span class=\"token punctuation\">{</span><span class=\"token punctuation\">{</span> secrets.SLACK_WEBHOOK_URL <span class=\"token punctuation\">}</span><span class=\"token punctuation\">}</span>\n        <span class=\"token key atrule\">run</span><span class=\"token punctuation\">:</span> node scripts/uploadScreenShot.mjs</code></pre></div>\n<p>これで毎日Slackに植物情報が投稿されるようになりました。</p>\n<p><img class=\"lozad\" src=\"data:image/gif;base64,R0lGODlhAQABAGAAACH5BAEKAP8ALAAAAAABAAEAAAgEAP8FBAA7\" data-src=\"https://i.imgur.com/xNW7WDG.png\" alt=\"img\"></p>\n<h2 id=\"反省\" style=\"position:relative;\"><a href=\"#%E5%8F%8D%E7%9C%81\" aria-label=\"反省 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>反省</h2>\n<p>Denoを使ってSlackアップロードスクリプトは改修します。絶対に。</p>","words":4470,"minutes":12}},"staticQueryHashes":["1319877725","2959249232"]}