{"componentChunkName":"component---src-templates-blog-post-tsx","path":"/2021/07/26/calendar","result":{"data":{"content":{"edges":[{"node":{"id":"4fd278eb-92a9-5803-88dd-0936a39c2fd0","excerpt":"ラズパイが余っているので活用したいと思います。 Table of Contents ラズパイ有効活用 そもそもなぜ電子ペーパー？ 先人がいました。 詰まったところその1 GoogleのoAuth2.0認証が取れない!! 詰まったところその2 2.…","fields":{"slug":"2021/07/26/calendar"},"frontmatter":{"id":null,"title":"ラズパイ活用！電子ペーパーを使ってカレンダーを作ってみる","slug":"2021/07/26/calendar","date":"2021-07-25T07:59:27.482Z","headerImage":"https://i.imgur.com/QR3FGt8.jpg","tags":["RaspberryPi","電子ペーパー","Googleカレンダー"]}}}]}},"pageContext":{"id":"4fd278eb-92a9-5803-88dd-0936a39c2fd0","index":15,"repHtml":"<p>ラズパイが余っているので活用したいと思います。</p>\n<h2 id=\"table-of-contents\" style=\"position:relative;\"><a href=\"#table-of-contents\" aria-label=\"table of contents permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Table of Contents</h2>\n<div class=\"toc\">\n<ul>\n<li>\n<p><a href=\"#%E3%83%A9%E3%82%BA%E3%83%91%E3%82%A4%E6%9C%89%E5%8A%B9%E6%B4%BB%E7%94%A8\">ラズパイ有効活用</a></p>\n</li>\n<li>\n<p><a href=\"#%E3%81%9D%E3%82%82%E3%81%9D%E3%82%82%E3%81%AA%E3%81%9C%E9%9B%BB%E5%AD%90%E3%83%9A%E3%83%BC%E3%83%91%E3%83%BC\">そもそもなぜ電子ペーパー？</a></p>\n</li>\n<li>\n<p><a href=\"#%E5%85%88%E4%BA%BA%E3%81%8C%E3%81%84%E3%81%BE%E3%81%97%E3%81%9F\">先人がいました。</a></p>\n</li>\n<li>\n<p><a href=\"#%E8%A9%B0%E3%81%BE%E3%81%A3%E3%81%9F%E3%81%A8%E3%81%93%E3%82%8D%E3%81%9D%E3%81%AE1-google%E3%81%AEoauth20%E8%AA%8D%E8%A8%BC%E3%81%8C%E5%8F%96%E3%82%8C%E3%81%AA%E3%81%84\">詰まったところその1 GoogleのoAuth2.0認証が取れない!!</a></p>\n</li>\n<li>\n<p><a href=\"#%E8%A9%B0%E3%81%BE%E3%81%A3%E3%81%9F%E3%81%A8%E3%81%93%E3%82%8D%E3%81%9D%E3%81%AE2-27%E3%82%A4%E3%83%B3%E3%83%81%E3%81%AF%E7%94%BB%E9%9D%A2%E5%B0%8F%E3%81%95%E3%81%99%E3%81%8E\">詰まったところその2 2.7インチは画面小さすぎ</a></p>\n<ul>\n<li><a href=\"#%E8%87%AA%E6%85%A2\">自慢</a></li>\n</ul>\n</li>\n<li>\n<p><a href=\"#gpio%E3%81%AE%E3%82%AD%E3%83%BC%E3%82%B9%E3%82%A4%E3%83%83%E3%83%81%E3%82%92%E4%BD%BF%E3%81%8A%E3%81%86\">GPIOのキースイッチを使おう！</a></p>\n</li>\n<li>\n<p><a href=\"#%E8%A9%B0%E3%81%BE%E3%81%A3%E3%81%9F%E3%81%A8%E3%81%93%E3%82%8D%E3%81%9D%E3%81%AE3-%E3%82%AD%E3%83%BC%E3%82%B9%E3%82%A4%E3%83%83%E3%83%81%E3%81%8C%E3%83%87%E3%83%BC%E3%82%BF%E3%82%B7%E3%83%BC%E3%83%88%E3%81%AB%E8%BC%89%E3%81%A3%E3%81%A6%E3%81%AA%E3%81%84\">詰まったところその3 キースイッチがデータシートに載ってない！</a></p>\n</li>\n<li>\n<p><a href=\"#%E3%81%A7%E3%81%8D%E3%81%9F\">できた！</a></p>\n</li>\n</ul>\n</div>\n<h2 id=\"ラズパイ有効活用\" style=\"position:relative;\"><a href=\"#%E3%83%A9%E3%82%BA%E3%83%91%E3%82%A4%E6%9C%89%E5%8A%B9%E6%B4%BB%E7%94%A8\" aria-label=\"ラズパイ有効活用 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>ラズパイ有効活用</h2>\n<p>皆さんは家に余っているラズパイはありますか？</p>\n<p><strong>私はあります...。</strong></p>\n<p>いい加減眠らせておくのももったいなく感じ、かつちょうどカレンダーが家になかった(会社でもらったカレンダーは全部捨ててしまった)のでラズパイと電子ペーパーを使って万年カレンダーでも作ってみようかと思います。</p>\n<p>ラズパイと電子ペーパーのセットアップは過去記事<a href=\"https://blog.tubone-project24.xyz/2021/01/01/mqtt-nenga\" target=\"_blank\" rel=\"noopener noreferrer\">MQTTと電子ペーパーを使って年賀状を作る</a>で実施済みなのでこちらを使うことにします。</p>\n<h2 id=\"そもそもなぜ電子ペーパー\" style=\"position:relative;\"><a href=\"#%E3%81%9D%E3%82%82%E3%81%9D%E3%82%82%E3%81%AA%E3%81%9C%E9%9B%BB%E5%AD%90%E3%83%9A%E3%83%BC%E3%83%91%E3%83%BC\" aria-label=\"そもそもなぜ電子ペーパー permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>そもそもなぜ電子ペーパー？</h2>\n<p>昨今リモートワークも多くなり、オフィスに出向くことも少なくなりました。私はオフィスの机に卓上カレンダーを置いていたのですがリモートワーク中でもカレンダーが常に見れるようにしておきたいです。なぜなら無茶なスケジュールをクライアントから要求されたときに、おおよそ何週間くらい猶予があるのかカレンダーを使うことで直感的にわかるからです。</p>\n<p>しかしながら家に置いておく卓上カレンダーが現在ありません。</p>\n<p>買えばいいじゃんという意見も出てきそうですが過去記事の通り、せっかく<a href=\"https://amzn.to/3BRCQDl\" target=\"_blank\" rel=\"noopener noreferrer\">Waveshare 2.7inch E-Ink Screen Display HAT for Raspberry Pi</a>を買ったのでカレンダーデバイスを作ってみようと思います。</p>\n<h2 id=\"先人がいました\" style=\"position:relative;\"><a href=\"#%E5%85%88%E4%BA%BA%E3%81%8C%E3%81%84%E3%81%BE%E3%81%97%E3%81%9F\" aria-label=\"先人がいました permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>先人がいました。</h2>\n<p>作ろうと思って調べるとすでに電子ペーパーでカレンダーを作っていた人がいました。しかもGoogleカレンダー連携までしているまさにスマートデバイス。</p>\n<p><a href=\"https://blog.mktia.com/e-calendar/?utm_source=pocket_mylist\" target=\"_blank\" rel=\"noopener noreferrer\">Googleと連動した電子ペーパー製カレンダーを作る</a></p>\n<p>一からコードを書くのもめんどくさくなり、上記を<del>パクッて</del>参考に作ればいいという気分になりました。</p>\n<p>コード自体は結構コピペで作って、画面サイズ変更と赤色の印字無効だけで済ませてしまったので公開はしませんが詰まったところを下記に書いていきたいと思います。</p>\n<h2 id=\"詰まったところその1-googleのoauth20認証が取れない\" style=\"position:relative;\"><a href=\"#%E8%A9%B0%E3%81%BE%E3%81%A3%E3%81%9F%E3%81%A8%E3%81%93%E3%82%8D%E3%81%9D%E3%81%AE1-google%E3%81%AEoauth20%E8%AA%8D%E8%A8%BC%E3%81%8C%E5%8F%96%E3%82%8C%E3%81%AA%E3%81%84\" aria-label=\"詰まったところその1 googleのoauth20認証が取れない permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>詰まったところその1 GoogleのoAuth2.0認証が取れない!!</h2>\n<p>これが一番苦戦しました。</p>\n<p><a href=\"https://blog.mktia.com/e-calendar/?utm_source=pocket_mylist\" target=\"_blank\" rel=\"noopener noreferrer\">Googleと連動した電子ペーパー製カレンダーを作る</a>を参考に作っていくとGoogleカレンダーとの連携のため、oAuth2.0のユーザー認証が必要なのですが...。</p>\n<p>Google CloudのAPIコンソールから発行できるクレデンシャル用のJSONがある場合で、認証済みの場合に作成される<strong>token.pickle</strong>が存在しない場合は<strong>google_auth_oauthlib.flow.InstalledAppFlow</strong>のrun_local_serverを使って、ローカル上にWebサーバーを立ててGoogleアカウントでの認証が済んだ場合にローカルサーバーにリダイレクトするようにする認証方式をとるようにしてありました。</p>\n<div class=\"gatsby-highlight\" data-language=\"python\"><pre class=\"language-python\"><code class=\"language-python\">        <span class=\"token keyword\">if</span> <span class=\"token keyword\">not</span> creds <span class=\"token keyword\">or</span> <span class=\"token keyword\">not</span> creds<span class=\"token punctuation\">.</span>valid<span class=\"token punctuation\">:</span>\n            <span class=\"token keyword\">if</span> creds <span class=\"token keyword\">and</span> creds<span class=\"token punctuation\">.</span>expired <span class=\"token keyword\">and</span> creds<span class=\"token punctuation\">.</span>refresh_token<span class=\"token punctuation\">:</span>\n                creds<span class=\"token punctuation\">.</span>refresh<span class=\"token punctuation\">(</span>Request<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n            <span class=\"token keyword\">else</span><span class=\"token punctuation\">:</span>\n                flow <span class=\"token operator\">=</span> InstalledAppFlow<span class=\"token punctuation\">.</span>from_client_secrets_file<span class=\"token punctuation\">(</span>\n                    <span class=\"token string\">'credentials.json'</span><span class=\"token punctuation\">,</span> SCOPES<span class=\"token punctuation\">)</span>\n                creds <span class=\"token operator\">=</span> flow<span class=\"token punctuation\">.</span>run_local_server<span class=\"token punctuation\">(</span>port<span class=\"token operator\">=</span><span class=\"token number\">0</span><span class=\"token punctuation\">)</span>\n            <span class=\"token comment\"># Save the credentials for the next run</span>\n            <span class=\"token keyword\">with</span> <span class=\"token builtin\">open</span><span class=\"token punctuation\">(</span><span class=\"token string\">'token.pickle'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'wb'</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">as</span> token<span class=\"token punctuation\">:</span>\n                pickle<span class=\"token punctuation\">.</span>dump<span class=\"token punctuation\">(</span>creds<span class=\"token punctuation\">,</span> token<span class=\"token punctuation\">)</span></code></pre></div>\n<p>公式のドキュメントに載っている<a href=\"https://developers.google.com/people/quickstart/python\" target=\"_blank\" rel=\"noopener noreferrer\">クイックスタート</a>でも同様の設定になっているので問題ないと思ってましたが....。</p>\n<p>いざリダイレクトが始まると..。</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">エラー 400: redirect_uri_mismatch The redirect URI in the request, http://localhost:58979/, does not match the ones authorized for the OAuth client. To update the authorized redirect URIs, visit: https://console.developers.google.com/apis/credentials/oauthclient/xxxxxxxxxxxxxxxxxxxxxxxxxx.apps.googleusercontent.com?project=xxxxxxxxxxxxx</code></pre></div>\n<p>というエラーがブラウザで出てしまい、リダイレクトされず当然認証も通りませんでした。</p>\n<p>エラー内容的にoAuthのリダイレクトURLがミスマッチということなので、リダイレクトURLに <strong><a href=\"http://localhost\" target=\"_blank\" rel=\"noopener noreferrer\">http://localhost</a></strong> つまり、<strong><a href=\"http://localhost:80\" target=\"_blank\" rel=\"noopener noreferrer\">http://localhost:80</a></strong> を設定していたのが悪いのではという仮説のもと、<strong>flow.run_local_server()</strong> のポートを <strong>port=xxxxx</strong>で固定化してリダイレクトURLもポート指定にして再度トライしたのですが、同じエラーでした。</p>\n<p>途方に暮れていたのですが、そもそも自己でリダイレクト先のローカルサーバーを立てることのできないタイプのデバイスもあるはずでそういった場合はどうやって認証するのか調べたところ...。</p>\n<p><strong>テレビと入力機能が限られているデバイス</strong>という認証オプションが用意されてました。</p>\n<p>APIのコンソールでoAuth2.0のクライアント作成時に上記を選んだ後、コード側で、</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">creds = flow.run_local_server(port=0)\n↓\ncreds = flow.run_console()</code></pre></div>\n<p>に書いてあげることで、ブラウザ上で認証が完了したらワンタイムコードが表示され、それをコンソール上に入力する形で認証が通るようになりました。めでたしめでたし。</p>\n<h2 id=\"詰まったところその2-27インチは画面小さすぎ\" style=\"position:relative;\"><a href=\"#%E8%A9%B0%E3%81%BE%E3%81%A3%E3%81%9F%E3%81%A8%E3%81%93%E3%82%8D%E3%81%9D%E3%81%AE2-27%E3%82%A4%E3%83%B3%E3%83%81%E3%81%AF%E7%94%BB%E9%9D%A2%E5%B0%8F%E3%81%95%E3%81%99%E3%81%8E\" aria-label=\"詰まったところその2 27インチは画面小さすぎ permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>詰まったところその2 2.7インチは画面小さすぎ</h2>\n<p>先人の知恵をお借りして画面サイズとフォントサイズだけ合わせと赤色無効化をして調整して作ったところ...。</p>\n<p><img class=\"lozad\" src=\"data:image/gif;base64,R0lGODlhAQABAGAAACH5BAEKAP8ALAAAAAABAAEAAAgEAP8FBAA7\" data-src=\"https://i.imgur.com/d4TGMVSl.jpg\" alt=\"tiisai\"></p>\n<p>小さいっ！圧倒的に小さい。Zippoと比べてもらうとわかるのですが、こんなの使いものにならない！</p>\n<p><img class=\"lozad\" src=\"data:image/gif;base64,R0lGODlhAQABAGAAACH5BAEKAP8ALAAAAAABAAEAAAgEAP8FBAA7\" data-src=\"https://i.imgur.com/tERPWfnl.jpg\" alt=\"ima\"></p>\n<p>先人、かなり理にかなったデザインをしていたようで、メインのカレンダーの他、右側に予定表と次の月のミニカレンダーを表示するようになっているのですが、さすがに2.7インチには小さすぎました。</p>\n<p>さすがにこのサイズだと予定表とか読めたものではないです。もちろん削ってしまってもいいのですがせっかく苦労してGoogleカレンダーと連携しているので何とかしたい...!</p>\n<h3 id=\"自慢\" style=\"position:relative;\"><a href=\"#%E8%87%AA%E6%85%A2\" aria-label=\"自慢 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>自慢</h3>\n<p>予定表をよく見てほしい。</p>\n<p><img class=\"lozad\" src=\"data:image/gif;base64,R0lGODlhAQABAGAAACH5BAEKAP8ALAAAAAABAAEAAAgEAP8FBAA7\" data-src=\"https://i.imgur.com/mtf5J9v.jpg\" alt=\"imfg\"></p>\n<p>そう。今年色々大変そうですが<a href=\"https://bang-dream.com/9th-live-thebeginning\" target=\"_blank\" rel=\"noopener noreferrer\">BanG Dream! 9th☆LIVE「The Beginning」</a>行きます。</p>\n<p>楽しみだなぁ。</p>\n<h2 id=\"gpioのキースイッチを使おう\" style=\"position:relative;\"><a href=\"#gpio%E3%81%AE%E3%82%AD%E3%83%BC%E3%82%B9%E3%82%A4%E3%83%83%E3%83%81%E3%82%92%E4%BD%BF%E3%81%8A%E3%81%86\" aria-label=\"gpioのキースイッチを使おう permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>GPIOのキースイッチを使おう！</h2>\n<p>話を戻して、2.7インチだとさすがにいろいろ視認性が悪いですね、という結論になりました。</p>\n<p>そこで、2.7インチHATに搭載されているキースイッチを活用することにしました。</p>\n<p><img class=\"lozad\" src=\"data:image/gif;base64,R0lGODlhAQABAGAAACH5BAEKAP8ALAAAAAABAAEAAAgEAP8FBAA7\" data-src=\"https://i.imgur.com/6L3j6pFl.jpg\" alt=\"img\"></p>\n<p>キースイッチは4つありますので、4画面に分割できます。これならうまくいきそうですね。</p>\n<p>とりあえず下記の通りにしました。</p>\n<ul>\n<li>Key1: 当月カレンダー</li>\n<li>Key2: 来月カレンダー</li>\n<li>Key3: 当月カレンダー&#x26;前月・来月カレンダー</li>\n<li>Key4: 予定表</li>\n</ul>\n<p>とします。</p>\n<p>それぞれを分割してスクリプトを作成します。コードは上記でも申しているとおり、コピペが多いのでさすがに恥ずかしいので載せません..!</p>\n<h2 id=\"詰まったところその3-キースイッチがデータシートに載ってない\" style=\"position:relative;\"><a href=\"#%E8%A9%B0%E3%81%BE%E3%81%A3%E3%81%9F%E3%81%A8%E3%81%93%E3%82%8D%E3%81%9D%E3%81%AE3-%E3%82%AD%E3%83%BC%E3%82%B9%E3%82%A4%E3%83%83%E3%83%81%E3%81%8C%E3%83%87%E3%83%BC%E3%82%BF%E3%82%B7%E3%83%BC%E3%83%88%E3%81%AB%E8%BC%89%E3%81%A3%E3%81%A6%E3%81%AA%E3%81%84\" aria-label=\"詰まったところその3 キースイッチがデータシートに載ってない permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>詰まったところその3 キースイッチがデータシートに載ってない！</h2>\n<p>さて、それぞれの描画スクリプトは何のことなく作れたので、あとはキースイッチが押されたら画面を切り替えるようにします。</p>\n<p>ではデータシートを見ていきましょう。<a href=\"https://www.waveshare.com/wiki/2.7inch_e-Paper_HAT\" target=\"_blank\" rel=\"noopener noreferrer\">https://www.waveshare.com/wiki/2.7inch_e-Paper_HAT</a></p>\n<p>あれ？キースイッチの記載がない...。</p>\n<p>ちゃんと書いてよぉ...。と思いましたが<a href=\"https://diyprojects.io/test-waveshare-epaper-eink-2-7-spi-screen-raspberry-pi-python/\" target=\"_blank\" rel=\"noopener noreferrer\">https://diyprojects.io/test-waveshare-epaper-eink-2-7-spi-screen-raspberry-pi-python/</a>というサイトに、</p>\n<ul>\n<li>Key 1 on pin 12</li>\n<li>Key 2 on pin 16</li>\n<li>Key 3 on pin 18</li>\n<li>Key 4 on pin 4</li>\n</ul>\n<p>という記載がありました!!GoodJob！</p>\n<p>ということでコードを書いていきます。</p>\n<div class=\"gatsby-highlight\" data-language=\"python\"><pre class=\"language-python\"><code class=\"language-python\"><span class=\"token comment\">#!/usr/bin/env python3</span>\n<span class=\"token keyword\">import</span> subprocess\n<span class=\"token keyword\">from</span> datetime <span class=\"token keyword\">import</span> datetime\n<span class=\"token keyword\">import</span> time\n<span class=\"token keyword\">import</span> RPi<span class=\"token punctuation\">.</span>GPIO <span class=\"token keyword\">as</span> GPIO\n\n\nBOUNCE_TIME <span class=\"token operator\">=</span> <span class=\"token number\">500</span>\n\n\nPIN_KEY1 <span class=\"token operator\">=</span> <span class=\"token number\">5</span>\nPIN_KEY2 <span class=\"token operator\">=</span> <span class=\"token number\">6</span>\nPIN_KEY3 <span class=\"token operator\">=</span> <span class=\"token number\">13</span>\nPIN_KEY4 <span class=\"token operator\">=</span> <span class=\"token number\">19</span>\n\nDISPMODE_THIS_MONTH <span class=\"token operator\">=</span> <span class=\"token number\">1</span>\nDISPMODE_NEXT_MONTH <span class=\"token operator\">=</span> <span class=\"token number\">2</span>\nDISPMODE_BEFORE_NEXT <span class=\"token operator\">=</span> <span class=\"token number\">3</span>\nDISPMODE_TODO <span class=\"token operator\">=</span> <span class=\"token number\">4</span>\n\n\n<span class=\"token keyword\">class</span> <span class=\"token class-name\">Display</span><span class=\"token punctuation\">:</span>\n    mode <span class=\"token operator\">=</span> DISPMODE_THIS_MONTH\n\n    <span class=\"token keyword\">def</span> <span class=\"token function\">start</span><span class=\"token punctuation\">(</span>self<span class=\"token punctuation\">,</span> first_mode<span class=\"token operator\">=</span>DISPMODE_THIS_MONTH<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n        self<span class=\"token punctuation\">.</span>mode <span class=\"token operator\">=</span> first_mode\n        <span class=\"token keyword\">while</span> <span class=\"token boolean\">True</span><span class=\"token punctuation\">:</span>\n            <span class=\"token keyword\">if</span> DISPMODE_NEXT_MONTH <span class=\"token operator\">==</span> self<span class=\"token punctuation\">.</span>mode<span class=\"token punctuation\">:</span>\n                self<span class=\"token punctuation\">.</span>draw_next_month<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n            <span class=\"token keyword\">elif</span> DISPMODE_BEFORE_NEXT <span class=\"token operator\">==</span> self<span class=\"token punctuation\">.</span>mode<span class=\"token punctuation\">:</span>\n                self<span class=\"token punctuation\">.</span>draw_before_next<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n            <span class=\"token keyword\">elif</span> DISPMODE_TODO <span class=\"token operator\">==</span> self<span class=\"token punctuation\">.</span>mode<span class=\"token punctuation\">:</span>\n                self<span class=\"token punctuation\">.</span>draw_todo<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n            <span class=\"token keyword\">else</span><span class=\"token punctuation\">:</span>\n                self<span class=\"token punctuation\">.</span>mode <span class=\"token operator\">=</span> DISPMODE_THIS_MONTH\n                self<span class=\"token punctuation\">.</span>draw_this_month<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n            time<span class=\"token punctuation\">.</span>sleep<span class=\"token punctuation\">(</span><span class=\"token number\">3600</span><span class=\"token punctuation\">)</span>\n\n    <span class=\"token keyword\">def</span> <span class=\"token function\">key_pressed</span><span class=\"token punctuation\">(</span>self<span class=\"token punctuation\">,</span> pin<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n        <span class=\"token keyword\">if</span> PIN_KEY1 <span class=\"token operator\">==</span> pin<span class=\"token punctuation\">:</span>\n            self<span class=\"token punctuation\">.</span>mode <span class=\"token operator\">=</span> DISPMODE_THIS_MONTH\n            self<span class=\"token punctuation\">.</span>draw_this_month<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n        <span class=\"token keyword\">elif</span> PIN_KEY2 <span class=\"token operator\">==</span> pin<span class=\"token punctuation\">:</span>\n            self<span class=\"token punctuation\">.</span>mode <span class=\"token operator\">=</span> DISPMODE_NEXT_MONTH\n            self<span class=\"token punctuation\">.</span>draw_next_month<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n        <span class=\"token keyword\">elif</span> PIN_KEY3 <span class=\"token operator\">==</span> pin<span class=\"token punctuation\">:</span>\n            self<span class=\"token punctuation\">.</span>mode <span class=\"token operator\">=</span> DISPMODE_BEFORE_NEXT\n            self<span class=\"token punctuation\">.</span>draw_before_next<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n        <span class=\"token keyword\">elif</span> PIN_KEY4 <span class=\"token operator\">==</span> pin<span class=\"token punctuation\">:</span>\n            self<span class=\"token punctuation\">.</span>mode <span class=\"token operator\">=</span> DISPMODE_TODO\n            self<span class=\"token punctuation\">.</span>draw_todo<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n        <span class=\"token keyword\">else</span><span class=\"token punctuation\">:</span>\n            <span class=\"token keyword\">print</span><span class=\"token punctuation\">(</span>pin<span class=\"token punctuation\">)</span>\n    \n    <span class=\"token decorator annotation punctuation\">@staticmethod</span>\n    <span class=\"token keyword\">def</span> <span class=\"token function\">draw_this_month</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n        command <span class=\"token operator\">=</span> <span class=\"token punctuation\">[</span><span class=\"token string\">\"python3\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"/home/pi/e-calendar/this_month.py\"</span><span class=\"token punctuation\">]</span>\n        <span class=\"token keyword\">print</span><span class=\"token punctuation\">(</span>command<span class=\"token punctuation\">)</span>\n        proc <span class=\"token operator\">=</span> subprocess<span class=\"token punctuation\">.</span>Popen<span class=\"token punctuation\">(</span>command<span class=\"token punctuation\">)</span>\n        result <span class=\"token operator\">=</span> proc<span class=\"token punctuation\">.</span>communicate<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n        <span class=\"token keyword\">print</span><span class=\"token punctuation\">(</span>result<span class=\"token punctuation\">)</span>\n\n    <span class=\"token decorator annotation punctuation\">@staticmethod</span>\n    <span class=\"token keyword\">def</span> <span class=\"token function\">draw_next_month</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n        command <span class=\"token operator\">=</span> <span class=\"token punctuation\">[</span><span class=\"token string\">\"python3\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"/home/pi/e-calendar/next_month.py\"</span><span class=\"token punctuation\">]</span>\n        <span class=\"token keyword\">print</span><span class=\"token punctuation\">(</span>command<span class=\"token punctuation\">)</span>\n        proc <span class=\"token operator\">=</span> subprocess<span class=\"token punctuation\">.</span>Popen<span class=\"token punctuation\">(</span>command<span class=\"token punctuation\">)</span>\n        result <span class=\"token operator\">=</span> proc<span class=\"token punctuation\">.</span>communicate<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n        <span class=\"token keyword\">print</span><span class=\"token punctuation\">(</span>result<span class=\"token punctuation\">)</span>\n\n    <span class=\"token decorator annotation punctuation\">@staticmethod</span>\n    <span class=\"token keyword\">def</span> <span class=\"token function\">draw_before_next</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n        command <span class=\"token operator\">=</span> <span class=\"token punctuation\">[</span><span class=\"token string\">\"python3\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"/home/pi/e-calendar/before_next.py\"</span><span class=\"token punctuation\">]</span>\n        <span class=\"token keyword\">print</span><span class=\"token punctuation\">(</span>command<span class=\"token punctuation\">)</span>\n        proc <span class=\"token operator\">=</span> subprocess<span class=\"token punctuation\">.</span>Popen<span class=\"token punctuation\">(</span>command<span class=\"token punctuation\">)</span>\n        result <span class=\"token operator\">=</span> proc<span class=\"token punctuation\">.</span>communicate<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n        <span class=\"token keyword\">print</span><span class=\"token punctuation\">(</span>result<span class=\"token punctuation\">)</span>\n\n    <span class=\"token decorator annotation punctuation\">@staticmethod</span>\n    <span class=\"token keyword\">def</span> <span class=\"token function\">draw_todo</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n        command <span class=\"token operator\">=</span> <span class=\"token punctuation\">[</span><span class=\"token string\">\"python3\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"/home/pi/e-calendar/todo.py\"</span><span class=\"token punctuation\">]</span>\n        <span class=\"token keyword\">print</span><span class=\"token punctuation\">(</span>command<span class=\"token punctuation\">)</span>\n        proc <span class=\"token operator\">=</span> subprocess<span class=\"token punctuation\">.</span>Popen<span class=\"token punctuation\">(</span>command<span class=\"token punctuation\">)</span>\n        result <span class=\"token operator\">=</span> proc<span class=\"token punctuation\">.</span>communicate<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n        <span class=\"token keyword\">print</span><span class=\"token punctuation\">(</span>result<span class=\"token punctuation\">)</span>\n\n\n<span class=\"token keyword\">if</span> __name__ <span class=\"token operator\">==</span> <span class=\"token string\">'__main__'</span><span class=\"token punctuation\">:</span>\n    <span class=\"token keyword\">try</span><span class=\"token punctuation\">:</span>\n        display <span class=\"token operator\">=</span> Display<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n        GPIO<span class=\"token punctuation\">.</span>setmode<span class=\"token punctuation\">(</span>GPIO<span class=\"token punctuation\">.</span>BCM<span class=\"token punctuation\">)</span>\n        GPIO<span class=\"token punctuation\">.</span>setup<span class=\"token punctuation\">(</span>PIN_KEY1<span class=\"token punctuation\">,</span> GPIO<span class=\"token punctuation\">.</span>IN<span class=\"token punctuation\">,</span> pull_up_down<span class=\"token operator\">=</span>GPIO<span class=\"token punctuation\">.</span>PUD_UP<span class=\"token punctuation\">)</span>\n        GPIO<span class=\"token punctuation\">.</span>add_event_detect<span class=\"token punctuation\">(</span>PIN_KEY1<span class=\"token punctuation\">,</span> GPIO<span class=\"token punctuation\">.</span>FALLING<span class=\"token punctuation\">,</span> callback<span class=\"token operator\">=</span>display<span class=\"token punctuation\">.</span>key_pressed<span class=\"token punctuation\">,</span> BOUNCE_TIME<span class=\"token operator\">=</span>BOUNCE_TIME<span class=\"token punctuation\">)</span>\n        GPIO<span class=\"token punctuation\">.</span>setup<span class=\"token punctuation\">(</span>PIN_KEY2<span class=\"token punctuation\">,</span> GPIO<span class=\"token punctuation\">.</span>IN<span class=\"token punctuation\">,</span> pull_up_down<span class=\"token operator\">=</span>GPIO<span class=\"token punctuation\">.</span>PUD_UP<span class=\"token punctuation\">)</span>\n        GPIO<span class=\"token punctuation\">.</span>add_event_detect<span class=\"token punctuation\">(</span>PIN_KEY2<span class=\"token punctuation\">,</span> GPIO<span class=\"token punctuation\">.</span>FALLING<span class=\"token punctuation\">,</span> callback<span class=\"token operator\">=</span>display<span class=\"token punctuation\">.</span>key_pressed<span class=\"token punctuation\">,</span> BOUNCE_TIME<span class=\"token operator\">=</span>BOUNCE_TIME<span class=\"token punctuation\">)</span>\n        GPIO<span class=\"token punctuation\">.</span>setup<span class=\"token punctuation\">(</span>PIN_KEY3<span class=\"token punctuation\">,</span> GPIO<span class=\"token punctuation\">.</span>IN<span class=\"token punctuation\">,</span> pull_up_down<span class=\"token operator\">=</span>GPIO<span class=\"token punctuation\">.</span>PUD_UP<span class=\"token punctuation\">)</span>\n        GPIO<span class=\"token punctuation\">.</span>add_event_detect<span class=\"token punctuation\">(</span>PIN_KEY3<span class=\"token punctuation\">,</span> GPIO<span class=\"token punctuation\">.</span>FALLING<span class=\"token punctuation\">,</span> callback<span class=\"token operator\">=</span>display<span class=\"token punctuation\">.</span>key_pressed<span class=\"token punctuation\">,</span> BOUNCE_TIME<span class=\"token operator\">=</span>BOUNCE_TIME<span class=\"token punctuation\">)</span>\n        GPIO<span class=\"token punctuation\">.</span>setup<span class=\"token punctuation\">(</span>PIN_KEY4<span class=\"token punctuation\">,</span> GPIO<span class=\"token punctuation\">.</span>IN<span class=\"token punctuation\">,</span> pull_up_down<span class=\"token operator\">=</span>GPIO<span class=\"token punctuation\">.</span>PUD_UP<span class=\"token punctuation\">)</span>\n        GPIO<span class=\"token punctuation\">.</span>add_event_detect<span class=\"token punctuation\">(</span>PIN_KEY4<span class=\"token punctuation\">,</span> GPIO<span class=\"token punctuation\">.</span>FALLING<span class=\"token punctuation\">,</span> callback<span class=\"token operator\">=</span>display<span class=\"token punctuation\">.</span>key_pressed<span class=\"token punctuation\">,</span> BOUNCE_TIME<span class=\"token operator\">=</span>BOUNCE_TIME<span class=\"token punctuation\">)</span>\n        display<span class=\"token punctuation\">.</span>start<span class=\"token punctuation\">(</span>DISPMODE_THIS_MONTH<span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">finally</span><span class=\"token punctuation\">:</span>\n        GPIO<span class=\"token punctuation\">.</span>cleanup<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span></code></pre></div>\n<p>ポイントは、キースイッチはただのGPIOなので、<strong>RPi.GPIO</strong> を使って制御できます。</p>\n<p>キースイッチが押されたときに何かをする、というのは<strong>GPIO.add_event_detect</strong>でイベントリスナーを登録できます。コールバック関数が設定できるので、こちらにキースイッチが押下された際のふるまいを登録すればいいです。また、コールバック関数にはGPIOのPINが引数でわたりますのでkey_pressedみたいな感じで共通化できます。</p>\n<p>本来はちゃんと作るべきなのですが、ちょっと手探りで画面を作っていたところもあり、subprocessを使って直接Pythonファイルを実行するイケてない実装になってます。恥ずかしい。</p>\n<h2 id=\"できた\" style=\"position:relative;\"><a href=\"#%E3%81%A7%E3%81%8D%E3%81%9F\" aria-label=\"できた permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>できた！</h2>\n<p>できました。</p>\n<p>当月カレンダー↓</p>\n<p><img class=\"lozad\" src=\"data:image/gif;base64,R0lGODlhAQABAGAAACH5BAEKAP8ALAAAAAABAAEAAAgEAP8FBAA7\" data-src=\"https://i.imgur.com/3HqmDpil.jpg\" alt=\"mga\"></p>\n<p>翌月カレンダー↓</p>\n<p><img class=\"lozad\" src=\"data:image/gif;base64,R0lGODlhAQABAGAAACH5BAEKAP8ALAAAAAABAAEAAAgEAP8FBAA7\" data-src=\"https://i.imgur.com/pa1jUtbl.jpg\" alt=\"imng\"></p>\n<p>当月カレンダー&#x26;前月・来月カレンダー↓</p>\n<p><img class=\"lozad\" src=\"data:image/gif;base64,R0lGODlhAQABAGAAACH5BAEKAP8ALAAAAAABAAEAAAgEAP8FBAA7\" data-src=\"https://i.imgur.com/QR3FGt8l.jpg\" alt=\"imna\"></p>\n<p>予定表↓</p>\n<p><img class=\"lozad\" src=\"data:image/gif;base64,R0lGODlhAQABAGAAACH5BAEKAP8ALAAAAAABAAEAAAgEAP8FBAA7\" data-src=\"https://i.imgur.com/M6muDFQl.jpg\" alt=\"ima\"></p>\n<p>電子ペーパーの再描画はかなり重たいので切り替えには時間がかかるのが欠点ですが他はまぁまぁ上出来ではないでしょうか？</p>\n<iframe loading=\"lazy\" width=\"200\" height=\"113\" src=\"https://www.youtube.com/embed/RuiDxP65nnU?feature=oembed\" frameborder=\"0\" allow=\"accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture\" allowfullscreen title=\"2.7inch E-paper Calendar\"></iframe>\n<p>おっそ。</p>","words":2481,"minutes":7}},"staticQueryHashes":["1319877725","2959249232"]}